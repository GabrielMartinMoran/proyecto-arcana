const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./lCNLHSrR.js","./C4c6zY-H.js","./yBjK6igh.js","./x4_yyNok.js"])))=>i.map(i=>d[i]);
import{_ as I}from"./PPVm8Dsz.js";import{C as S}from"./BdNfXnux.js";import{w as O,g as q}from"./Cje6xDa-.js";const Y=t=>{if(t&&typeof t.toDate=="function")try{return t.toDate()}catch{}if(t instanceof Date)return t;if(typeof t=="string"||typeof t=="number"){const e=new Date(t);if(!isNaN(e.getTime()))return e}if(t&&typeof t=="object"){const e=typeof t.seconds=="number"?t.seconds:typeof t._seconds=="number"?t._seconds:null;if(typeof e=="number")return new Date(e*1e3)}return new Date},G=t=>({...t,timestamp:Y(t.timestamp)}),U=t=>({...t,timestamp:t.timestamp.toISOString()}),X=(t,e)=>{if(!t)return 0;const a=t.trim();try{const r=new Function("cuerpo","reflejos","mente","instinto","presencia","Math",`return (${a});`);return Number(r(Number(e.cuerpo)||0,Number(e.reflejos)||0,Number(e.mente)||0,Number(e.instinto)||0,Number(e.presencia)||0,Math))||0}catch(r){return console.error("Error evaluating modifier expression:",r),0}},Z=(t,e)=>X(t,{cuerpo:e.attributes.body,reflejos:e.attributes.reflexes,mente:e.attributes.mind,instinto:e.attributes.instinct,presencia:e.attributes.presence,Math});class B{id;name;attributes;cards;ppHistory;goldHistory;equipment;modifiers;currentHP;tempHP;currentLuck;img;story;notes;languages;quickInfo;attacks;maxActiveCards;version;constructor(e){this.id=e.id,this.name=e.name,this.attributes=e.attributes,this.cards=e.cards,this.ppHistory=e.ppHistory,this.goldHistory=e.goldHistory,this.equipment=e.equipment,this.modifiers=e.modifiers,this.currentHP=e.currentHP,this.tempHP=e.tempHP,this.currentLuck=e.currentLuck,this.img=e.img,this.story=e.story,this.notes=e.notes,this.languages=e.languages,this.quickInfo=e.quickInfo,this.attacks=e.attacks,this.maxActiveCards=e.maxActiveCards,this.version=e.version}calculateAttrModifiers(e,a){let r=a;const l=this.modifiers.filter(s=>s.attribute===e);for(const s of l){const o=Z(s.formula,this);if(s.type==="set")return o;s.type==="add"&&(r+=o)}return r}get maxLuck(){const e=S.MAX_LUCK;return this.calculateAttrModifiers("maxLuck",e)}get maxHP(){const e=S.BASE_HEALTH+this.attributes.body*S.HEALTH_BODY_MULTIPIER;return this.calculateAttrModifiers("maxHP",e)}get speed(){const e=S.BASE_SPEED+this.attributes.reflexes;return this.calculateAttrModifiers("speed",e)}get evasion(){const e=S.BASE_EVASION+this.attributes.reflexes;return this.calculateAttrModifiers("evasion",e)}get physicalMitigation(){return this.calculateAttrModifiers("physicalMitigation",0)}get magicalMitigation(){return this.calculateAttrModifiers("magicalMitigation",0)}get currentGold(){const e=this.goldHistory.filter(r=>r.type==="add").reduce((r,l)=>r+l.value,0),a=this.spentGold;return a>0?e-a:e}get spentGold(){return this.goldHistory.filter(e=>e.type==="subtract").reduce((e,a)=>e+a.value,0)}get currentPP(){const e=this.ppHistory.filter(r=>r.type==="add").reduce((r,l)=>r+l.value,0),a=this.spentPP;return a>0?e-a:e}get spentPP(){return this.ppHistory.filter(e=>e.type==="subtract").reduce((e,a)=>e+a.value,0)}get pjPower(){const e=this.cards.reduce((r,l)=>Math.max(r,l.level),0),a=this.spentPP/S.PJ_POWER_SPENT_PP_DIVIDER;return Math.round(e+a)}get numActiveCards(){return this.cards.filter(e=>e.isActive).length}get initiative(){return this.attributes.reflexes}copy(){return new B({...this})}}var C={VITE_FIREBASE_MESSAGING_SENDER_ID:"647852941329",VITE_FIREBASE_STORAGE_BUCKET:"arcana-85eeb.firebasestorage.app",VITE_FIREBASE_AUTH_DOMAIN:"arcana-85eeb.firebaseapp.com",VITE_FIREBASE_PROJECT_ID:"arcana-85eeb",VITE_FIREBASE_APP_ID:"1:647852941329:web:f2aa1e9dd6792f6a9d91b0",VITE_FIREBASE_API_KEY:"AIzaSyAFv5lor5ufY-KPBQ166rPSRnscFrtm88w"};function T(){return typeof window<"u"}function Q(){if(typeof C>"u")return null;const t=typeof C=="string"?JSON.parse(C):C;return t.VITE_FIREBASE_API_KEY?{apiKey:t.VITE_FIREBASE_API_KEY,authDomain:t.VITE_FIREBASE_AUTH_DOMAIN,projectId:t.VITE_FIREBASE_PROJECT_ID,storageBucket:t.VITE_FIREBASE_STORAGE_BUCKET,messagingSenderId:t.VITE_FIREBASE_MESSAGING_SENDER_ID,appId:t.VITE_FIREBASE_APP_ID}:null}function ee(){let t=null,e=null,a=!1,r=null;const l=O(!1),s=O(null);async function o(){if(a)return;if(a=!0,!T()){l.set(!1);return}const d=Q()??null;if(!d)throw l.set(!1),new Error("Firebase configuration missing: VITE_FIREBASE_* variables required.");try{const{initializeApp:u,getApps:E}=await I(async()=>{const{initializeApp:f,getApps:n}=await import("./lCNLHSrR.js");return{initializeApp:f,getApps:n}},__vite__mapDeps([0,1]),import.meta.url),p=await I(()=>import("./yBjK6igh.js"),__vite__mapDeps([2,1]),import.meta.url),y=await I(()=>import("./x4_yyNok.js"),__vite__mapDeps([3,1]),import.meta.url);E&&E().length===0&&u(d),t=p.getAuth(),e=y.getFirestore(),p.onAuthStateChanged(t,f=>{const n=f?{uid:f.uid,displayName:f.displayName,email:f.email,photoURL:f.photoURL}:null;s.set(n)}),l.set(!0)}catch(u){throw l.set(!1),console.error("[firebase-service] Initialization error:",u),u}}async function c(){if(r)return r;r=o();try{await r}finally{r=null}}function i(){let d=!1;return l.subscribe(u=>{d=u})(),d&&!!t&&!!e}async function w(){if(!T())return null;await c();const{GoogleAuthProvider:d,signInWithPopup:u}=await I(async()=>{const{GoogleAuthProvider:n,signInWithPopup:m}=await import("./yBjK6igh.js");return{GoogleAuthProvider:n,signInWithPopup:m}},__vite__mapDeps([2,1]),import.meta.url),E=new d;E.setCustomParameters({prompt:"select_account"});const y=(await u(t,E)).user;if(!y)return null;const f={uid:y.uid,displayName:y.displayName,email:y.email,photoURL:y.photoURL};return s.set(f),f}async function b(){if(!T())return;await c();const{signOut:d}=await I(async()=>{const{signOut:u}=await import("./yBjK6igh.js");return{signOut:u}},__vite__mapDeps([2,1]),import.meta.url);await d(t),s.set(null)}async function v(d){if(!T())return d(null),()=>{};await c();const{onAuthStateChanged:u}=await I(async()=>{const{onAuthStateChanged:p}=await import("./yBjK6igh.js");return{onAuthStateChanged:p}},__vite__mapDeps([2,1]),import.meta.url);return u(t,p=>{const y=p?{uid:p.uid,displayName:p.displayName,email:p.email,photoURL:p.photoURL}:null;s.set(y),d(y)})}async function g(){if(await c(),!e)throw new Error("Firestore not initialized")}async function A(d,u){if(!d)throw new Error("userId required");if(!T())return;await g();const{doc:E,writeBatch:p}=await I(async()=>{const{doc:n,writeBatch:m}=await import("./x4_yyNok.js");return{doc:n,writeBatch:m}},__vite__mapDeps([3,1]),import.meta.url),y=u.map(n=>JSON.parse(JSON.stringify(n||{}))),f=3;for(let n=1;n<=f;n++)try{const m=p(e);for(const D of y){const F=E(e,"users",d,"characters",D.id);m.set(F,D,{merge:!0})}await m.commit();return}catch(m){if(console.error(`[firebase-service] saveCharactersForUser attempt ${n} failed:`,m),n===f)throw m;await new Promise(D=>setTimeout(D,200*n))}}async function _(d,u){if(!d)throw new Error("userId required");if(!u)throw new Error("characterId required");if(!T())return;await g();const{doc:E,deleteDoc:p}=await I(async()=>{const{doc:y,deleteDoc:f}=await import("./x4_yyNok.js");return{doc:y,deleteDoc:f}},__vite__mapDeps([3,1]),import.meta.url);await p(E(e,"users",d,"characters",u))}async function R(d){if(!d)throw new Error("userId required");if(!T())return[];await g();const{collection:u,getDocs:E}=await I(async()=>{const{collection:n,getDocs:m}=await import("./x4_yyNok.js");return{collection:n,getDocs:m}},__vite__mapDeps([3,1]),import.meta.url),p=u(e,"users",d,"characters"),y=await E(p),f=[];return y.forEach(n=>{const m=n.data();f.push(new B(m))}),f}function k(d,u){if(!T())return u([]),()=>{};let E=()=>{};return(async()=>{try{await g();const{collection:p,onSnapshot:y}=await I(async()=>{const{collection:n,onSnapshot:m}=await import("./x4_yyNok.js");return{collection:n,onSnapshot:m}},__vite__mapDeps([3,1]),import.meta.url),f=p(e,"users",d,"characters");E=y(f,n=>{const m=[];n.forEach(D=>{m.push(new B(D.data()))}),u(m)},n=>{console.error("[firebase-service] listenCharactersForUser snapshot error:",n),u([])})}catch(p){console.error("[firebase-service] listenCharactersForUser setup error:",p),u([])}})(),()=>{try{E&&E()}catch{}}}async function H(d,u){if(!d)throw new Error("userId required");if(!T())return;await g();const{doc:E,writeBatch:p}=await I(async()=>{const{doc:n,writeBatch:m}=await import("./x4_yyNok.js");return{doc:n,writeBatch:m}},__vite__mapDeps([3,1]),import.meta.url),y=u.map(n=>JSON.parse(JSON.stringify(n||{}))),f=3;for(let n=1;n<=f;n++)try{const m=p(e);for(const D of y){const F=E(e,"users",d,"rollLogs",D.id);m.set(F,D,{merge:!0})}await m.commit();return}catch(m){if(console.error(`[firebase-service] saveRollLogsForUser attempt ${n} failed:`,m),n===f)throw m;await new Promise(D=>setTimeout(D,200*n))}}async function N(d){if(!d)throw new Error("userId required");if(!T())return[];await g();const{collection:u,getDocs:E}=await I(async()=>{const{collection:n,getDocs:m}=await import("./x4_yyNok.js");return{collection:n,getDocs:m}},__vite__mapDeps([3,1]),import.meta.url),p=u(e,"users",d,"rollLogs"),y=await E(p),f=[];return y.forEach(n=>f.push({...n.data()||{},id:n.id})),f}function z(d,u){if(!T())return u([]),()=>{};let E=()=>{};return(async()=>{try{await g();const{collection:p,onSnapshot:y}=await I(async()=>{const{collection:n,onSnapshot:m}=await import("./x4_yyNok.js");return{collection:n,onSnapshot:m}},__vite__mapDeps([3,1]),import.meta.url),f=p(e,"users",d,"rollLogs");E=y(f,n=>{const m=[];n.forEach(D=>{const F={...D.data()||{},id:D.id};m.push(F)}),u(m)},n=>{console.error("[firebase-service] listenRollLogsForUser snapshot error:",n),u([])})}catch(p){console.error("[firebase-service] listenRollLogsForUser setup error:",p),u([])}})(),()=>{try{E&&E()}catch{}}}async function W(d,u){if(!d)throw new Error("userId required");if(!u)throw new Error("logId required");if(!T())return;await g();const{doc:E,deleteDoc:p}=await I(async()=>{const{doc:y,deleteDoc:f}=await import("./x4_yyNok.js");return{doc:y,deleteDoc:f}},__vite__mapDeps([3,1]),import.meta.url);await p(E(e,"users",d,"rollLogs",u))}return{firebaseReady:l,user:s,initFirebase:c,isEnabled:i,signInWithGoogle:w,signOutUser:b,onAuthState:v,saveCharactersForUser:A,loadCharactersForUser:R,deleteCharacterForUser:_,listenCharactersForUser:k,saveRollLogsForUser:H,loadRollLogsForUser:N,deleteRollLogForUser:W,listenRollLogsForUser:z}}const te=ee();function re(){return te}const se=(t,e)=>{if(!t)return[];const a=[],r=t.replace(/\s+/g,""),l=/([+-]?)(\d*d\d+(?:[eE])?|\d+(\.\d+)?|[A-Za-z_][A-Za-z0-9_]*)/g;let s;for(;(s=l.exec(r))!==null;){const o=s[1]||"+",c=s[2],i=/^(\d*)[dD](\d+)([eE])?$/.exec(c);if(i){const A=i[1],_=i[2],R=!!i[3],k=A?Number(A):1,H=Number(_);let N=`${k}d${H}`;o==="-"&&(N=`-${N}`);const z={type:"dice",isExplosive:R,value:N};a.push(z);continue}if(/^\d+(\.\d+)?$/.exec(c)){let A=Number(c);o==="-"&&(A=-A),a.push({type:"constant",isExplosive:!1,value:A});continue}const b=c,v=e&&Object.prototype.hasOwnProperty.call(e,b)&&Number(e[b])||0,g=o==="-"?-v:v;a.push({type:"variable",value:g,isExplosive:!1,label:b})}return a},oe=t=>{let e="";return t.forEach((a,r)=>{const l=a.expressionMember;let s="";switch(l.type){case"dice":r>0&&!l.value.toString().startsWith("-")&&(s+="+ "),s+=`${l.value}${l.isExplosive?"e":""} [${a.result.map(o=>`<span class="${o.value===o.sides?"max":""}${o.value===1?"min":""}">`+o.value.toString()+(l.isExplosive&&o.value===o.sides?"💥":"")+"</span>").join(", ")}]`;break;case"constant":s=`${r>0&&l.value>=0?"+ ":""}${l.value}`;break;case"variable":s=`${r>0&&l.value>=0?"+ ":""}${l.label} [${l.value}]`;break}s.startsWith("-")&&(s=s.replace("-","- ")),e+=`${r>0?" ":""}${s}`}),e},K=t=>{let e=0;return t.forEach(a=>{const r=a.expressionMember;switch(r.type){case"dice":e+=a.result.reduce((l,s)=>l+s.value,0)*(r.value.toString().startsWith("-")?-1:1);break;case"constant":e+=r.value;break;case"variable":e+=r.value;break}}),e},me=t=>{const e=[];if(!t||!String(t).trim())return e;const a=String(t).trim(),r=/^[+-]/.test(a)?a:`+${a}`,l=/([+-])\s*([^+-]+)/g;let s;for(;(s=l.exec(r))!==null;){const c=s[1]==="+"?1:-1,i=(s[2]||"").trim();if(!i)continue;const w=i.match(/^(\d+)\s*d\s*(\d+)/i);if(w){const g=Number(w[1]),A=Number(w[2]),R=i.slice(w[0].length).trim()||null;e.push({kind:"dice",sign:c,n:g,faces:A,damageType:R,raw:i});continue}const b=i.match(/^(\d+)/);if(b){const g=Number(b[1]),_=i.slice(b[0].length).trim()||null;e.push({kind:"flat",sign:c,value:g,damageType:_,raw:i});continue}const v=i.match(/(\d+)\s*d\s*(\d+)/i);if(v){const g=Number(v[1]),A=Number(v[2]),_=i.replace(v[0],"").trim()||null;e.push({kind:"dice",sign:c,n:g,faces:A,damageType:_,raw:i});continue}e.push({kind:"flat",sign:c,value:0,damageType:i||null,raw:i})}return e.reduce((c,i)=>i.kind==="dice"?`${c} ${i.sign===1?"+":"-"} ${i.n}d${i.faces}`:i.kind==="flat"?`${c} ${i.sign===1?"+":"-"} ${i.value}`:c,"")},x="arcana:rollLogs",L=100,h={inited:!1,clearTimeoutId:null,roll3DDice:async()=>[],clear3DDices:()=>{},logs:O([]),rollModalOpened:O(!1),rollModalData:O(void 0)},P=re();let M=null,V=null,J=!1,$=!1;const ie=()=>{try{const t=localStorage.getItem(x),e=t?JSON.parse(t):[];return(Array.isArray(e)?e.slice(-L):e).map(r=>G(r))}catch(t){return console.error("Error loading roll logs:",t),[]}finally{h.logs.subscribe(async t=>{try{await ae(t)}catch(e){console.error("[dice-roller-service] saveRollLogs subscription error:",e)}})}},ae=async t=>{if(!J){if($){try{const a=(Array.isArray(t)?t.slice(-L):[]).map(r=>U(r));localStorage.setItem(x,JSON.stringify(a))}catch(e){console.error("[dice-roller-service] Error persisting locally during concurrent save:",e)}return}try{const e=Array.isArray(t)?t.slice(-L):[],a=e.filter(r=>r&&r.pending);for(const r of a)if(r&&!r.id)try{r.id=crypto.randomUUID()}catch{r.id=`local-${Date.now()}-${Math.floor(Math.random()*1e5)}`}if(M&&P.isEnabled()&&a.length>0)try{$=!0;const r=a.map(s=>U(s));await P.saveRollLogsForUser(M,r);const l=r.map(s=>s.id).filter(Boolean);if(l.length>0){h.logs.update(c=>Array.isArray(c)?c.map(i=>l.includes(i.id)?{...i,pending:!1}:i):c);const s=q(h.logs)||[],o=(Array.isArray(s)?s.slice(-L):[]).map(c=>U(c));localStorage.setItem(x,JSON.stringify(o))}}catch(r){console.error("[dice-roller-service] Cloud sync failed, falling back to localStorage:",r)}finally{$=!1}try{const r=e.map(l=>U(l));localStorage.setItem(x,JSON.stringify(r))}catch(r){console.error("Error saving roll logs to localStorage:",r)}}catch(e){console.error("Error preparing roll logs for save:",e)}finally{$=!1}}},j=async t=>S.STANDARD_DICES.some(a=>t.endsWith(a))?h.roll3DDice(t):new Promise(a=>{const[r,l]=t.split("d"),s=[];for(let o=0;o<Number(r);o++)s.push({value:Math.floor(Math.random()*Number(l))+1,sides:Number(l),dieType:"d"+l,groupId:0,rollId:o,theme:"default",themeColor:"#000000"});a(s)}),ne=(t,e,a)=>{const r=K(t),l={id:crypto.randomUUID(),timestamp:new Date,title:e||"Tirada anónima",total:r,formattedTotal:a?a(r):void 0,pending:!0,detail:oe(t)};h.logs.update(s=>[...s,l].slice(-L))},le=(t,e)=>{const a=new Map;for(const s of t)s&&s.id&&a.set(s.id,s);const r=new Map;for(const s of t)s&&s.id&&r.set(s.id,s);for(const s of e){const o=s.id;if(!o){const i=crypto.randomUUID();s.id=i,r.set(i,s);continue}if(s.pending){r.set(o,s);continue}const c=a.get(o);if(!c)r.set(o,s);else{const i=new Date(s.timestamp).getTime(),w=new Date(c.timestamp).getTime();!isNaN(i)&&!isNaN(w)?r.set(o,i>=w?s:c):r.set(o,s)}}return Array.from(r.values()).sort((s,o)=>new Date(s.timestamp).getTime()-new Date(o.timestamp).getTime()).slice(-L)},pe=()=>{h.inited||(h.logs.set(ie()),h.inited=!0,(async()=>{try{await P.initFirebase(),await P.onAuthState(async o=>{const c=M;if(M=o?o.uid:null,c&&c!==M&&V)try{V(),V=null}catch{}if(M&&P.isEnabled())try{V=P.listenRollLogsForUser(M,i=>{J=!0;try{const w=(i||[]).map(g=>G(g)),b=q(h.logs)||[],v=le(w,b);h.logs.set(v)}catch(w){console.error("[dice-roller-service] Error applying remote logs:",w)}finally{J=!1}})}catch(i){console.error("[dice-roller-service] Error starting remote listener:",i)}else try{const i=localStorage.getItem(x);if(i){const b=JSON.parse(i).map(v=>G(v));h.logs.set(b)}}catch(i){console.error("[dice-roller-service] Error loading local logs:",i)}})}catch(o){console.warn("[dice-roller-service] Firebase setup error (continuing with local logs):",o)}})());const t=({expression:o,variables:c={},title:i=void 0,resultFormatter:w=()=>{}})=>{h.rollModalData.set({expression:o,variables:c,title:i??"Tirar",rollType:"normal",extraModsExpression:"",resultFormatter:w}),h.rollModalOpened.set(!0)},e=async()=>{const o=q(h.rollModalData);if(h.rollModalData.set(void 0),h.rollModalOpened.set(!1),!o)return;let c=o.expression,i=o.title;o.rollType!=="normal"&&(c+=o.rollType==="advantage"?"+1d4":"-1d4",i+=o.rollType==="advantage"?" (ventaja)":" (desventaja)"),o?.extraModsExpression&&(c+=`+${o.extraModsExpression.trim()}`,c=c.replaceAll("++","+").replaceAll("+-","-")),r({expression:c,variables:o.variables,title:i})},a=()=>{h.rollModalOpened.set(!1),h.rollModalData.set(void 0)},r=async({expression:o,variables:c={},title:i=void 0,resultFormatter:w=()=>{}})=>{const b=se(o,c);h.clearTimeoutId&&(clearTimeout(h.clearTimeoutId),h.clearTimeoutId=null),h.clear3DDices();const v=[];for(const g of b)g.type==="dice"?v.push({expressionMember:g,promise:j(g.value),result:void 0,explosionResolved:!1,numExplosions:0}):v.push({expressionMember:g,promise:void 0,result:g.value,explosionResolved:!0,numExplosions:0});for(;v.some(g=>g.result===void 0);){const g=[],A=v.filter(_=>_.expressionMember.type==="dice"&&_.result===void 0);for(const _ of A)g.push((async()=>{_.result=await _.promise,_.promise=void 0;for(const R of _.result)_.expressionMember.isExplosive&&R.sides===R.value&&R.sides>1&&_.numExplosions++;if(_.numExplosions>0){const R={..._.expressionMember,value:`${_.numExplosions}d${_.result[0].sides}`};v.push({expressionMember:R,promise:j(R.value),result:void 0,explosionResolved:!1,numExplosions:0})}return _})());await Promise.all(g)}return h.clearTimeoutId=setTimeout(()=>{h.clear3DDices()},S.CLEAR_3D_DICES_DELAY),ne(v,i,w),K(v)};return{rollExpression:r,register3DDiceRollerFn:o=>{h.roll3DDice=o},registerClear3DDicesFn:o=>{h.clear3DDices=o},rollLogs:h.logs,rollModal:{rollModalOpened:h.rollModalOpened,openRollModal:t,rollModalData:h.rollModalData,submitRollModal:e,abortRollModal:a}}};export{B as C,pe as a,me as p,re as u};
