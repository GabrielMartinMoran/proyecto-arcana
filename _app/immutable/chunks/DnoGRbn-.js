const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./lCNLHSrR.js","./C4c6zY-H.js","./yBjK6igh.js","./x4_yyNok.js"])))=>i.map(i=>d[i]);
import{_ as I}from"./PPVm8Dsz.js";import{C as P}from"./DjstBrrL.js";import{w as F,g as q}from"./Cje6xDa-.js";const Y=t=>{if(t&&typeof t.toDate=="function")try{return t.toDate()}catch{}if(t instanceof Date)return t;if(typeof t=="string"||typeof t=="number"){const e=new Date(t);if(!isNaN(e.getTime()))return e}if(t&&typeof t=="object"){const e=typeof t.seconds=="number"?t.seconds:typeof t._seconds=="number"?t._seconds:null;if(typeof e=="number")return new Date(e*1e3)}return new Date},G=t=>({...t,timestamp:Y(t.timestamp)}),C=t=>({...t,timestamp:t.timestamp.toISOString()}),X=(t,e)=>{if(!t)return 0;const i=t.trim();try{const r=new Function("cuerpo","reflejos","mente","instinto","presencia","Math",`return (${i});`);return Number(r(Number(e.cuerpo)||0,Number(e.reflejos)||0,Number(e.mente)||0,Number(e.instinto)||0,Number(e.presencia)||0,Math))||0}catch(r){return console.error("Error evaluating modifier expression:",r),0}},Z=(t,e)=>X(t,{cuerpo:e.attributes.body,reflejos:e.attributes.reflexes,mente:e.attributes.mind,instinto:e.attributes.instinct,presencia:e.attributes.presence,Math});class B{id;name;attributes;cards;ppHistory;goldHistory;equipment;modifiers;currentHP;tempHP;currentLuck;img;story;notes;languages;quickInfo;attacks;maxActiveCards;version;constructor(e){this.id=e.id,this.name=e.name,this.attributes=e.attributes,this.cards=e.cards,this.ppHistory=e.ppHistory,this.goldHistory=e.goldHistory,this.equipment=e.equipment,this.modifiers=e.modifiers,this.currentHP=e.currentHP,this.tempHP=e.tempHP,this.currentLuck=e.currentLuck,this.img=e.img,this.story=e.story,this.notes=e.notes,this.languages=e.languages,this.quickInfo=e.quickInfo,this.attacks=e.attacks,this.maxActiveCards=e.maxActiveCards,this.version=e.version}calculateAttrModifiers(e,i){let r=i;const n=this.modifiers.filter(s=>s.attribute===e);for(const s of n){const o=Z(s.formula,this);if(s.type==="set")return o;s.type==="add"&&(r+=o)}return r}get maxLuck(){const e=P.MAX_LUCK;return this.calculateAttrModifiers("maxLuck",e)}get maxHP(){const e=Math.round(this.spentPP/P.PP_TO_HP_FACTOR),i=P.BASE_HEALTH+this.attributes.body*P.HEALTH_BODY_MULTIPIER+e;return this.calculateAttrModifiers("maxHP",i)}get speed(){const e=P.BASE_SPEED+this.attributes.reflexes;return this.calculateAttrModifiers("speed",e)}get evasion(){const e=P.BASE_EVASION+this.attributes.reflexes;return this.calculateAttrModifiers("evasion",e)}get physicalMitigation(){return this.calculateAttrModifiers("physicalMitigation",0)}get magicalMitigation(){return this.calculateAttrModifiers("magicalMitigation",0)}get currentGold(){const e=this.goldHistory.filter(r=>r.type==="add").reduce((r,n)=>r+n.value,0),i=this.spentGold;return i>0?e-i:e}get spentGold(){return this.goldHistory.filter(e=>e.type==="subtract").reduce((e,i)=>e+i.value,0)}get currentPP(){const e=this.ppHistory.filter(r=>r.type==="add").reduce((r,n)=>r+n.value,0),i=this.spentPP;return i>0?e-i:e}get spentPP(){return this.ppHistory.filter(e=>e.type==="subtract").reduce((e,i)=>e+i.value,0)}get pjPower(){const e=this.cards.map(n=>n.level).sort((n,s)=>s-n).slice(0,P.TOP_N_CARDS_TO_CALCULATE_PJ_POWER);console.log(e);const i=e.reduce((n,s)=>n+s,0)/e.length,r=this.spentPP/P.PJ_POWER_SPENT_PP_DIVIDER;return Math.round(i+r)}get tier(){for(const e of P.CHARACTER_TIERS)if(this.spentPP>=e.minPP&&this.spentPP<=e.maxPP)return e.tier;return 0}get numActiveCards(){return this.cards.filter(e=>e.isActive).length}get initiative(){return this.attributes.reflexes}copy(){return new B({...this})}}var U={VITE_FIREBASE_MESSAGING_SENDER_ID:"647852941329",VITE_FIREBASE_STORAGE_BUCKET:"arcana-85eeb.firebasestorage.app",VITE_FIREBASE_AUTH_DOMAIN:"arcana-85eeb.firebaseapp.com",VITE_FIREBASE_PROJECT_ID:"arcana-85eeb",VITE_FIREBASE_APP_ID:"1:647852941329:web:f2aa1e9dd6792f6a9d91b0",VITE_FIREBASE_API_KEY:"AIzaSyAFv5lor5ufY-KPBQ166rPSRnscFrtm88w"};function R(){return typeof window<"u"}function Q(){if(typeof U>"u")return null;const t=typeof U=="string"?JSON.parse(U):U;return t.VITE_FIREBASE_API_KEY?{apiKey:t.VITE_FIREBASE_API_KEY,authDomain:t.VITE_FIREBASE_AUTH_DOMAIN,projectId:t.VITE_FIREBASE_PROJECT_ID,storageBucket:t.VITE_FIREBASE_STORAGE_BUCKET,messagingSenderId:t.VITE_FIREBASE_MESSAGING_SENDER_ID,appId:t.VITE_FIREBASE_APP_ID}:null}function ee(){let t=null,e=null,i=!1,r=null;const n=F(!1),s=F(null);async function o(){if(i)return;if(i=!0,!R()){n.set(!1);return}const d=Q()??null;if(!d)throw n.set(!1),new Error("Firebase configuration missing: VITE_FIREBASE_* variables required.");try{const{initializeApp:u,getApps:E}=await I(async()=>{const{initializeApp:f,getApps:l}=await import("./lCNLHSrR.js");return{initializeApp:f,getApps:l}},__vite__mapDeps([0,1]),import.meta.url),p=await I(()=>import("./yBjK6igh.js"),__vite__mapDeps([2,1]),import.meta.url),y=await I(()=>import("./x4_yyNok.js"),__vite__mapDeps([3,1]),import.meta.url);E&&E().length===0&&u(d),t=p.getAuth(),e=y.getFirestore(),p.onAuthStateChanged(t,f=>{const l=f?{uid:f.uid,displayName:f.displayName,email:f.email,photoURL:f.photoURL}:null;s.set(l)}),n.set(!0)}catch(u){throw n.set(!1),console.error("[firebase-service] Initialization error:",u),u}}async function c(){if(r)return r;r=o();try{await r}finally{r=null}}function a(){let d=!1;return n.subscribe(u=>{d=u})(),d&&!!t&&!!e}async function w(){if(!R())return null;await c();const{GoogleAuthProvider:d,signInWithPopup:u}=await I(async()=>{const{GoogleAuthProvider:l,signInWithPopup:m}=await import("./yBjK6igh.js");return{GoogleAuthProvider:l,signInWithPopup:m}},__vite__mapDeps([2,1]),import.meta.url),E=new d;E.setCustomParameters({prompt:"select_account"});const y=(await u(t,E)).user;if(!y)return null;const f={uid:y.uid,displayName:y.displayName,email:y.email,photoURL:y.photoURL};return s.set(f),f}async function b(){if(!R())return;await c();const{signOut:d}=await I(async()=>{const{signOut:u}=await import("./yBjK6igh.js");return{signOut:u}},__vite__mapDeps([2,1]),import.meta.url);await d(t),s.set(null)}async function v(d){if(!R())return d(null),()=>{};await c();const{onAuthStateChanged:u}=await I(async()=>{const{onAuthStateChanged:p}=await import("./yBjK6igh.js");return{onAuthStateChanged:p}},__vite__mapDeps([2,1]),import.meta.url);return u(t,p=>{const y=p?{uid:p.uid,displayName:p.displayName,email:p.email,photoURL:p.photoURL}:null;s.set(y),d(y)})}async function g(){if(await c(),!e)throw new Error("Firestore not initialized")}async function A(d,u){if(!d)throw new Error("userId required");if(!R())return;await g();const{doc:E,writeBatch:p}=await I(async()=>{const{doc:l,writeBatch:m}=await import("./x4_yyNok.js");return{doc:l,writeBatch:m}},__vite__mapDeps([3,1]),import.meta.url),y=u.map(l=>JSON.parse(JSON.stringify(l||{}))),f=3;for(let l=1;l<=f;l++)try{const m=p(e);for(const D of y){const N=E(e,"users",d,"characters",D.id);m.set(N,D,{merge:!0})}await m.commit();return}catch(m){if(console.error(`[firebase-service] saveCharactersForUser attempt ${l} failed:`,m),l===f)throw m;await new Promise(D=>setTimeout(D,200*l))}}async function _(d,u){if(!d)throw new Error("userId required");if(!u)throw new Error("characterId required");if(!R())return;await g();const{doc:E,deleteDoc:p}=await I(async()=>{const{doc:y,deleteDoc:f}=await import("./x4_yyNok.js");return{doc:y,deleteDoc:f}},__vite__mapDeps([3,1]),import.meta.url);await p(E(e,"users",d,"characters",u))}async function T(d){if(!d)throw new Error("userId required");if(!R())return[];await g();const{collection:u,getDocs:E}=await I(async()=>{const{collection:l,getDocs:m}=await import("./x4_yyNok.js");return{collection:l,getDocs:m}},__vite__mapDeps([3,1]),import.meta.url),p=u(e,"users",d,"characters"),y=await E(p),f=[];return y.forEach(l=>{const m=l.data();f.push(new B(m))}),f}function k(d,u){if(!R())return u([]),()=>{};let E=()=>{};return(async()=>{try{await g();const{collection:p,onSnapshot:y}=await I(async()=>{const{collection:l,onSnapshot:m}=await import("./x4_yyNok.js");return{collection:l,onSnapshot:m}},__vite__mapDeps([3,1]),import.meta.url),f=p(e,"users",d,"characters");E=y(f,l=>{const m=[];l.forEach(D=>{m.push(new B(D.data()))}),u(m)},l=>{console.error("[firebase-service] listenCharactersForUser snapshot error:",l),u([])})}catch(p){console.error("[firebase-service] listenCharactersForUser setup error:",p),u([])}})(),()=>{try{E&&E()}catch{}}}async function H(d,u){if(!d)throw new Error("userId required");if(!R())return;await g();const{doc:E,writeBatch:p}=await I(async()=>{const{doc:l,writeBatch:m}=await import("./x4_yyNok.js");return{doc:l,writeBatch:m}},__vite__mapDeps([3,1]),import.meta.url),y=u.map(l=>JSON.parse(JSON.stringify(l||{}))),f=3;for(let l=1;l<=f;l++)try{const m=p(e);for(const D of y){const N=E(e,"users",d,"rollLogs",D.id);m.set(N,D,{merge:!0})}await m.commit();return}catch(m){if(console.error(`[firebase-service] saveRollLogsForUser attempt ${l} failed:`,m),l===f)throw m;await new Promise(D=>setTimeout(D,200*l))}}async function O(d){if(!d)throw new Error("userId required");if(!R())return[];await g();const{collection:u,getDocs:E}=await I(async()=>{const{collection:l,getDocs:m}=await import("./x4_yyNok.js");return{collection:l,getDocs:m}},__vite__mapDeps([3,1]),import.meta.url),p=u(e,"users",d,"rollLogs"),y=await E(p),f=[];return y.forEach(l=>f.push({...l.data()||{},id:l.id})),f}function z(d,u){if(!R())return u([]),()=>{};let E=()=>{};return(async()=>{try{await g();const{collection:p,onSnapshot:y}=await I(async()=>{const{collection:l,onSnapshot:m}=await import("./x4_yyNok.js");return{collection:l,onSnapshot:m}},__vite__mapDeps([3,1]),import.meta.url),f=p(e,"users",d,"rollLogs");E=y(f,l=>{const m=[];l.forEach(D=>{const N={...D.data()||{},id:D.id};m.push(N)}),u(m)},l=>{console.error("[firebase-service] listenRollLogsForUser snapshot error:",l),u([])})}catch(p){console.error("[firebase-service] listenRollLogsForUser setup error:",p),u([])}})(),()=>{try{E&&E()}catch{}}}async function W(d,u){if(!d)throw new Error("userId required");if(!u)throw new Error("logId required");if(!R())return;await g();const{doc:E,deleteDoc:p}=await I(async()=>{const{doc:y,deleteDoc:f}=await import("./x4_yyNok.js");return{doc:y,deleteDoc:f}},__vite__mapDeps([3,1]),import.meta.url);await p(E(e,"users",d,"rollLogs",u))}return{firebaseReady:n,user:s,initFirebase:c,isEnabled:a,signInWithGoogle:w,signOutUser:b,onAuthState:v,saveCharactersForUser:A,loadCharactersForUser:T,deleteCharacterForUser:_,listenCharactersForUser:k,saveRollLogsForUser:H,loadRollLogsForUser:O,deleteRollLogForUser:W,listenRollLogsForUser:z}}const te=ee();function re(){return te}const se=(t,e)=>{if(!t)return[];const i=[],r=t.replace(/\s+/g,""),n=/([+-]?)(\d*d\d+(?:[eE])?|\d+(\.\d+)?|[A-Za-z_][A-Za-z0-9_]*)/g;let s;for(;(s=n.exec(r))!==null;){const o=s[1]||"+",c=s[2],a=/^(\d*)[dD](\d+)([eE])?$/.exec(c);if(a){const A=a[1],_=a[2],T=!!a[3],k=A?Number(A):1,H=Number(_);let O=`${k}d${H}`;o==="-"&&(O=`-${O}`);const z={type:"dice",isExplosive:T,value:O};i.push(z);continue}if(/^\d+(\.\d+)?$/.exec(c)){let A=Number(c);o==="-"&&(A=-A),i.push({type:"constant",isExplosive:!1,value:A});continue}const b=c,v=e&&Object.prototype.hasOwnProperty.call(e,b)&&Number(e[b])||0,g=o==="-"?-v:v;i.push({type:"variable",value:g,isExplosive:!1,label:b})}return i},oe=t=>{let e="";return t.forEach((i,r)=>{const n=i.expressionMember;let s="";switch(n.type){case"dice":r>0&&!n.value.toString().startsWith("-")&&(s+="+ "),s+=`${n.value}${n.isExplosive?"e":""} [${i.result.map(o=>`<span class="${o.value===o.sides?"max":""}${o.value===1?"min":""}">`+o.value.toString()+(n.isExplosive&&o.value===o.sides?"💥":"")+"</span>").join(", ")}]`;break;case"constant":s=`${r>0&&n.value>=0?"+ ":""}${n.value}`;break;case"variable":s=`${r>0&&n.value>=0?"+ ":""}${n.label} [${n.value}]`;break}s.startsWith("-")&&(s=s.replace("-","- ")),e+=`${r>0?" ":""}${s}`}),e},K=t=>{let e=0;return t.forEach(i=>{const r=i.expressionMember;switch(r.type){case"dice":e+=i.result.reduce((n,s)=>n+s.value,0)*(r.value.toString().startsWith("-")?-1:1);break;case"constant":e+=r.value;break;case"variable":e+=r.value;break}}),e},me=t=>{const e=[];if(!t||!String(t).trim())return e;const i=String(t).trim(),r=/^[+-]/.test(i)?i:`+${i}`,n=/([+-])\s*([^+-]+)/g;let s;for(;(s=n.exec(r))!==null;){const c=s[1]==="+"?1:-1,a=(s[2]||"").trim();if(!a)continue;const w=a.match(/^(\d+)\s*d\s*(\d+)/i);if(w){const g=Number(w[1]),A=Number(w[2]),T=a.slice(w[0].length).trim()||null;e.push({kind:"dice",sign:c,n:g,faces:A,damageType:T,raw:a});continue}const b=a.match(/^(\d+)/);if(b){const g=Number(b[1]),_=a.slice(b[0].length).trim()||null;e.push({kind:"flat",sign:c,value:g,damageType:_,raw:a});continue}const v=a.match(/(\d+)\s*d\s*(\d+)/i);if(v){const g=Number(v[1]),A=Number(v[2]),_=a.replace(v[0],"").trim()||null;e.push({kind:"dice",sign:c,n:g,faces:A,damageType:_,raw:a});continue}e.push({kind:"flat",sign:c,value:0,damageType:a||null,raw:a})}return e.reduce((c,a)=>a.kind==="dice"?`${c} ${a.sign===1?"+":"-"} ${a.n}d${a.faces}`:a.kind==="flat"?`${c} ${a.sign===1?"+":"-"} ${a.value}`:c,"")},x="arcana:rollLogs",L=100,h={inited:!1,clearTimeoutId:null,roll3DDice:async()=>[],clear3DDices:()=>{},logs:F([]),rollModalOpened:F(!1),rollModalData:F(void 0)},M=re();let S=null,V=null,J=!1,$=!1;const ie=()=>{try{const t=localStorage.getItem(x),e=t?JSON.parse(t):[];return(Array.isArray(e)?e.slice(-L):e).map(r=>G(r))}catch(t){return console.error("Error loading roll logs:",t),[]}finally{h.logs.subscribe(async t=>{try{await ae(t)}catch(e){console.error("[dice-roller-service] saveRollLogs subscription error:",e)}})}},ae=async t=>{if(!J){if($){try{const i=(Array.isArray(t)?t.slice(-L):[]).map(r=>C(r));localStorage.setItem(x,JSON.stringify(i))}catch(e){console.error("[dice-roller-service] Error persisting locally during concurrent save:",e)}return}try{const e=Array.isArray(t)?t.slice(-L):[],i=e.filter(r=>r&&r.pending);for(const r of i)if(r&&!r.id)try{r.id=crypto.randomUUID()}catch{r.id=`local-${Date.now()}-${Math.floor(Math.random()*1e5)}`}if(S&&M.isEnabled()&&i.length>0)try{$=!0;const r=i.map(s=>C(s));await M.saveRollLogsForUser(S,r);const n=r.map(s=>s.id).filter(Boolean);if(n.length>0){h.logs.update(c=>Array.isArray(c)?c.map(a=>n.includes(a.id)?{...a,pending:!1}:a):c);const s=q(h.logs)||[],o=(Array.isArray(s)?s.slice(-L):[]).map(c=>C(c));localStorage.setItem(x,JSON.stringify(o))}}catch(r){console.error("[dice-roller-service] Cloud sync failed, falling back to localStorage:",r)}finally{$=!1}try{const r=e.map(n=>C(n));localStorage.setItem(x,JSON.stringify(r))}catch(r){console.error("Error saving roll logs to localStorage:",r)}}catch(e){console.error("Error preparing roll logs for save:",e)}finally{$=!1}}},j=async t=>P.STANDARD_DICES.some(i=>t.endsWith(i))?h.roll3DDice(t):new Promise(i=>{const[r,n]=t.split("d"),s=[];for(let o=0;o<Number(r);o++)s.push({value:Math.floor(Math.random()*Number(n))+1,sides:Number(n),dieType:"d"+n,groupId:0,rollId:o,theme:"default",themeColor:"#000000"});i(s)}),ne=(t,e,i)=>{const r=K(t),n={id:crypto.randomUUID(),timestamp:new Date,title:e||"Tirada anónima",total:r,formattedTotal:i?i(r):void 0,pending:!0,detail:oe(t)};h.logs.update(s=>[...s,n].slice(-L))},le=(t,e)=>{const i=new Map;for(const s of t)s&&s.id&&i.set(s.id,s);const r=new Map;for(const s of t)s&&s.id&&r.set(s.id,s);for(const s of e){const o=s.id;if(!o){const a=crypto.randomUUID();s.id=a,r.set(a,s);continue}if(s.pending){r.set(o,s);continue}const c=i.get(o);if(!c)r.set(o,s);else{const a=new Date(s.timestamp).getTime(),w=new Date(c.timestamp).getTime();!isNaN(a)&&!isNaN(w)?r.set(o,a>=w?s:c):r.set(o,s)}}return Array.from(r.values()).sort((s,o)=>new Date(s.timestamp).getTime()-new Date(o.timestamp).getTime()).slice(-L)},pe=()=>{h.inited||(h.logs.set(ie()),h.inited=!0,(async()=>{try{await M.initFirebase(),await M.onAuthState(async o=>{const c=S;if(S=o?o.uid:null,c&&c!==S&&V)try{V(),V=null}catch{}if(S&&M.isEnabled())try{V=M.listenRollLogsForUser(S,a=>{J=!0;try{const w=(a||[]).map(g=>G(g)),b=q(h.logs)||[],v=le(w,b);h.logs.set(v)}catch(w){console.error("[dice-roller-service] Error applying remote logs:",w)}finally{J=!1}})}catch(a){console.error("[dice-roller-service] Error starting remote listener:",a)}else try{const a=localStorage.getItem(x);if(a){const b=JSON.parse(a).map(v=>G(v));h.logs.set(b)}}catch(a){console.error("[dice-roller-service] Error loading local logs:",a)}})}catch(o){console.warn("[dice-roller-service] Firebase setup error (continuing with local logs):",o)}})());const t=({expression:o,variables:c={},title:a=void 0,resultFormatter:w=()=>{}})=>{h.rollModalData.set({expression:o,variables:c,title:a??"Tirar",rollType:"normal",extraModsExpression:"",resultFormatter:w}),h.rollModalOpened.set(!0)},e=async()=>{const o=q(h.rollModalData);if(h.rollModalData.set(void 0),h.rollModalOpened.set(!1),!o)return;let c=o.expression,a=o.title;o.rollType!=="normal"&&(c+=o.rollType==="advantage"?"+1d4":"-1d4",a+=o.rollType==="advantage"?" (ventaja)":" (desventaja)"),o?.extraModsExpression&&(c+=`+${o.extraModsExpression.trim()}`,c=c.replaceAll("++","+").replaceAll("+-","-")),r({expression:c,variables:o.variables,title:a})},i=()=>{h.rollModalOpened.set(!1),h.rollModalData.set(void 0)},r=async({expression:o,variables:c={},title:a=void 0,resultFormatter:w=()=>{}})=>{const b=se(o,c);h.clearTimeoutId&&(clearTimeout(h.clearTimeoutId),h.clearTimeoutId=null),h.clear3DDices();const v=[];for(const g of b)g.type==="dice"?v.push({expressionMember:g,promise:j(g.value),result:void 0,explosionResolved:!1,numExplosions:0}):v.push({expressionMember:g,promise:void 0,result:g.value,explosionResolved:!0,numExplosions:0});for(;v.some(g=>g.result===void 0);){const g=[],A=v.filter(_=>_.expressionMember.type==="dice"&&_.result===void 0);for(const _ of A)g.push((async()=>{_.result=await _.promise,_.promise=void 0;for(const T of _.result)_.expressionMember.isExplosive&&T.sides===T.value&&T.sides>1&&_.numExplosions++;if(_.numExplosions>0){const T={..._.expressionMember,value:`${_.numExplosions}d${_.result[0].sides}`};v.push({expressionMember:T,promise:j(T.value),result:void 0,explosionResolved:!1,numExplosions:0})}return _})());await Promise.all(g)}return h.clearTimeoutId=setTimeout(()=>{h.clear3DDices()},P.CLEAR_3D_DICES_DELAY),ne(v,a,w),K(v)};return{rollExpression:r,register3DDiceRollerFn:o=>{h.roll3DDice=o},registerClear3DDicesFn:o=>{h.clear3DDices=o},rollLogs:h.logs,rollModal:{rollModalOpened:h.rollModalOpened,openRollModal:t,rollModalData:h.rollModalData,submitRollModal:e,abortRollModal:i}}};export{B as C,pe as a,me as p,re as u};
