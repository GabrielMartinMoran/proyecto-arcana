import{r as J}from"./DvYrvlig.js";import{C as m,u as U}from"./DGmKBFm_.js";import{w as O,g as F}from"./y52P6WVk.js";const E="arcana:characters",A="arcana:pendingCharacterDeletes",_=500,D=1500,n={charactersStore:O([]),exampleCharactersStore:O([]),charactersAlreadyLoaded:!1,exampleCharactersAlreadyLoaded:!1};let l=null,y=null,u=null,g=null,b=!1,S=null;const p={},f=new Map,d=U(),h=(()=>{try{const o=(()=>{try{return localStorage.getItem(A)}catch{return null}})();return o?JSON.parse(o):[]}catch{return[]}})(),C=()=>{try{localStorage.setItem(A,JSON.stringify(h))}catch(o){console.warn("[characters-service] Failed to persist pending deletes",o)}},I=async o=>{if(o&&d.isEnabled())for(const i of[...h])try{await d.deleteCharacterForUser(o,i);const s=h.indexOf(i);s!==-1&&(h.splice(s,1),C()),console.info("[characters-service] Successfully processed pending delete for",i)}catch(s){console.warn("[characters-service] Failed to process pending delete for",i,s)}},P=()=>{g||(g=n.charactersStore.subscribe(async o=>{if(b)return;try{const s=Date.now();for(const e of o){if(!e||!e.id)continue;const c=JSON.stringify(e);f.get(e.id)!==c&&(p[e.id]=s)}const t=new Set(o.map(e=>e.id));for(const e of Array.from(f.keys()))t.has(e)||(f.delete(e),delete p[e])}catch{}const i=JSON.stringify(o);try{localStorage.setItem(E,i)}catch(s){console.warn("Error saving characters to localStorage:",s)}try{l&&d.isEnabled()&&(S&&clearTimeout(S),S=setTimeout(async()=>{S=null;try{console.debug("[characters-service] preparing changed characters save (debounced)");const s=Date.now(),t=[],e=Date.now();for(const r of o){if(!r||!r.id)continue;const a=JSON.stringify(r);f.get(r.id)!==a&&(t.push(r),p[r.id]=e)}const c=t.map(r=>r.id);if(console.debug("[characters-service] changed characters detected",{count:t.length,ids:c}),t.length>0&&l&&d.isEnabled())try{await d.saveCharactersForUser(l,t);for(const a of t)a?.id&&f.set(a.id,JSON.stringify(a));const r=Date.now()-s;console.debug("[characters-service] saved changed characters to remote",{count:t.length,ids:c,duration:r})}catch(r){console.error("[characters-service] Error saving changed characters to remote:",r)}else console.debug("[characters-service] no changed characters to save")}catch(s){console.error("[characters-service] Error preparing changed characters save:",s)}},_))}catch(s){console.error("Error persisting characters to cloud:",s)}}))},R=()=>{if(g){try{g()}catch{}g=null}},T=o=>{if(u){try{u()}catch{}u=null}u=d.listenCharactersForUser(o,i=>{b=!0;try{const s=F(n.charactersStore),t=Date.now(),e=new Map;for(const r of i)r?.id&&e.set(r.id,r);const c=[...s];for(const r of i){const a=r?.id;if(!a||p[a]!==void 0&&t-p[a]<D)continue;const w=new m(r);f.set(a,JSON.stringify(w));const L=c.findIndex(N=>N?.id===a);L!==-1?c[L]=w:c.push(w)}for(let r=c.length-1;r>=0;r--){const a=c[r]?.id;a&&(e.has(a)||p[a]!==void 0&&t-p[a]<D||(c.splice(r,1),f.delete(a)))}n.charactersStore.set(c)}finally{b=!1}})},v=()=>{if(u){try{u()}catch{}u=null}},j=()=>{const o=async()=>{if(!n.charactersAlreadyLoaded){try{await d.initFirebase()}catch(t){console.warn("Firebase init error (continuing with local persistence):",t)}try{y=await d.onAuthState(async t=>{const e=l;if(l=t?t.uid:null,e&&e!==l&&v(),l&&d.isEnabled())try{T(l),I(l).catch(c=>{console.warn("[characters-service] processPendingDeletes failed:",c)})}catch(c){console.error("[characters-service] Error starting remote listener:",c)}else{v();const c=localStorage.getItem(E);if(c)try{const r=JSON.parse(c);n.charactersStore.set(r.map(a=>new m(a)))}catch(r){console.error("Error parsing characters JSON:",r)}else n.charactersStore.set([])}})}catch(t){console.warn("Auth listener setup error (continuing with local persistence):",t);const e=localStorage.getItem(E);if(e)try{const c=JSON.parse(e);n.charactersStore.set(c.map(r=>new m(r)))}catch(c){console.error("Error parsing characters JSON:",c)}}P(),n.charactersAlreadyLoaded=!0}},i=async()=>{if(n.exampleCharactersAlreadyLoaded)return;let t=[];try{t=await(await fetch(J("/docs/example-characters.json"))).json()}catch(e){console.error("Error fetching example characters:",e)}try{n.exampleCharactersStore.set(t.map(e=>new m(e)))}catch(e){console.error("Error parsing example characters JSON:",e)}n.exampleCharactersAlreadyLoaded=!0},s=async t=>{n.charactersStore.update(e=>e.filter(c=>c.id!==t));try{h.includes(t)||(h.push(t),C())}catch(e){console.warn("[characters-service] Failed to queue pending delete:",e)}if(l&&d.isEnabled())try{await d.deleteCharacterForUser(l,t);const e=h.indexOf(t);e!==-1&&(h.splice(e,1),C())}catch(e){console.warn("[characters-service] Immediate cloud delete failed, queued for retry:",e)}};return{loadCharacters:o,loadExampleCharacters:i,characters:n.charactersStore,exampleCharacters:n.exampleCharactersStore,deleteCharacter:s,cleanup:()=>{if(y){try{y()}catch{}y=null}v(),R()}}};export{j as u};
