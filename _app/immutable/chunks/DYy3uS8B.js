import{r as pe}from"./yCoHh2B5.js";import{C as I,u as ve}from"./F630LRhk.js";import{w as W}from"./y52P6WVk.js";import"./DsnmJJEf.js";import{p as _e,b as x,a as S,d as be,g as A,e as g,r as b,j as c,ab as H,t as k,f as Ce,K as ye}from"./t0Cq7XZL.js";import{d as ge,s as X}from"./D_zjkKVN.js";import{i as j,s as we,a as Ee}from"./CuTJ2zLb.js";import{e as Se,s as B}from"./BDY9aIh_.js";import{s as Ae}from"./BmU-s7xp.js";import{p as D}from"./Pn6U6YSw.js";import{g as Z}from"./2IFoCY1h.js";import{p}from"./KyYO0PDG.js";import{C as xe}from"./C82mCCUT.js";import{C as $}from"./BLLLuF8N.js";const K="arcana:characters",ee="arcana:pendingCharacterDeletes",Te=500,l={charactersStore:W([]),exampleCharactersStore:W([]),charactersAlreadyLoaded:!1,exampleCharactersAlreadyLoaded:!1};let u=null,L=null,w=null,P=null,q=!1,O=null;const m=ve(),C=(()=>{try{const o=(()=>{try{return localStorage.getItem(ee)}catch{return null}})();return o?JSON.parse(o):[]}catch{return[]}})(),Y=()=>{try{localStorage.setItem(ee,JSON.stringify(C))}catch(o){console.warn("[characters-service] Failed to persist pending deletes",o)}},ke=async o=>{if(o&&m.isEnabled())for(const e of[...C])try{await m.deleteCharacterForUser(o,e);const r=C.indexOf(e);r!==-1&&(C.splice(r,1),Y()),console.info("[characters-service] Successfully processed pending delete for",e)}catch(r){console.warn("[characters-service] Failed to process pending delete for",e,r)}},De=()=>{P||(P=l.charactersStore.subscribe(async o=>{if(q)return;const e=JSON.stringify(o);try{localStorage.setItem(K,e)}catch(r){console.warn("Error saving characters to localStorage:",r)}try{u&&m.isEnabled()&&(O&&clearTimeout(O),O=setTimeout(async()=>{O=null,await m.saveCharactersForUser(u,o)},Te))}catch(r){console.error("Error persisting characters to cloud:",r)}}))},Pe=()=>{if(P){try{P()}catch{}P=null}},Ue=o=>{if(w){try{w()}catch{}w=null}w=m.listenCharactersForUser(o,e=>{q=!0;try{l.charactersStore.set(e.map(r=>new I(r)))}finally{q=!1}})},G=()=>{if(w){try{w()}catch{}w=null}},sr=()=>{const o=async()=>{if(!l.charactersAlreadyLoaded){try{await m.initFirebase()}catch(s){console.warn("Firebase init error (continuing with local persistence):",s)}try{L=await m.onAuthState(async s=>{const t=u;if(u=s?s.uid:null,t&&t!==u&&G(),u&&m.isEnabled())try{Ue(u),ke(u).catch(i=>{console.warn("[characters-service] processPendingDeletes failed:",i)})}catch(i){console.error("[characters-service] Error starting remote listener:",i)}else{G();const i=localStorage.getItem(K);if(i)try{const f=JSON.parse(i);l.charactersStore.set(f.map(T=>new I(T)))}catch(f){console.error("Error parsing characters JSON:",f)}else l.charactersStore.set([])}})}catch(s){console.warn("Auth listener setup error (continuing with local persistence):",s);const t=localStorage.getItem(K);if(t)try{const i=JSON.parse(t);l.charactersStore.set(i.map(f=>new I(f)))}catch(i){console.error("Error parsing characters JSON:",i)}}De(),l.charactersAlreadyLoaded=!0}},e=async()=>{if(l.exampleCharactersAlreadyLoaded)return;let s=[];try{s=await(await fetch(pe("/docs/example-characters.json"))).json()}catch(t){console.error("Error fetching example characters:",t)}try{l.exampleCharactersStore.set(s.map(t=>new I(t)))}catch(t){console.error("Error parsing example characters JSON:",t)}l.exampleCharactersAlreadyLoaded=!0},r=async s=>{l.charactersStore.update(t=>t.filter(i=>i.id!==s));try{C.includes(s)||(C.push(s),Y())}catch(t){console.warn("[characters-service] Failed to queue pending delete:",t)}if(u&&m.isEnabled())try{await m.deleteCharacterForUser(u,s);const t=C.indexOf(s);t!==-1&&(C.splice(t,1),Y())}catch(t){console.warn("[characters-service] Immediate cloud delete failed, queued for retry:",t);try{const i=await new Promise(f=>{l.charactersStore.subscribe(T=>f(T))()});await m.saveCharactersForUser(u,i)}catch(i){console.error("[characters-service] Error syncing characters after failed delete:",i)}}};return{loadCharacters:o,loadExampleCharacters:e,characters:l.charactersStore,exampleCharacters:l.exampleCharactersStore,deleteCharacter:r,cleanup:()=>{if(L){try{L()}catch{}L=null}G(),Pe()}}},Fe=async(o,e,r)=>{const s=await e()();r(s)},Le=async(o,e,r)=>{const s=await e()();r(s)},Oe=async(o,e,r)=>{c(e)&&await r()(c(e))},Ie=async(o,e,r,s)=>{!c(e)||!confirm(`Â¿Quieres eliminar a ${c(e).name}?`)||(await r()(c(e)),ye(e,void 0),s(null))},Ne=async(o,e,r)=>{c(e)&&await r()(c(e))};var Re=x('<button title="Importar y Editar">ğŸ“</button>'),Je=x('<button title="Crear">â•</button> <button title="Importar">ğŸ“¥</button> <button title="Exportar">ğŸ“¤</button> <button title="Eliminar">ğŸ—‘ï¸</button>',1),Me=(o,e,r)=>e(c(r)),He=x('<img class="character-image svelte-dk16f3"/>'),je=x('<span class="image-placeholder svelte-dk16f3"> </span>'),Be=x('<button><!> <span class="name svelte-dk16f3"> </span></button>'),Ge=x('<section class="characters-page svelte-dk16f3"><div class="list svelte-dk16f3"><div class="header svelte-dk16f3"><!></div> <div class="content svelte-dk16f3"></div></div> <div class="viewport svelte-dk16f3"><!></div></section>');function cr(o,e){_e(e,!0);const r=()=>Ee(e.characters,"$characters",s),[s,t]=we();let i=D(e,"onAddToMyCharacters",3,()=>{throw new Error("onAddToMyCharacters not implemented")}),f=D(e,"onCreateCharacter",3,async()=>{throw new Error("onCreateCharacter not implemented")}),T=D(e,"onImportCharacter",3,async()=>{throw new Error("onCreateCharacter not implemented")}),re=D(e,"onExportCharacter",3,async()=>{throw new Error("onCreateCharacter not implemented")}),te=D(e,"onDeleteCharacter",3,async()=>{throw new Error("onCreateCharacter not implemented")}),z=H(()=>p.url.searchParams.get("characterId")),ae=H(()=>p.url.searchParams.get("tab")??$.DEFAULT_CHARACTER_SHEET_TAB);const U=a=>{a!==null?(p.url.searchParams.set("characterId",a.id),p.url.searchParams.set("tab",$.DEFAULT_CHARACTER_SHEET_TAB)):(p.url.searchParams.delete("characterId"),p.url.searchParams.delete("tab")),Z(`?${p.url.searchParams.toString()}`)},se=a=>{p.url.searchParams.set("tab",a),Z(`?${p.url.searchParams.toString()}`)};let v=H(()=>r().find(a=>a.id===c(z)));const ce=a=>{e.characters.update(n=>{const d=n.findIndex(h=>h.id===a.id);if(d!==-1){const h=[...n];return h[d]=a,h}return n})};var N=Ge(),R=g(N),J=g(R),oe=g(J);{var ne=a=>{var n=Re();n.__click=[Ne,v,i],k(()=>n.disabled=e.allActionsDisabled||!c(v)),S(a,n)},ie=a=>{var n=Je(),d=Ce(n);d.__click=[Fe,f,U];var h=A(d,2);h.__click=[Le,T,U];var E=A(h,2);E.__click=[Oe,v,re];var F=A(E,2);F.__click=[Ie,v,te,U],k(()=>{d.disabled=e.allActionsDisabled,h.disabled=e.allActionsDisabled,E.disabled=e.allActionsDisabled||!c(v),F.disabled=e.allActionsDisabled||!c(v)}),S(a,n)};j(oe,a=>{e.readonly?a(ne):a(ie,!1)})}b(J);var Q=A(J,2);Se(Q,5,r,a=>a.id,(a,n)=>{var d=Be();let h;d.__click=[Me,U,n];var E=g(d);{var F=_=>{var y=He();k(()=>{B(y,"src",c(n).img),B(y,"alt",c(n).name)}),S(_,y)},he=_=>{var y=je(),me=g(y,!0);b(y),k(fe=>X(me,fe),[()=>c(n).name.charAt(0).toUpperCase()]),S(_,y)};j(E,_=>{c(n).img?_(F):_(he,!1)})}var M=A(E,2),ue=g(M,!0);b(M),b(d),k(_=>{h=Ae(d,1,"character-item svelte-dk16f3",null,h,_),B(M,"title",c(n).name),X(ue,c(n).name)},[()=>({selected:c(z)===c(n).id})]),S(a,d)}),b(Q),b(R);var V=A(R,2),le=g(V);{var de=a=>{xe(a,{get character(){return c(v)},get readonly(){return e.readonly},onChange:ce,get currentTab(){return c(ae)},onTabChange:se})};j(le,a=>{c(v)&&a(de)})}b(V),b(N),S(o,N),be(),t()}ge(["click"]);export{cr as C,sr as u};
