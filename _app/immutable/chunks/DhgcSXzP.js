import{r as fe}from"./B1RTRjFS.js";import{C as U,u as pe}from"./8iG_Nq0v.js";import{w as V}from"./DQyq_pEW.js";import"./DsnmJJEf.js";import{p as ve,b as x,a as S,d as be,g as A,e as g,r as _,j as c,ab as H,t as P,f as _e,K as Ce}from"./DWCm9pug.js";import{d as ye,s as W}from"./Cr_WvuOy.js";import{i as M,s as ge,a as we}from"./DAwWLKW0.js";import{e as Ee,s as j}from"./9dkhkBLf.js";import{s as Se}from"./BkiENg0Z.js";import{p as T}from"./eoMlQPJr.js";import{g as X}from"./Ch-wVOzj.js";import{p}from"./CuoKUW6K.js";import{C as Ae}from"./DcjqnFkE.js";import{C as Z}from"./BLLLuF8N.js";const K="arcana:characters",$="arcana:pendingCharacterDeletes",l={charactersStore:V([]),exampleCharactersStore:V([]),charactersAlreadyLoaded:!1,exampleCharactersAlreadyLoaded:!1};let u=null,I=null,w=null,D=null,q=!1;const m=pe(),C=(()=>{try{const o=(()=>{try{return localStorage.getItem($)}catch{return null}})();return o?JSON.parse(o):[]}catch{return[]}})(),B=()=>{try{localStorage.setItem($,JSON.stringify(C))}catch(o){console.warn("[characters-service] Failed to persist pending deletes",o)}},xe=async o=>{if(o&&m.isEnabled())for(const e of[...C])try{await m.deleteCharacterForUser(o,e);const r=C.indexOf(e);r!==-1&&(C.splice(r,1),B()),console.info("[characters-service] Successfully processed pending delete for",e)}catch(r){console.warn("[characters-service] Failed to process pending delete for",e,r)}},ke=()=>{D||(D=l.charactersStore.subscribe(async o=>{if(q)return;const e=JSON.stringify(o);try{localStorage.setItem(K,e)}catch(r){console.warn("Error saving characters to localStorage:",r)}try{u&&m.isEnabled()&&await m.saveCharactersForUser(u,o)}catch(r){console.error("Error persisting characters to cloud:",r)}}))},Pe=()=>{if(D){try{D()}catch{}D=null}},Te=o=>{if(w){try{w()}catch{}w=null}w=m.listenCharactersForUser(o,e=>{q=!0;try{l.charactersStore.set(e.map(r=>new U(r)))}finally{q=!1}})},G=()=>{if(w){try{w()}catch{}w=null}},tr=()=>{const o=async()=>{if(!l.charactersAlreadyLoaded){try{await m.initFirebase()}catch(s){console.warn("Firebase init error (continuing with local persistence):",s)}try{I=await m.onAuthState(async s=>{const t=u;if(u=s?s.uid:null,t&&t!==u&&G(),u&&m.isEnabled())try{Te(u),xe(u).catch(i=>{console.warn("[characters-service] processPendingDeletes failed:",i)})}catch(i){console.error("[characters-service] Error starting remote listener:",i)}else{G();const i=localStorage.getItem(K);if(i)try{const f=JSON.parse(i);l.charactersStore.set(f.map(k=>new U(k)))}catch(f){console.error("Error parsing characters JSON:",f)}else l.charactersStore.set([])}})}catch(s){console.warn("Auth listener setup error (continuing with local persistence):",s);const t=localStorage.getItem(K);if(t)try{const i=JSON.parse(t);l.charactersStore.set(i.map(f=>new U(f)))}catch(i){console.error("Error parsing characters JSON:",i)}}ke(),l.charactersAlreadyLoaded=!0}},e=async()=>{if(l.exampleCharactersAlreadyLoaded)return;let s=[];try{s=await(await fetch(fe("/docs/example-characters.json"))).json()}catch(t){console.error("Error fetching example characters:",t)}try{l.exampleCharactersStore.set(s.map(t=>new U(t)))}catch(t){console.error("Error parsing example characters JSON:",t)}l.exampleCharactersAlreadyLoaded=!0},r=async s=>{l.charactersStore.update(t=>t.filter(i=>i.id!==s));try{C.includes(s)||(C.push(s),B())}catch(t){console.warn("[characters-service] Failed to queue pending delete:",t)}if(u&&m.isEnabled())try{await m.deleteCharacterForUser(u,s);const t=C.indexOf(s);t!==-1&&(C.splice(t,1),B())}catch(t){console.warn("[characters-service] Immediate cloud delete failed, queued for retry:",t);try{const i=await new Promise(f=>{l.charactersStore.subscribe(k=>f(k))()});await m.saveCharactersForUser(u,i)}catch(i){console.error("[characters-service] Error syncing characters after failed delete:",i)}}};return{loadCharacters:o,loadExampleCharacters:e,characters:l.charactersStore,exampleCharacters:l.exampleCharactersStore,deleteCharacter:r,cleanup:()=>{if(I){try{I()}catch{}I=null}G(),Pe()}}},De=async(o,e,r)=>{const s=await e()();r(s)},Fe=async(o,e,r)=>{const s=await e()();r(s)},Le=async(o,e,r)=>{c(e)&&await r()(c(e))},Ie=async(o,e,r,s)=>{!c(e)||!confirm(`Â¿Quieres eliminar a ${c(e).name}?`)||(await r()(c(e)),Ce(e,void 0),s(null))},Ue=async(o,e,r)=>{c(e)&&await r()(c(e))};var Oe=x('<button title="Importar y Editar">ğŸ“</button>'),Ne=x('<button title="Crear">â•</button> <button title="Importar">ğŸ“¥</button> <button title="Exportar">ğŸ“¤</button> <button title="Eliminar">ğŸ—‘ï¸</button>',1),Re=(o,e,r)=>e(c(r)),Je=x('<img class="character-image svelte-dk16f3"/>'),He=x('<span class="image-placeholder svelte-dk16f3"> </span>'),Me=x('<button><!> <span class="name svelte-dk16f3"> </span></button>'),je=x('<section class="characters-page svelte-dk16f3"><div class="list svelte-dk16f3"><div class="header svelte-dk16f3"><!></div> <div class="content svelte-dk16f3"></div></div> <div class="viewport svelte-dk16f3"><!></div></section>');function ar(o,e){ve(e,!0);const r=()=>we(e.characters,"$characters",s),[s,t]=ge();let i=T(e,"onAddToMyCharacters",3,()=>{throw new Error("onAddToMyCharacters not implemented")}),f=T(e,"onCreateCharacter",3,async()=>{throw new Error("onCreateCharacter not implemented")}),k=T(e,"onImportCharacter",3,async()=>{throw new Error("onCreateCharacter not implemented")}),ee=T(e,"onExportCharacter",3,async()=>{throw new Error("onCreateCharacter not implemented")}),re=T(e,"onDeleteCharacter",3,async()=>{throw new Error("onCreateCharacter not implemented")}),Y=H(()=>p.url.searchParams.get("characterId")),te=H(()=>p.url.searchParams.get("tab")??Z.DEFAULT_CHARACTER_SHEET_TAB);const F=a=>{a!==null?(p.url.searchParams.set("characterId",a.id),p.url.searchParams.set("tab",Z.DEFAULT_CHARACTER_SHEET_TAB)):(p.url.searchParams.delete("characterId"),p.url.searchParams.delete("tab")),X(`?${p.url.searchParams.toString()}`)},ae=a=>{p.url.searchParams.set("tab",a),X(`?${p.url.searchParams.toString()}`)};let v=H(()=>r().find(a=>a.id===c(Y)));const se=a=>{e.characters.update(n=>{const d=n.findIndex(h=>h.id===a.id);if(d!==-1){const h=[...n];return h[d]=a,h}return n})};var O=je(),N=g(O),R=g(N),ce=g(R);{var oe=a=>{var n=Oe();n.__click=[Ue,v,i],P(()=>n.disabled=e.allActionsDisabled||!c(v)),S(a,n)},ne=a=>{var n=Ne(),d=_e(n);d.__click=[De,f,F];var h=A(d,2);h.__click=[Fe,k,F];var E=A(h,2);E.__click=[Le,v,ee];var L=A(E,2);L.__click=[Ie,v,re,F],P(()=>{d.disabled=e.allActionsDisabled,h.disabled=e.allActionsDisabled,E.disabled=e.allActionsDisabled||!c(v),L.disabled=e.allActionsDisabled||!c(v)}),S(a,n)};M(ce,a=>{e.readonly?a(oe):a(ne,!1)})}_(R);var z=A(R,2);Ee(z,5,r,a=>a.id,(a,n)=>{var d=Me();let h;d.__click=[Re,F,n];var E=g(d);{var L=b=>{var y=Je();P(()=>{j(y,"src",c(n).img),j(y,"alt",c(n).name)}),S(b,y)},de=b=>{var y=He(),ue=g(y,!0);_(y),P(me=>W(ue,me),[()=>c(n).name.charAt(0).toUpperCase()]),S(b,y)};M(E,b=>{c(n).img?b(L):b(de,!1)})}var J=A(E,2),he=g(J,!0);_(J),_(d),P(b=>{h=Se(d,1,"character-item svelte-dk16f3",null,h,b),j(J,"title",c(n).name),W(he,c(n).name)},[()=>({selected:c(Y)===c(n).id})]),S(a,d)}),_(z),_(N);var Q=A(N,2),ie=g(Q);{var le=a=>{Ae(a,{get character(){return c(v)},get readonly(){return e.readonly},onChange:se,get currentTab(){return c(te)},onTabChange:ae})};M(ie,a=>{c(v)&&a(le)})}_(Q),_(O),S(o,O),be(),t()}ye(["click"]);export{ar as C,tr as u};
