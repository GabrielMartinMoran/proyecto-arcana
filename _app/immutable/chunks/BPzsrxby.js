import{w as b,g as R}from"./CkIMCjdd.js";import{C as x}from"./CKrzFlF1.js";const S=e=>({...e,timestamp:new Date(e.timestamp)}),w=e=>({...e,timestamp:e.timestamp.toISOString()}),N=(e,t)=>{if(!e)return[];const l=[],c=e.replace(/\s+/g,""),n=/([+-]?)(\d*d\d+(?:[eE])?|\d+(\.\d+)?|[A-Za-z_][A-Za-z0-9_]*)/g;let r;for(;(r=n.exec(c))!==null;){const s=r[1]||"+",i=r[2],o=/^(\d*)[dD](\d+)([eE])?$/.exec(i);if(o){const m=o[1],d=o[2],v=!!o[3],y=m?Number(m):1,$=Number(d);let D=`${y}d${$}`;s==="-"&&(D=`-${D}`);const T={type:"dice",isExplosive:v,value:D};l.push(T);continue}if(/^\d+(\.\d+)?$/.exec(i)){let m=Number(i);s==="-"&&(m=-m),l.push({type:"constant",isExplosive:!1,value:m});continue}const g=i,p=t&&Object.prototype.hasOwnProperty.call(t,g)&&Number(t[g])||0,u=s==="-"?-p:p;l.push({type:"variable",value:u,isExplosive:!1,label:g})}return l},k=e=>{let t="";return e.forEach((l,c)=>{const n=l.expressionMember;let r="";switch(n.type){case"dice":c>0&&!n.value.toString().startsWith("-")&&(r+="+ "),r+=`${n.value}${n.isExplosive?"e":""} [${l.result.map(s=>`<span class="${s.value===s.sides?"max":""}${s.value===1?"min":""}">`+s.value.toString()+(n.isExplosive&&s.value===s.sides?"ðŸ’¥":"")+"</span>").join(", ")}]`;break;case"constant":r=`${c>0&&n.value>=0?"+ ":""}${n.value}`;break;case"variable":r=`${c>0&&n.value>=0?"+ ":""}${n.label} [${n.value}]`;break}r.startsWith("-")&&(r=r.replace("-","- ")),t+=`${c>0?" ":""}${r}`}),t},M=e=>{let t=0;return e.forEach(l=>{const c=l.expressionMember;switch(c.type){case"dice":t+=l.result.reduce((n,r)=>n+r.value,0)*(c.value.toString().startsWith("-")?-1:1);break;case"constant":t+=c.value;break;case"variable":t+=c.value;break}}),t},_=e=>{const t=[];if(!e||!String(e).trim())return t;const l=String(e).trim(),c=/^[+-]/.test(l)?l:`+${l}`,n=/([+-])\s*([^+-]+)/g;let r;for(;(r=n.exec(c))!==null;){const i=r[1]==="+"?1:-1,o=(r[2]||"").trim();if(!o)continue;const f=o.match(/^(\d+)\s*d\s*(\d+)/i);if(f){const u=Number(f[1]),m=Number(f[2]),v=o.slice(f[0].length).trim()||null;t.push({kind:"dice",sign:i,n:u,faces:m,damageType:v,raw:o});continue}const g=o.match(/^(\d+)/);if(g){const u=Number(g[1]),d=o.slice(g[0].length).trim()||null;t.push({kind:"flat",sign:i,value:u,damageType:d,raw:o});continue}const p=o.match(/(\d+)\s*d\s*(\d+)/i);if(p){const u=Number(p[1]),m=Number(p[2]),d=o.replace(p[0],"").trim()||null;t.push({kind:"dice",sign:i,n:u,faces:m,damageType:d,raw:o});continue}t.push({kind:"flat",sign:i,value:0,damageType:o||null,raw:o})}return t.reduce((i,o)=>o.kind==="dice"?`${i} ${o.sign===1?"+":"-"} ${o.n}d${o.faces}`:o.kind==="flat"?`${i} ${o.sign===1?"+":"-"} ${o.value}`:i,"")},E="arcana:rollLogs",a={inited:!1,clearTimeoutId:null,roll3DDice:async()=>[],clear3DDices:()=>{},logs:b([]),rollModalOpened:b(!1),rollModalData:b(void 0)},I=()=>{try{const e=localStorage.getItem(E);return(e?JSON.parse(e):[]).map(l=>S(l))}catch(e){return console.error("Error loading roll logs:",e),[]}finally{a.logs.subscribe(e=>O(e))}},O=e=>{try{const t=e.map(l=>w(l));localStorage.setItem(E,JSON.stringify(t))}catch(t){console.error("Error saving roll logs:",t)}},h=async e=>x.STANDARD_DICES.some(l=>e.endsWith(l))?a.roll3DDice(e):new Promise(l=>{const[c,n]=e.split("d"),r=[];for(let s=0;s<Number(c);s++)r.push({value:Math.floor(Math.random()*Number(n))+1,sides:Number(n),dieType:"d"+n,groupId:0,rollId:s,theme:"default",themeColor:"#000000"});l(r)}),L=(e,t,l)=>{const c=M(e),n={id:crypto.randomUUID(),timestamp:new Date,title:t||"Tirada anÃ³nima",total:c,formattedTotal:l?l(c):void 0,detail:k(e)};a.logs.update(r=>[...r,n])},z=()=>{a.inited||(a.logs.set(I()),a.inited=!0);const e=({expression:s,variables:i={},title:o=void 0,resultFormatter:f=()=>{}})=>{a.rollModalData.set({expression:s,variables:i,title:o??"Tirar",rollType:"normal",extraModsExpression:"",resultFormatter:f}),a.rollModalOpened.set(!0)},t=async()=>{const s=R(a.rollModalData);if(a.rollModalData.set(void 0),a.rollModalOpened.set(!1),!s)return;let i=s.expression,o=s.title;s.rollType!=="normal"&&(i+=s.rollType==="advantage"?"+1d4":"-1d4",o+=s.rollType==="advantage"?" (ventaja)":" (desventaja)"),s?.extraModsExpression&&(i+=`+${s.extraModsExpression.trim()}`,i=i.replaceAll("++","+").replaceAll("+-","-")),c({expression:i,variables:s.variables,title:o})},l=()=>{a.rollModalOpened.set(!1),a.rollModalData.set(void 0)},c=async({expression:s,variables:i={},title:o=void 0,resultFormatter:f=()=>{}})=>{const g=N(s,i);a.clearTimeoutId&&(clearTimeout(a.clearTimeoutId),a.clearTimeoutId=null),a.clear3DDices();const p=[];for(const u of g)u.type==="dice"?p.push({expressionMember:u,promise:h(u.value),result:void 0,explosionResolved:!1,numExplosions:0}):p.push({expressionMember:u,promise:void 0,result:u.value,explosionResolved:!0,numExplosions:0});for(;p.some(u=>u.result===void 0);){const u=[],m=p.filter(d=>d.expressionMember.type==="dice"&&d.result===void 0);for(const d of m)u.push((async()=>{d.result=await d.promise,d.promise=void 0;for(const v of d.result)d.expressionMember.isExplosive&&v.sides===v.value&&v.sides>1&&d.numExplosions++;if(d.numExplosions>0){const v={...d.expressionMember,value:`${d.numExplosions}d${d.result[0].sides}`};p.push({expressionMember:v,promise:h(v.value),result:void 0,explosionResolved:!1,numExplosions:0})}return d})());await Promise.all(u)}return a.clearTimeoutId=setTimeout(()=>{a.clear3DDices()},x.CLEAR_3D_DICES_DELAY),L(p,o,f),M(p)};return{rollExpression:c,register3DDiceRollerFn:s=>{a.roll3DDice=s},registerClear3DDicesFn:s=>{a.clear3DDices=s},rollLogs:a.logs,rollModal:{rollModalOpened:a.rollModalOpened,openRollModal:e,rollModalData:a.rollModalData,submitRollModal:t,abortRollModal:l}}};export{_ as p,z as u};
