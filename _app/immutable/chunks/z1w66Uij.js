import{C as fe,u as Me,a as ze}from"./kpi8fZtB.js";import{w as Re,g as _e}from"./DnpldMJA.js";import"./DsnmJJEf.js";import{p as L,b as y,an as G,t as U,J as j,i as a,a as f,d as W,e as g,s as l,bd as Ue,r as c,f as ne,am as ge,I as ve,a_ as Oe,c as Le}from"./CXLGFl3I.js";import{d as Z,s as J,e as We}from"./DYVYXqqK.js";import{i as M,s as He,a as je}from"./ta242qJX.js";import{r as Ge,s as re,e as le}from"./BPnaOVD8.js";import{b as De,s as te}from"./BJEA7xJg.js";import{p as I}from"./tM2D1iY6.js";import{g as pe}from"./D01d1uBr.js";import{p as ae}from"./Bsmwaz86.js";import{c as Je}from"./DOxq7gAU.js";import{c as O,u as Ve,a as Be,b as Ce,C as Ke,d as Ye,e as Qe,f as Xe,I as D}from"./CVfuz9nF.js";import{a as Ze,o as $e}from"./DfNiT5Wx.js";import{c as et}from"./CjlGQt4x.js";import{b as tt}from"./g8FqIwc9.js";const xe="arcana:characters",B={charactersStore:Re([]),exampleCharactersStore:Re([]),charactersAlreadyLoaded:!1,exampleCharactersAlreadyLoaded:!1};let $=null,me=null,ce=null,be=null,we=!1;const qe="arcana:pendingCharacterDeletes",se=(()=>{try{const v=(()=>{try{return localStorage.getItem(qe)}catch{return null}})();return v?JSON.parse(v):[]}catch{return[]}})(),Pe=()=>{try{localStorage.setItem(qe,JSON.stringify(se))}catch(v){console.warn("[characters-service] Failed to persist pending deletes",v)}},at=async v=>{if(v&&ee.isEnabled())for(const e of[...se])try{await ee.deleteCharacterForUser(v,e);const t=se.indexOf(e);t!==-1&&(se.splice(t,1),Pe()),console.info("[characters-service] Successfully processed pending delete for",e)}catch(t){console.warn("[characters-service] Failed to process pending delete for",e,t)}},ee=Me(),rt=()=>{be||(be=B.charactersStore.subscribe(async v=>{if(we)return;const e=JSON.stringify(v);try{localStorage.setItem(xe,e)}catch(t){console.warn("Error saving characters to localStorage:",t)}try{$&&ee.isEnabled()&&await ee.saveCharactersForUser($,v)}catch(t){console.error("Error persisting characters to cloud:",t)}}))},nt=()=>{if(be){try{be()}catch{}be=null}},lt=v=>{if(ce){try{ce()}catch{}ce=null}ce=ee.listenCharactersForUser(v,e=>{we=!0;try{B.charactersStore.set(e.map(t=>new fe(t)))}finally{we=!1}})},ke=()=>{if(ce){try{ce()}catch{}ce=null}},cr=()=>{const v=async()=>{if(!B.charactersAlreadyLoaded){try{await ee.initFirebase()}catch(n){console.warn("Firebase init error (continuing with local persistence):",n)}try{me=await ee.onAuthState(async n=>{const r=$;if($=n?n.uid:null,r&&r!==$&&ke(),$&&ee.isEnabled())try{lt($),at($).catch(o=>{console.warn("[characters-service] processPendingDeletes failed:",o)})}catch(o){console.error("Error starting remote listener:",o)}else{ke();const o=localStorage.getItem(xe);if(o)try{const C=JSON.parse(o);B.charactersStore.set(C.map(A=>new fe(A)))}catch(C){console.error("Error parsing characters JSON:",C)}else B.charactersStore.set([])}})}catch(n){console.warn("Auth listener setup error (continuing with local persistence):",n);const r=localStorage.getItem(xe);if(r)try{const o=JSON.parse(r);B.charactersStore.set(o.map(C=>new fe(C)))}catch(o){console.error("Error parsing characters JSON:",o)}}rt(),B.charactersAlreadyLoaded=!0}},e=async()=>{if(B.exampleCharactersAlreadyLoaded)return;let n=[];try{n=await(await fetch("/docs/example-characters.json")).json()}catch(r){console.error("Error fetching example characters:",r)}try{B.exampleCharactersStore.set(n.map(r=>new fe(r)))}catch(r){console.error("Error parsing example characters JSON:",r)}B.exampleCharactersAlreadyLoaded=!0},t=async n=>{B.charactersStore.update(r=>r.filter(o=>o.id!==n));try{se.includes(n)||(se.push(n),Pe())}catch(r){console.warn("[characters-service] Failed to queue pending delete:",r)}if($&&ee.isEnabled())try{await ee.deleteCharacterForUser($,n);const r=se.indexOf(n);r!==-1&&(se.splice(r,1),Pe())}catch(r){console.warn("[characters-service] Immediate cloud delete failed, queued for retry:",r);try{const o=await new Promise(C=>{B.charactersStore.subscribe(A=>C(A))()});await ee.saveCharactersForUser($,o)}catch(o){console.error("[characters-service] Error syncing characters after failed delete:",o)}}};return{loadCharacters:v,loadExampleCharacters:e,characters:B.charactersStore,exampleCharacters:B.exampleCharactersStore,deleteCharacter:t,cleanup:()=>{if(me){try{me()}catch{}me=null}ke(),nt()}}};var ot=(v,e,t)=>e.onChange(a(t)),st=y('<input type="text" class="svelte-19nbfo1"/>');function Fe(v,e){L(e,!0);let t=I(e,"placeholder",3,void 0),n=G(()=>e.value);var r=st();Ge(r),r.__input=[ot,e,n],U(()=>{re(r,"placeholder",t()),r.disabled=e.readonly}),De(r,()=>a(n),o=>j(n,o)),f(v,r),W()}Z(["input"]);var it=y("<label> </label>"),dt=(v,e,t)=>e.onChange(a(t)),ct=y("<div><!> <div><textarea></textarea></div></div>");function Se(v,e){L(e,!0);const t=6;let n=I(e,"label",3,void 0),r=I(e,"placeholder",3,""),o=I(e,"maxRows",3,t),C=G(()=>e.value);var A=ct();let w;var S=g(A);{var _=s=>{var h=it(),k=g(h,!0);c(h),U(()=>J(k,n())),f(s,h)};M(S,s=>{n()&&s(_)})}var b=l(S,2);let E;var d=g(b);Ue(d),d.__input=[dt,e,C];let P;c(b),c(A),U((s,h,k)=>{w=te(A,1,"fieldgroup svelte-o02g58",null,w,s),E=te(b,1,"field svelte-o02g58",null,E,h),d.disabled=e.readonly,re(d,"placeholder",r()),re(d,"rows",o()==="unlimited"?void 0:o()),P=te(d,1,"svelte-o02g58",null,P,k)},[()=>({expanded:o()==="unlimited"}),()=>({expanded:o()==="unlimited"}),()=>({expanded:o()==="unlimited"})]),De(d,()=>a(C),s=>j(C,s)),f(v,A),W()}Z(["input"]);var vt=y('<div class="portrait svelte-8jg83a"><img class="svelte-8jg83a"/></div>'),ut=y("<!> <!>",1);function gt(v,e){L(e,!0);let t=I(e,"character",7);var n=ut(),r=ne(n);{var o=A=>{O(A,{children:(w,S)=>{var _=vt(),b=g(_);c(_),U(()=>{re(b,"src",t().img),re(b,"alt",t().name)}),f(w,_)},$$slots:{default:!0}})};M(r,A=>{t().img&&A(o)})}var C=l(r,2);O(C,{children:(A,w)=>{Se(A,{label:"Historia",get value(){return t().story},get readonly(){return e.readonly},onChange:S=>{t().story=S,e.onChange(t())}})},$$slots:{default:!0}}),f(v,n),W()}var bt=(v,e)=>e("ability"),ht=(v,e)=>e("item"),_t=y('<!> <div class="controls svelte-o497rd"><span class="svelte-o497rd">Agregar cartas a tu colección</span> <div class="buttons svelte-o497rd"><button>Agregar Carta de Habilidad</button> <button>Agregar Carta de Objeto Mágico</button></div></div>',1),mt=y('<div class="empty svelte-o497rd"><em>No se encontraron resultados</em></div>'),ft=y('<div class="cards-tab svelte-o497rd"><!> <!> <!></div> <div class="add-card-modal svelte-o497rd"><div class="all-cards svelte-o497rd"><!> <div class="cards-viewport svelte-o497rd"><!></div></div> <div class="footer svelte-o497rd"><button>Cerrar</button></div></div>',1);function yt(v,e){L(e,!0);let t=I(e,"character",7),{loadAbilityCards:n,abilityCards:r,loadItemCards:o,itemCards:C}=Be(),{rollExpression:A}=ze();const{buildEmptyFilters:w}=Ve();let S=ge(ve(w())),_=ge(ve([])),b=ge(ve({opened:!1,filteredCards:[],allCards:[]}));const E=r.subscribe(()=>{j(b,{...a(b),allCards:[],filteredCards:[]},!0)});Ze(()=>{E()}),$e(async()=>{await Promise.all([o(),n()]),j(_,[..._e(C),..._e(r)],!0)});const d=N=>{t().cards=N,e.onChange(t())},P=async N=>{const H=t().cards.find(T=>T.id===N),F=a(_).find(T=>T.id===N);H&&F&&H.uses!==null&&F&&await A({expression:"1d6",variables:{},title:`${t().name}: Recarga de carta ${F.name}`,resultFormatter:X=>`<span class="total ${X>=(F.uses?.qty??0)?"success":"failure"}">${X}</span>`})>=(F.uses?.qty??0)&&(H.uses+=1,d([...t().cards]))},s=N=>{j(S,N,!0),j(b,{...a(b),filteredCards:Xe(a(b).allCards,a(S))},!0)},h=()=>{s(w())},k=N=>{setTimeout(()=>{const H=N==="ability"?_e(r):_e(C);j(b,{opened:!0,filteredCards:H,allCards:H},!0)},0)},x=()=>{j(b,{opened:!1,filteredCards:[],allCards:[]},!0)};var i=ft(),u=ne(i),m=g(u);{var R=N=>{O(N,{children:(H,F)=>{var T=_t(),X=ne(T);D(X,{label:"Ranuras de Cartas Activas",labelWidth:"fit",get value(){return t().maxActiveCards},get readonly(){return e.readonly},fullWidth:!0,onChange:Ie=>{t().maxActiveCards=Number(Ie),e.onChange(t())}});var he=l(X,2),Ae=l(g(he),2),Ee=g(Ae);Ee.__click=[bt,k];var Te=l(Ee,2);Te.__click=[ht,k],c(Ae),c(he),f(H,T)},$$slots:{default:!0}})};M(m,N=>{e.readonly||N(R)})}var z=l(m,2);O(z,{get title(){return`Cartas Activas (${t().numActiveCards??""}/${t().maxActiveCards??""})`},children:(N,H)=>{{let F=G(()=>a(_).filter(T=>t().cards.some(X=>X.isActive&&X.id===T.id)));Ce(N,{get cards(){return a(F)},get readonly(){return e.readonly},get characterCards(){return t().cards},listMode:"active",onChange:d,onCardReloadClick:P})}},$$slots:{default:!0}});var K=l(z,2);O(K,{title:"Colección",children:(N,H)=>{{let F=G(()=>a(_).filter(T=>t().cards.some(X=>X.id===T.id)));Ce(N,{get cards(){return a(F)},get readonly(){return e.readonly},get characterCards(){return t().cards},listMode:"collection",onChange:d})}},$$slots:{default:!0}}),c(u);var Q=l(u,2),ie=g(Q),p=g(ie);Ke(p,{get cards(){return a(b).filteredCards},onFiltersChange:s,onResetFilters:h,get filters(){return a(S)}});var q=l(p,2),V=g(q);{var Y=N=>{{let H=G(()=>a(b).filteredCards.filter(F=>t().cards.find(T=>T.id===F.id)===void 0));Ce(N,{get cards(){return a(H)},get readonly(){return e.readonly},get characterCards(){return t().cards},listMode:"all",onChange:d})}},oe=N=>{var H=mt();f(N,H)};M(V,N=>{a(b).filteredCards.length>0?N(Y):N(oe,!1)})}c(q),c(ie);var de=l(ie,2),ye=g(de);ye.__click=x,c(de),c(Q),Ye(Q,N=>Qe?.(N)),U(()=>re(Q,"hidden",!a(b).opened)),We("outsideclick",Q,x),f(v,i),W()}Z(["click"]);const Ct=(v,e,t,n,r,o)=>{const C={id:crypto.randomUUID(),type:"add",value:e.quantity,reason:e.reason||t};n().goldHistory.unshift(C),r.onChange(n()),o()},kt=(v,e,t,n,r,o)=>{const C={id:crypto.randomUUID(),type:"subtract",value:e.quantity,reason:e.reason||t};n().goldHistory.unshift(C),r.onChange(n()),o()};var xt=y('<div class="status svelte-ssntdk"><div class="indicator svelte-ssntdk"><span>Oro Actual</span> <strong> </strong></div> <div class="indicator svelte-ssntdk"><span>Oro Gastado</span> <strong class="number svelte-ssntdk"> </strong></div></div>'),wt=y('<div class="editor svelte-ssntdk"><div class="labels svelte-ssntdk"><label class="qty svelte-ssntdk">Cantidad</label> <label class="reason svelte-ssntdk">Razón</label> <label class="btn svelte-ssntdk"></label> <label class="btn svelte-ssntdk"></label></div> <div class="controls svelte-ssntdk"><!> <!> <button title="Gastar Oro" class="svelte-ssntdk">-</button> <button title="Ganar Oro" class="svelte-ssntdk">+</button></div></div>'),Pt=(v,e,t)=>e(a(t)),St=y('<div class="log-content svelte-ssntdk"><strong> </strong> <span class="log-reason svelte-ssntdk"> </span> <button title="Deshacer esta acción">↶</button></div>'),At=y('<div class="empty svelte-ssntdk"><em>No hay registros</em></div>'),Et=y('<div class="history svelte-ssntdk"></div>'),Rt=y("<!> <!> <!>",1);function pt(v,e){L(e,!0);const t="Sin razón especifica";let n=I(e,"character",7),r=ve({quantity:1,reason:""});const o=()=>{r.quantity=1,r.reason=""},C=E=>{n().goldHistory=n().goldHistory.filter(d=>d.id!==E.id),e.onChange(n())};var A=Rt(),w=ne(A);O(w,{title:"Estado Actual",children:(E,d)=>{var P=xt(),s=g(P),h=l(g(s),2);let k;var x=g(h,!0);c(h),c(s);var i=l(s,2),u=l(g(i),2),m=g(u,!0);c(u),c(i),c(P),U(R=>{k=te(h,1,"number svelte-ssntdk",null,k,R),J(x,n().currentGold),J(m,n().spentGold)},[()=>({negative:n().currentGold<0})]),f(E,P)},$$slots:{default:!0}});var S=l(w,2);{var _=E=>{O(E,{title:"Actualizar Oro",children:(d,P)=>{var s=wt(),h=l(g(s),2),k=g(h);D(k,{get value(){return r.quantity},placeholder:"Cantidad",fullWidth:!1,onChange:m=>{r.quantity=Number(m)}});var x=l(k,2);D(x,{get value(){return r.reason},placeholder:"Razón",fullWidth:!0,onChange:m=>{r.reason=m.toString()}});var i=l(x,2);i.__click=[kt,r,t,n,e,o];var u=l(i,2);u.__click=[Ct,r,t,n,e,o],c(h),c(s),f(d,s)},$$slots:{default:!0}})};M(S,E=>{e.readonly||E(_)})}var b=l(S,2);O(b,{title:"Historial",children:(E,d)=>{var P=Et();le(P,21,()=>n().goldHistory,s=>s.id,(s,h)=>{var k=St(),x=g(k);let i;var u=g(x);c(x);var m=l(x,2),R=g(m,!0);c(m);var z=l(m,2);z.__click=[Pt,C,h],c(k),U(K=>{i=te(x,1,"log-amount svelte-ssntdk",null,i,K),J(u,`${a(h).type==="add"?"+":"-"}${a(h).value??""} Oro`),J(R,a(h).reason)},[()=>({positive:a(h).type==="add",negative:a(h).type==="subtract"})]),f(s,k)},s=>{var h=At();f(s,h)}),c(P),f(E,P)},$$slots:{default:!0}}),f(v,A),W()}Z(["click"]);const Nt=(v,e,t)=>{e([...e(),{id:crypto.randomUUID(),name:"",atkFormula:"",dmgFormula:"",notes:""}]),t.onChange(e())};var zt=y('<button title="Agregar Ataque">➕</button>'),Dt=(v,e,t)=>e(a(t)),qt=y('<button title="Eliminar" class="svelte-1v2w3y3">🗑️</button>'),Ft=y('<div class="item svelte-1v2w3y3"><!> <!> <!> <!> <!></div>'),Tt=y('<div class="attack-list svelte-1v2w3y3"><div class="header svelte-1v2w3y3"><label>Ataques</label> <!></div> <div class="content svelte-1v2w3y3"><div class="attacks-header svelte-1v2w3y3"><label class="name svelte-1v2w3y3">Nombre</label> <label class="atk-formula svelte-1v2w3y3">Formula Ataque</label> <label class="dmg-formula svelte-1v2w3y3">Formula Daño</label> <label class="notes svelte-1v2w3y3">Notas</label> <label class="actions svelte-1v2w3y3"></label></div> <!></div></div>');function It(v,e){L(e,!0);let t=I(e,"attacks",7);const n=_=>{t(t().filter(b=>b.id!==_.id)),e.onChange(t())};var r=Tt(),o=g(r),C=l(g(o),2);{var A=_=>{var b=zt();b.__click=[Nt,t,e],f(_,b)};M(C,_=>{e.readonly||_(A)})}c(o);var w=l(o,2),S=l(g(w),2);le(S,17,t,_=>_.id,(_,b,E)=>{var d=Ft(),P=g(d);D(P,{get value(){return a(b).name},get readonly(){return e.readonly},placeholder:"Nombre",fullWidth:!0,onChange:u=>{a(b).name=u.toString(),e.onChange(t())}});var s=l(P,2);{let u=G(()=>({icon:"🎯",title:"Tirar Ataque",onClick:()=>e.onAttackRoll(a(b)),disabled:!a(b).atkFormula}));D(s,{get value(){return a(b).atkFormula},get readonly(){return e.readonly},placeholder:"1d6e+cuerpo",fullWidth:!0,onChange:m=>{a(b).atkFormula=m.toString(),e.onChange(t())},get button(){return a(u)}})}var h=l(s,2);{let u=G(()=>({icon:"💥",title:"Tirar Daño",onClick:()=>e.onDamageRoll(a(b)),disabled:!a(b).dmgFormula}));D(h,{get value(){return a(b).dmgFormula},get readonly(){return e.readonly},placeholder:"1d4",fullWidth:!0,onChange:m=>{a(b).dmgFormula=m.toString(),e.onChange(t())},get button(){return a(u)}})}var k=l(h,2);D(k,{get value(){return a(b).notes},get readonly(){return e.readonly},placeholder:"Contundente",fullWidth:!0,onChange:u=>{a(b).notes=u.toString(),e.onChange(t())}});var x=l(k,2);{var i=u=>{var m=qt();m.__click=[Dt,n,b],f(u,m)};M(x,u=>{e.readonly||u(i)})}c(d),f(_,d)}),c(w),c(r),f(v,r),W()}Z(["click"]);function ue(v,e){L(e,!0);{let t=G(()=>({icon:"🎲",onClick:e.onDiceRoll,title:"Tirar"}));D(v,{get label(){return e.name},get value(){return e.value},get readonly(){return e.readonly},onChange:n=>e.onChange(Number(n)),get button(){return a(t)}})}W()}const Mt=(v,e,t)=>{e([...e(),{id:crypto.randomUUID(),quantity:1,name:"",notes:""}]),t.onChange(e())};var Ut=y('<button title="Agregar Item">➕</button>'),Ot=(v,e,t)=>e(a(t)),Lt=y('<button title="Eliminar">🗑️</button>'),Wt=y('<div class="item svelte-1ewnrao"><!> <!> <!> <!></div>'),Ht=y('<div class="equipment-list svelte-1ewnrao"><div class="header svelte-1ewnrao"><label>Equipo</label> <!></div> <div class="content svelte-1ewnrao"><div class="items-header svelte-1ewnrao"><label class="quantity svelte-1ewnrao">Cantidad</label> <label class="name svelte-1ewnrao">Nombre</label> <label class="notes svelte-1ewnrao">Notas</label></div> <!></div></div>');function jt(v,e){L(e,!0);let t=I(e,"equipment",7);const n=_=>{t(t().filter(b=>b.id!==_.id)),e.onChange(t())};var r=Ht(),o=g(r),C=l(g(o),2);{var A=_=>{var b=Ut();b.__click=[Mt,t,e],f(_,b)};M(C,_=>{e.readonly||_(A)})}c(o);var w=l(o,2),S=l(g(w),2);le(S,17,t,_=>_.id,(_,b,E)=>{var d=Wt(),P=g(d);D(P,{get value(){return a(b).quantity},get readonly(){return e.readonly},onChange:i=>{a(b).quantity=Number(i),e.onChange(t())}});var s=l(P,2);D(s,{get value(){return a(b).name},get readonly(){return e.readonly},placeholder:"Nombre",onChange:i=>{a(b).name=i.toString(),e.onChange(t())}});var h=l(s,2);D(h,{get value(){return a(b).notes},get readonly(){return e.readonly},placeholder:"Notas",fullWidth:!0,onChange:i=>{a(b).notes=i.toString(),e.onChange(t())}});var k=l(h,2);{var x=i=>{var u=Lt();u.__click=[Ot,n,b],f(i,u)};M(k,i=>{e.readonly||i(x)})}c(d),f(_,d)}),c(w),c(r),f(v,r),W()}Z(["click"]);var Gt=y('<div class="attributes svelte-ox7hjw"><!> <!> <!> <!> <!> <!></div>'),Jt=y('<div class="attributes svelte-ox7hjw"><!> <!> <!> <!> <!> <!> <!></div>'),Vt=y('<div class="empty svelte-ox7hjw"><em>No hay ataques cargados.</em></div>'),Bt=y('<div class="info svelte-ox7hjw"><!> <!> <!> <!></div>'),Kt=y('<div class="empty svelte-ox7hjw"><em>El equipo esta vacío.</em></div>'),Yt=y('<div class="equipment svelte-ox7hjw"><!> <!> <!></div>'),Qt=y("<!> <!> <!> <!>",1);function Xt(v,e){L(e,!0);let t=I(e,"character",7),{rollExpression:n,rollModal:r}=ze();const o=d=>{r.openRollModal({expression:`1d6e+${d}`,variables:{cuerpo:t().attributes.body,reflejos:t().attributes.reflexes,mente:t().attributes.mind,instinto:t().attributes.instinct,presencia:t().attributes.presence,iniciativa:t().initiative},title:`${t().name}: ${et(d)}`})},C=d=>{r.openRollModal({expression:d.atkFormula,variables:{cuerpo:t().attributes.body,reflejos:t().attributes.reflexes,mente:t().attributes.mind,instinto:t().attributes.instinct,presencia:t().attributes.presence},title:`${t().name}: Ataque con ${d.name}`})},A=d=>{n({expression:d.dmgFormula,variables:{cuerpo:t().attributes.body,reflejos:t().attributes.reflexes,mente:t().attributes.mind,instinto:t().attributes.instinct,presencia:t().attributes.presence},title:`${t().name}: Daño de ${d.name}`})};var w=Qt(),S=ne(w);O(S,{title:"Atributos Principales",children:(d,P)=>{var s=Gt(),h=g(s);ue(h,{name:"Cuerpo",get value(){return t().attributes.body},get readonly(){return e.readonly},onDiceRoll:()=>o("cuerpo"),onChange:R=>{t().attributes.body=R,e.onChange(t())}});var k=l(h,2);ue(k,{name:"Reflejos",get value(){return t().attributes.reflexes},get readonly(){return e.readonly},onDiceRoll:()=>o("reflejos"),onChange:R=>{t().attributes.reflexes=R,e.onChange(t())}});var x=l(k,2);ue(x,{name:"Mente",get value(){return t().attributes.mind},get readonly(){return e.readonly},onDiceRoll:()=>o("mente"),onChange:R=>{t().attributes.mind=R,e.onChange(t())}});var i=l(x,2);ue(i,{name:"Instinto",get value(){return t().attributes.instinct},get readonly(){return e.readonly},onDiceRoll:()=>o("instinto"),onChange:R=>{t().attributes.instinct=R,e.onChange(t())}});var u=l(i,2);ue(u,{name:"Presencia",get value(){return t().attributes.presence},get readonly(){return e.readonly},onDiceRoll:()=>o("presencia"),onChange:R=>{t().attributes.presence=R,e.onChange(t())}});var m=l(u,2);D(m,{label:"Suerte",get value(){return t().currentLuck},get max(){return t().maxLuck},get readonly(){return e.readonly},onChange:R=>{t().currentLuck=Number(R),e.onChange(t())}}),c(s),f(d,s)},$$slots:{default:!0}});var _=l(S,2);O(_,{title:"Atributos Derivados",children:(d,P)=>{var s=Jt(),h=g(s);D(h,{label:"Salud",get value(){return t().currentHP},get max(){return t().maxHP},get readonly(){return e.readonly},onChange:z=>{t().currentHP=Number(z),e.onChange(t())}});var k=l(h,2);D(k,{label:"Salud Temporal",get value(){return t().tempHP},get readonly(){return e.readonly},onChange:z=>{t().tempHP=Number(z),e.onChange(t())}});var x=l(k,2);D(x,{label:"Velocidad",get value(){return t().speed},readonly:!0});var i=l(x,2);D(i,{label:"Esquiva",get value(){return t().evasion},readonly:!0});var u=l(i,2);D(u,{label:"Mitigación Física",get value(){return t().physicalMitigation},readonly:!0});var m=l(u,2);D(m,{label:"Mitigación Mágica",get value(){return t().magicalMitigation},readonly:!0});var R=l(m,2);D(R,{label:"Iniciativa",get value(){return t().initiative},readonly:!0,button:{icon:"🎲",title:"Tirar iniciativa",onClick:()=>o("iniciativa")}}),c(s),f(d,s)},$$slots:{default:!0}});var b=l(_,2);O(b,{title:"Información",children:(d,P)=>{var s=Bt(),h=g(s);It(h,{get attacks(){return t().attacks},get readonly(){return e.readonly},onChange:m=>{t().attacks=m,e.onChange(t())},onAttackRoll:C,onDamageRoll:A});var k=l(h,2);{var x=m=>{var R=Vt();f(m,R)};M(k,m=>{t().attacks.length===0&&m(x)})}var i=l(k,2);Se(i,{label:"Información Rápida",get value(){return t().quickInfo},get readonly(){return e.readonly},placeholder:"Información general, habilidades, etc.",onChange:m=>{t().quickInfo=m,e.onChange(t())}});var u=l(i,2);D(u,{label:"Lenguas",get value(){return t().languages},get readonly(){return e.readonly},fullWidth:!0,placeholder:"Lista de lenguas concidas",textAlign:"left",onChange:m=>{t().languages=m,e.onChange(t())}}),c(s),f(d,s)},$$slots:{default:!0}});var E=l(b,2);O(E,{title:"Equipo",children:(d,P)=>{var s=Yt(),h=g(s);D(h,{label:"Oro",get value(){return t().currentGold},readonly:!0,fullWidth:!0});var k=l(h,2);jt(k,{get equipment(){return t().equipment},get readonly(){return e.readonly},onChange:u=>{t().equipment=u,e.onChange(t())}});var x=l(k,2);{var i=u=>{var m=Kt();f(u,m)};M(x,u=>{t().equipment.length===0&&u(i)})}c(s),f(d,s)},$$slots:{default:!0}}),f(v,w),W()}const Zt=(v,e,t,n)=>{const r={id:crypto.randomUUID(),title:"Nota Nueva",content:""};j(e,[...a(e),r],!0),t.onChange(a(e)),n(r)};var $t=(v,e,t)=>e(a(t)),ea=y('<div class="header svelte-z1ulbz"><button title="Agregar Nota">➕</button> <button title="Eliminar Nota">🗑️</button></div>'),ta=(v,e,t)=>e(a(t)),aa=y('<button><span class="svelte-z1ulbz"> </span></button>'),ra=y('<div class="notes svelte-z1ulbz"></div>'),na=y('<div class="notes empty svelte-z1ulbz"><em>No hay notas</em></div>'),la=y('<div class="note svelte-z1ulbz"><!> <!></div>'),oa=y('<div class="note empty svelte-z1ulbz"><em>No hay ninguna nota seleccionada</em></div>'),sa=y('<div class="notes svelte-z1ulbz"><div class="list svelte-z1ulbz"><!> <!></div> <div class="content svelte-z1ulbz"><!></div></div>');function ia(v,e){L(e,!0);let t=ge(ve(e.notes)),n=ge(void 0),r=G(()=>a(t).find(i=>i.id===a(n)));const o=i=>{j(n,i.id,!0)},C=i=>{i&&(j(t,a(t).filter(u=>u.id!==i),!0),j(n,void 0),e.onChange(a(t)))},A=()=>{j(t,[...a(t)],!0),e.onChange(a(t))};var w=sa(),S=g(w),_=g(S);{var b=i=>{var u=ea(),m=g(u);m.__click=[Zt,t,e,o];var R=l(m,2);R.__click=[$t,C,n],c(u),U(()=>R.disabled=!a(r)),f(i,u)};M(_,i=>{e.readonly||i(b)})}var E=l(_,2);{var d=i=>{var u=ra();le(u,21,()=>a(t),m=>m.id,(m,R)=>{var z=aa();let K;z.__click=[ta,o,R];var Q=g(z),ie=g(Q,!0);c(Q),c(z),U(p=>{K=te(z,1,"note-btn svelte-z1ulbz",null,K,p),J(ie,a(R).title||"Nota sin título")},[()=>({selected:a(n)===a(R).id})]),f(m,z)}),c(u),f(i,u)},P=i=>{var u=na();f(i,u)};M(E,i=>{a(t).length>0?i(d):i(P,!1)})}c(S);var s=l(S,2),h=g(s);{var k=i=>{var u=la(),m=g(u);Fe(m,{get value(){return a(r).title},get readonly(){return e.readonly},placeholder:"Título de la nota",onChange:z=>{a(r).title=z,A()}});var R=l(m,2);Se(R,{get value(){return a(r).content},get readonly(){return e.readonly},placeholder:"Contenido de la nota",onChange:z=>{a(r).content=z,A()},maxRows:"unlimited"}),c(u),f(i,u)},x=i=>{var u=oa();f(i,u)};M(h,i=>{a(r)?i(k):i(x,!1)})}c(s),c(w),f(v,w),W()}Z(["click"]);function da(v,e){L(e,!0);let t=I(e,"character",7);O(v,{title:"Notas",children:(n,r)=>{ia(n,{get notes(){return t().notes},get readonly(){return e.readonly},onChange:o=>{t().notes=o,e.onChange(t())}})},$$slots:{default:!0}}),W()}const ca=(v,e,t,n,r,o)=>{const C={id:crypto.randomUUID(),type:"add",value:e.quantity,reason:e.reason||t};n().ppHistory.unshift(C),r.onChange(n()),o()},va=(v,e,t,n,r,o)=>{const C={id:crypto.randomUUID(),type:"subtract",value:e.quantity,reason:e.reason||t};n().ppHistory.unshift(C),r.onChange(n()),o()};var ua=y('<div class="status svelte-1cdo061"><div class="indicator svelte-1cdo061"><span>PP Actuales</span> <strong> </strong></div> <div class="indicator svelte-1cdo061"><span>PP Gastados</span> <strong class="number svelte-1cdo061"> </strong></div> <div class="indicator svelte-1cdo061"><span>Poder de PJ</span> <strong class="number svelte-1cdo061"> </strong></div></div>'),ga=y('<div class="editor svelte-1cdo061"><div class="labels svelte-1cdo061"><label class="qty svelte-1cdo061">Cantidad</label> <label class="reason svelte-1cdo061">Razón</label> <label class="btn svelte-1cdo061"></label> <label class="btn svelte-1cdo061"></label></div> <div class="controls svelte-1cdo061"><!> <!> <button title="Gastar PP" class="svelte-1cdo061">-</button> <button title="Ganar PP" class="svelte-1cdo061">+</button></div></div>'),ba=(v,e,t)=>e(a(t)),ha=y('<div class="log-content svelte-1cdo061"><strong> </strong> <span class="log-reason svelte-1cdo061"> </span> <button title="Deshacer esta acción">↶</button></div>'),_a=y('<div class="empty svelte-1cdo061"><em>No hay registros</em></div>'),ma=y('<div class="history svelte-1cdo061"></div>'),fa=y("<!> <!> <!>",1);function ya(v,e){L(e,!0);const t="Sin razón especifica";let n=I(e,"character",7),r=ve({quantity:1,reason:""});const o=()=>{r.quantity=1,r.reason=""},C=E=>{n().ppHistory=n().ppHistory.filter(d=>d.id!==E.id),e.onChange(n())};var A=fa(),w=ne(A);O(w,{title:"Estado Actual",children:(E,d)=>{var P=ua(),s=g(P),h=l(g(s),2);let k;var x=g(h,!0);c(h),c(s);var i=l(s,2),u=l(g(i),2),m=g(u,!0);c(u),c(i);var R=l(i,2),z=l(g(R),2),K=g(z,!0);c(z),c(R),c(P),U(Q=>{k=te(h,1,"number svelte-1cdo061",null,k,Q),J(x,n().currentPP),J(m,n().spentPP),J(K,n().pjPower)},[()=>({negative:n().currentPP<0})]),f(E,P)},$$slots:{default:!0}});var S=l(w,2);{var _=E=>{O(E,{title:"Actualizar Progreso",children:(d,P)=>{var s=ga(),h=l(g(s),2),k=g(h);D(k,{get value(){return r.quantity},placeholder:"Cantidad",fullWidth:!1,onChange:m=>{r.quantity=Number(m)}});var x=l(k,2);D(x,{get value(){return r.reason},placeholder:"Razón",fullWidth:!0,onChange:m=>{r.reason=m.toString()}});var i=l(x,2);i.__click=[va,r,t,n,e,o];var u=l(i,2);u.__click=[ca,r,t,n,e,o],c(h),c(s),f(d,s)},$$slots:{default:!0}})};M(S,E=>{e.readonly||E(_)})}var b=l(S,2);O(b,{title:"Historial",children:(E,d)=>{var P=ma();le(P,21,()=>n().ppHistory,s=>s.id,(s,h)=>{var k=ha(),x=g(k);let i;var u=g(x);c(x);var m=l(x,2),R=g(m,!0);c(m);var z=l(m,2);z.__click=[ba,C,h],c(k),U(K=>{i=te(x,1,"log-amount svelte-1cdo061",null,i,K),J(u,`${a(h).type==="add"?"+":"-"}${a(h).value??""} PP`),J(R,a(h).reason)},[()=>({positive:a(h).type==="add",negative:a(h).type==="subtract"})]),f(s,k)},s=>{var h=_a();f(s,h)}),c(P),f(E,P)},$$slots:{default:!0}}),f(v,A),W()}Z(["click"]);var Ca=(v,e,t)=>e()(a(t)),ka=y("<option> </option>"),xa=y('<div class="fieldgroup svelte-1oyc7vz"><select></select></div>');function Ne(v,e){L(e,!0);let t=I(e,"onChange",3,()=>{}),n=G(()=>e.value);var r=xa(),o=g(r);o.__change=[Ca,t,n],le(o,21,()=>e.options,C=>C.label,(C,A)=>{var w=ka(),S=g(w,!0);c(w);var _={};U(()=>{J(S,a(A).label),_!==(_=a(A).value)&&(w.value=(w.__value=a(A).value)??"")}),f(C,w)}),c(o),c(r),tt(o,()=>a(n),C=>j(n,C)),f(v,r),W()}Z(["change"]);const wa=(v,e,t)=>{e([...e(),{id:crypto.randomUUID(),attribute:"maxHP",type:"add",formula:"",reason:""}]),t.onChange(e())};var Pa=(v,e,t)=>e(a(t)),Sa=y('<div class="modifier svelte-1n17zba"><!> <!> <!> <!> <button title="Eliminar" class="svelte-1n17zba">🗑️</button></div>'),Aa=y('<div class="empty svelte-1n17zba"><em>No hay modificadores disponibles</em></div>'),Ea=y('<div class="modifier-list svelte-1n17zba"><div class="header svelte-1n17zba"><label>Modificadores</label> <button title="Agregar Modificador">➕</button></div> <div class="content svelte-1n17zba"><div class="modifiers-header svelte-1n17zba"><label class="type svelte-1n17zba">Tipo</label> <label class="field svelte-1n17zba">Atributo</label> <label class="formula svelte-1n17zba">Formula</label> <label class="label svelte-1n17zba">Razón</label> <label class="btn svelte-1n17zba"></label></div> <!></div></div>');function Ra(v,e){L(e,!0);let t=I(e,"modifiers",7);const n=S=>{t(t().filter(_=>_.id!==S.id)),e.onChange(t())};var r=Ea(),o=g(r),C=l(g(o),2);C.__click=[wa,t,e],c(o);var A=l(o,2),w=l(g(A),2);le(w,17,t,S=>S.id,(S,_,b)=>{var E=Sa(),d=g(E);Ne(d,{options:[{label:"Sumar",value:"add"},{label:"Establecer",value:"set"}],get value(){return a(_).type},onChange:x=>{a(_).type=x.toString(),e.onChange(t())}});var P=l(d,2);Ne(P,{options:[{label:"Salud Máxima",value:"maxHP"},{label:"Suerte Máxima",value:"maxLuck"},{label:"Esquiva",value:"evasion"},{label:"Mitigación Física",value:"physicalMitigation"},{label:"Mitigación Mágica",value:"magicalMitigation"},{label:"Velocidad",value:"speed"}],get value(){return a(_).attribute},onChange:x=>{a(_).attribute=x.toString(),e.onChange(t())}});var s=l(P,2);D(s,{get value(){return a(_).formula},placeholder:"1+cuerpo",fullWidth:!0,onChange:x=>{a(_).formula=x.toString(),e.onChange(t())}});var h=l(s,2);D(h,{get value(){return a(_).reason},placeholder:"Razón",fullWidth:!0,onChange:x=>{a(_).reason=x.toString(),e.onChange(t())}});var k=l(h,2);k.__click=[Pa,n,_],c(E),f(S,E)},S=>{var _=Aa();f(S,_)}),c(A),c(r),f(v,r),W()}Z(["click"]);var pa=y('<div class="general svelte-1hn03u3"><!></div>'),Na=y('<div class="modifiers svelte-1hn03u3"><!> <small class="available-variables svelte-1hn03u3"><em>Varaibles disponibles: cuerpo, reflejos, mente, instinto, presencia.</em></small></div>'),za=y("<!> <!>",1);function Da(v,e){L(e,!0);let t=I(e,"character",7);var n=za(),r=ne(n);O(r,{title:"General",children:(C,A)=>{var w=pa(),S=g(w);{let _=G(()=>t().img??"");D(S,{label:"URL del Retrato",get value(){return a(_)},fullWidth:!0,placeholder:"https://...",textAlign:"left",onChange:b=>{const E=b.toString();E.length>0?t().img=E:t().img=null,e.onChange(t())}})}c(w),f(C,w)},$$slots:{default:!0}});var o=l(r,2);O(o,{title:"Modificadores",children:(C,A)=>{var w=Na(),S=g(w);Ra(S,{get modifiers(){return t().modifiers},onChange:_=>{t().modifiers=_,e.onChange(t())}}),Oe(2),c(w),f(C,w)},$$slots:{default:!0}}),f(v,n),W()}var qa=y("<button> </button>"),Fa=y('<div class="character-sheet svelte-1dl9cdg"><div class="title"><!></div> <div class="tabs svelte-1dl9cdg"></div> <!></div>');function Ta(v,e){L(e,!0);let t=I(e,"character",7);const n=[{name:"general",title:"General",component:Xt,availableWhenReadOnly:!0},{name:"cards",title:"Cartas",component:yt,availableWhenReadOnly:!0},{name:"bio",title:"Bio",component:gt,availableWhenReadOnly:!0},{name:"notes",title:"Notas",component:da,availableWhenReadOnly:!0},{name:"progress",title:"Progreso",component:ya,availableWhenReadOnly:!0},{name:"economy",title:"Economía",component:pt,availableWhenReadOnly:!0},{name:"settings",title:"Configuración",component:Da,availableWhenReadOnly:!1}];let r=G(()=>Math.max(n.findIndex(d=>d.name===e.currentTab),0)),o=G(()=>n.find(d=>d.name===e.currentTab)??n[0]);const C=d=>{const P=d.copy();e.onChange(P),t(P)},A=d=>{j(r,d),e.onTabChange(n[d].name)};var w=Fa(),S=g(w),_=g(S);Fe(_,{get value(){return t().name},get readonly(){return e.readonly},onChange:d=>{t().name=d,C(t())}}),c(S);var b=l(S,2);le(b,23,()=>n,d=>d.title,(d,P,s)=>{var h=Le(),k=ne(h);{var x=i=>{var u=qa();let m;u.__click=()=>A(a(s));var R=g(u,!0);c(u),U(z=>{m=te(u,1,"tab",null,m,z),J(R,a(P).title)},[()=>({selected:a(r)===a(s)})]),f(i,u)};M(k,i=>{(a(P).availableWhenReadOnly||!e.readonly)&&i(x)})}f(d,h)}),c(b);var E=l(b,2);Je(E,()=>a(o).component,(d,P)=>{P(d,{get character(){return t()},get readonly(){return e.readonly},onChange:C})}),c(w),f(v,w),W()}Z(["click"]);const Ia=async(v,e,t)=>{const n=await e()();t(n)},Ma=async(v,e,t)=>{const n=await e()();t(n)},Ua=async(v,e,t)=>{a(e)&&await t()(a(e))},Oa=async(v,e,t,n)=>{!a(e)||!confirm(`¿Quieres eliminar a ${a(e).name}?`)||(await t()(a(e)),j(e,void 0),n(null))},La=async(v,e,t)=>{a(e)&&await t()(a(e))};var Wa=y('<button title="Importar y Editar">📝</button>'),Ha=y('<button title="Crear">➕</button> <button title="Importar">📥</button> <button title="Exportar">📤</button> <button title="Eliminar">🗑️</button>',1),ja=(v,e,t)=>e(a(t)),Ga=y('<img class="character-image svelte-dk16f3"/>'),Ja=y('<span class="image-placeholder svelte-dk16f3"> </span>'),Va=y('<button><!> <span class="name svelte-dk16f3"> </span></button>'),Ba=y('<section class="characters-page svelte-dk16f3"><div class="list svelte-dk16f3"><div class="header svelte-dk16f3"><!></div> <div class="content svelte-dk16f3"></div></div> <div class="viewport svelte-dk16f3"><!></div></section>');function vr(v,e){L(e,!0);const t=()=>je(e.characters,"$characters",n),[n,r]=He(),o="general";let C=I(e,"onAddToMyCharacters",3,()=>{throw new Error("onAddToMyCharacters not implemented")}),A=I(e,"onCreateCharacter",3,async()=>{throw new Error("onCreateCharacter not implemented")}),w=I(e,"onImportCharacter",3,async()=>{throw new Error("onCreateCharacter not implemented")}),S=I(e,"onExportCharacter",3,async()=>{throw new Error("onCreateCharacter not implemented")}),_=I(e,"onDeleteCharacter",3,async()=>{throw new Error("onCreateCharacter not implemented")}),b=G(()=>ae.url.searchParams.get("characterId")),E=G(()=>ae.url.searchParams.get("tab")??o);const d=p=>{p!==null?(ae.url.searchParams.set("characterId",p.id),ae.url.searchParams.set("tab",o)):(ae.url.searchParams.delete("characterId"),ae.url.searchParams.delete("tab")),pe(`?${ae.url.searchParams.toString()}`)},P=p=>{ae.url.searchParams.set("tab",p),pe(`?${ae.url.searchParams.toString()}`)};let s=G(()=>t().find(p=>p.id===a(b)));const h=p=>{e.characters.update(q=>{const V=q.findIndex(Y=>Y.id===p.id);if(V!==-1){const Y=[...q];return Y[V]=p,Y}return q})};var k=Ba(),x=g(k),i=g(x),u=g(i);{var m=p=>{var q=Wa();q.__click=[La,s,C],U(()=>q.disabled=e.allActionsDisabled||!a(s)),f(p,q)},R=p=>{var q=Ha(),V=ne(q);V.__click=[Ia,A,d];var Y=l(V,2);Y.__click=[Ma,w,d];var oe=l(Y,2);oe.__click=[Ua,s,S];var de=l(oe,2);de.__click=[Oa,s,_,d],U(()=>{V.disabled=e.allActionsDisabled,Y.disabled=e.allActionsDisabled,oe.disabled=e.allActionsDisabled||!a(s),de.disabled=e.allActionsDisabled||!a(s)}),f(p,q)};M(u,p=>{e.readonly?p(m):p(R,!1)})}c(i);var z=l(i,2);le(z,5,t,p=>p.id,(p,q)=>{var V=Va();let Y;V.__click=[ja,d,q];var oe=g(V);{var de=F=>{var T=Ga();U(()=>{re(T,"src",a(q).img),re(T,"alt",a(q).name)}),f(F,T)},ye=F=>{var T=Ja(),X=g(T,!0);c(T),U(he=>J(X,he),[()=>a(q).name.charAt(0).toUpperCase()]),f(F,T)};M(oe,F=>{a(q).img?F(de):F(ye,!1)})}var N=l(oe,2),H=g(N,!0);c(N),c(V),U(F=>{Y=te(V,1,"character-item svelte-dk16f3",null,Y,F),re(N,"title",a(q).name),J(H,a(q).name)},[()=>({selected:a(b)===a(q).id})]),f(p,V)}),c(z),c(x);var K=l(x,2),Q=g(K);{var ie=p=>{Ta(p,{get character(){return a(s)},get readonly(){return e.readonly},onChange:h,get currentTab(){return a(E)},onTabChange:P})};M(Q,p=>{a(s)&&p(ie)})}c(K),c(k),f(v,k),W(),r()}Z(["click"]);export{vr as C,cr as u};
