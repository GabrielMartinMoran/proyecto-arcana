import{P as f,u as x}from"./C0WBsAqK.js";import{w as C,g as D}from"./CDyK6DUB.js";const J=i=>new f({id:crypto.randomUUID(),name:"Nuevo Grupo",ownerId:i??"",notes:[],members:{}}),E="arcana:parties",N="arcana:pendingPartyDeletes",I=500,U=1500,a={partiesStore:C([]),partiesAlreadyLoaded:!1,scheduledStoreUpdate:null};let l=null,w=null,g=null,S=null,L=!1;const b={},v=new Map,p=x(),y=(()=>{try{const i=(()=>{try{return localStorage.getItem(N)}catch{return null}})();return i?JSON.parse(i):[]}catch{return[]}})(),O=()=>{try{localStorage.setItem(N,JSON.stringify(y))}catch(i){console.warn("[parties-service] Failed to persist pending deletes",i)}},R=async i=>{if(i&&p.isEnabled())for(const n of[...y])try{await p.deleteParty(n);const d=y.indexOf(n);d!==-1&&(y.splice(d,1),O()),console.info("[parties-service] Processed pending delete for",n)}catch(d){console.warn("[parties-service] Failed to process pending delete for",n,d)}},T=()=>{S||(S=a.partiesStore.subscribe(async i=>{if(!L){try{localStorage.setItem(E,JSON.stringify(i))}catch(n){console.warn("[parties-service] Error saving parties to localStorage:",n)}if(l&&p.isEnabled())try{const n=[],d=Date.now();for(const c of i){if(!c||!c.id)continue;let t="";try{t=JSON.stringify(c.asPlain())}catch{t=JSON.stringify(new f(c).asPlain())}v.get(c.id)!==t&&(n.push({id:c.id,payload:t,party:c}),b[c.id]=d)}for(const c of n)try{l===c.party.ownerId&&(await p.saveParty(c.party),v.set(c.id,c.payload))}catch(t){console.error("[parties-service] Failed saving party",c?.id,t)}}catch(n){console.error("[parties-service] Error persisting parties to cloud:",n)}}}))},_=()=>{if(S){try{S()}catch{}S=null}},F=i=>{const n=D(a.partiesStore);if(!l)return;const d=i.filter(r=>r.isAccessible(l)),c=new Map;for(const r of d)r?.id&&c.set(r.id,r);const t=Date.now(),e=[...n];for(const r of d){const s=r?.id;if(!s||b[s]!==void 0&&t-b[s]<U)continue;const u=e.findIndex(A=>A.id===s),h=new f(r),m=u!==-1?e[u]:null;m&&(h.characters=m.characters,h.unsubscribeCharacterListener=m.unsubscribeCharacterListener);try{v.set(s,JSON.stringify(h.asPlain()))}catch{v.set(s,JSON.stringify(new f(h).asPlain()))}u!==-1?e[u]=h:e.push(h)}for(let r=e.length-1;r>=0;r--){const s=e[r]?.id;if(s&&!c.has(s)&&!(b[s]!==void 0&&t-b[s]<U)){try{e[r].unsubscribeCharacterListener?.()}catch{}e.splice(r,1),v.delete(s),delete b[s]}}for(const r of e){try{r.unsubscribeCharacterListener?.()}catch{}r.unsubscribeCharacterListener=p.listenCharactersByIds(r.getCharactersFullIdentifiers(),s=>{a.partiesStore.update(o=>{const u=o.findIndex(h=>h.id===r.id);return u!==-1&&(o[u].characters=s,o[u]=o[u].copy()),[...o]})})}a.partiesStore.set(e)},q=i=>{if(console.debug("[parties-service] startRemoteListener called for",i),g){try{g()}catch{}g=null}try{g=p.listenToUserParties(i,n=>{try{console.debug("[parties-service] remote snapshot received for user",i,"count=",n?.length)}catch{}a.scheduledStoreUpdate&&clearTimeout(a.scheduledStoreUpdate),a.scheduledStoreUpdate=setTimeout(()=>{a.scheduledStoreUpdate=null,L=!0;try{F(n)}finally{L=!1,console.debug("[parties-service] applied remote snapshot for user",i)}},I)})}catch(n){console.error("[parties-service] listenToUserParties setup failed for",i,n)}},P=()=>{if(g){try{for(const i of D(a.partiesStore))i.unsubscribeCharacterListener();g()}catch{}g=null}},M=()=>{const i=async()=>{if(!a.partiesAlreadyLoaded){try{await p.initFirebase()}catch(t){console.warn("[parties-service] Firebase init error (continuing with local persistence):",t)}try{w=await p.onAuthState(async t=>{const e=l;if(l=t?t.uid:null,e&&e!==l&&P(),l&&p.isEnabled())try{q(l),R(l).catch(r=>{console.warn("[parties-service] processPendingDeletes failed:",r)})}catch(r){console.error("[parties-service] Error starting remote listener:",r)}else{P();const r=(()=>{try{return localStorage.getItem(E)}catch{return null}})();if(r)try{const s=JSON.parse(r);a.partiesStore.set(s.map(o=>new f(o)))}catch(s){console.error("[parties-service] Error parsing parties JSON:",s)}else a.partiesStore.set([])}})}catch(t){console.warn("[parties-service] Auth listener setup error (continuing with local persistence):",t);const e=(()=>{try{return localStorage.getItem(E)}catch{return null}})();if(e)try{const r=JSON.parse(e);a.partiesStore.set(r.map(s=>new f(s)))}catch(r){console.error("[parties-service] Error parsing parties JSON:",r)}}T(),a.partiesAlreadyLoaded=!0}},n=async t=>{const e=J(l??void 0);return t&&(e.name=t),l&&(e.ownerId=l),console.debug("[parties-service] creating party locally",{id:e.id,ownerId:e.ownerId,name:e.name}),a.partiesStore.update(r=>{const s=[...r,new f(e)];try{console.debug("[parties-service] local parties count after create",s.length)}catch{}return s}),new f(e)},d=async t=>{if(!t||!t.id)throw new Error("party.id required");console.debug("[parties-service] saveParty called for",t.id),a.partiesStore.update(e=>{const r=e.findIndex(u=>u.id===t.id),s=new f(t);let o;r===-1?o=[...e,s]:(o=[...e],o[r]=s);try{console.debug("[parties-service] local parties count after save",o.length,"partyId=",t.id)}catch{}return o})},c=async t=>{console.debug("[parties-service] deleteParty called for",t),a.partiesStore.update(e=>{const r=e.find(o=>o.id===t);r&&r.unsubscribeCharacterListener();const s=e.filter(o=>o.id!==t);try{console.debug("[parties-service] local parties count after delete",s.length)}catch{}return s});try{y.includes(t)||(y.push(t),O(),console.debug("[parties-service] queued pending delete for",t))}catch(e){console.warn("[parties-service] Failed to queue pending delete:",e)}if(l&&p.isEnabled())try{console.debug("[parties-service] attempting immediate cloud delete for",t),await p.deleteParty(t);const e=y.indexOf(t);e!==-1&&(y.splice(e,1),O()),console.debug("[parties-service] immediate cloud delete successful for",t)}catch(e){console.warn("[parties-service] Immediate cloud delete failed, queued for retry:",t,e)}};return{loadParties:i,parties:a.partiesStore,createParty:n,saveParty:d,deleteParty:c,cleanup:()=>{if(w){try{w()}catch{}w=null}P(),_()}}};export{M as u};
