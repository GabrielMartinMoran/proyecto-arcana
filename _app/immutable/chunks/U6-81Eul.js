import{r as ye}from"./BfoKIOzI.js";import{C as B,u as _e}from"./F630LRhk.js";import{w as ee,g as ge}from"./y52P6WVk.js";import"./DsnmJJEf.js";import{p as Ce,b as D,a as A,d as be,g as x,e as b,r as _,j as n,ab as Y,t as T,f as we,K as Ee}from"./t0Cq7XZL.js";import{d as Se,s as re}from"./D_zjkKVN.js";import{i as z,s as Ae,a as xe}from"./CuTJ2zLb.js";import{e as De,s as Q}from"./BDY9aIh_.js";import{s as Te}from"./BmU-s7xp.js";import{p as k}from"./Pn6U6YSw.js";import{g as te}from"./B_eVflCM.js";import{p}from"./BdC4WmnE.js";import{C as ke}from"./DkiBSRWY.js";import{C as ae}from"./BLLLuF8N.js";const W="arcana:characters",se="arcana:pendingCharacterDeletes",Le=500,Pe=1500,d={charactersStore:ee([]),exampleCharactersStore:ee([]),charactersAlreadyLoaded:!1,exampleCharactersAlreadyLoaded:!1};let f=null,J=null,w=null,P=null,O=!1,M=null;const G={},L=new Map,m=_e(),g=(()=>{try{const s=(()=>{try{return localStorage.getItem(se)}catch{return null}})();return s?JSON.parse(s):[]}catch{return[]}})(),X=()=>{try{localStorage.setItem(se,JSON.stringify(g))}catch(s){console.warn("[characters-service] Failed to persist pending deletes",s)}},Oe=async s=>{if(s&&m.isEnabled())for(const e of[...g])try{await m.deleteCharacterForUser(s,e);const t=g.indexOf(e);t!==-1&&(g.splice(t,1),X()),console.info("[characters-service] Successfully processed pending delete for",e)}catch(t){console.warn("[characters-service] Failed to process pending delete for",e,t)}},Ue=()=>{P||(P=d.charactersStore.subscribe(async s=>{if(O)return;try{const t=Date.now();for(const r of s){if(!r||!r.id)continue;const c=JSON.stringify(r);L.get(r.id)!==c&&(G[r.id]=t,L.set(r.id,c))}const a=new Set(s.map(r=>r.id));for(const r of Array.from(L.keys()))a.has(r)||(L.delete(r),delete G[r])}catch{}const e=JSON.stringify(s);try{localStorage.setItem(W,e)}catch(t){console.warn("Error saving characters to localStorage:",t)}try{f&&m.isEnabled()&&(M&&clearTimeout(M),M=setTimeout(async()=>{O=!0,M=null,await m.saveCharactersForUser(f,s),O=!1},Le))}catch(t){console.error("Error persisting characters to cloud:",t)}}))},Ie=()=>{if(P){try{P()}catch{}P=null}},Fe=s=>{if(w){try{w()}catch{}w=null}w=m.listenCharactersForUser(s,e=>{O=!0;try{const t=ge(d.charactersStore),a=Date.now(),r=e.map(c=>{const l=c?.id;if(l&&G[l]!==void 0&&a-G[l]<Pe){const I=t.find(F=>F?.id===l);if(I)return I}const U=new B(c);return l&&L.set(l,JSON.stringify(U)),U});d.charactersStore.set(r)}finally{O=!1}})},V=()=>{if(w){try{w()}catch{}w=null}},ir=()=>{const s=async()=>{if(!d.charactersAlreadyLoaded){try{await m.initFirebase()}catch(a){console.warn("Firebase init error (continuing with local persistence):",a)}try{J=await m.onAuthState(async a=>{const r=f;if(f=a?a.uid:null,r&&r!==f&&V(),f&&m.isEnabled())try{Fe(f),Oe(f).catch(c=>{console.warn("[characters-service] processPendingDeletes failed:",c)})}catch(c){console.error("[characters-service] Error starting remote listener:",c)}else{V();const c=localStorage.getItem(W);if(c)try{const l=JSON.parse(c);d.charactersStore.set(l.map(E=>new B(E)))}catch(l){console.error("Error parsing characters JSON:",l)}else d.charactersStore.set([])}})}catch(a){console.warn("Auth listener setup error (continuing with local persistence):",a);const r=localStorage.getItem(W);if(r)try{const c=JSON.parse(r);d.charactersStore.set(c.map(l=>new B(l)))}catch(c){console.error("Error parsing characters JSON:",c)}}Ue(),d.charactersAlreadyLoaded=!0}},e=async()=>{if(d.exampleCharactersAlreadyLoaded)return;let a=[];try{a=await(await fetch(ye("/docs/example-characters.json"))).json()}catch(r){console.error("Error fetching example characters:",r)}try{d.exampleCharactersStore.set(a.map(r=>new B(r)))}catch(r){console.error("Error parsing example characters JSON:",r)}d.exampleCharactersAlreadyLoaded=!0},t=async a=>{d.charactersStore.update(r=>r.filter(c=>c.id!==a));try{g.includes(a)||(g.push(a),X())}catch(r){console.warn("[characters-service] Failed to queue pending delete:",r)}if(f&&m.isEnabled())try{await m.deleteCharacterForUser(f,a);const r=g.indexOf(a);r!==-1&&(g.splice(r,1),X())}catch(r){console.warn("[characters-service] Immediate cloud delete failed, queued for retry:",r);try{const c=await new Promise(l=>{d.charactersStore.subscribe(E=>l(E))()});await m.saveCharactersForUser(f,c)}catch(c){console.error("[characters-service] Error syncing characters after failed delete:",c)}}};return{loadCharacters:s,loadExampleCharacters:e,characters:d.charactersStore,exampleCharacters:d.exampleCharactersStore,deleteCharacter:t,cleanup:()=>{if(J){try{J()}catch{}J=null}V(),Ie()}}},Ne=async(s,e,t)=>{const a=await e()();t(a)},Re=async(s,e,t)=>{const a=await e()();t(a)},Je=async(s,e,t)=>{n(e)&&await t()(n(e))},Me=async(s,e,t,a)=>{!n(e)||!confirm(`Â¿Quieres eliminar a ${n(e).name}?`)||(await t()(n(e)),Ee(e,void 0),a(null))},Be=async(s,e,t)=>{n(e)&&await t()(n(e))};var Ge=D('<button title="Importar y Editar">ğŸ“</button>'),He=D('<button title="Crear">â•</button> <button title="Importar">ğŸ“¥</button> <button title="Exportar">ğŸ“¤</button> <button title="Eliminar">ğŸ—‘ï¸</button>',1),je=(s,e,t)=>e(n(t)),Ke=D('<img class="character-image svelte-dk16f3"/>'),qe=D('<span class="image-placeholder svelte-dk16f3"> </span>'),Ye=D('<button><!> <span class="name svelte-dk16f3"> </span></button>'),ze=D('<section class="characters-page svelte-dk16f3"><div class="list svelte-dk16f3"><div class="header svelte-dk16f3"><!></div> <div class="content svelte-dk16f3"></div></div> <div class="viewport svelte-dk16f3"><!></div></section>');function lr(s,e){Ce(e,!0);const t=()=>xe(e.characters,"$characters",a),[a,r]=Ae();let c=k(e,"onAddToMyCharacters",3,()=>{throw new Error("onAddToMyCharacters not implemented")}),l=k(e,"onCreateCharacter",3,async()=>{throw new Error("onCreateCharacter not implemented")}),E=k(e,"onImportCharacter",3,async()=>{throw new Error("onCreateCharacter not implemented")}),U=k(e,"onExportCharacter",3,async()=>{throw new Error("onCreateCharacter not implemented")}),I=k(e,"onDeleteCharacter",3,async()=>{throw new Error("onCreateCharacter not implemented")}),F=Y(()=>p.url.searchParams.get("characterId")),ce=Y(()=>p.url.searchParams.get("tab")??ae.DEFAULT_CHARACTER_SHEET_TAB);const N=o=>{o!==null?(p.url.searchParams.set("characterId",o.id),p.url.searchParams.set("tab",ae.DEFAULT_CHARACTER_SHEET_TAB)):(p.url.searchParams.delete("characterId"),p.url.searchParams.delete("tab")),te(`?${p.url.searchParams.toString()}`)},oe=o=>{p.url.searchParams.set("tab",o),te(`?${p.url.searchParams.toString()}`)};let v=Y(()=>t().find(o=>o.id===n(F)));const ne=o=>{e.characters.update(i=>{const h=i.findIndex(u=>u.id===o.id);if(h!==-1){const u=[...i];return u[h]=o,u}return i})};var H=ze(),j=b(H),K=b(j),ie=b(K);{var le=o=>{var i=Ge();i.__click=[Be,v,c],T(()=>i.disabled=e.allActionsDisabled||!n(v)),A(o,i)},de=o=>{var i=He(),h=we(i);h.__click=[Ne,l,N];var u=x(h,2);u.__click=[Re,E,N];var S=x(u,2);S.__click=[Je,v,U];var R=x(S,2);R.__click=[Me,v,I,N],T(()=>{h.disabled=e.allActionsDisabled,u.disabled=e.allActionsDisabled,S.disabled=e.allActionsDisabled||!n(v),R.disabled=e.allActionsDisabled||!n(v)}),A(o,i)};z(ie,o=>{e.readonly?o(le):o(de,!1)})}_(K);var Z=x(K,2);De(Z,5,t,o=>o.id,(o,i)=>{var h=Ye();let u;h.__click=[je,N,i];var S=b(h);{var R=y=>{var C=Ke();T(()=>{Q(C,"src",n(i).img),Q(C,"alt",n(i).name)}),A(y,C)},fe=y=>{var C=qe(),pe=b(C,!0);_(C),T(ve=>re(pe,ve),[()=>n(i).name.charAt(0).toUpperCase()]),A(y,C)};z(S,y=>{n(i).img?y(R):y(fe,!1)})}var q=x(S,2),me=b(q,!0);_(q),_(h),T(y=>{u=Te(h,1,"character-item svelte-dk16f3",null,u,y),Q(q,"title",n(i).name),re(me,n(i).name)},[()=>({selected:n(F)===n(i).id})]),A(o,h)}),_(Z),_(j);var $=x(j,2),he=b($);{var ue=o=>{ke(o,{get character(){return n(v)},get readonly(){return e.readonly},onChange:ne,get currentTab(){return n(ce)},onTabChange:oe})};z(he,o=>{n(v)&&o(ue)})}_($),_(H),A(s,H),be(),r()}Se(["click"]);export{lr as C,ir as u};
