import{P as f,u as U}from"./8iG_Nq0v.js";import{w as L,g as w}from"./DQyq_pEW.js";const O=t=>new f({id:crypto.randomUUID(),name:"Nuevo Grupo",ownerId:t??"",notes:[],members:{}}),S="arcana:parties",P="arcana:pendingPartyDeletes",N=500,a={partiesStore:L([]),partiesAlreadyLoaded:!1,scheduledStoreUpdate:null};let l=null,y=null,h=null,g=null,v=!1;const u=U(),p=(()=>{try{const t=(()=>{try{return localStorage.getItem(P)}catch{return null}})();return t?JSON.parse(t):[]}catch{return[]}})(),m=()=>{try{localStorage.setItem(P,JSON.stringify(p))}catch(t){console.warn("[parties-service] Failed to persist pending deletes",t)}},D=async t=>{if(t&&u.isEnabled())for(const c of[...p])try{await u.deleteParty(c);const s=p.indexOf(c);s!==-1&&(p.splice(s,1),m()),console.info("[parties-service] Processed pending delete for",c)}catch(s){console.warn("[parties-service] Failed to process pending delete for",c,s)}},x=()=>{if(g)return;const t={};g=a.partiesStore.subscribe(async c=>{if(!v){try{localStorage.setItem(S,JSON.stringify(c))}catch(s){console.warn("[parties-service] Error saving parties to localStorage:",s)}if(l&&u.isEnabled())try{const s=[];for(const o of c){if(!o||!o.id)continue;let e="";try{e=JSON.stringify(o.asPlain())}catch{e=JSON.stringify(new f(o).asPlain())}t[o.id]!==e&&s.push({id:o.id,payload:e,party:o})}for(const o of s)try{l===o.party.ownerId&&(await u.saveParty(o.party),t[o.id]=o.payload)}catch(e){console.error("[parties-service] Failed saving party",o?.id,e)}}catch(s){console.error("[parties-service] Error persisting parties to cloud:",s)}}})},A=()=>{if(g){try{g()}catch{}g=null}},J=t=>{for(const s of w(a.partiesStore))s.unsubscribeCharacterListener(),s.unsubscribeCharacterListener=()=>{};if(!l)return;const c=t.filter(s=>s.isAccessible(l));for(const s of c)s.unsubscribeCharacterListener=u.listenCharactersByIds(s.getCharactersFullIdentifiers(),o=>{console.log("[parties-service] detected character change for party",s.id),a.partiesStore.update(e=>{const r=e.findIndex(i=>i.id===s.id);return r!==-1&&(e[r].characters=o,e[r]=e[r].copy()),[...e]})});a.partiesStore.set(c)},C=t=>{if(console.debug("[parties-service] startRemoteListener called for",t),h){try{h()}catch{}h=null}try{h=u.listenToUserParties(t,c=>{try{console.debug("[parties-service] remote snapshot received for user",t,"count=",c?.length)}catch{}a.scheduledStoreUpdate&&clearTimeout(a.scheduledStoreUpdate),a.scheduledStoreUpdate=setTimeout(()=>{a.scheduledStoreUpdate=null,v=!0;try{J(c)}finally{v=!1,console.debug("[parties-service] applied remote snapshot for user",t)}},N)})}catch(c){console.error("[parties-service] listenToUserParties setup failed for",t,c)}},b=()=>{if(h){try{for(const t of w(a.partiesStore))t.unsubscribeCharacterListener();h()}catch{}h=null}},_=()=>{const t=async()=>{if(!a.partiesAlreadyLoaded){try{await u.initFirebase()}catch(e){console.warn("[parties-service] Firebase init error (continuing with local persistence):",e)}try{y=await u.onAuthState(async e=>{const r=l;if(l=e?e.uid:null,r&&r!==l&&b(),l&&u.isEnabled())try{C(l),D(l).catch(i=>{console.warn("[parties-service] processPendingDeletes failed:",i)})}catch(i){console.error("[parties-service] Error starting remote listener:",i)}else{b();const i=(()=>{try{return localStorage.getItem(S)}catch{return null}})();if(i)try{const n=JSON.parse(i);a.partiesStore.set(n.map(d=>new f(d)))}catch(n){console.error("[parties-service] Error parsing parties JSON:",n)}else a.partiesStore.set([])}})}catch(e){console.warn("[parties-service] Auth listener setup error (continuing with local persistence):",e);const r=(()=>{try{return localStorage.getItem(S)}catch{return null}})();if(r)try{const i=JSON.parse(r);a.partiesStore.set(i.map(n=>new f(n)))}catch(i){console.error("[parties-service] Error parsing parties JSON:",i)}}x(),a.partiesAlreadyLoaded=!0}},c=async e=>{const r=O(l??void 0);return e&&(r.name=e),l&&(r.ownerId=l),console.debug("[parties-service] creating party locally",{id:r.id,ownerId:r.ownerId,name:r.name}),a.partiesStore.update(i=>{const n=[...i,new f(r)];try{console.debug("[parties-service] local parties count after create",n.length)}catch{}return n}),new f(r)},s=async e=>{if(!e||!e.id)throw new Error("party.id required");console.debug("[parties-service] saveParty called for",e.id),a.partiesStore.update(r=>{const i=r.findIndex(E=>E.id===e.id),n=new f(e);let d;i===-1?d=[...r,n]:(d=[...r],d[i]=n);try{console.debug("[parties-service] local parties count after save",d.length,"partyId=",e.id)}catch{}return d})},o=async e=>{console.debug("[parties-service] deleteParty called for",e),a.partiesStore.update(r=>{const i=r.find(d=>d.id===e);i&&i.unsubscribeCharacterListener();const n=r.filter(d=>d.id!==e);try{console.debug("[parties-service] local parties count after delete",n.length)}catch{}return n});try{p.includes(e)||(p.push(e),m(),console.debug("[parties-service] queued pending delete for",e))}catch(r){console.warn("[parties-service] Failed to queue pending delete:",r)}if(l&&u.isEnabled())try{console.debug("[parties-service] attempting immediate cloud delete for",e),await u.deleteParty(e);const r=p.indexOf(e);r!==-1&&(p.splice(r,1),m()),console.debug("[parties-service] immediate cloud delete successful for",e)}catch(r){console.warn("[parties-service] Immediate cloud delete failed, queued for retry:",e,r)}};return{loadParties:t,parties:a.partiesStore,createParty:c,saveParty:s,deleteParty:o,cleanup:()=>{if(y){try{y()}catch{}y=null}b(),A()}}};export{_ as u};
