import{r as D}from"./D6W2gXA4.js";import{C as g,u as N}from"./F630LRhk.js";import{w as L,g as U}from"./y52P6WVk.js";const C="arcana:characters",O="arcana:pendingCharacterDeletes",F=500,J=1500,c={charactersStore:L([]),exampleCharactersStore:L([]),charactersAlreadyLoaded:!1,exampleCharactersAlreadyLoaded:!1};let n=null,S=null,h=null,f=null,p=!1,m=null;const w={},u=new Map,i=N(),d=(()=>{try{const a=(()=>{try{return localStorage.getItem(O)}catch{return null}})();return a?JSON.parse(a):[]}catch{return[]}})(),b=()=>{try{localStorage.setItem(O,JSON.stringify(d))}catch(a){console.warn("[characters-service] Failed to persist pending deletes",a)}},_=async a=>{if(a&&i.isEnabled())for(const l of[...d])try{await i.deleteCharacterForUser(a,l);const o=d.indexOf(l);o!==-1&&(d.splice(o,1),b()),console.info("[characters-service] Successfully processed pending delete for",l)}catch(o){console.warn("[characters-service] Failed to process pending delete for",l,o)}},P=()=>{f||(f=c.charactersStore.subscribe(async a=>{if(p)return;try{const o=Date.now();for(const e of a){if(!e||!e.id)continue;const r=JSON.stringify(e);u.get(e.id)!==r&&(w[e.id]=o,u.set(e.id,r))}const t=new Set(a.map(e=>e.id));for(const e of Array.from(u.keys()))t.has(e)||(u.delete(e),delete w[e])}catch{}const l=JSON.stringify(a);try{localStorage.setItem(C,l)}catch(o){console.warn("Error saving characters to localStorage:",o)}try{n&&i.isEnabled()&&(m&&clearTimeout(m),m=setTimeout(async()=>{p=!0,m=null,await i.saveCharactersForUser(n,a),p=!1},F))}catch(o){console.error("Error persisting characters to cloud:",o)}}))},R=()=>{if(f){try{f()}catch{}f=null}},T=a=>{if(h){try{h()}catch{}h=null}h=i.listenCharactersForUser(a,l=>{p=!0;try{const o=U(c.charactersStore),t=Date.now(),e=l.map(r=>{const s=r?.id;if(s&&w[s]!==void 0&&t-w[s]<J){const x=o.find(A=>A?.id===s);if(x)return x}const v=new g(r);return s&&u.set(s,JSON.stringify(v)),v});c.charactersStore.set(e)}finally{p=!1}})},E=()=>{if(h){try{h()}catch{}h=null}},j=()=>{const a=async()=>{if(!c.charactersAlreadyLoaded){try{await i.initFirebase()}catch(t){console.warn("Firebase init error (continuing with local persistence):",t)}try{S=await i.onAuthState(async t=>{const e=n;if(n=t?t.uid:null,e&&e!==n&&E(),n&&i.isEnabled())try{T(n),_(n).catch(r=>{console.warn("[characters-service] processPendingDeletes failed:",r)})}catch(r){console.error("[characters-service] Error starting remote listener:",r)}else{E();const r=localStorage.getItem(C);if(r)try{const s=JSON.parse(r);c.charactersStore.set(s.map(y=>new g(y)))}catch(s){console.error("Error parsing characters JSON:",s)}else c.charactersStore.set([])}})}catch(t){console.warn("Auth listener setup error (continuing with local persistence):",t);const e=localStorage.getItem(C);if(e)try{const r=JSON.parse(e);c.charactersStore.set(r.map(s=>new g(s)))}catch(r){console.error("Error parsing characters JSON:",r)}}P(),c.charactersAlreadyLoaded=!0}},l=async()=>{if(c.exampleCharactersAlreadyLoaded)return;let t=[];try{t=await(await fetch(D("/docs/example-characters.json"))).json()}catch(e){console.error("Error fetching example characters:",e)}try{c.exampleCharactersStore.set(t.map(e=>new g(e)))}catch(e){console.error("Error parsing example characters JSON:",e)}c.exampleCharactersAlreadyLoaded=!0},o=async t=>{c.charactersStore.update(e=>e.filter(r=>r.id!==t));try{d.includes(t)||(d.push(t),b())}catch(e){console.warn("[characters-service] Failed to queue pending delete:",e)}if(n&&i.isEnabled())try{await i.deleteCharacterForUser(n,t);const e=d.indexOf(t);e!==-1&&(d.splice(e,1),b())}catch(e){console.warn("[characters-service] Immediate cloud delete failed, queued for retry:",e);try{const r=await new Promise(s=>{c.charactersStore.subscribe(y=>s(y))()});await i.saveCharactersForUser(n,r)}catch(r){console.error("[characters-service] Error syncing characters after failed delete:",r)}}};return{loadCharacters:a,loadExampleCharacters:l,characters:c.charactersStore,exampleCharacters:c.exampleCharactersStore,deleteCharacter:o,cleanup:()=>{if(S){try{S()}catch{}S=null}E(),R()}}};export{j as u};
