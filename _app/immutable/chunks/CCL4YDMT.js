const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./DRCQTmuD.js","./grAHckH9.js","./fw75x0r7.js","./DyWkVpd5.js"])))=>i.map(i=>d[i]);
import{_ as I}from"./PPVm8Dsz.js";import{C as F}from"./erSfHhUs.js";import{w as O,g as j}from"./Cop9rsZ2.js";const V=t=>({...t,timestamp:new Date(t.timestamp)}),W=t=>({...t,timestamp:t.timestamp.toISOString()}),Y=(t,e)=>{if(!t)return 0;const o=t.trim();try{const r=new Function("cuerpo","reflejos","mente","instinto","presencia","Math",`return (${o});`);return Number(r(Number(e.cuerpo)||0,Number(e.reflejos)||0,Number(e.mente)||0,Number(e.instinto)||0,Number(e.presencia)||0,Math))||0}catch(r){return console.error("Error evaluating modifier expression:",r),0}},X=(t,e)=>Y(t,{cuerpo:e.attributes.body,reflejos:e.attributes.reflexes,mente:e.attributes.mind,instinto:e.attributes.instinct,presencia:e.attributes.presence,Math});class M{id;name;attributes;cards;ppHistory;goldHistory;equipment;modifiers;currentHP;tempHP;currentLuck;img;story;notes;languages;quickInfo;attacks;maxActiveCards;version;constructor(e){this.id=e.id,this.name=e.name,this.attributes=e.attributes,this.cards=e.cards,this.ppHistory=e.ppHistory,this.goldHistory=e.goldHistory,this.equipment=e.equipment,this.modifiers=e.modifiers,this.currentHP=e.currentHP,this.tempHP=e.tempHP,this.currentLuck=e.currentLuck,this.img=e.img,this.story=e.story,this.notes=e.notes,this.languages=e.languages,this.quickInfo=e.quickInfo,this.attacks=e.attacks,this.maxActiveCards=e.maxActiveCards,this.version=e.version}calculateAttrModifiers(e,o){let r=o;const n=this.modifiers.filter(l=>l.attribute===e);for(const l of n){const a=X(l.formula,this);if(l.type==="set")return a;l.type==="add"&&(r+=a)}return r}get maxLuck(){const e=F.MAX_LUCK;return this.calculateAttrModifiers("maxLuck",e)}get maxHP(){const e=F.BASE_HEALTH+this.attributes.body*F.HEALTH_BODY_MULTIPIER;return this.calculateAttrModifiers("maxHP",e)}get speed(){const e=F.BASE_SPEED+this.attributes.reflexes;return this.calculateAttrModifiers("speed",e)}get evasion(){const e=F.BASE_EVASION+this.attributes.reflexes;return this.calculateAttrModifiers("evasion",e)}get physicalMitigation(){return this.calculateAttrModifiers("physicalMitigation",0)}get magicalMitigation(){return this.calculateAttrModifiers("magicalMitigation",0)}get currentGold(){const e=this.goldHistory.filter(r=>r.type==="add").reduce((r,n)=>r+n.value,0),o=this.spentGold;return o>0?e-o:e}get spentGold(){return this.goldHistory.filter(e=>e.type==="subtract").reduce((e,o)=>e+o.value,0)}get currentPP(){const e=this.ppHistory.filter(r=>r.type==="add").reduce((r,n)=>r+n.value,0),o=this.spentPP;return o>0?e-o:e}get spentPP(){return this.ppHistory.filter(e=>e.type==="subtract").reduce((e,o)=>e+o.value,0)}get pjPower(){const e=this.cards.reduce((r,n)=>Math.max(r,n.level),0),o=this.spentPP/F.PJ_POWER_SPENT_PP_DIVIDER;return Math.round(e+o)}get numActiveCards(){return this.cards.filter(e=>e.isActive).length}get initiative(){return this.attributes.reflexes}copy(){return new M({...this})}}const Z={VITE_FIREBASE_API_KEY:"AIzaSyAFv5lor5ufY-KPBQ166rPSRnscFrtm88w",VITE_FIREBASE_APP_ID:"1:647852941329:web:f2aa1e9dd6792f6a9d91b0",VITE_FIREBASE_AUTH_DOMAIN:"arcana-85eeb.firebaseapp.com",VITE_FIREBASE_MESSAGING_SENDER_ID:"647852941329",VITE_FIREBASE_PROJECT_ID:"arcana-85eeb",VITE_FIREBASE_STORAGE_BUCKET:"arcana-85eeb.firebasestorage.app"};function D(){return typeof window<"u"}const z=(()=>{const t=typeof import.meta<"u"&&"env"in import.meta?"production":void 0;return t===void 0?!0:t==="development"})();function Q(){const t=typeof import.meta<"u"&&"env"in import.meta?Z:{},e=t.VITE_FIREBASE_API_KEY,o=t.VITE_FIREBASE_AUTH_DOMAIN,r=t.VITE_FIREBASE_PROJECT_ID,n=t.VITE_FIREBASE_STORAGE_BUCKET,l=t.VITE_FIREBASE_MESSAGING_SENDER_ID,a=t.VITE_FIREBASE_APP_ID;return!e||!r||!a?null:{apiKey:e,authDomain:o,projectId:r,storageBucket:n,messagingSenderId:l,appId:a}}function ee(){let t=!1,e=null,o=!1,r=null,n=null;const l=O(!1),a=O(null);async function g(){if(t)return;if(t=!0,!D()){console.info("[firebase-service] Not initializing: not running in browser"),o=!1,l.set(!1);return}if(z){console.info("[firebase-service] Not initializing Firebase in development mode"),o=!1,l.set(!1);return}const m=Q();if(!m){console.warn("[firebase-service] Firebase config missing. Set VITE_FIREBASE_* env vars to enable cloud persistence."),o=!1,l.set(!1);return}try{const{initializeApp:d,getApps:b}=await I(async()=>{const{initializeApp:f,getApps:p}=await import("./DRCQTmuD.js");return{initializeApp:f,getApps:p}},__vite__mapDeps([0,1]),import.meta.url),c=await I(()=>import("./fw75x0r7.js"),__vite__mapDeps([2,1]),import.meta.url),i=await I(()=>import("./DyWkVpd5.js"),__vite__mapDeps([3,1]),import.meta.url);if(b&&b().length===0&&d(m),r=c.getAuth(),n=i.getFirestore(),!r||!n){console.warn("[firebase-service] Auth or Firestore not available after initialization."),o=!1,l.set(!1);return}o=!0,l.set(!0),console.info("[firebase-service] Firebase initialized and available.")}catch(d){console.error("[firebase-service] Error initializing firebase:",d),o=!1,l.set(!1)}}async function s(){if(e)return e;e=g(),await e,e=null}function h(){return!z&&o}async function R(m){if(!D())return console.info("[firebase-service] onAuthState called but not in browser."),m(null),()=>{};if(await s(),!h())return m(null),()=>{};const{onAuthStateChanged:d}=await I(async()=>{const{onAuthStateChanged:c}=await import("./fw75x0r7.js");return{onAuthStateChanged:c}},__vite__mapDeps([2,1]),import.meta.url),b=d(r,c=>{const i=c?{uid:c.uid,displayName:c.displayName,email:c.email,photoURL:c.photoURL}:null;if(a.set(i),i)try{const f="arcana:characters",p=(()=>{try{return localStorage.getItem(f)}catch{return null}})();p&&(async()=>{try{const u=JSON.parse(p);if(Array.isArray(u)&&u.length>0){await y(i.uid,u.map(v=>new M(v)));try{localStorage.removeItem(f),console.info("[firebase-service] Resynced local characters to Firestore after sign-in and cleared local fallback.")}catch(v){console.warn("[firebase-service] Resynced after sign-in but failed to remove local fallback:",v)}}}catch(u){console.warn("[firebase-service] Failed to resync local fallback after sign-in:",u)}})()}catch(f){console.warn("[firebase-service] Error scheduling resync after sign-in (ignored):",f)}m(i)});return()=>{try{b&&b()}catch{}}}async function A(){if(!D())return null;if(await s(),!h())return console.info("[firebase-service] signInWithGoogle called but firebase is not enabled"),null;const{GoogleAuthProvider:m,signInWithPopup:d}=await I(async()=>{const{GoogleAuthProvider:f,signInWithPopup:p}=await import("./fw75x0r7.js");return{GoogleAuthProvider:f,signInWithPopup:p}},__vite__mapDeps([2,1]),import.meta.url),b=new m;b.setCustomParameters({prompt:"select_account"});const i=(await d(r,b)).user;if(!i)return null;try{const f="arcana:characters",p=(()=>{try{return localStorage.getItem(f)}catch{return null}})();p&&(async()=>{try{const u=JSON.parse(p);if(Array.isArray(u)&&u.length>0){await y(i.uid,u.map(v=>new M(v)));try{localStorage.removeItem(f),console.info("[firebase-service] Resynced local characters to Firestore after sign-in and cleared local fallback.")}catch(v){console.warn("[firebase-service] Resynced after sign-in but failed to remove local fallback:",v)}}}catch(u){console.warn("[firebase-service] Failed to resync local fallback after sign-in:",u)}})()}catch(f){console.warn("[firebase-service] Error scheduling resync after sign-in (ignored):",f)}return{uid:i.uid,displayName:i.displayName,email:i.email,photoURL:i.photoURL}}async function _(){if(!D())return;if(await s(),!h()){console.info("[firebase-service] signOutUser called but firebase is not enabled");return}const{signOut:m}=await I(async()=>{const{signOut:d}=await import("./fw75x0r7.js");return{signOut:d}},__vite__mapDeps([2,1]),import.meta.url);await m(r)}function w(){if(!D())throw new Error("Not in browser");if(!h())throw new Error("Firebase not enabled");if(!n)throw new Error("Firestore not initialized")}async function y(m,d){if(!m)throw new Error("userId required");if(!D())return;if(await s(),!h()){console.info("[firebase-service] saveCharactersForUser: firebase not enabled; skipping");return}w();const{doc:b,setDoc:c}=await I(async()=>{const{doc:i,setDoc:f}=await import("./DyWkVpd5.js");return{doc:i,setDoc:f}},__vite__mapDeps([3,1]),import.meta.url);try{const i=d.map(f=>{const p=JSON.parse(JSON.stringify(f||{})),u=b(n,"users",m,"characters",p.id);return c(u,p,{merge:!0})});await Promise.all(i)}catch(i){throw console.error("[firebase-service] saveCharactersForUser error:",i),i}}async function S(m,d){if(!m)throw new Error("userId required");if(!d)throw new Error("characterId required");if(!D())return;if(await s(),!h()){console.info("[firebase-service] deleteCharacterForUser: firebase not enabled; skipping");return}w();const{doc:b,deleteDoc:c}=await I(async()=>{const{doc:i,deleteDoc:f}=await import("./DyWkVpd5.js");return{doc:i,deleteDoc:f}},__vite__mapDeps([3,1]),import.meta.url);try{await c(b(n,"users",m,"characters",d))}catch(i){throw console.error("[firebase-service] deleteCharacterForUser error:",i),i}}async function k(m){if(!m)throw new Error("userId required");if(!D())return[];if(await s(),!h())return console.info("[firebase-service] loadCharactersForUser: firebase not enabled; returning []"),[];w();const{collection:d,getDocs:b}=await I(async()=>{const{collection:c,getDocs:i}=await import("./DyWkVpd5.js");return{collection:c,getDocs:i}},__vite__mapDeps([3,1]),import.meta.url);try{const c=d(n,"users",m,"characters"),i=await b(c),f=[];return i.forEach(p=>{const u=p.data();try{f.push(new M(u))}catch{f.push(new M({...u}))}}),f}catch(c){throw console.error("[firebase-service] loadCharactersForUser error:",c),c}}function N(m,d){if(!D())return console.info("[firebase-service] listenCharactersForUser called but not in browser. Calling back with empty array."),d([]),()=>{};let b=()=>{};async function c(){try{if(await s(),!h()){console.info("[firebase-service] listenCharactersForUser: firebase not enabled; calling back []"),d([]);return}w();const{collection:i,onSnapshot:f}=await I(async()=>{const{collection:u,onSnapshot:v}=await import("./DyWkVpd5.js");return{collection:u,onSnapshot:v}},__vite__mapDeps([3,1]),import.meta.url),p=i(n,"users",m,"characters");b=f(p,u=>{const v=[];u.forEach(L=>{const H=L.data();try{v.push(new M(H))}catch{v.push(new M({...H}))}}),d(v)},u=>{console.error("[firebase-service] listenCharactersForUser snapshot error:",u),d([])})}catch(i){console.error("[firebase-service] Error setting up characters snapshot listener:",i),d([])}}return c().catch(i=>{console.error("[firebase-service] Error setting up characters snapshot listener (unhandled):",i),d([])}),()=>{try{b&&b()}catch{}}}async function x(m,d){if(!m)throw new Error("userId required");if(!D())return;if(await s(),!h()){console.info("[firebase-service] saveRollLogsForUser: firebase not enabled; skipping");return}w();const{doc:b,writeBatch:c}=await I(async()=>{const{doc:u,writeBatch:v}=await import("./DyWkVpd5.js");return{doc:u,writeBatch:v}},__vite__mapDeps([3,1]),import.meta.url),i=d.map(u=>JSON.parse(JSON.stringify(u||{}))),f=3;let p=0;for(;p<f;)try{const u=c(n);for(const v of i){const L=b(n,"users",m,"rollLogs",v.id);u.set(L,v,{merge:!0})}await u.commit();return}catch(u){if(p++,console.error(`[firebase-service] saveRollLogsForUser attempt ${p} failed:`,u),p<f){const v=200*Math.pow(2,p-1);await new Promise(L=>setTimeout(L,v));continue}try{const v="arcana:rollLogs";localStorage.setItem(v,JSON.stringify(i)),console.warn("[firebase-service] saveRollLogsForUser: all attempts failed. Roll logs saved to localStorage as fallback under key:",v)}catch(v){console.error("[firebase-service] saveRollLogsForUser fallback to localStorage failed:",v)}return}}async function C(m){if(!m)throw new Error("userId required");if(!D())return[];if(await s(),!h())return console.info("[firebase-service] loadRollLogsForUser: firebase not enabled; returning []"),[];w();const{collection:d,getDocs:b}=await I(async()=>{const{collection:c,getDocs:i}=await import("./DyWkVpd5.js");return{collection:c,getDocs:i}},__vite__mapDeps([3,1]),import.meta.url);try{const c=d(n,"users",m,"rollLogs"),i=await b(c),f=[];return i.forEach(p=>{const u=p.data();f.push({...u})}),f}catch(c){throw console.error("[firebase-service] loadRollLogsForUser error:",c),c}}function J(m,d){if(!D())return console.info("[firebase-service] listenRollLogsForUser called but not in browser. Calling back with empty array."),d([]),()=>{};let b=()=>{};return(async()=>{try{if(await s(),!h()){console.info("[firebase-service] listenRollLogsForUser: firebase not enabled; calling back []"),d([]);return}w();const{collection:c,onSnapshot:i}=await I(async()=>{const{collection:p,onSnapshot:u}=await import("./DyWkVpd5.js");return{collection:p,onSnapshot:u}},__vite__mapDeps([3,1]),import.meta.url),f=c(n,"users",m,"rollLogs");b=i(f,p=>{const u=[];p.forEach(v=>{const L=v.data();u.push({...L})}),d(u)},p=>{console.error("[firebase-service] listenRollLogsForUser snapshot error:",p),d([])})}catch(c){console.error("[firebase-service] Error setting up roll logs snapshot listener:",c),d([])}})().catch(c=>{console.error("[firebase-service] Error starting roll logs listener (unhandled):",c),d([])}),()=>{try{b&&b()}catch{}}}async function K(m,d){if(!m)throw new Error("userId required");if(!d)throw new Error("logId required");if(!D())return;if(await s(),!h()){console.info("[firebase-service] deleteRollLogForUser: firebase not enabled; skipping");return}w();const{doc:b,deleteDoc:c}=await I(async()=>{const{doc:i,deleteDoc:f}=await import("./DyWkVpd5.js");return{doc:i,deleteDoc:f}},__vite__mapDeps([3,1]),import.meta.url);try{await c(b(n,"users",m,"rollLogs",d))}catch(i){throw console.error("[firebase-service] deleteRollLogForUser error:",i),i}}return{firebaseReady:l,user:a,initFirebase:s,isEnabled:h,signInWithGoogle:A,signOutUser:_,onAuthState:R,saveCharactersForUser:y,loadCharactersForUser:k,deleteCharacterForUser:S,listenCharactersForUser:N,saveRollLogsForUser:x,loadRollLogsForUser:C,deleteRollLogForUser:K,listenRollLogsForUser:J}}const re=ee();function te(){return re}const se=(t,e)=>{if(!t)return[];const o=[],r=t.replace(/\s+/g,""),n=/([+-]?)(\d*d\d+(?:[eE])?|\d+(\.\d+)?|[A-Za-z_][A-Za-z0-9_]*)/g;let l;for(;(l=n.exec(r))!==null;){const a=l[1]||"+",g=l[2],s=/^(\d*)[dD](\d+)([eE])?$/.exec(g);if(s){const w=s[1],y=s[2],S=!!s[3],k=w?Number(w):1,N=Number(y);let x=`${k}d${N}`;a==="-"&&(x=`-${x}`);const C={type:"dice",isExplosive:S,value:x};o.push(C);continue}if(/^\d+(\.\d+)?$/.exec(g)){let w=Number(g);a==="-"&&(w=-w),o.push({type:"constant",isExplosive:!1,value:w});continue}const R=g,A=e&&Object.prototype.hasOwnProperty.call(e,R)&&Number(e[R])||0,_=a==="-"?-A:A;o.push({type:"variable",value:_,isExplosive:!1,label:R})}return o},oe=t=>{let e="";return t.forEach((o,r)=>{const n=o.expressionMember;let l="";switch(n.type){case"dice":r>0&&!n.value.toString().startsWith("-")&&(l+="+ "),l+=`${n.value}${n.isExplosive?"e":""} [${o.result.map(a=>`<span class="${a.value===a.sides?"max":""}${a.value===1?"min":""}">`+a.value.toString()+(n.isExplosive&&a.value===a.sides?"💥":"")+"</span>").join(", ")}]`;break;case"constant":l=`${r>0&&n.value>=0?"+ ":""}${n.value}`;break;case"variable":l=`${r>0&&n.value>=0?"+ ":""}${n.label} [${n.value}]`;break}l.startsWith("-")&&(l=l.replace("-","- ")),e+=`${r>0?" ":""}${l}`}),e},G=t=>{let e=0;return t.forEach(o=>{const r=o.expressionMember;switch(r.type){case"dice":e+=o.result.reduce((n,l)=>n+l.value,0)*(r.value.toString().startsWith("-")?-1:1);break;case"constant":e+=r.value;break;case"variable":e+=r.value;break}}),e},de=t=>{const e=[];if(!t||!String(t).trim())return e;const o=String(t).trim(),r=/^[+-]/.test(o)?o:`+${o}`,n=/([+-])\s*([^+-]+)/g;let l;for(;(l=n.exec(r))!==null;){const g=l[1]==="+"?1:-1,s=(l[2]||"").trim();if(!s)continue;const h=s.match(/^(\d+)\s*d\s*(\d+)/i);if(h){const _=Number(h[1]),w=Number(h[2]),S=s.slice(h[0].length).trim()||null;e.push({kind:"dice",sign:g,n:_,faces:w,damageType:S,raw:s});continue}const R=s.match(/^(\d+)/);if(R){const _=Number(R[1]),y=s.slice(R[0].length).trim()||null;e.push({kind:"flat",sign:g,value:_,damageType:y,raw:s});continue}const A=s.match(/(\d+)\s*d\s*(\d+)/i);if(A){const _=Number(A[1]),w=Number(A[2]),y=s.replace(A[0],"").trim()||null;e.push({kind:"dice",sign:g,n:_,faces:w,damageType:y,raw:s});continue}e.push({kind:"flat",sign:g,value:0,damageType:s||null,raw:s})}return e.reduce((g,s)=>s.kind==="dice"?`${g} ${s.sign===1?"+":"-"} ${s.n}d${s.faces}`:s.kind==="flat"?`${g} ${s.sign===1?"+":"-"} ${s.value}`:g,"")},B="arcana:rollLogs",E={inited:!1,clearTimeoutId:null,roll3DDice:async()=>[],clear3DDices:()=>{},logs:O([]),rollModalOpened:O(!1),rollModalData:O(void 0)},P=te();let T=null,U=null,$=!1;const ae=()=>{try{const t=localStorage.getItem(B),e=t?JSON.parse(t):[];return(Array.isArray(e)?e.slice(-100):e).map(r=>V(r))}catch(t){return console.error("Error loading roll logs:",t),[]}finally{E.logs.subscribe(async t=>{try{await ie(t)}catch(e){console.error("[dice-roller-service] saveRollLogs subscription error:",e)}})}},ie=async t=>{if(!$)try{const o=(Array.isArray(t)?t.slice(-100):t).map(r=>W(r));if(T&&P.isEnabled())try{await P.saveRollLogsForUser(T,o);return}catch(r){console.error("[dice-roller-service] saveRollLogs cloud write failed, falling back to localStorage:",r)}try{localStorage.setItem(B,JSON.stringify(o))}catch(r){console.error("Error saving roll logs to localStorage:",r)}}catch(e){console.error("Error preparing roll logs for save:",e)}},q=async t=>F.STANDARD_DICES.some(o=>t.endsWith(o))?E.roll3DDice(t):new Promise(o=>{const[r,n]=t.split("d"),l=[];for(let a=0;a<Number(r);a++)l.push({value:Math.floor(Math.random()*Number(n))+1,sides:Number(n),dieType:"d"+n,groupId:0,rollId:a,theme:"default",themeColor:"#000000"});o(l)}),ne=(t,e,o)=>{const r=G(t),n={id:crypto.randomUUID(),timestamp:new Date,title:e||"Tirada anónima",total:r,formattedTotal:o?o(r):void 0,detail:oe(t)};E.logs.update(l=>[...l,n].slice(-100))},fe=()=>{E.inited||(E.logs.set(ae()),E.inited=!0,(async()=>{try{try{await P.initFirebase()}catch(a){console.warn("[dice-roller-service] firebase init error (continuing with local logs):",a)}try{await P.onAuthState(async a=>{const g=T;if(T=a?a.uid:null,g&&g!==T&&U){try{U()}catch{}U=null}if(T&&P.isEnabled())try{U=P.listenRollLogsForUser(T,s=>{$=!0;try{const h=(s||[]).map(R=>V(R));E.logs.set(h)}catch(h){console.error("[dice-roller-service] Error applying remote roll logs:",h)}finally{$=!1}})}catch(s){console.error("[dice-roller-service] Error starting remote roll logs listener:",s)}else try{const s=localStorage.getItem(B);if(s){const h=JSON.parse(s);E.logs.set(h.map(R=>V(R)))}}catch(s){console.error("[dice-roller-service] Error loading local fallback logs:",s)}})}catch(a){console.warn("[dice-roller-service] Error subscribing to auth state (ignored):",a)}}catch(a){console.error("[dice-roller-service] Unexpected error setting up firebase integration:",a)}})());const t=({expression:a,variables:g={},title:s=void 0,resultFormatter:h=()=>{}})=>{E.rollModalData.set({expression:a,variables:g,title:s??"Tirar",rollType:"normal",extraModsExpression:"",resultFormatter:h}),E.rollModalOpened.set(!0)},e=async()=>{const a=j(E.rollModalData);if(E.rollModalData.set(void 0),E.rollModalOpened.set(!1),!a)return;let g=a.expression,s=a.title;a.rollType!=="normal"&&(g+=a.rollType==="advantage"?"+1d4":"-1d4",s+=a.rollType==="advantage"?" (ventaja)":" (desventaja)"),a?.extraModsExpression&&(g+=`+${a.extraModsExpression.trim()}`,g=g.replaceAll("++","+").replaceAll("+-","-")),r({expression:g,variables:a.variables,title:s})},o=()=>{E.rollModalOpened.set(!1),E.rollModalData.set(void 0)},r=async({expression:a,variables:g={},title:s=void 0,resultFormatter:h=()=>{}})=>{const R=se(a,g);E.clearTimeoutId&&(clearTimeout(E.clearTimeoutId),E.clearTimeoutId=null),E.clear3DDices();const A=[];for(const _ of R)_.type==="dice"?A.push({expressionMember:_,promise:q(_.value),result:void 0,explosionResolved:!1,numExplosions:0}):A.push({expressionMember:_,promise:void 0,result:_.value,explosionResolved:!0,numExplosions:0});for(;A.some(_=>_.result===void 0);){const _=[],w=A.filter(y=>y.expressionMember.type==="dice"&&y.result===void 0);for(const y of w)_.push((async()=>{y.result=await y.promise,y.promise=void 0;for(const S of y.result)y.expressionMember.isExplosive&&S.sides===S.value&&S.sides>1&&y.numExplosions++;if(y.numExplosions>0){const S={...y.expressionMember,value:`${y.numExplosions}d${y.result[0].sides}`};A.push({expressionMember:S,promise:q(S.value),result:void 0,explosionResolved:!1,numExplosions:0})}return y})());await Promise.all(_)}return E.clearTimeoutId=setTimeout(()=>{E.clear3DDices()},F.CLEAR_3D_DICES_DELAY),ne(A,s,h),G(A)};return{rollExpression:r,register3DDiceRollerFn:a=>{E.roll3DDice=a},registerClear3DDicesFn:a=>{E.clear3DDices=a},rollLogs:E.logs,rollModal:{rollModalOpened:E.rollModalOpened,openRollModal:t,rollModalData:E.rollModalData,submitRollModal:e,abortRollModal:o}}};export{M as C,fe as a,de as p,te as u};
