const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./lCNLHSrR.js","./C4c6zY-H.js","./yBjK6igh.js","./x4_yyNok.js"])))=>i.map(i=>d[i]);
import{_ as R}from"./PPVm8Dsz.js";import{C as U}from"./CyC3GOE6.js";import{w as J,g as x,d as Le}from"./DefpNfFO.js";import{s as Me}from"./CmL3Knf_.js";const Oe=t=>{if(t&&typeof t.toDate=="function")try{return t.toDate()}catch{}if(t instanceof Date)return t;if(typeof t=="string"||typeof t=="number"){const e=new Date(t);if(!isNaN(e.getTime()))return e}if(t&&typeof t=="object"){const e=typeof t.seconds=="number"?t.seconds:typeof t._seconds=="number"?t._seconds:null;if(typeof e=="number")return new Date(e*1e3)}return new Date},z=t=>({...t,timestamp:Oe(t.timestamp)}),X=t=>({...t,timestamp:t.timestamp.toISOString()}),Fe=(t,e)=>{if(!t)return 0;const y=t.trim();try{const o=new Function("cuerpo","reflejos","mente","instinto","presencia","ppGastados","floor","ceil","round","Math",`return (${y});`);return Number(o(Number(e.cuerpo)||0,Number(e.reflejos)||0,Number(e.mente)||0,Number(e.instinto)||0,Number(e.presencia)||0,Number(e.ppGastados)||0,Math.floor,Math.ceil,Math.round,Math))||0}catch(o){return console.error("Error evaluating modifier expression:",o),0}},Ne=(t,e)=>Fe(t,{cuerpo:e.attributes.body,reflejos:e.attributes.reflexes,mente:e.attributes.mind,instinto:e.attributes.instinct,presencia:e.attributes.presence,ppGastados:e.spentPP,floor:Math.floor,ceil:Math.ceil,round:Math.round,Math});class W{id;name;attributes;cards;ppHistory;goldHistory;equipment;modifiers;currentHP;tempHP;currentLuck;img;story;notes;languages;quickInfo;attacks;maxActiveCards;version;party;constructor(e){this.id=e.id,this.name=e.name,this.attributes=e.attributes,this.cards=e.cards,this.ppHistory=e.ppHistory,this.goldHistory=e.goldHistory,this.equipment=e.equipment,this.modifiers=e.modifiers,this.currentHP=e.currentHP,this.tempHP=e.tempHP,this.currentLuck=e.currentLuck,this.img=e.img,this.party=e.party??{partyId:null,ownerId:null},this.story=e.story,this.notes=e.notes,this.languages=e.languages,this.quickInfo=e.quickInfo,this.attacks=e.attacks,this.maxActiveCards=e.maxActiveCards,this.version=e.version}calculateAttrModifiers(e,y){let o=y;const f=this.modifiers.filter(s=>s.attribute===e);for(const s of f){const i=Ne(s.formula,this);if(s.type==="set")return i;s.type==="add"&&(o+=i)}return o}get maxLuck(){const e=U.MAX_LUCK;return this.calculateAttrModifiers("maxLuck",e)}get maxHP(){const e=U.BASE_HEALTH+this.attributes.body*U.HEALTH_BODY_MULTIPIER;return this.calculateAttrModifiers("maxHP",e)}get speed(){const e=U.BASE_SPEED+this.attributes.reflexes;return this.calculateAttrModifiers("speed",e)}get evasion(){const e=U.BASE_EVASION+this.attributes.reflexes;return this.calculateAttrModifiers("evasion",e)}get physicalMitigation(){return this.calculateAttrModifiers("physicalMitigation",0)}get magicalMitigation(){return this.calculateAttrModifiers("magicalMitigation",0)}get currentGold(){const e=this.goldHistory.filter(o=>o.type==="add").reduce((o,f)=>o+f.value,0),y=this.spentGold;return y>0?e-y:e}get spentGold(){return this.goldHistory.filter(e=>e.type==="subtract").reduce((e,y)=>e+y.value,0)}get currentPP(){const e=this.ppHistory.filter(o=>o.type==="add").reduce((o,f)=>o+f.value,0),y=this.spentPP;return y>0?e-y:e}get spentPP(){return this.ppHistory.filter(e=>e.type==="subtract").reduce((e,y)=>e+y.value,0)}get pjPower(){const e=this.cards.map(f=>f.level).sort((f,s)=>s-f).slice(0,U.TOP_N_CARDS_TO_CALCULATE_PJ_POWER);console.log(e);const y=e.reduce((f,s)=>f+s,0)/e.length,o=this.spentPP/U.PJ_POWER_SPENT_PP_DIVIDER;return Math.round(y+o)}get tier(){for(const e of U.CHARACTER_TIERS)if(this.spentPP>=e.minPP&&this.spentPP<=e.maxPP)return e.tier;return 0}get numActiveCards(){return this.cards.filter(e=>e.isActive).length}get initiative(){return this.attributes.reflexes}copy(){return new W({...this})}getExportableData(){return{...this,party:{partyId:null,ownerId:null}}}}class te{id;name;ownerId;notes;members;characters;unsubscribeCharacterListener;constructor(e){this.id=e?.id??"",this.name=e?.name??"",this.ownerId=e?.ownerId??"",this.notes=Array.isArray(e?.notes)?e.notes:[],this.members=e?.members&&typeof e.members=="object"?e.members:{},this.characters=e?.characters??[],this.unsubscribeCharacterListener=e?.unsubscribeCharacterListener??(()=>{})}getAllCharacterIds(){const e=[];for(const y of Object.keys(this.members)){const o=this.members[y]??[];for(const f of o)e.includes(f)||e.push(f)}return e}getCharactersFullIdentifiers(){const e=[];for(const y of Object.keys(this.members)){const o=this.members[y]??[];for(const f of o)e.push({userId:y,characterId:f})}return e}isAccessible(e){return this.ownerId===e||this.members[e]?.length>0}copy(){const e=JSON.parse(JSON.stringify(this.asPlain())),y=new te(e);return y.characters=this.characters.filter(o=>o.party.partyId===this.id&&y.getAllCharacterIds().includes(o.id)),y.unsubscribeCharacterListener=this.unsubscribeCharacterListener,y}asPlain(){return{id:this.id,name:this.name,ownerId:this.ownerId,notes:this.notes,members:this.members}}}var Z={VITE_FIREBASE_MESSAGING_SENDER_ID:"647852941329",VITE_FIREBASE_STORAGE_BUCKET:"arcana-85eeb.firebasestorage.app",VITE_FIREBASE_AUTH_DOMAIN:"arcana-85eeb.firebaseapp.com",VITE_FIREBASE_PROJECT_ID:"arcana-85eeb",VITE_FIREBASE_APP_ID:"1:647852941329:web:f2aa1e9dd6792f6a9d91b0",VITE_FIREBASE_API_KEY:"AIzaSyAFv5lor5ufY-KPBQ166rPSRnscFrtm88w"};function M(){return typeof window<"u"}function $e(){if(typeof Z>"u")return null;const t=typeof Z=="string"?JSON.parse(Z):Z;return t.VITE_FIREBASE_API_KEY?{apiKey:t.VITE_FIREBASE_API_KEY,authDomain:t.VITE_FIREBASE_AUTH_DOMAIN,projectId:t.VITE_FIREBASE_PROJECT_ID,storageBucket:t.VITE_FIREBASE_STORAGE_BUCKET,messagingSenderId:t.VITE_FIREBASE_MESSAGING_SENDER_ID,appId:t.VITE_FIREBASE_APP_ID}:null}function xe(){let t=null,e=null,y=!1,o=null,f=0,s=0,i=null;const b=()=>{if(!i)try{i=setTimeout(()=>{i=null;try{console.debug("[firebase-service] ops:",{reads:f,writes:s})}catch{}},1e3)}catch{}},r=(l=1)=>{f+=l,b()},E=(l=1)=>{s+=l,b()},I=J(!1),A=J(null);async function P(){if(y)return;if(y=!0,!M()){I.set(!1);return}const l=$e()??null;if(!l)throw I.set(!1),new Error("Firebase configuration missing: VITE_FIREBASE_* variables required.");try{const{initializeApp:a,getApps:u}=await R(async()=>{const{initializeApp:w,getApps:p}=await import("./lCNLHSrR.js");return{initializeApp:w,getApps:p}},__vite__mapDeps([0,1]),import.meta.url),c=await R(()=>import("./yBjK6igh.js"),__vite__mapDeps([2,1]),import.meta.url),d=await R(()=>import("./x4_yyNok.js"),__vite__mapDeps([3,1]),import.meta.url);u&&u().length===0&&a(l),t=c.getAuth(),e=d.getFirestore(),c.onAuthStateChanged(t,w=>{const p=w?{uid:w.uid,displayName:w.displayName,email:w.email,photoURL:w.photoURL}:null;A.set(p)}),I.set(!0)}catch(a){throw I.set(!1),console.error("[firebase-service] Initialization error:",a),a}}async function T(){if(o)return o;o=P();try{await o}finally{o=null}}function S(){let l=!1;return I.subscribe(a=>{l=a})(),l&&!!t&&!!e}async function C(){if(!M())return null;await T();const{GoogleAuthProvider:l,signInWithPopup:a}=await R(async()=>{const{GoogleAuthProvider:p,signInWithPopup:g}=await import("./yBjK6igh.js");return{GoogleAuthProvider:p,signInWithPopup:g}},__vite__mapDeps([2,1]),import.meta.url),u=new l;u.setCustomParameters({prompt:"select_account"});const d=(await a(t,u)).user;if(!d)return null;const w={uid:d.uid,displayName:d.displayName,email:d.email,photoURL:d.photoURL};return A.set(w),w}async function se(){if(!M())return;await T();const{signOut:l}=await R(async()=>{const{signOut:a}=await import("./yBjK6igh.js");return{signOut:a}},__vite__mapDeps([2,1]),import.meta.url);await l(t),A.set(null)}async function oe(l){if(!M())return l(null),()=>{};await T();const{onAuthStateChanged:a}=await R(async()=>{const{onAuthStateChanged:c}=await import("./yBjK6igh.js");return{onAuthStateChanged:c}},__vite__mapDeps([2,1]),import.meta.url);return a(t,c=>{const d=c?{uid:c.uid,displayName:c.displayName,email:c.email,photoURL:c.photoURL}:null;A.set(d),l(d)})}async function O(){if(await T(),!e)throw new Error("Firestore not initialized")}async function ae(l,a){if(!l)throw new Error("userId required");if(!M())return;await O();const{doc:u,writeBatch:c,getDoc:d}=await R(async()=>{const{doc:n,writeBatch:m,getDoc:h}=await import("./x4_yyNok.js");return{doc:n,writeBatch:m,getDoc:h}},__vite__mapDeps([3,1]),import.meta.url);let w=a.map(n=>JSON.parse(JSON.stringify(n||{})));const p=w.filter(n=>!n||typeof n.id!="string"||n.id.trim()==="");if(p.length>0&&console.warn("[firebase-service] saveCharactersForUser: skipping characters without valid id:",p.map(n=>n&&n.id)),w=w.filter(n=>n&&typeof n.id=="string"&&n.id.trim()!==""),w.length===0)return;try{const n=new Set;for(const m of w){const h=(m?.party&&m.party.partyId)??m?.partyId??null;h&&n.add(h)}if(n.size>0){const m=new Map;for(const h of n)try{const _=await d(u(e,"parties",h));r();let D;_&&typeof _.exists=="function"&&_.exists()?D=_.data():D=void 0,m.set(h,D?D.ownerId??null:null)}catch(_){console.warn("[firebase-service] Failed to read party for denormalization",h,_),m.set(h,null)}for(const h of w){const _=(h?.party&&h.party.partyId)??h?.partyId??null;h.party?_?(h.party.partyId=_,h.party.ownerId=m.get(_)??null):h.party={partyId:null,ownerId:null}:h.party={partyId:_??null,ownerId:_?m.get(_)??null:null}}}else for(const m of w)m.party?m.party.ownerId=m.party.ownerId??null:m.party={partyId:null,ownerId:null}}catch(n){console.warn("[firebase-service] Party denormalization step failed:",n);for(const m of w)m.party?m.party.ownerId=m.party.ownerId??null:m.party={partyId:null,ownerId:null}}const g=3;for(let n=1;n<=g;n++)try{for(const h of w)if(!(!h||!h.id||typeof h.id!="string"))try{const _=u(e,"users",l,"characters",h.id),D=await d(_);if(r(),D&&D.exists()){const L=D.data()||{},F=(L?.party&&L.party.partyId)??L?.partyId??null,K=(h?.party&&h.party.partyId)??h?.partyId??null;if(F&&(!K||K!==F))try{await ne(F,l,h.id)}catch(ie){console.warn("[firebase-service] best-effort removePartyMember failed for",{prevPartyId:F,userId:l,cid:h.id,err:ie})}}}catch(_){console.warn("[firebase-service] failed to read existing character doc (continuing):",h?.id,_)}const m=c(e);for(const h of w){if(!h||!h.id||typeof h.id!="string")continue;const _=u(e,"users",l,"characters",h.id);m.set(_,h,{merge:!0})}await m.commit(),E(w.length);return}catch(m){if(console.error(`[firebase-service] saveCharactersForUser attempt ${n} failed:`,m),n===g)throw m;await new Promise(h=>setTimeout(h,200*n))}}async function me(l,a){if(!l)throw new Error("userId required");if(!a)throw new Error("characterId required");if(!M())return;await O();const{doc:u,deleteDoc:c}=await R(async()=>{const{doc:d,deleteDoc:w}=await import("./x4_yyNok.js");return{doc:d,deleteDoc:w}},__vite__mapDeps([3,1]),import.meta.url);await c(u(e,"users",l,"characters",a)),E()}async function ye(l){if(!l)throw new Error("userId required");if(!M())return[];await O();const{collection:a,getDocs:u}=await R(async()=>{const{collection:p,getDocs:g}=await import("./x4_yyNok.js");return{collection:p,getDocs:g}},__vite__mapDeps([3,1]),import.meta.url),c=a(e,"users",l,"characters"),d=await u(c);r(d?.size??0);const w=[];return d.forEach(p=>{const g=p.data();w.push(new W(g))}),w}function ge(l,a){if(!M())return a([]),()=>{};let u=()=>{};return(async()=>{try{await O();const{collection:c,onSnapshot:d}=await R(async()=>{const{collection:p,onSnapshot:g}=await import("./x4_yyNok.js");return{collection:p,onSnapshot:g}},__vite__mapDeps([3,1]),import.meta.url),w=c(e,"users",l,"characters");u=d(w,p=>{r(p?.size??0);const g=[];p.forEach(n=>{g.push(new W(n.data()))}),a(g)},p=>{console.error("[firebase-service] listenCharactersForUser snapshot error:",p),a([])})}catch(c){console.error("[firebase-service] listenCharactersForUser setup error:",c),a([])}})(),()=>{try{u&&u()}catch{}}}async function he(l){if(!l||!M())return null;await O();const{doc:a,getDoc:u}=await R(async()=>{const{doc:c,getDoc:d}=await import("./x4_yyNok.js");return{doc:c,getDoc:d}},__vite__mapDeps([3,1]),import.meta.url);try{const c=await u(a(e,"parties",l));if(r(),!c.exists())return null;const d=c.data();return new te(d)}catch(c){return console.error("[firebase-service] loadParty failed:",c),null}}async function be(l,a,u){if(!l)throw new Error("partyId required");if(!a)throw new Error("userId required");if(!u)throw new Error("characterId required");if(!M())return;await O();const{doc:c,runTransaction:d,getDoc:w,updateDoc:p,setDoc:g}=await R(async()=>{const{doc:m,runTransaction:h,getDoc:_,updateDoc:D,setDoc:L}=await import("./x4_yyNok.js");return{doc:m,runTransaction:h,getDoc:_,updateDoc:D,setDoc:L}},__vite__mapDeps([3,1]),import.meta.url),n=c(e,"parties",l);try{await d(e,async m=>{const h=await m.get(n);if(r(),!h||!h.exists()){const F={};F[a]=[u],m.set(n,{members:F},{merge:!0}),E();return}const _=h.data()||{},D=_.members&&typeof _.members=="object"?_.members:{},L=Array.isArray(D[a])?D[a].slice():[];if(!L.includes(u)){L.push(u);const F={};F[`members.${a}`]=L,m.update(n,F),E()}})}catch(m){console.error("[firebase-service] setPartyMember transaction failed:",m);try{const h=await w(n);if(r(),!h||!h.exists()){await g(n,{members:{[a]:[u]}},{merge:!0}),E();return}const _=h.data()||{},D=_.members&&typeof _.members=="object"?_.members:{},L=Array.isArray(D[a])?D[a].slice():[];L.includes(u)||(L.push(u),await p(n,{[`members.${a}`]:L}),E())}catch(h){throw console.error("[firebase-service] setPartyMember fallback failed:",h),m}}}async function ne(l,a,u){if(!l)throw new Error("partyId required");if(!a)throw new Error("userId required");if(!u)throw new Error("characterId required");if(!M())return;await O();const{doc:c,runTransaction:d,getDoc:w,updateDoc:p,deleteField:g}=await R(async()=>{const{doc:m,runTransaction:h,getDoc:_,updateDoc:D,deleteField:L}=await import("./x4_yyNok.js");return{doc:m,runTransaction:h,getDoc:_,updateDoc:D,deleteField:L}},__vite__mapDeps([3,1]),import.meta.url),n=c(e,"parties",l);try{await d(e,async m=>{const h=await m.get(n);if(r(),!h||!h.exists())return;const _=h.data()||{},D=_.members&&typeof _.members=="object"?_.members:{},L=Array.isArray(D[a])?D[a].slice():[],F=L.indexOf(u);F!==-1&&(L.splice(F,1),L.length===0?(m.update(n,{[`members.${a}`]:g()}),E()):(m.update(n,{[`members.${a}`]:L}),E()))})}catch(m){console.error("[firebase-service] removePartyMember transaction failed:",m);try{const{deleteField:h}=await R(async()=>{const{deleteField:ie}=await import("./x4_yyNok.js");return{deleteField:ie}},__vite__mapDeps([3,1]),import.meta.url),_=await w(n);if(r(),!_||!_.exists())return;const D=_.data()||{},L=D.members&&typeof D.members=="object"?D.members:{},F=Array.isArray(L[a])?L[a].slice():[],K=F.indexOf(u);K!==-1&&(F.splice(K,1),F.length===0?(await p(n,{[`members.${a}`]:h()}),E()):(await p(n,{[`members.${a}`]:F}),E()))}catch(h){throw console.error("[firebase-service] removePartyMember fallback failed:",h),m}}}async function we(l){if(!l||!l.id)throw new Error("party.id required");if(!M())return;await O();const{doc:a,setDoc:u}=await R(async()=>{const{doc:w,setDoc:p}=await import("./x4_yyNok.js");return{doc:w,setDoc:p}},__vite__mapDeps([3,1]),import.meta.url),c=l.asPlain(),d=3;for(let w=1;w<=d;w++)try{await u(a(e,"parties",c.id),c,{merge:!0}),E();return}catch(p){if(console.error(`[firebase-service] saveParty attempt ${w} failed for party ${c.id} owner=${c.ownerId}:`,p),w===d){try{console.error("[firebase-service] saveParty giving up after max attempts for party:",JSON.stringify(c))}catch(g){console.error("[firebase-service] saveParty could not stringify party payload",g)}throw p}await new Promise(g=>setTimeout(g,200*w))}}async function Ee(l){if(!l)throw new Error("partyId required");if(!M())return;await O();const{doc:a,deleteDoc:u}=await R(async()=>{const{doc:c,deleteDoc:d}=await import("./x4_yyNok.js");return{doc:c,deleteDoc:d}},__vite__mapDeps([3,1]),import.meta.url);await u(a(e,"parties",l)),E()}function _e(l,a){if(!M())return a([]),()=>{};let u=()=>{};return(async()=>{try{await O();const{collection:c,onSnapshot:d}=await R(async()=>{const{collection:p,onSnapshot:g}=await import("./x4_yyNok.js");return{collection:p,onSnapshot:g}},__vite__mapDeps([3,1]),import.meta.url),w=c(e,"parties");u=d(w,p=>{try{r(p?.size??0)}catch{}const g=[];p.forEach(n=>{const m=n.data();if(!m)return;m.id=n.id;const h=m.ownerId===l,_=m.members&&typeof m.members=="object"&&Array.isArray(m.members[l])&&m.members[l].length>0;(h||_)&&g.push(new te(m))}),a(g)},p=>{console.error("[firebase-service] listenToUserParties error:",p),a([])})}catch(c){console.error("[firebase-service] listenToUserParties setup error:",c),a([])}})(),()=>{try{u&&u()}catch{}}}async function ve(l,a){if(!l)throw new Error("userId required");if(!M())return;await O();const{doc:u,writeBatch:c}=await R(async()=>{const{doc:p,writeBatch:g}=await import("./x4_yyNok.js");return{doc:p,writeBatch:g}},__vite__mapDeps([3,1]),import.meta.url),d=a.map(p=>JSON.parse(JSON.stringify(p||{}))),w=3;for(let p=1;p<=w;p++)try{const g=c(e);for(const n of d){const m=u(e,"users",l,"rollLogs",n.id);g.set(m,n,{merge:!0})}await g.commit(),E(d.length);return}catch(g){if(console.error(`[firebase-service] saveRollLogsForUser attempt ${p} failed:`,g),p===w)throw g;await new Promise(n=>setTimeout(n,200*p))}}async function Ie(l,a,u){if(!l)throw new Error("partyId required");if(!M())return;await O();const{doc:c,writeBatch:d}=await R(async()=>{const{doc:g,writeBatch:n}=await import("./x4_yyNok.js");return{doc:g,writeBatch:n}},__vite__mapDeps([3,1]),import.meta.url),w=a.map(g=>{const n=JSON.parse(JSON.stringify(g||{}));return u&&(u.id&&(n.authorId=u.id),u.name&&(n.authorName=u.name),u.photoURL&&(n.authorPhotoURL=u.photoURL)),n}),p=3;for(let g=1;g<=p;g++)try{const n=d(e);for(const m of w){const h=c(e,"parties",l,"rollLogs",m.id);n.set(h,m,{merge:!0})}await n.commit(),E(w.length);return}catch(n){if(console.error(`[firebase-service] saveGroupRollLogsForParty attempt ${g} failed:`,n),g===p)throw n;await new Promise(m=>setTimeout(m,200*g))}}function Ae(l,a){if(!M())return a([]),()=>{};let u=()=>{};return(async()=>{try{await O();const{collection:c,onSnapshot:d}=await R(async()=>{const{collection:p,onSnapshot:g}=await import("./x4_yyNok.js");return{collection:p,onSnapshot:g}},__vite__mapDeps([3,1]),import.meta.url),w=c(e,"parties",l,"rollLogs");u=d(w,p=>{r(p?.size??0);const g=[];p.forEach(n=>{const m={...n.data()||{},id:n.id};g.push(m)}),a(g)},p=>{console.error("[firebase-service] listenGroupRollLogsForParty snapshot error:",p),a([])})}catch(c){console.error("[firebase-service] listenGroupRollLogsForParty setup error:",c),a([])}})(),()=>{try{u&&u()}catch{}}}async function Pe(l,a){if(!l)throw new Error("partyId required");if(!a)throw new Error("logId required");if(!M())return;await O();const{doc:u,deleteDoc:c}=await R(async()=>{const{doc:d,deleteDoc:w}=await import("./x4_yyNok.js");return{doc:d,deleteDoc:w}},__vite__mapDeps([3,1]),import.meta.url);await c(u(e,"parties",l,"rollLogs",a)),E()}async function Te(l){if(!l)throw new Error("userId required");if(!M())return[];await O();const{collection:a,getDocs:u}=await R(async()=>{const{collection:p,getDocs:g}=await import("./x4_yyNok.js");return{collection:p,getDocs:g}},__vite__mapDeps([3,1]),import.meta.url),c=a(e,"users",l,"rollLogs"),d=await u(c);r(d?.size??0);const w=[];return d.forEach(p=>w.push({...p.data()||{},id:p.id})),w}function De(l,a){if(!M())return a([]),()=>{};let u=()=>{};return(async()=>{try{await O();const{collection:c,onSnapshot:d}=await R(async()=>{const{collection:p,onSnapshot:g}=await import("./x4_yyNok.js");return{collection:p,onSnapshot:g}},__vite__mapDeps([3,1]),import.meta.url),w=c(e,"users",l,"rollLogs");u=d(w,p=>{r(p?.size??0);const g=[];p.forEach(n=>{const m={...n.data()||{},id:n.id};g.push(m)}),a(g)},p=>{console.error("[firebase-service] listenRollLogsForUser snapshot error:",p),a([])})}catch(c){console.error("[firebase-service] listenRollLogsForUser setup error:",c),a([])}})(),()=>{try{u&&u()}catch{}}}async function Re(l,a){if(!l)throw new Error("userId required");if(!a)throw new Error("logId required");if(!M())return;await O();const{doc:u,deleteDoc:c}=await R(async()=>{const{doc:d,deleteDoc:w}=await import("./x4_yyNok.js");return{doc:d,deleteDoc:w}},__vite__mapDeps([3,1]),import.meta.url);await c(u(e,"users",l,"rollLogs",a)),E()}const Y={};function ce(l,a){if(!M())return()=>{};const u=`${l.userId}/${l.characterId}`;let c=Y[u];if(c||(c={subscribers:new Set,unsubscribe:null,latest:null},Y[u]=c),c.subscribers.add(a),c.unsubscribe||(async()=>{try{await O();const{doc:d,onSnapshot:w}=await R(async()=>{const{doc:g,onSnapshot:n}=await import("./x4_yyNok.js");return{doc:g,onSnapshot:n}},__vite__mapDeps([3,1]),import.meta.url),p=d(e,"users",l.userId,"characters",l.characterId);c.unsubscribe=w(p,g=>{if(r(),g&&g.exists()){const n=g.data()||{};n.id||(n.id=g.id),c.latest=new W(n)}else c.latest=null;for(const n of Array.from(c.subscribers))try{n(c.latest)}catch(m){console.error("[firebase-service] subscribeCharacter subscriber error:",m)}},g=>{console.error("[firebase-service] subscribeCharacter snapshot error for",u,g)})}catch(d){console.error("[firebase-service] subscribeCharacter setup error for",u,d)}})(),c.latest!==null)try{a(c.latest)}catch(d){console.error("[firebase-service] subscribeCharacter immediate callback error:",d)}return()=>{const d=Y[u];if(d&&(d.subscribers.delete(a),d.subscribers.size===0)){try{d.unsubscribe&&d.unsubscribe()}catch{}delete Y[u]}}}function Se(l,a){if(!M())return a([]),()=>{};const u={},c=[];for(const d of l){if(!d||!d.userId||!d.characterId)continue;const w=`${d.userId}/${d.characterId}`,p=ce(d,g=>{u[w]=g;const n=[];for(const m of Object.keys(u)){const h=u[m];h&&n.push(h)}try{a(n)}catch(m){console.error("[firebase-service] listenCharactersByIds callback error:",m)}});c.push(p)}return()=>{for(const d of c)try{d()}catch{}}}return{firebaseReady:I,user:A,initFirebase:T,isEnabled:S,signInWithGoogle:C,signOutUser:se,onAuthState:oe,saveCharactersForUser:ae,loadCharactersForUser:ye,deleteCharacterForUser:me,listenCharactersForUser:ge,saveParty:we,deleteParty:Ee,loadParty:he,listenToUserParties:_e,setPartyMember:be,removePartyMember:ne,subscribeCharacter:ce,listenCharactersByIds:Se,saveRollLogsForUser:ve,loadRollLogsForUser:Te,deleteRollLogForUser:Re,listenRollLogsForUser:De,saveGroupRollLogsForParty:Ie,deleteGroupRollLogForParty:Pe,listenGroupRollLogsForParty:Ae,getReadCount:()=>f,getWriteCount:()=>s,resetOpCounters:()=>{f=0,s=0},getOpCounters:()=>({reads:f,writes:s})}}const Ce=xe();function ke(){return Ce}const ue="arcana:rollTarget";function de(){return typeof window<"u"}function re(t){return typeof t=="string"&&t.trim().length>0}function Ue(t){return!t||typeof t!="object"?null:t.type==="party"&&re(t.partyId)?{type:"party",partyId:t.partyId,partyName:re(t.partyName)?t.partyName:void 0}:{type:"personal"}}function Ve(t){if(de())try{localStorage.setItem(ue,JSON.stringify(t))}catch(e){console.warn("[roll-target-service] failed to persist target",e)}}function Be(){if(!de())return null;try{const t=localStorage.getItem(ue);if(!t)return null;const e=JSON.parse(t);return Ue(e)}catch(t){return console.warn("[roll-target-service] failed to load target",t),null}}const N={inited:!1,target:J({type:"personal"}),unsub:null};function Ge(){if(!N.inited){N.inited=!0;const b=Be();b&&N.target.set(b),N.unsub=N.target.subscribe(r=>Ve(r))}const t=()=>{N.target.set({type:"personal"})},e=(b,r)=>{if(!re(b)){console.warn("[roll-target-service] setPartyTarget called with invalid partyId, falling back to personal"),N.target.set({type:"personal"});return}const E={type:"party",partyId:b.trim()};re(r)&&(E.partyName=r.trim()),N.target.set(E)},y=b=>{try{const r=x(N.target);r.type==="party"&&(Array.isArray(b)&&b.includes(r.partyId)||N.target.set({type:"personal"}))}catch(r){console.warn("[roll-target-service] reconcileAccessibility error",r)}},o=()=>x(N.target),f=()=>x(N.target).type==="personal",s=()=>x(N.target).type==="party",i=()=>{const b=x(N.target);return b.type==="party"?b.partyId:null};return{target:N.target,setPersonalTarget:t,setPartyTarget:e,reconcileAccessibility:y,getTarget:o,isPersonalTarget:f,isPartyTarget:s,getPartyId:i,cleanup:()=>{if(N.unsub){try{N.unsub()}catch{}N.unsub=null}}}}const ze=(t,e)=>{if(!t)return[];const y=[],o=t.replace(/\s+/g,""),f=/([+-]?)(\d*d\d+(?:[eE])?|\d+(\.\d+)?|[A-Za-z_][A-Za-z0-9_]*)/g;let s;for(;(s=f.exec(o))!==null;){const i=s[1]||"+",b=s[2],r=/^(\d*)[dD](\d+)([eE])?$/.exec(b);if(r){const T=r[1],S=r[2],C=!!r[3],se=T?Number(T):1,oe=Number(S);let O=`${se}d${oe}`;i==="-"&&(O=`-${O}`);const ae={type:"dice",isExplosive:C,value:O};y.push(ae);continue}if(/^\d+(\.\d+)?$/.exec(b)){let T=Number(b);i==="-"&&(T=-T),y.push({type:"constant",isExplosive:!1,value:T});continue}const I=b,A=e&&Object.prototype.hasOwnProperty.call(e,I)&&Number(e[I])||0,P=i==="-"?-A:A;y.push({type:"variable",value:P,isExplosive:!1,label:I})}return y},qe=t=>{let e="";return t.forEach((y,o)=>{const f=y.expressionMember;let s="";switch(f.type){case"dice":o>0&&!f.value.toString().startsWith("-")&&(s+="+ "),s+=`${f.value}${f.isExplosive?"e":""} [${y.result.map(i=>`<span class="${i.value===i.sides?"max":""}${i.value===1?"min":""}">`+i.value.toString()+(f.isExplosive&&i.value===i.sides?"ðŸ’¥":"")+"</span>").join(", ")}]`;break;case"constant":s=`${o>0&&f.value>=0?"+ ":""}${f.value}`;break;case"variable":s=`${o>0&&f.value>=0?"+ ":""}${f.label} [${f.value}]`;break}s.startsWith("-")&&(s=s.replace("-","- ")),e+=`${o>0?" ":""}${s}`}),e},pe=t=>{let e=0;return t.forEach(y=>{const o=y.expressionMember;switch(o.type){case"dice":e+=y.result.reduce((f,s)=>f+s.value,0)*(o.value.toString().startsWith("-")?-1:1);break;case"constant":e+=o.value;break;case"variable":e+=o.value;break}}),e},rt=t=>{const e=[];if(!t||!String(t).trim())return e;const y=String(t).trim(),o=/^[+-]/.test(y)?y:`+${y}`,f=/([+-])\s*([^+-]+)/g;let s;for(;(s=f.exec(o))!==null;){const b=s[1]==="+"?1:-1,r=(s[2]||"").trim();if(!r)continue;const E=r.match(/^(\d+)\s*d\s*(\d+)/i);if(E){const P=Number(E[1]),T=Number(E[2]),C=r.slice(E[0].length).trim()||null;e.push({kind:"dice",sign:b,n:P,faces:T,damageType:C,raw:r});continue}const I=r.match(/^(\d+)/);if(I){const P=Number(I[1]),S=r.slice(I[0].length).trim()||null;e.push({kind:"flat",sign:b,value:P,damageType:S,raw:r});continue}const A=r.match(/(\d+)\s*d\s*(\d+)/i);if(A){const P=Number(A[1]),T=Number(A[2]),S=r.replace(A[0],"").trim()||null;e.push({kind:"dice",sign:b,n:P,faces:T,damageType:S,raw:r});continue}e.push({kind:"flat",sign:b,value:0,damageType:r||null,raw:r})}return e.reduce((b,r)=>r.kind==="dice"?`${b} ${r.sign===1?"+":"-"} ${r.n}d${r.faces}`:r.kind==="flat"?`${b} ${r.sign===1?"+":"-"} ${r.value}`:b,"")},He=()=>{const t=Me;return{page:{subscribe:t.page.subscribe},navigating:{subscribe:t.navigating.subscribe},updated:t.updated}},Je={subscribe(t){return He().page.subscribe(t)}};Le(Je,t=>t.url.searchParams.get("mode")==="foundry");const je=()=>{const t=o=>{typeof window<"u"&&window.parent?window.parent.postMessage(o,"*"):console.warn("[Foundry Service] No se detectÃ³ la ventana padre (Foundry).")};return{broadcastRollResult:(o,f)=>{const s=[],i=[];o.forEach(E=>{const{type:I,value:A}=E.expressionMember,P=E.result;I==="dice"?(s.push(String(A)),Array.isArray(P)&&P.forEach(T=>{i.push(T.value)})):typeof P=="number"?s.push(String(P)):s.push(String(A))});const b=s.join(" + "),r={type:"PRECALCULATED_ROLL",formula:b,results:i,flavor:f};console.log(`[Foundry] Enviando: ${b} -> [${i}]`),t(r)},isInsideFoundry:()=>window.self!==window.top}},q="arcana:rollLogs:personal",H="arcana:rollLogs:party:",j=100,v={inited:!1,clearTimeoutId:null,roll3DDice:async()=>[],clear3DDices:()=>{},logs:J([]),rollModalOpened:J(!1),rollModalData:J(void 0)},$=ke(),V=Ge();let G=null,k=null,B=!1,Q=!1;const{broadcastRollResult:Ke,isInsideFoundry:fe}=je(),We=()=>{try{const t=(()=>{const f=V.getTarget();return f&&f.type==="party"?`${H}${f.partyId}`:q})(),e=localStorage.getItem(t),y=e?JSON.parse(e):[];return(Array.isArray(y)?y.slice(-j):y).map(f=>z(f))}catch(t){return console.error("Error loading roll logs:",t),[]}finally{v.logs.subscribe(async t=>{try{await Ye(t)}catch(e){console.error("[dice-roller-service] saveRollLogs subscription error:",e)}})}},Ye=async t=>{if(!B){if(Q){try{const y=(Array.isArray(t)?t.slice(-j):[]).map(f=>X(f)),o=(()=>{const f=V.getTarget();return f&&f.type==="party"?`${H}${f.partyId}`:q})();localStorage.setItem(o,JSON.stringify(y))}catch(e){console.error("[dice-roller-service] Error persisting locally during concurrent save:",e)}return}try{const e=Array.isArray(t)?t.slice(-j):[],y=e.filter(o=>o&&o.pending);for(const o of y)if(o&&!o.id)try{o.id=crypto.randomUUID()}catch{o.id=`local-${Date.now()}-${Math.floor(Math.random()*1e5)}`}if(G&&$.isEnabled()&&y.length>0)try{Q=!0;const o=y.map(s=>X(s));{const s=V.getTarget();if(s&&s.type==="party"){const i=x($.user),b={id:i?.uid,name:i?.displayName??i?.email??"Usuario",photoURL:i?.photoURL??void 0};await $.saveGroupRollLogsForParty(s.partyId,o,b)}else await $.saveRollLogsForUser(G,o)}const f=o.map(s=>s.id).filter(Boolean);if(f.length>0){v.logs.update(r=>Array.isArray(r)?r.map(E=>f.includes(E.id)?{...E,pending:!1}:E):r);const s=x(v.logs)||[],i=(Array.isArray(s)?s.slice(-j):[]).map(r=>X(r)),b=(()=>{const r=V.getTarget();return r&&r.type==="party"?`${H}${r.partyId}`:q})();localStorage.setItem(b,JSON.stringify(i))}}catch(o){console.error("[dice-roller-service] Cloud sync failed, falling back to localStorage:",o)}finally{Q=!1}try{const o=e.map(s=>X(s)),f=(()=>{const s=V.getTarget();return s&&s.type==="party"?`${H}${s.partyId}`:q})();localStorage.setItem(f,JSON.stringify(o))}catch(o){console.error("Error saving roll logs to localStorage:",o)}}catch(e){console.error("Error preparing roll logs for save:",e)}finally{Q=!1}}},le=async t=>U.STANDARD_DICES.some(y=>t.endsWith(y))&&!fe()?v.roll3DDice(t):new Promise(y=>{const[o,f]=t.split("d"),s=[];for(let i=0;i<Number(o);i++)s.push({value:Math.floor(Math.random()*Number(f))+1,sides:Number(f),dieType:"d"+f,groupId:0,rollId:i,theme:"default",themeColor:"#000000"});y(s)}),Xe=(t,e,y)=>{const o=pe(t),f={id:crypto.randomUUID(),timestamp:new Date,title:e||"Tirada rÃ¡pida",total:o,formattedTotal:y?y(o):void 0,pending:!0,detail:qe(t)},s=V.getTarget();if(s&&s.type==="party"){const i=x($.user);i?.uid&&(f.authorId=i.uid,f.authorName=i.displayName??i.email??void 0)}v.logs.update(i=>[...i,f].slice(-j))},ee=(t,e)=>{const y=new Map;for(const s of t)s&&s.id&&y.set(s.id,s);const o=new Map;for(const s of t)s&&s.id&&o.set(s.id,s);for(const s of e){const i=s.id;if(!i){const r=crypto.randomUUID();s.id=r,o.set(r,s);continue}if(s.pending){o.set(i,s);continue}const b=y.get(i);if(!b)o.set(i,s);else{const r=new Date(s.timestamp).getTime(),E=new Date(b.timestamp).getTime();!isNaN(r)&&!isNaN(E)?o.set(i,r>=E?s:b):o.set(i,s)}}return Array.from(o.values()).sort((s,i)=>new Date(s.timestamp).getTime()-new Date(i.timestamp).getTime()).slice(-j)},st=()=>{v.inited||(v.logs.set(We()),v.inited=!0,(async()=>{try{await $.initFirebase(),await $.onAuthState(async i=>{const b=G;if(G=i?i.uid:null,b&&b!==G&&k)try{k(),k=null}catch{}if(G&&$.isEnabled())try{{const r=V.getTarget();r&&r.type==="party"?k=$.listenGroupRollLogsForParty(r.partyId,E=>{B=!0;try{const I=(E||[]).map(T=>z(T)),A=x(v.logs)||[],P=ee(I,A);v.logs.set(P)}catch(I){console.error("[dice-roller-service] Error applying remote logs:",I)}finally{B=!1}}):k=$.listenRollLogsForUser(G,E=>{B=!0;try{const I=(E||[]).map(T=>z(T)),A=x(v.logs)||[],P=ee(I,A);v.logs.set(P)}catch(I){console.error("[dice-roller-service] Error applying remote logs:",I)}finally{B=!1}})}}catch(r){console.error("[dice-roller-service] Error starting remote listener:",r)}else try{const r=(()=>{const I=V.getTarget();return I&&I.type==="party"?`${H}${I.partyId}`:q})(),E=localStorage.getItem(r);if(E){const A=JSON.parse(E).map(P=>z(P));v.logs.set(A)}}catch(r){console.error("[dice-roller-service] Error loading local logs:",r)}})}catch(i){console.warn("[dice-roller-service] Firebase setup error (continuing with local logs):",i)}})(),V.target.subscribe(i=>{try{const b=i&&i.type==="party"?`${H}${i.partyId}`:q,r=localStorage.getItem(b);if(r){const I=JSON.parse(r).map(A=>z(A));v.logs.set(I)}else v.logs.set([])}catch{v.logs.set([])}if(k){try{k()}catch{}k=null}if(G&&$.isEnabled())try{i&&i.type==="party"?k=$.listenGroupRollLogsForParty(i.partyId,b=>{B=!0;try{const r=(b||[]).map(A=>z(A)),E=x(v.logs)||[],I=ee(r,E);v.logs.set(I)}catch(r){console.error("[dice-roller-service] Error applying remote logs:",r)}finally{B=!1}}):k=$.listenRollLogsForUser(G,b=>{B=!0;try{const r=(b||[]).map(A=>z(A)),E=x(v.logs)||[],I=ee(r,E);v.logs.set(I)}catch(r){console.error("[dice-roller-service] Error applying remote logs:",r)}finally{B=!1}})}catch(b){console.error("[dice-roller-service] Error starting remote listener:",b)}else try{const b=(()=>{const E=V.getTarget();return E&&E.type==="party"?`${H}${E.partyId}`:q})(),r=localStorage.getItem(b);if(r){const I=JSON.parse(r).map(A=>z(A));v.logs.set(I)}else v.logs.set([])}catch(b){console.error("[dice-roller-service] Error loading local logs:",b)}}));const t=({expression:i,variables:b={},title:r=void 0,resultFormatter:E=()=>{}})=>{v.rollModalData.set({expression:i,variables:b,title:r??"Tirar",rollType:"normal",extraModsExpression:"",resultFormatter:E}),v.rollModalOpened.set(!0)},e=async()=>{const i=x(v.rollModalData);if(v.rollModalData.set(void 0),v.rollModalOpened.set(!1),!i)return;let b=i.expression,r=i.title;i.rollType!=="normal"&&(b+=i.rollType==="advantage"?"+1d4":"-1d4",r+=i.rollType==="advantage"?" (ventaja)":" (desventaja)"),i?.extraModsExpression&&(b+=`+${i.extraModsExpression.trim()}`,b=b.replaceAll("++","+").replaceAll("+-","-")),o({expression:b,variables:i.variables,title:r})},y=()=>{v.rollModalOpened.set(!1),v.rollModalData.set(void 0)},o=async({expression:i,variables:b={},title:r=void 0,resultFormatter:E=()=>{}})=>{const I=ze(i,b);v.clearTimeoutId&&(clearTimeout(v.clearTimeoutId),v.clearTimeoutId=null),v.clear3DDices();const A=[];for(const P of I)P.type==="dice"?A.push({expressionMember:P,promise:le(P.value),result:void 0,explosionResolved:!1,numExplosions:0}):A.push({expressionMember:P,promise:void 0,result:P.value,explosionResolved:!0,numExplosions:0});for(;A.some(P=>P.result===void 0);){const P=[],T=A.filter(S=>S.expressionMember.type==="dice"&&S.result===void 0);for(const S of T)P.push((async()=>{S.result=await S.promise,S.promise=void 0;for(const C of S.result)S.expressionMember.isExplosive&&C.sides===C.value&&C.sides>1&&S.numExplosions++;if(S.numExplosions>0){const C={...S.expressionMember,value:`${S.numExplosions}d${S.result[0].sides}`};A.push({expressionMember:C,promise:le(C.value),result:void 0,explosionResolved:!1,numExplosions:0})}return S})());await Promise.all(P)}return v.clearTimeoutId=setTimeout(()=>{v.clear3DDices()},U.CLEAR_3D_DICES_DELAY),Xe(A,r,E),fe()&&(console.log("Broadcasting roll to Foundry..."),Ke(A,r)),pe(A)};return{rollExpression:o,register3DDiceRollerFn:i=>{v.roll3DDice=i},registerClear3DDicesFn:i=>{v.clear3DDices=i},rollLogs:v.logs,rollModal:{rollModalOpened:v.rollModalOpened,openRollModal:t,rollModalData:v.rollModalData,submitRollModal:e,abortRollModal:y}}};export{W as C,te as P,st as a,Ge as b,rt as p,ke as u};
