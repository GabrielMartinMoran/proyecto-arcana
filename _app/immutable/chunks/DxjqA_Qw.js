const nt=window;function ot(s,q,z={}){const c={tab:"	",indentOn:/[({\[]$/,moveToNewLine:/^[)}\]]/,spellcheck:!1,catchTab:!0,preserveIdent:!0,addClosing:!0,history:!0,window:nt,autoclose:{open:`([{'"`,close:`)]}'"`},...z},O=c.window,h=O.document,A=[],y=[];let l=-1,L=!1,T=()=>{},R;s.setAttribute("contenteditable","plaintext-only"),s.setAttribute("spellcheck",c.spellcheck?"true":"false"),s.style.outline="none",s.style.overflowWrap="break-word",s.style.overflowY="auto",s.style.whiteSpace="pre-wrap";const x=(t,e)=>{q(t,e)},H=O.navigator.userAgent.match(/Firefox\/([0-9]+)\./),X=H?parseInt(H[1]):0;let k=!1;(s.contentEditable!=="plaintext-only"||X>=136)&&(k=!0),k&&s.setAttribute("contenteditable","true");const Z=W(()=>{const t=d();x(s,t),f(t)},30);let M=!1;const P=t=>!F(t)&&!I(t)&&t.key!=="Meta"&&t.key!=="Control"&&t.key!=="Alt"&&!t.key.startsWith("Arrow"),J=W(t=>{P(t)&&(C(),M=!1)},300),b=(t,e)=>{A.push([t,e]),s.addEventListener(t,e)};b("keydown",t=>{t.defaultPrevented||(R=m(),c.preserveIdent?Y(t):U(t),c.catchTab&&G(t),c.addClosing&&$(t),c.history&&(Q(t),P(t)&&!M&&(C(),M=!0)),k&&!et(t)&&f(d()))}),b("keyup",t=>{t.defaultPrevented||t.isComposing||(R!==m()&&Z(),J(t),T(m()))}),b("focus",t=>{L=!0}),b("blur",t=>{L=!1}),b("paste",t=>{C(),v(t),C(),T(m())}),b("cut",t=>{C(),tt(t),C(),T(m())});function d(){const t=E(),e={start:0,end:0,dir:void 0};let{anchorNode:n,anchorOffset:o,focusNode:r,focusOffset:i}=t;if(!n||!r)throw"error1";if(n===s&&r===s)return e.start=o>0&&s.textContent?s.textContent.length:0,e.end=i>0&&s.textContent?s.textContent.length:0,e.dir=i>=o?"->":"<-",e;if(n.nodeType===Node.ELEMENT_NODE){const a=h.createTextNode("");n.insertBefore(a,n.childNodes[o]),n=a,o=0}if(r.nodeType===Node.ELEMENT_NODE){const a=h.createTextNode("");r.insertBefore(a,r.childNodes[i]),r=a,i=0}return V(s,a=>{if(a===n&&a===r)return e.start+=o,e.end+=i,e.dir=o<=i?"->":"<-","stop";if(a===n)if(e.start+=o,!e.dir)e.dir="->";else return"stop";else if(a===r)if(e.end+=i,!e.dir)e.dir="<-";else return"stop";a.nodeType===Node.TEXT_NODE&&(e.dir!="->"&&(e.start+=a.nodeValue.length),e.dir!="<-"&&(e.end+=a.nodeValue.length))}),s.normalize(),e}function f(t){const e=E();let n,o=0,r,i=0;if(t.dir||(t.dir="->"),t.start<0&&(t.start=0),t.end<0&&(t.end=0),t.dir=="<-"){const{start:u,end:g}=t;t.start=g,t.end=u}let a=0;V(s,u=>{if(u.nodeType!==Node.TEXT_NODE)return;const g=(u.nodeValue||"").length;if(a+g>t.start&&(n||(n=u,o=t.start-a),a+g>t.end))return r=u,i=t.end-a,"stop";a+=g}),n||(n=s,o=s.childNodes.length),r||(r=s,i=s.childNodes.length),t.dir=="<-"&&([n,o,r,i]=[r,i,n,o]);{const u=_(n);if(u){const w=h.createTextNode("");u.parentNode?.insertBefore(w,u),n=w,o=0}const g=_(r);if(g){const w=h.createTextNode("");g.parentNode?.insertBefore(w,g),r=w,i=0}}e.setBaseAndExtent(n,o,r,i),s.normalize()}function _(t){for(;t&&t!==s;){if(t.nodeType===Node.ELEMENT_NODE){const e=t;if(e.getAttribute("contenteditable")=="false")return e}t=t.parentNode}}function K(){const e=E().getRangeAt(0),n=h.createRange();return n.selectNodeContents(s),n.setEnd(e.startContainer,e.startOffset),n.toString()}function B(){const e=E().getRangeAt(0),n=h.createRange();return n.selectNodeContents(s),n.setStart(e.endContainer,e.endOffset),n.toString()}function Y(t){if(t.key==="Enter"){const e=K(),n=B();let[o]=j(e),r=o;if(c.indentOn.test(e)&&(r+=c.tab),r.length>0?(p(t),t.stopPropagation(),N(`
`+r)):U(t),r!==o&&c.moveToNewLine.test(n)){const i=d();N(`
`+o),f(i)}}}function U(t){if(k&&t.key==="Enter")if(p(t),t.stopPropagation(),B()==""){N(`
 `);const e=d();e.start=--e.end,f(e)}else N(`
`)}function $(t){const e=c.autoclose.open,n=c.autoclose.close;if(e.includes(t.key)){p(t);const o=d(),r=o.start==o.end?"":E().toString(),i=t.key+r+(n[e.indexOf(t.key)]??"");N(i),o.start++,o.end++,f(o)}}function G(t){if(t.key==="Tab")if(p(t),t.shiftKey){const e=K();let[n,o]=j(e);if(n.length>0){const r=d(),i=Math.min(c.tab.length,n.length);f({start:o,end:o+i}),h.execCommand("delete"),r.start-=i,r.end-=i,f(r)}}else N(c.tab)}function Q(t){if(F(t)){p(t),l--;const e=y[l];e&&(s.innerHTML=e.html,f(e.pos)),l<0&&(l=0)}if(I(t)){p(t),l++;const e=y[l];e&&(s.innerHTML=e.html,f(e.pos)),l>=y.length&&l--}}function C(){if(!L)return;const t=s.innerHTML,e=d(),n=y[l];if(n&&n.html===t&&n.pos.start===e.start&&n.pos.end===e.end)return;l++,y[l]={html:t,pos:e},y.splice(l+1);const o=300;l>o&&(l=o,y.splice(0,1))}function v(t){if(t.defaultPrevented)return;p(t);const n=(t.originalEvent??t).clipboardData.getData("text/plain").replace(/\r\n?/g,`
`),o=d();N(n),x(s),f({start:Math.min(o.start,o.end)+n.length,end:Math.min(o.start,o.end)+n.length,dir:"<-"})}function tt(t){const e=d(),n=E();(t.originalEvent??t).clipboardData.setData("text/plain",n.toString()),h.execCommand("delete"),x(s),f({start:Math.min(e.start,e.end),end:Math.min(e.start,e.end),dir:"<-"}),p(t)}function V(t,e){const n=[];t.firstChild&&n.push(t.firstChild);let o=n.pop();for(;o&&e(o)!=="stop";)o.nextSibling&&n.push(o.nextSibling),o.firstChild&&n.push(o.firstChild),o=n.pop()}function S(t){return t.metaKey||t.ctrlKey}function F(t){return S(t)&&!t.shiftKey&&D(t)==="Z"}function I(t){return S(t)&&t.shiftKey&&D(t)==="Z"}function et(t){return S(t)&&D(t)==="C"}function D(t){let e=t.key||t.keyCode||t.which;if(e)return(typeof e=="string"?e:String.fromCharCode(e)).toUpperCase()}function N(t){t=t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;"),h.execCommand("insertHTML",!1,t)}function W(t,e){let n=0;return(...o)=>{clearTimeout(n),n=O.setTimeout(()=>t(...o),e)}}function j(t){let e=t.length-1;for(;e>=0&&t[e]!==`
`;)e--;e++;let n=e;for(;n<t.length&&/[ \t]/.test(t[n]);)n++;return[t.substring(e,n)||"",e,n]}function m(){return s.textContent||""}function p(t){t.preventDefault()}function E(){return s.getRootNode().getSelection()}return{updateOptions(t){Object.assign(c,t)},updateCode(t,e=!0){s.textContent=t,x(s),e&&T(t)},onUpdate(t){T=t},toString:m,save:d,restore:f,recordHistory:C,destroy(){for(let[t,e]of A)s.removeEventListener(t,e)}}}export{ot as CodeJar};
