const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./lCNLHSrR.js","./C4c6zY-H.js","./yBjK6igh.js","./x4_yyNok.js"])))=>i.map(i=>d[i]);
import{_ as S}from"./PPVm8Dsz.js";import{C as k}from"./CyC3GOE6.js";import{w as z,g as N,d as Oe}from"./CDyK6DUB.js";import{s as Fe}from"./ChmArcVQ.js";const xe=r=>{if(r&&typeof r.toDate=="function")try{return r.toDate()}catch{}if(r instanceof Date)return r;if(typeof r=="string"||typeof r=="number"){const e=new Date(r);if(!isNaN(e.getTime()))return e}if(r&&typeof r=="object"){const e=typeof r.seconds=="number"?r.seconds:typeof r._seconds=="number"?r._seconds:null;if(typeof e=="number")return new Date(e*1e3)}return new Date},G=r=>({...r,timestamp:xe(r.timestamp)}),Z=r=>({...r,timestamp:r.timestamp.toISOString()}),Ne=(r,e)=>{if(!r)return 0;const p=r.trim();try{const a=new Function("cuerpo","reflejos","mente","instinto","presencia","ppGastados","floor","ceil","round","Math",`return (${p});`);return Number(a(Number(e.cuerpo)||0,Number(e.reflejos)||0,Number(e.mente)||0,Number(e.instinto)||0,Number(e.presencia)||0,Number(e.ppGastados)||0,Math.floor,Math.ceil,Math.round,Math))||0}catch(a){return console.error("Error evaluating modifier expression:",a),0}},Ce=(r,e)=>Ne(r,{cuerpo:e.attributes.body,reflejos:e.attributes.reflexes,mente:e.attributes.mind,instinto:e.attributes.instinct,presencia:e.attributes.presence,ppGastados:e.spentPP,floor:Math.floor,ceil:Math.ceil,round:Math.round,Math});class W{id;name;attributes;cards;ppHistory;goldHistory;equipment;modifiers;currentHP;tempHP;currentLuck;img;story;notes;languages;quickInfo;attacks;maxActiveCards;version;party;constructor(e){this.id=e.id,this.name=e.name,this.attributes=e.attributes,this.cards=e.cards,this.ppHistory=e.ppHistory,this.goldHistory=e.goldHistory,this.equipment=e.equipment,this.modifiers=e.modifiers,this.currentHP=e.currentHP,this.tempHP=e.tempHP,this.currentLuck=e.currentLuck,this.img=e.img,this.party=e.party??{partyId:null,ownerId:null},this.story=e.story,this.notes=e.notes,this.languages=e.languages,this.quickInfo=e.quickInfo,this.attacks=e.attacks,this.maxActiveCards=e.maxActiveCards,this.version=e.version}calculateAttrModifiers(e,p){let a=p;const f=this.modifiers.filter(s=>s.attribute===e);for(const s of f){const o=Ce(s.formula,this);if(s.type==="set")return o;s.type==="add"&&(a+=o)}return a}get maxLuck(){const e=k.MAX_LUCK;return this.calculateAttrModifiers("maxLuck",e)}get maxHP(){const e=k.BASE_HEALTH+this.attributes.body*k.HEALTH_BODY_MULTIPIER;return this.calculateAttrModifiers("maxHP",e)}get speed(){const e=k.BASE_SPEED+this.attributes.reflexes;return this.calculateAttrModifiers("speed",e)}get evasion(){const e=k.BASE_EVASION+this.attributes.reflexes;return this.calculateAttrModifiers("evasion",e)}get physicalMitigation(){return this.calculateAttrModifiers("physicalMitigation",0)}get magicalMitigation(){return this.calculateAttrModifiers("magicalMitigation",0)}get currentGold(){const e=this.goldHistory.filter(a=>a.type==="add").reduce((a,f)=>a+f.value,0),p=this.spentGold;return p>0?e-p:e}get spentGold(){return this.goldHistory.filter(e=>e.type==="subtract").reduce((e,p)=>e+p.value,0)}get currentPP(){const e=this.ppHistory.filter(a=>a.type==="add").reduce((a,f)=>a+f.value,0),p=this.spentPP;return p>0?e-p:e}get spentPP(){return this.ppHistory.filter(e=>e.type==="subtract").reduce((e,p)=>e+p.value,0)}get pjPower(){const e=this.cards.map(f=>f.level).sort((f,s)=>s-f).slice(0,k.TOP_N_CARDS_TO_CALCULATE_PJ_POWER);console.log(e);const p=e.reduce((f,s)=>f+s,0)/e.length,a=this.spentPP/k.PJ_POWER_SPENT_PP_DIVIDER;return Math.round(p+a)}get tier(){for(const e of k.CHARACTER_TIERS)if(this.spentPP>=e.minPP&&this.spentPP<=e.maxPP)return e.tier;return 0}get numActiveCards(){return this.cards.filter(e=>e.isActive).length}get initiative(){return this.attributes.reflexes}copy(){return new W({...this})}getExportableData(){return{...this,party:{partyId:null,ownerId:null}}}}class re{id;name;ownerId;notes;members;characters;unsubscribeCharacterListener;constructor(e){this.id=e?.id??"",this.name=e?.name??"",this.ownerId=e?.ownerId??"",this.notes=Array.isArray(e?.notes)?e.notes:[],this.members=e?.members&&typeof e.members=="object"?e.members:{},this.characters=e?.characters??[],this.unsubscribeCharacterListener=e?.unsubscribeCharacterListener??(()=>{})}getAllCharacterIds(){const e=[];for(const p of Object.keys(this.members)){const a=this.members[p]??[];for(const f of a)e.includes(f)||e.push(f)}return e}getCharactersFullIdentifiers(){const e=[];for(const p of Object.keys(this.members)){const a=this.members[p]??[];for(const f of a)e.push({userId:p,characterId:f})}return e}isAccessible(e){return this.ownerId===e||this.members[e]?.length>0}copy(){const e=JSON.parse(JSON.stringify(this.asPlain())),p=new re(e);return p.characters=this.characters.filter(a=>a.party.partyId===this.id&&p.getAllCharacterIds().includes(a.id)),p.unsubscribeCharacterListener=this.unsubscribeCharacterListener,p}asPlain(){return{id:this.id,name:this.name,ownerId:this.ownerId,notes:this.notes,members:this.members}}}var Q={VITE_FIREBASE_MESSAGING_SENDER_ID:"647852941329",VITE_FIREBASE_STORAGE_BUCKET:"arcana-85eeb.firebasestorage.app",VITE_FIREBASE_AUTH_DOMAIN:"arcana-85eeb.firebaseapp.com",VITE_FIREBASE_PROJECT_ID:"arcana-85eeb",VITE_FIREBASE_APP_ID:"1:647852941329:web:f2aa1e9dd6792f6a9d91b0",VITE_FIREBASE_API_KEY:"AIzaSyAFv5lor5ufY-KPBQ166rPSRnscFrtm88w"};function M(){return typeof window<"u"}function $e(){if(typeof Q>"u")return null;const r=typeof Q=="string"?JSON.parse(Q):Q;return r.VITE_FIREBASE_API_KEY?{apiKey:r.VITE_FIREBASE_API_KEY,authDomain:r.VITE_FIREBASE_AUTH_DOMAIN,projectId:r.VITE_FIREBASE_PROJECT_ID,storageBucket:r.VITE_FIREBASE_STORAGE_BUCKET,messagingSenderId:r.VITE_FIREBASE_MESSAGING_SENDER_ID,appId:r.VITE_FIREBASE_APP_ID}:null}function Ue(){let r=null,e=null,p=!1,a=null,f=0,s=0,o=null;const n=()=>{if(!o)try{o=setTimeout(()=>{o=null;try{console.debug("[firebase-service] ops:",{reads:f,writes:s})}catch{}},1e3)}catch{}},t=(u=1)=>{f+=u,n()},w=(u=1)=>{s+=u,n()},_=z(!1),v=z(null);async function P(){if(p)return;if(p=!0,!M()){_.set(!1);return}const u=$e()??null;if(!u)throw _.set(!1),new Error("Firebase configuration missing: VITE_FIREBASE_* variables required.");try{const{initializeApp:i,getApps:d}=await S(async()=>{const{initializeApp:E,getApps:y}=await import("./lCNLHSrR.js");return{initializeApp:E,getApps:y}},__vite__mapDeps([0,1]),import.meta.url),l=await S(()=>import("./yBjK6igh.js"),__vite__mapDeps([2,1]),import.meta.url),m=await S(()=>import("./x4_yyNok.js"),__vite__mapDeps([3,1]),import.meta.url);d&&d().length===0&&i(u),r=l.getAuth(),e=m.getFirestore(),l.onAuthStateChanged(r,E=>{const y=E?{uid:E.uid,displayName:E.displayName,email:E.email,photoURL:E.photoURL}:null;v.set(y)}),_.set(!0)}catch(i){throw _.set(!1),console.error("[firebase-service] Initialization error:",i),i}}async function D(){if(a)return a;a=P();try{await a}finally{a=null}}function T(){let u=!1;return _.subscribe(i=>{u=i})(),u&&!!r&&!!e}async function C(){if(!M())return null;await D();const{GoogleAuthProvider:u,signInWithPopup:i}=await S(async()=>{const{GoogleAuthProvider:y,signInWithPopup:h}=await import("./yBjK6igh.js");return{GoogleAuthProvider:y,signInWithPopup:h}},__vite__mapDeps([2,1]),import.meta.url),d=new u;d.setCustomParameters({prompt:"select_account"});const m=(await i(r,d)).user;if(!m)return null;const E={uid:m.uid,displayName:m.displayName,email:m.email,photoURL:m.photoURL};return v.set(E),E}async function oe(){if(!M())return;await D();const{signOut:u}=await S(async()=>{const{signOut:i}=await import("./yBjK6igh.js");return{signOut:i}},__vite__mapDeps([2,1]),import.meta.url);await u(r),v.set(null)}async function ae(u){if(!M())return u(null),()=>{};await D();const{onAuthStateChanged:i}=await S(async()=>{const{onAuthStateChanged:l}=await import("./yBjK6igh.js");return{onAuthStateChanged:l}},__vite__mapDeps([2,1]),import.meta.url);return i(r,l=>{const m=l?{uid:l.uid,displayName:l.displayName,email:l.email,photoURL:l.photoURL}:null;v.set(m),u(m)})}async function O(){if(await D(),!e)throw new Error("Firestore not initialized")}async function ne(u,i){if(!u)throw new Error("userId required");if(!M())return;await O();const{doc:d,writeBatch:l,getDoc:m}=await S(async()=>{const{doc:c,writeBatch:g,getDoc:b}=await import("./x4_yyNok.js");return{doc:c,writeBatch:g,getDoc:b}},__vite__mapDeps([3,1]),import.meta.url);let E=i.map(c=>JSON.parse(JSON.stringify(c||{})));const y=E.filter(c=>!c||typeof c.id!="string"||c.id.trim()==="");if(y.length>0&&console.warn("[firebase-service] saveCharactersForUser: skipping characters without valid id:",y.map(c=>c&&c.id)),E=E.filter(c=>c&&typeof c.id=="string"&&c.id.trim()!==""),E.length===0)return;try{const c=new Set;for(const g of E){const b=(g?.party&&g.party.partyId)??g?.partyId??null;b&&c.add(b)}if(c.size>0){const g=new Map;for(const b of c)try{const I=await m(d(e,"parties",b));t();let R;I&&typeof I.exists=="function"&&I.exists()?R=I.data():R=void 0,g.set(b,R?R.ownerId??null:null)}catch(I){console.warn("[firebase-service] Failed to read party for denormalization",b,I),g.set(b,null)}for(const b of E){const I=(b?.party&&b.party.partyId)??b?.partyId??null;b.party?I?(b.party.partyId=I,b.party.ownerId=g.get(I)??null):b.party={partyId:null,ownerId:null}:b.party={partyId:I??null,ownerId:I?g.get(I)??null:null}}}else for(const g of E)g.party?g.party.ownerId=g.party.ownerId??null:g.party={partyId:null,ownerId:null}}catch(c){console.warn("[firebase-service] Party denormalization step failed:",c);for(const g of E)g.party?g.party.ownerId=g.party.ownerId??null:g.party={partyId:null,ownerId:null}}const h=3;for(let c=1;c<=h;c++)try{for(const b of E)if(!(!b||!b.id||typeof b.id!="string"))try{const I=d(e,"users",u,"characters",b.id),R=await m(I);if(t(),R&&R.exists()){const L=R.data()||{},F=(L?.party&&L.party.partyId)??L?.partyId??null,K=(b?.party&&b.party.partyId)??b?.partyId??null;if(F&&(!K||K!==F))try{await ce(F,u,b.id)}catch(ie){console.warn("[firebase-service] best-effort removePartyMember failed for",{prevPartyId:F,userId:u,cid:b.id,err:ie})}}}catch(I){console.warn("[firebase-service] failed to read existing character doc (continuing):",b?.id,I)}const g=l(e);for(const b of E){if(!b||!b.id||typeof b.id!="string")continue;const I=d(e,"users",u,"characters",b.id);g.set(I,b,{merge:!0})}await g.commit(),w(E.length);return}catch(g){if(console.error(`[firebase-service] saveCharactersForUser attempt ${c} failed:`,g),c===h)throw g;await new Promise(b=>setTimeout(b,200*c))}}async function ge(u,i){if(!u)throw new Error("userId required");if(!i)throw new Error("characterId required");if(!M())return;await O();const{doc:d,deleteDoc:l}=await S(async()=>{const{doc:m,deleteDoc:E}=await import("./x4_yyNok.js");return{doc:m,deleteDoc:E}},__vite__mapDeps([3,1]),import.meta.url);await l(d(e,"users",u,"characters",i)),w()}async function he(u){if(!u)throw new Error("userId required");if(!M())return[];await O();const{collection:i,getDocs:d}=await S(async()=>{const{collection:y,getDocs:h}=await import("./x4_yyNok.js");return{collection:y,getDocs:h}},__vite__mapDeps([3,1]),import.meta.url),l=i(e,"users",u,"characters"),m=await d(l);t(m?.size??0);const E=[];return m.forEach(y=>{const h=y.data();E.push(new W(h))}),E}function be(u,i){if(!M())return i([]),()=>{};let d=()=>{};return(async()=>{try{await O();const{collection:l,onSnapshot:m}=await S(async()=>{const{collection:y,onSnapshot:h}=await import("./x4_yyNok.js");return{collection:y,onSnapshot:h}},__vite__mapDeps([3,1]),import.meta.url),E=l(e,"users",u,"characters");d=m(E,y=>{t(y?.size??0);const h=[];y.forEach(c=>{h.push(new W(c.data()))}),i(h)},y=>{console.error("[firebase-service] listenCharactersForUser snapshot error:",y),i([])})}catch(l){console.error("[firebase-service] listenCharactersForUser setup error:",l),i([])}})(),()=>{try{d&&d()}catch{}}}async function we(u){if(!u||!M())return null;await O();const{doc:i,getDoc:d}=await S(async()=>{const{doc:l,getDoc:m}=await import("./x4_yyNok.js");return{doc:l,getDoc:m}},__vite__mapDeps([3,1]),import.meta.url);try{const l=await d(i(e,"parties",u));if(t(),!l.exists())return null;const m=l.data();return new re(m)}catch(l){return console.error("[firebase-service] loadParty failed:",l),null}}async function Ee(u,i,d){if(!u)throw new Error("partyId required");if(!i)throw new Error("userId required");if(!d)throw new Error("characterId required");if(!M())return;await O();const{doc:l,runTransaction:m,getDoc:E,updateDoc:y,setDoc:h}=await S(async()=>{const{doc:g,runTransaction:b,getDoc:I,updateDoc:R,setDoc:L}=await import("./x4_yyNok.js");return{doc:g,runTransaction:b,getDoc:I,updateDoc:R,setDoc:L}},__vite__mapDeps([3,1]),import.meta.url),c=l(e,"parties",u);try{await m(e,async g=>{const b=await g.get(c);if(t(),!b||!b.exists()){const F={};F[i]=[d],g.set(c,{members:F},{merge:!0}),w();return}const I=b.data()||{},R=I.members&&typeof I.members=="object"?I.members:{},L=Array.isArray(R[i])?R[i].slice():[];if(!L.includes(d)){L.push(d);const F={};F[`members.${i}`]=L,g.update(c,F),w()}})}catch(g){console.error("[firebase-service] setPartyMember transaction failed:",g);try{const b=await E(c);if(t(),!b||!b.exists()){await h(c,{members:{[i]:[d]}},{merge:!0}),w();return}const I=b.data()||{},R=I.members&&typeof I.members=="object"?I.members:{},L=Array.isArray(R[i])?R[i].slice():[];L.includes(d)||(L.push(d),await y(c,{[`members.${i}`]:L}),w())}catch(b){throw console.error("[firebase-service] setPartyMember fallback failed:",b),g}}}async function ce(u,i,d){if(!u)throw new Error("partyId required");if(!i)throw new Error("userId required");if(!d)throw new Error("characterId required");if(!M())return;await O();const{doc:l,runTransaction:m,getDoc:E,updateDoc:y,deleteField:h}=await S(async()=>{const{doc:g,runTransaction:b,getDoc:I,updateDoc:R,deleteField:L}=await import("./x4_yyNok.js");return{doc:g,runTransaction:b,getDoc:I,updateDoc:R,deleteField:L}},__vite__mapDeps([3,1]),import.meta.url),c=l(e,"parties",u);try{await m(e,async g=>{const b=await g.get(c);if(t(),!b||!b.exists())return;const I=b.data()||{},R=I.members&&typeof I.members=="object"?I.members:{},L=Array.isArray(R[i])?R[i].slice():[],F=L.indexOf(d);F!==-1&&(L.splice(F,1),L.length===0?(g.update(c,{[`members.${i}`]:h()}),w()):(g.update(c,{[`members.${i}`]:L}),w()))})}catch(g){console.error("[firebase-service] removePartyMember transaction failed:",g);try{const{deleteField:b}=await S(async()=>{const{deleteField:ie}=await import("./x4_yyNok.js");return{deleteField:ie}},__vite__mapDeps([3,1]),import.meta.url),I=await E(c);if(t(),!I||!I.exists())return;const R=I.data()||{},L=R.members&&typeof R.members=="object"?R.members:{},F=Array.isArray(L[i])?L[i].slice():[],K=F.indexOf(d);K!==-1&&(F.splice(K,1),F.length===0?(await y(c,{[`members.${i}`]:b()}),w()):(await y(c,{[`members.${i}`]:F}),w()))}catch(b){throw console.error("[firebase-service] removePartyMember fallback failed:",b),g}}}async function _e(u){if(!u||!u.id)throw new Error("party.id required");if(!M())return;await O();const{doc:i,setDoc:d}=await S(async()=>{const{doc:E,setDoc:y}=await import("./x4_yyNok.js");return{doc:E,setDoc:y}},__vite__mapDeps([3,1]),import.meta.url),l=u.asPlain(),m=3;for(let E=1;E<=m;E++)try{await d(i(e,"parties",l.id),l,{merge:!0}),w();return}catch(y){if(console.error(`[firebase-service] saveParty attempt ${E} failed for party ${l.id} owner=${l.ownerId}:`,y),E===m){try{console.error("[firebase-service] saveParty giving up after max attempts for party:",JSON.stringify(l))}catch(h){console.error("[firebase-service] saveParty could not stringify party payload",h)}throw y}await new Promise(h=>setTimeout(h,200*E))}}async function ve(u){if(!u)throw new Error("partyId required");if(!M())return;await O();const{doc:i,deleteDoc:d}=await S(async()=>{const{doc:l,deleteDoc:m}=await import("./x4_yyNok.js");return{doc:l,deleteDoc:m}},__vite__mapDeps([3,1]),import.meta.url);await d(i(e,"parties",u)),w()}function Ie(u,i){if(!M())return i([]),()=>{};let d=()=>{};return(async()=>{try{await O();const{collection:l,onSnapshot:m}=await S(async()=>{const{collection:y,onSnapshot:h}=await import("./x4_yyNok.js");return{collection:y,onSnapshot:h}},__vite__mapDeps([3,1]),import.meta.url),E=l(e,"parties");d=m(E,y=>{try{t(y?.size??0)}catch{}const h=[];y.forEach(c=>{const g=c.data();if(!g)return;g.id=c.id;const b=g.ownerId===u,I=g.members&&typeof g.members=="object"&&Array.isArray(g.members[u])&&g.members[u].length>0;(b||I)&&h.push(new re(g))}),i(h)},y=>{console.error("[firebase-service] listenToUserParties error:",y),i([])})}catch(l){console.error("[firebase-service] listenToUserParties setup error:",l),i([])}})(),()=>{try{d&&d()}catch{}}}async function Ae(u,i){if(!u)throw new Error("userId required");if(!M())return;await O();const{doc:d,writeBatch:l}=await S(async()=>{const{doc:y,writeBatch:h}=await import("./x4_yyNok.js");return{doc:y,writeBatch:h}},__vite__mapDeps([3,1]),import.meta.url),m=i.map(y=>JSON.parse(JSON.stringify(y||{}))),E=3;for(let y=1;y<=E;y++)try{const h=l(e);for(const c of m){const g=d(e,"users",u,"rollLogs",c.id);h.set(g,c,{merge:!0})}await h.commit(),w(m.length);return}catch(h){if(console.error(`[firebase-service] saveRollLogsForUser attempt ${y} failed:`,h),y===E)throw h;await new Promise(c=>setTimeout(c,200*y))}}async function Pe(u,i,d){if(!u)throw new Error("partyId required");if(!M())return;await O();const{doc:l,writeBatch:m}=await S(async()=>{const{doc:h,writeBatch:c}=await import("./x4_yyNok.js");return{doc:h,writeBatch:c}},__vite__mapDeps([3,1]),import.meta.url),E=i.map(h=>{const c=JSON.parse(JSON.stringify(h||{}));return d&&(d.id&&(c.authorId=d.id),d.name&&(c.authorName=d.name),d.photoURL&&(c.authorPhotoURL=d.photoURL)),c}),y=3;for(let h=1;h<=y;h++)try{const c=m(e);for(const g of E){const b=l(e,"parties",u,"rollLogs",g.id);c.set(b,g,{merge:!0})}await c.commit(),w(E.length);return}catch(c){if(console.error(`[firebase-service] saveGroupRollLogsForParty attempt ${h} failed:`,c),h===y)throw c;await new Promise(g=>setTimeout(g,200*h))}}function Te(u,i){if(!M())return i([]),()=>{};let d=()=>{};return(async()=>{try{await O();const{collection:l,onSnapshot:m}=await S(async()=>{const{collection:y,onSnapshot:h}=await import("./x4_yyNok.js");return{collection:y,onSnapshot:h}},__vite__mapDeps([3,1]),import.meta.url),E=l(e,"parties",u,"rollLogs");d=m(E,y=>{t(y?.size??0);const h=[];y.forEach(c=>{const g={...c.data()||{},id:c.id};h.push(g)}),i(h)},y=>{console.error("[firebase-service] listenGroupRollLogsForParty snapshot error:",y),i([])})}catch(l){console.error("[firebase-service] listenGroupRollLogsForParty setup error:",l),i([])}})(),()=>{try{d&&d()}catch{}}}async function De(u,i){if(!u)throw new Error("partyId required");if(!i)throw new Error("logId required");if(!M())return;await O();const{doc:d,deleteDoc:l}=await S(async()=>{const{doc:m,deleteDoc:E}=await import("./x4_yyNok.js");return{doc:m,deleteDoc:E}},__vite__mapDeps([3,1]),import.meta.url);await l(d(e,"parties",u,"rollLogs",i)),w()}async function Re(u){if(!u)throw new Error("userId required");if(!M())return[];await O();const{collection:i,getDocs:d}=await S(async()=>{const{collection:y,getDocs:h}=await import("./x4_yyNok.js");return{collection:y,getDocs:h}},__vite__mapDeps([3,1]),import.meta.url),l=i(e,"users",u,"rollLogs"),m=await d(l);t(m?.size??0);const E=[];return m.forEach(y=>E.push({...y.data()||{},id:y.id})),E}function Se(u,i){if(!M())return i([]),()=>{};let d=()=>{};return(async()=>{try{await O();const{collection:l,onSnapshot:m}=await S(async()=>{const{collection:y,onSnapshot:h}=await import("./x4_yyNok.js");return{collection:y,onSnapshot:h}},__vite__mapDeps([3,1]),import.meta.url),E=l(e,"users",u,"rollLogs");d=m(E,y=>{t(y?.size??0);const h=[];y.forEach(c=>{const g={...c.data()||{},id:c.id};h.push(g)}),i(h)},y=>{console.error("[firebase-service] listenRollLogsForUser snapshot error:",y),i([])})}catch(l){console.error("[firebase-service] listenRollLogsForUser setup error:",l),i([])}})(),()=>{try{d&&d()}catch{}}}async function Le(u,i){if(!u)throw new Error("userId required");if(!i)throw new Error("logId required");if(!M())return;await O();const{doc:d,deleteDoc:l}=await S(async()=>{const{doc:m,deleteDoc:E}=await import("./x4_yyNok.js");return{doc:m,deleteDoc:E}},__vite__mapDeps([3,1]),import.meta.url);await l(d(e,"users",u,"rollLogs",i)),w()}const X={};function le(u,i){if(!M())return()=>{};const d=`${u.userId}/${u.characterId}`;let l=X[d];if(l||(l={subscribers:new Set,unsubscribe:null,latest:null},X[d]=l),l.subscribers.add(i),l.unsubscribe||(async()=>{try{await O();const{doc:m,onSnapshot:E}=await S(async()=>{const{doc:h,onSnapshot:c}=await import("./x4_yyNok.js");return{doc:h,onSnapshot:c}},__vite__mapDeps([3,1]),import.meta.url),y=m(e,"users",u.userId,"characters",u.characterId);l.unsubscribe=E(y,h=>{if(t(),h&&h.exists()){const c=h.data()||{};c.id||(c.id=h.id),l.latest=new W(c)}else l.latest=null;for(const c of Array.from(l.subscribers))try{c(l.latest)}catch(g){console.error("[firebase-service] subscribeCharacter subscriber error:",g)}},h=>{console.error("[firebase-service] subscribeCharacter snapshot error for",d,h)})}catch(m){console.error("[firebase-service] subscribeCharacter setup error for",d,m)}})(),l.latest!==null)try{i(l.latest)}catch(m){console.error("[firebase-service] subscribeCharacter immediate callback error:",m)}return()=>{const m=X[d];if(m&&(m.subscribers.delete(i),m.subscribers.size===0)){try{m.unsubscribe&&m.unsubscribe()}catch{}delete X[d]}}}function Me(u,i){if(!M())return i([]),()=>{};const d={},l=[];for(const m of u){if(!m||!m.userId||!m.characterId)continue;const E=`${m.userId}/${m.characterId}`,y=le(m,h=>{d[E]=h;const c=[];for(const g of Object.keys(d)){const b=d[g];b&&c.push(b)}try{i(c)}catch(g){console.error("[firebase-service] listenCharactersByIds callback error:",g)}});l.push(y)}return()=>{for(const m of l)try{m()}catch{}}}return{firebaseReady:_,user:v,initFirebase:D,isEnabled:T,signInWithGoogle:C,signOutUser:oe,onAuthState:ae,saveCharactersForUser:ne,loadCharactersForUser:he,deleteCharacterForUser:ge,listenCharactersForUser:be,saveParty:_e,deleteParty:ve,loadParty:we,listenToUserParties:Ie,setPartyMember:Ee,removePartyMember:ce,subscribeCharacter:le,listenCharactersByIds:Me,saveRollLogsForUser:Ae,loadRollLogsForUser:Re,deleteRollLogForUser:Le,listenRollLogsForUser:Se,saveGroupRollLogsForParty:Pe,deleteGroupRollLogForParty:De,listenGroupRollLogsForParty:Te,getReadCount:()=>f,getWriteCount:()=>s,resetOpCounters:()=>{f=0,s=0},getOpCounters:()=>({reads:f,writes:s})}}const ke=Ue();function Ve(){return ke}const pe="arcana:rollTarget";function fe(){return typeof window<"u"}function se(r){return typeof r=="string"&&r.trim().length>0}function Be(r){return!r||typeof r!="object"?null:r.type==="party"&&se(r.partyId)?{type:"party",partyId:r.partyId,partyName:se(r.partyName)?r.partyName:void 0}:{type:"personal"}}function He(r){if(fe())try{localStorage.setItem(pe,JSON.stringify(r))}catch(e){console.warn("[roll-target-service] failed to persist target",e)}}function Ge(){if(!fe())return null;try{const r=localStorage.getItem(pe);if(!r)return null;const e=JSON.parse(r);return Be(e)}catch(r){return console.warn("[roll-target-service] failed to load target",r),null}}const x={inited:!1,target:z({type:"personal"}),unsub:null};function qe(){if(!x.inited){x.inited=!0;const n=Ge();n&&x.target.set(n),x.unsub=x.target.subscribe(t=>He(t))}const r=()=>{x.target.set({type:"personal"})},e=(n,t)=>{if(!se(n)){console.warn("[roll-target-service] setPartyTarget called with invalid partyId, falling back to personal"),x.target.set({type:"personal"});return}const w={type:"party",partyId:n.trim()};se(t)&&(w.partyName=t.trim()),x.target.set(w)},p=n=>{try{const t=N(x.target);t.type==="party"&&(Array.isArray(n)&&n.includes(t.partyId)||x.target.set({type:"personal"}))}catch(t){console.warn("[roll-target-service] reconcileAccessibility error",t)}},a=()=>N(x.target),f=()=>N(x.target).type==="personal",s=()=>N(x.target).type==="party",o=()=>{const n=N(x.target);return n.type==="party"?n.partyId:null};return{target:x.target,setPersonalTarget:r,setPartyTarget:e,reconcileAccessibility:p,getTarget:a,isPersonalTarget:f,isPartyTarget:s,getPartyId:o,cleanup:()=>{if(x.unsub){try{x.unsub()}catch{}x.unsub=null}}}}const Je=(r,e)=>{if(!r)return[];const p=[],a=r.replace(/\s+/g,""),f=/([+-]?)(\d*d\d+(?:[eE])?|\d+(\.\d+)?|[A-Za-z_][A-Za-z0-9_]*)/g;let s;for(;(s=f.exec(a))!==null;){const o=s[1]||"+",n=s[2],t=/^(\d*)[dD](\d+)([eE])?$/.exec(n);if(t){const D=t[1],T=t[2],C=!!t[3],oe=D?Number(D):1,ae=Number(T);let O=`${oe}d${ae}`;o==="-"&&(O=`-${O}`);const ne={type:"dice",isExplosive:C,value:O};p.push(ne);continue}if(/^\d+(\.\d+)?$/.exec(n)){let D=Number(n);o==="-"&&(D=-D),p.push({type:"constant",isExplosive:!1,value:D});continue}const _=n,v=e&&Object.prototype.hasOwnProperty.call(e,_)&&Number(e[_])||0,P=o==="-"?-v:v;p.push({type:"variable",value:P,isExplosive:!1,label:_})}return p},ze=r=>{let e="";return r.forEach((p,a)=>{const f=p.expressionMember;let s="";switch(f.type){case"dice":a>0&&!f.value.toString().startsWith("-")&&(s+="+ "),s+=`${f.value}${f.isExplosive?"e":""} [${p.result.map(o=>`<span class="${o.value===o.sides?"max":""}${o.value===1?"min":""}">`+o.value.toString()+(f.isExplosive&&o.value===o.sides?"ðŸ’¥":"")+"</span>").join(", ")}]`;break;case"constant":s=`${a>0&&f.value>=0?"+ ":""}${f.value}`;break;case"variable":s=`${a>0&&f.value>=0?"+ ":""}${f.label} [${f.value}]`;break}s.startsWith("-")&&(s=s.replace("-","- ")),e+=`${a>0?" ":""}${s}`}),e},me=r=>{let e=0;return r.forEach(p=>{const a=p.expressionMember;switch(a.type){case"dice":e+=p.result.reduce((f,s)=>f+s.value,0)*(a.value.toString().startsWith("-")?-1:1);break;case"constant":e+=a.value;break;case"variable":e+=a.value;break}}),e},ot=r=>{const e=[];if(!r||!String(r).trim())return e;const p=String(r).trim(),a=/^[+-]/.test(p)?p:`+${p}`,f=/([+-])\s*([^+-]+)/g;let s;for(;(s=f.exec(a))!==null;){const n=s[1]==="+"?1:-1,t=(s[2]||"").trim();if(!t)continue;const w=t.match(/^(\d+)\s*d\s*(\d+)/i);if(w){const P=Number(w[1]),D=Number(w[2]),C=t.slice(w[0].length).trim()||null;e.push({kind:"dice",sign:n,n:P,faces:D,damageType:C,raw:t});continue}const _=t.match(/^(\d+)/);if(_){const P=Number(_[1]),T=t.slice(_[0].length).trim()||null;e.push({kind:"flat",sign:n,value:P,damageType:T,raw:t});continue}const v=t.match(/(\d+)\s*d\s*(\d+)/i);if(v){const P=Number(v[1]),D=Number(v[2]),T=t.replace(v[0],"").trim()||null;e.push({kind:"dice",sign:n,n:P,faces:D,damageType:T,raw:t});continue}e.push({kind:"flat",sign:n,value:0,damageType:t||null,raw:t})}return e.reduce((n,t)=>t.kind==="dice"?`${n} ${t.sign===1?"+":"-"} ${t.n}d${t.faces}`:t.kind==="flat"?`${n} ${t.sign===1?"+":"-"} ${t.value}`:n,"")},je=()=>{const r=Fe;return{page:{subscribe:r.page.subscribe},navigating:{subscribe:r.navigating.subscribe},updated:r.updated}},Ke={subscribe(r){return je().page.subscribe(r)}};async function ue(r,e=256,p=8,a="#000000"){return new Promise((f,s)=>{const o=new Image;o.crossOrigin="Anonymous",o.src=r,o.onload=()=>{try{const n=document.createElement("canvas");n.width=e,n.height=e;const t=n.getContext("2d");if(!t){s(new Error("No ctx"));return}const w=e/2,_=e/2,v=e/2-p/2;t.beginPath(),t.arc(w,_,v,0,Math.PI*2),t.closePath(),t.save(),t.clip();const P=Math.min(o.width,o.height),D=(o.width-P)/2,T=(o.height-P)/2;t.drawImage(o,D,T,P,P,0,0,e,e),t.restore(),p>0&&(t.beginPath(),t.arc(w,_,v,0,Math.PI*2),t.lineWidth=p,t.strokeStyle=a,t.stroke());const C=n.toDataURL("image/webp",.85);f(C)}catch(n){s(n)}},o.onerror=n=>{console.error("Error cargando imagen",n),f(r)}})}const Y=Oe(Ke,r=>{const e=r.url.searchParams;return{uuid:e.get("uuid")||e.get("actorId"),startHp:e.get("startHp"),startMax:e.get("startMax"),isFoundry:e.get("mode")==="foundry"}}),Ye=()=>{const r=s=>{typeof window<"u"&&window.parent?window.parent.postMessage(s,"*"):console.warn("[Foundry Service] No se detectÃ³ la ventana padre (Foundry).")};return{broadcastRollResult:(s,o)=>{if(!N(Y).isFoundry)return;const n=[],t=[];s.forEach(v=>{const{type:P,value:D}=v.expressionMember,T=v.result;P==="dice"?(n.push(String(D)),Array.isArray(T)&&T.forEach(C=>{t.push(C.value)})):typeof T=="number"?n.push(String(T)):n.push(String(D))});const w=n.join(" + "),_={type:"PRECALCULATED_ROLL",formula:w,results:t,flavor:o};console.log(`[Foundry] Broadcasting dice roll: ${w} -> [${t}]`),r(_)},isInsideFoundry:()=>window.self!==window.top||N(Y).isFoundry,syncCharacterState:async s=>{const o=N(Y);if(!o.isFoundry)return;if(!o.uuid){console.warn("[Foundry] Error: Modo Foundry detectado pero falta UUID en la URL.");return}let n;try{s.img&&(n=await ue(s.img,256,8,"#000000"))}catch(_){console.error("[Foundry] Error generando token circular:",_),n=s.img}const t={name:s.name,imageUrl:n,imageSource:s.img,hp:{value:s.currentHP,max:s.maxHP}},w={type:"UPDATE_ACTOR",uuid:o.uuid,actorId:o.uuid,payload:t};r(w)},syncCreatureState:async s=>{const o=N(Y);if(!o.isFoundry)return;if(!o.uuid){console.warn("[Foundry] Error: Falta UUID para la criatura.");return}let n;try{s.img&&(n=await ue(s.img,256,8,"#990000"))}catch(_){console.error("[Foundry] Error generando token de criatura:",_),n=s.img}const t={name:s.name,imageUrl:n,imageSource:s.img,hp:{value:s.stats.maxHealth,max:s.stats.maxHealth}},w={type:"UPDATE_ACTOR",uuid:o.uuid,actorId:o.uuid,payload:t};r(w)},foundryParams:Y}},q="arcana:rollLogs:personal",J="arcana:rollLogs:party:",j=100,A={inited:!1,clearTimeoutId:null,roll3DDice:async()=>[],clear3DDices:()=>{},logs:z([]),rollModalOpened:z(!1),rollModalData:z(void 0)},$=Ve(),V=qe();let H=null,U=null,B=!1,ee=!1;const{broadcastRollResult:We,isInsideFoundry:ye}=Ye(),Xe=()=>{try{const r=(()=>{const f=V.getTarget();return f&&f.type==="party"?`${J}${f.partyId}`:q})(),e=localStorage.getItem(r),p=e?JSON.parse(e):[];return(Array.isArray(p)?p.slice(-j):p).map(f=>G(f))}catch(r){return console.error("Error loading roll logs:",r),[]}finally{A.logs.subscribe(async r=>{try{await Ze(r)}catch(e){console.error("[dice-roller-service] saveRollLogs subscription error:",e)}})}},Ze=async r=>{if(!B){if(ee){try{const p=(Array.isArray(r)?r.slice(-j):[]).map(f=>Z(f)),a=(()=>{const f=V.getTarget();return f&&f.type==="party"?`${J}${f.partyId}`:q})();localStorage.setItem(a,JSON.stringify(p))}catch(e){console.error("[dice-roller-service] Error persisting locally during concurrent save:",e)}return}try{const e=Array.isArray(r)?r.slice(-j):[],p=e.filter(a=>a&&a.pending);for(const a of p)if(a&&!a.id)try{a.id=crypto.randomUUID()}catch{a.id=`local-${Date.now()}-${Math.floor(Math.random()*1e5)}`}if(H&&$.isEnabled()&&p.length>0)try{ee=!0;const a=p.map(s=>Z(s));{const s=V.getTarget();if(s&&s.type==="party"){const o=N($.user),n={id:o?.uid,name:o?.displayName??o?.email??"Usuario",photoURL:o?.photoURL??void 0};await $.saveGroupRollLogsForParty(s.partyId,a,n)}else await $.saveRollLogsForUser(H,a)}const f=a.map(s=>s.id).filter(Boolean);if(f.length>0){A.logs.update(t=>Array.isArray(t)?t.map(w=>f.includes(w.id)?{...w,pending:!1}:w):t);const s=N(A.logs)||[],o=(Array.isArray(s)?s.slice(-j):[]).map(t=>Z(t)),n=(()=>{const t=V.getTarget();return t&&t.type==="party"?`${J}${t.partyId}`:q})();localStorage.setItem(n,JSON.stringify(o))}}catch(a){console.error("[dice-roller-service] Cloud sync failed, falling back to localStorage:",a)}finally{ee=!1}try{const a=e.map(s=>Z(s)),f=(()=>{const s=V.getTarget();return s&&s.type==="party"?`${J}${s.partyId}`:q})();localStorage.setItem(f,JSON.stringify(a))}catch(a){console.error("Error saving roll logs to localStorage:",a)}}catch(e){console.error("Error preparing roll logs for save:",e)}finally{ee=!1}}},de=async r=>k.STANDARD_DICES.some(p=>r.endsWith(p))&&!ye()?A.roll3DDice(r):new Promise(p=>{const[a,f]=r.split("d"),s=[];for(let o=0;o<Number(a);o++)s.push({value:Math.floor(Math.random()*Number(f))+1,sides:Number(f),dieType:"d"+f,groupId:0,rollId:o,theme:"default",themeColor:"#000000"});p(s)}),Qe=(r,e,p)=>{const a=me(r),f={id:crypto.randomUUID(),timestamp:new Date,title:e||"Tirada rÃ¡pida",total:a,formattedTotal:p?p(a):void 0,pending:!0,detail:ze(r)},s=V.getTarget();if(s&&s.type==="party"){const o=N($.user);o?.uid&&(f.authorId=o.uid,f.authorName=o.displayName??o.email??void 0)}A.logs.update(o=>[...o,f].slice(-j))},te=(r,e)=>{const p=new Map;for(const s of r)s&&s.id&&p.set(s.id,s);const a=new Map;for(const s of r)s&&s.id&&a.set(s.id,s);for(const s of e){const o=s.id;if(!o){const t=crypto.randomUUID();s.id=t,a.set(t,s);continue}if(s.pending){a.set(o,s);continue}const n=p.get(o);if(!n)a.set(o,s);else{const t=new Date(s.timestamp).getTime(),w=new Date(n.timestamp).getTime();!isNaN(t)&&!isNaN(w)?a.set(o,t>=w?s:n):a.set(o,s)}}return Array.from(a.values()).sort((s,o)=>new Date(s.timestamp).getTime()-new Date(o.timestamp).getTime()).slice(-j)},at=()=>{A.inited||(A.logs.set(Xe()),A.inited=!0,(async()=>{try{await $.initFirebase(),await $.onAuthState(async o=>{const n=H;if(H=o?o.uid:null,n&&n!==H&&U)try{U(),U=null}catch{}if(H&&$.isEnabled())try{{const t=V.getTarget();t&&t.type==="party"?U=$.listenGroupRollLogsForParty(t.partyId,w=>{B=!0;try{const _=(w||[]).map(D=>G(D)),v=N(A.logs)||[],P=te(_,v);A.logs.set(P)}catch(_){console.error("[dice-roller-service] Error applying remote logs:",_)}finally{B=!1}}):U=$.listenRollLogsForUser(H,w=>{B=!0;try{const _=(w||[]).map(D=>G(D)),v=N(A.logs)||[],P=te(_,v);A.logs.set(P)}catch(_){console.error("[dice-roller-service] Error applying remote logs:",_)}finally{B=!1}})}}catch(t){console.error("[dice-roller-service] Error starting remote listener:",t)}else try{const t=(()=>{const _=V.getTarget();return _&&_.type==="party"?`${J}${_.partyId}`:q})(),w=localStorage.getItem(t);if(w){const v=JSON.parse(w).map(P=>G(P));A.logs.set(v)}}catch(t){console.error("[dice-roller-service] Error loading local logs:",t)}})}catch(o){console.warn("[dice-roller-service] Firebase setup error (continuing with local logs):",o)}})(),V.target.subscribe(o=>{try{const n=o&&o.type==="party"?`${J}${o.partyId}`:q,t=localStorage.getItem(n);if(t){const _=JSON.parse(t).map(v=>G(v));A.logs.set(_)}else A.logs.set([])}catch{A.logs.set([])}if(U){try{U()}catch{}U=null}if(H&&$.isEnabled())try{o&&o.type==="party"?U=$.listenGroupRollLogsForParty(o.partyId,n=>{B=!0;try{const t=(n||[]).map(v=>G(v)),w=N(A.logs)||[],_=te(t,w);A.logs.set(_)}catch(t){console.error("[dice-roller-service] Error applying remote logs:",t)}finally{B=!1}}):U=$.listenRollLogsForUser(H,n=>{B=!0;try{const t=(n||[]).map(v=>G(v)),w=N(A.logs)||[],_=te(t,w);A.logs.set(_)}catch(t){console.error("[dice-roller-service] Error applying remote logs:",t)}finally{B=!1}})}catch(n){console.error("[dice-roller-service] Error starting remote listener:",n)}else try{const n=(()=>{const w=V.getTarget();return w&&w.type==="party"?`${J}${w.partyId}`:q})(),t=localStorage.getItem(n);if(t){const _=JSON.parse(t).map(v=>G(v));A.logs.set(_)}else A.logs.set([])}catch(n){console.error("[dice-roller-service] Error loading local logs:",n)}}));const r=({expression:o,variables:n={},title:t=void 0,resultFormatter:w=()=>{}})=>{A.rollModalData.set({expression:o,variables:n,title:t??"Tirar",rollType:"normal",extraModsExpression:"",resultFormatter:w}),A.rollModalOpened.set(!0)},e=async()=>{const o=N(A.rollModalData);if(A.rollModalData.set(void 0),A.rollModalOpened.set(!1),!o)return;let n=o.expression,t=o.title;o.rollType!=="normal"&&(n+=o.rollType==="advantage"?"+1d4":"-1d4",t+=o.rollType==="advantage"?" (ventaja)":" (desventaja)"),o?.extraModsExpression&&(n+=`+${o.extraModsExpression.trim()}`,n=n.replaceAll("++","+").replaceAll("+-","-")),a({expression:n,variables:o.variables,title:t})},p=()=>{A.rollModalOpened.set(!1),A.rollModalData.set(void 0)},a=async({expression:o,variables:n={},title:t=void 0,resultFormatter:w=()=>{}})=>{const _=Je(o,n);A.clearTimeoutId&&(clearTimeout(A.clearTimeoutId),A.clearTimeoutId=null),A.clear3DDices();const v=[];for(const P of _)P.type==="dice"?v.push({expressionMember:P,promise:de(P.value),result:void 0,explosionResolved:!1,numExplosions:0}):v.push({expressionMember:P,promise:void 0,result:P.value,explosionResolved:!0,numExplosions:0});for(;v.some(P=>P.result===void 0);){const P=[],D=v.filter(T=>T.expressionMember.type==="dice"&&T.result===void 0);for(const T of D)P.push((async()=>{T.result=await T.promise,T.promise=void 0;for(const C of T.result)T.expressionMember.isExplosive&&C.sides===C.value&&C.sides>1&&T.numExplosions++;if(T.numExplosions>0){const C={...T.expressionMember,value:`${T.numExplosions}d${T.result[0].sides}`};v.push({expressionMember:C,promise:de(C.value),result:void 0,explosionResolved:!1,numExplosions:0})}return T})());await Promise.all(P)}return A.clearTimeoutId=setTimeout(()=>{A.clear3DDices()},k.CLEAR_3D_DICES_DELAY),Qe(v,t,w),ye()&&(console.log("Broadcasting roll to Foundry..."),We(v,t)),me(v)};return{rollExpression:a,register3DDiceRollerFn:o=>{A.roll3DDice=o},registerClear3DDicesFn:o=>{A.clear3DDices=o},rollLogs:A.logs,rollModal:{rollModalOpened:A.rollModalOpened,openRollModal:r,rollModalData:A.rollModalData,submitRollModal:e,abortRollModal:p}}};export{W as C,re as P,at as a,Ye as b,qe as c,ot as d,Ke as p,Ve as u};
