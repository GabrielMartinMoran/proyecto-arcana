const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./lCNLHSrR.js","./C4c6zY-H.js","./yBjK6igh.js","./x4_yyNok.js"])))=>i.map(i=>d[i]);
import{_ as S}from"./PPVm8Dsz.js";import{C as V}from"./CyC3GOE6.js";import{w as z,g as C,d as Ce}from"./0JtrQ17s.js";import{s as Ue}from"./BlEGOwK4.js";const $e=t=>{if(t&&typeof t.toDate=="function")try{return t.toDate()}catch{}if(t instanceof Date)return t;if(typeof t=="string"||typeof t=="number"){const e=new Date(t);if(!isNaN(e.getTime()))return e}if(t&&typeof t=="object"){const e=typeof t.seconds=="number"?t.seconds:typeof t._seconds=="number"?t._seconds:null;if(typeof e=="number")return new Date(e*1e3)}return new Date},q=t=>({...t,timestamp:$e(t.timestamp)}),Q=t=>({...t,timestamp:t.timestamp.toISOString()}),ke=(t,e)=>{if(!t)return 0;const p=t.trim();try{const a=new Function("cuerpo","reflejos","mente","instinto","presencia","ppGastados","floor","ceil","round","Math",`return (${p});`);return Number(a(Number(e.cuerpo)||0,Number(e.reflejos)||0,Number(e.mente)||0,Number(e.instinto)||0,Number(e.presencia)||0,Number(e.ppGastados)||0,Math.floor,Math.ceil,Math.round,Math))||0}catch(a){return console.error("Error evaluating modifier expression:",a),0}},Ve=(t,e)=>ke(t,{cuerpo:e.attributes.body,reflejos:e.attributes.reflexes,mente:e.attributes.mind,instinto:e.attributes.instinct,presencia:e.attributes.presence,ppGastados:e.spentPP,floor:Math.floor,ceil:Math.ceil,round:Math.round,Math});class X{id;name;attributes;cards;ppHistory;goldHistory;equipment;modifiers;currentHP;tempHP;currentLuck;img;story;notes;languages;quickInfo;attacks;maxActiveCards;version;party;constructor(e){this.id=e.id,this.name=e.name,this.attributes=e.attributes,this.cards=e.cards,this.ppHistory=e.ppHistory,this.goldHistory=e.goldHistory,this.equipment=e.equipment,this.modifiers=e.modifiers,this.currentHP=e.currentHP,this.tempHP=e.tempHP,this.currentLuck=e.currentLuck,this.img=e.img,this.party=e.party??{partyId:null,ownerId:null},this.story=e.story,this.notes=e.notes,this.languages=e.languages,this.quickInfo=e.quickInfo,this.attacks=e.attacks,this.maxActiveCards=e.maxActiveCards,this.version=e.version,this.skills=e.skills??[]}calculateAttrModifiers(e,p){let a=p;const m=this.modifiers.filter(s=>s.attribute===e);for(const s of m){const o=Ve(s.formula,this);if(s.type==="set")return o;s.type==="add"&&(a+=o)}return a}get maxLuck(){const e=V.MAX_LUCK;return this.calculateAttrModifiers("maxLuck",e)}get maxHP(){const e=V.BASE_HEALTH+this.attributes.body*V.HEALTH_BODY_MULTIPIER;return this.calculateAttrModifiers("maxHP",e)}get speed(){const e=V.BASE_SPEED+this.attributes.reflexes;return this.calculateAttrModifiers("speed",e)}get evasion(){const e=V.BASE_EVASION+this.attributes.reflexes;return this.calculateAttrModifiers("evasion",e)}get physicalMitigation(){return this.calculateAttrModifiers("physicalMitigation",0)}get magicalMitigation(){return this.calculateAttrModifiers("magicalMitigation",0)}get currentGold(){const e=this.goldHistory.filter(a=>a.type==="add").reduce((a,m)=>a+m.value,0),p=this.spentGold;return p>0?e-p:e}get spentGold(){return this.goldHistory.filter(e=>e.type==="subtract").reduce((e,p)=>e+p.value,0)}get currentPP(){const e=this.ppHistory.filter(a=>a.type==="add").reduce((a,m)=>a+m.value,0),p=this.spentPP;return p>0?e-p:e}get spentPP(){return this.ppHistory.filter(e=>e.type==="subtract").reduce((e,p)=>e+p.value,0)}get pjPower(){const e=this.cards.map(m=>m.level).sort((m,s)=>s-m).slice(0,V.TOP_N_CARDS_TO_CALCULATE_PJ_POWER);console.log(e);const p=e.reduce((m,s)=>m+s,0)/e.length,a=this.spentPP/V.PJ_POWER_SPENT_PP_DIVIDER;return Math.round(p+a)}get tier(){for(const e of V.CHARACTER_TIERS)if(this.spentPP>=e.minPP&&this.spentPP<=e.maxPP)return e.tier;return 0}get numActiveCards(){return this.cards.filter(e=>e.isActive).length}get initiative(){return this.attributes.reflexes}skills;copy(){return new X({...this})}getExportableData(){return{...this,party:{partyId:null,ownerId:null}}}}class se{id;name;ownerId;notes;members;characters;unsubscribeCharacterListener;constructor(e){this.id=e?.id??"",this.name=e?.name??"",this.ownerId=e?.ownerId??"",this.notes=Array.isArray(e?.notes)?e.notes:[],this.members=e?.members&&typeof e.members=="object"?e.members:{},this.characters=e?.characters??[],this.unsubscribeCharacterListener=e?.unsubscribeCharacterListener??(()=>{})}getAllCharacterIds(){const e=[];for(const p of Object.keys(this.members)){const a=this.members[p]??[];for(const m of a)e.includes(m)||e.push(m)}return e}getCharactersFullIdentifiers(){const e=[];for(const p of Object.keys(this.members)){const a=this.members[p]??[];for(const m of a)e.push({userId:p,characterId:m})}return e}isAccessible(e){return this.ownerId===e||this.members[e]?.length>0}copy(){const e=JSON.parse(JSON.stringify(this.asPlain())),p=new se(e);return p.characters=this.characters.filter(a=>a.party.partyId===this.id&&p.getAllCharacterIds().includes(a.id)),p.unsubscribeCharacterListener=this.unsubscribeCharacterListener,p}asPlain(){return{id:this.id,name:this.name,ownerId:this.ownerId,notes:this.notes,members:this.members}}}var ee={VITE_FIREBASE_MESSAGING_SENDER_ID:"647852941329",VITE_FIREBASE_STORAGE_BUCKET:"arcana-85eeb.firebasestorage.app",VITE_FIREBASE_AUTH_DOMAIN:"arcana-85eeb.firebaseapp.com",VITE_FIREBASE_PROJECT_ID:"arcana-85eeb",VITE_FIREBASE_APP_ID:"1:647852941329:web:f2aa1e9dd6792f6a9d91b0",VITE_FIREBASE_API_KEY:"AIzaSyAFv5lor5ufY-KPBQ166rPSRnscFrtm88w"};function M(){return typeof window<"u"}function Be(){if(typeof ee>"u")return null;const t=typeof ee=="string"?JSON.parse(ee):ee;return t.VITE_FIREBASE_API_KEY?{apiKey:t.VITE_FIREBASE_API_KEY,authDomain:t.VITE_FIREBASE_AUTH_DOMAIN,projectId:t.VITE_FIREBASE_PROJECT_ID,storageBucket:t.VITE_FIREBASE_STORAGE_BUCKET,messagingSenderId:t.VITE_FIREBASE_MESSAGING_SENDER_ID,appId:t.VITE_FIREBASE_APP_ID}:null}function He(){let t=null,e=null,p=!1,a=null,m=0,s=0,o=null;const n=()=>{if(!o)try{o=setTimeout(()=>{o=null;try{console.debug("[firebase-service] ops:",{reads:m,writes:s})}catch{}},1e3)}catch{}},r=(u=1)=>{m+=u,n()},b=(u=1)=>{s+=u,n()},_=z(!1),v=z(null);async function P(){if(p)return;if(p=!0,!M()){_.set(!1);return}const u=Be()??null;if(!u)throw _.set(!1),new Error("Firebase configuration missing: VITE_FIREBASE_* variables required.");try{const{initializeApp:i,getApps:d}=await S(async()=>{const{initializeApp:E,getApps:y}=await import("./lCNLHSrR.js");return{initializeApp:E,getApps:y}},__vite__mapDeps([0,1]),import.meta.url),l=await S(()=>import("./yBjK6igh.js"),__vite__mapDeps([2,1]),import.meta.url),f=await S(()=>import("./x4_yyNok.js"),__vite__mapDeps([3,1]),import.meta.url);d&&d().length===0&&i(u),t=l.getAuth(),e=f.getFirestore(),l.onAuthStateChanged(t,E=>{const y=E?{uid:E.uid,displayName:E.displayName,email:E.email,photoURL:E.photoURL}:null;v.set(y)}),_.set(!0)}catch(i){throw _.set(!1),console.error("[firebase-service] Initialization error:",i),i}}async function D(){if(a)return a;a=P();try{await a}finally{a=null}}function T(){let u=!1;return _.subscribe(i=>{u=i})(),u&&!!t&&!!e}async function U(){if(!M())return null;await D();const{GoogleAuthProvider:u,signInWithPopup:i}=await S(async()=>{const{GoogleAuthProvider:y,signInWithPopup:h}=await import("./yBjK6igh.js");return{GoogleAuthProvider:y,signInWithPopup:h}},__vite__mapDeps([2,1]),import.meta.url),d=new u;d.setCustomParameters({prompt:"select_account"});const f=(await i(t,d)).user;if(!f)return null;const E={uid:f.uid,displayName:f.displayName,email:f.email,photoURL:f.photoURL};return v.set(E),E}async function ae(){if(!M())return;await D();const{signOut:u}=await S(async()=>{const{signOut:i}=await import("./yBjK6igh.js");return{signOut:i}},__vite__mapDeps([2,1]),import.meta.url);await u(t),v.set(null)}async function ne(u){if(!M())return u(null),()=>{};await D();const{onAuthStateChanged:i}=await S(async()=>{const{onAuthStateChanged:l}=await import("./yBjK6igh.js");return{onAuthStateChanged:l}},__vite__mapDeps([2,1]),import.meta.url);return i(t,l=>{const f=l?{uid:l.uid,displayName:l.displayName,email:l.email,photoURL:l.photoURL}:null;v.set(f),u(f)})}async function F(){if(await D(),!e)throw new Error("Firestore not initialized")}async function ie(u,i){if(!u)throw new Error("userId required");if(!M())return;await F();const{doc:d,writeBatch:l,getDoc:f}=await S(async()=>{const{doc:c,writeBatch:g,getDoc:w}=await import("./x4_yyNok.js");return{doc:c,writeBatch:g,getDoc:w}},__vite__mapDeps([3,1]),import.meta.url);let E=i.map(c=>JSON.parse(JSON.stringify(c||{})));const y=E.filter(c=>!c||typeof c.id!="string"||c.id.trim()==="");if(y.length>0&&console.warn("[firebase-service] saveCharactersForUser: skipping characters without valid id:",y.map(c=>c&&c.id)),E=E.filter(c=>c&&typeof c.id=="string"&&c.id.trim()!==""),E.length===0)return;try{const c=new Set;for(const g of E){const w=(g?.party&&g.party.partyId)??g?.partyId??null;w&&c.add(w)}if(c.size>0){const g=new Map;for(const w of c)try{const I=await f(d(e,"parties",w));r();let R;I&&typeof I.exists=="function"&&I.exists()?R=I.data():R=void 0,g.set(w,R?R.ownerId??null:null)}catch(I){console.warn("[firebase-service] Failed to read party for denormalization",w,I),g.set(w,null)}for(const w of E){const I=(w?.party&&w.party.partyId)??w?.partyId??null;w.party?I?(w.party.partyId=I,w.party.ownerId=g.get(I)??null):w.party={partyId:null,ownerId:null}:w.party={partyId:I??null,ownerId:I?g.get(I)??null:null}}}else for(const g of E)g.party?g.party.ownerId=g.party.ownerId??null:g.party={partyId:null,ownerId:null}}catch(c){console.warn("[firebase-service] Party denormalization step failed:",c);for(const g of E)g.party?g.party.ownerId=g.party.ownerId??null:g.party={partyId:null,ownerId:null}}const h=3;for(let c=1;c<=h;c++)try{for(const w of E)if(!(!w||!w.id||typeof w.id!="string"))try{const I=d(e,"users",u,"characters",w.id),R=await f(I);if(r(),R&&R.exists()){const L=R.data()||{},O=(L?.party&&L.party.partyId)??L?.partyId??null,W=(w?.party&&w.party.partyId)??w?.partyId??null;if(O&&(!W||W!==O))try{await de(O,u,w.id)}catch(ce){console.warn("[firebase-service] best-effort removePartyMember failed for",{prevPartyId:O,userId:u,cid:w.id,err:ce})}}}catch(I){console.warn("[firebase-service] failed to read existing character doc (continuing):",w?.id,I)}const g=l(e);for(const w of E){if(!w||!w.id||typeof w.id!="string")continue;const I=d(e,"users",u,"characters",w.id);g.set(I,w,{merge:!0})}await g.commit(),b(E.length);return}catch(g){if(console.error(`[firebase-service] saveCharactersForUser attempt ${c} failed:`,g),c===h)throw g;await new Promise(w=>setTimeout(w,200*c))}}async function Ee(u,i){if(!u)throw new Error("userId required");if(!i)throw new Error("characterId required");if(!M())return;await F();const{doc:d,deleteDoc:l}=await S(async()=>{const{doc:f,deleteDoc:E}=await import("./x4_yyNok.js");return{doc:f,deleteDoc:E}},__vite__mapDeps([3,1]),import.meta.url);await l(d(e,"users",u,"characters",i)),b()}async function _e(u){if(!u)throw new Error("userId required");if(!M())return[];await F();const{collection:i,getDocs:d}=await S(async()=>{const{collection:y,getDocs:h}=await import("./x4_yyNok.js");return{collection:y,getDocs:h}},__vite__mapDeps([3,1]),import.meta.url),l=i(e,"users",u,"characters"),f=await d(l);r(f?.size??0);const E=[];return f.forEach(y=>{const h=y.data();E.push(new X(h))}),E}function ve(u,i){if(!M())return i([]),()=>{};let d=()=>{};return(async()=>{try{await F();const{collection:l,onSnapshot:f}=await S(async()=>{const{collection:y,onSnapshot:h}=await import("./x4_yyNok.js");return{collection:y,onSnapshot:h}},__vite__mapDeps([3,1]),import.meta.url),E=l(e,"users",u,"characters");d=f(E,y=>{r(y?.size??0);const h=[];y.forEach(c=>{h.push(new X(c.data()))}),i(h)},y=>{console.error("[firebase-service] listenCharactersForUser snapshot error:",y),i([])})}catch(l){console.error("[firebase-service] listenCharactersForUser setup error:",l),i([])}})(),()=>{try{d&&d()}catch{}}}async function Ie(u){if(!u||!M())return null;await F();const{doc:i,getDoc:d}=await S(async()=>{const{doc:l,getDoc:f}=await import("./x4_yyNok.js");return{doc:l,getDoc:f}},__vite__mapDeps([3,1]),import.meta.url);try{const l=await d(i(e,"parties",u));if(r(),!l.exists())return null;const f=l.data();return new se(f)}catch(l){return console.error("[firebase-service] loadParty failed:",l),null}}async function Ae(u,i,d){if(!u)throw new Error("partyId required");if(!i)throw new Error("userId required");if(!d)throw new Error("characterId required");if(!M())return;await F();const{doc:l,runTransaction:f,getDoc:E,updateDoc:y,setDoc:h}=await S(async()=>{const{doc:g,runTransaction:w,getDoc:I,updateDoc:R,setDoc:L}=await import("./x4_yyNok.js");return{doc:g,runTransaction:w,getDoc:I,updateDoc:R,setDoc:L}},__vite__mapDeps([3,1]),import.meta.url),c=l(e,"parties",u);try{await f(e,async g=>{const w=await g.get(c);if(r(),!w||!w.exists()){const O={};O[i]=[d],g.set(c,{members:O},{merge:!0}),b();return}const I=w.data()||{},R=I.members&&typeof I.members=="object"?I.members:{},L=Array.isArray(R[i])?R[i].slice():[];if(!L.includes(d)){L.push(d);const O={};O[`members.${i}`]=L,g.update(c,O),b()}})}catch(g){console.error("[firebase-service] setPartyMember transaction failed:",g);try{const w=await E(c);if(r(),!w||!w.exists()){await h(c,{members:{[i]:[d]}},{merge:!0}),b();return}const I=w.data()||{},R=I.members&&typeof I.members=="object"?I.members:{},L=Array.isArray(R[i])?R[i].slice():[];L.includes(d)||(L.push(d),await y(c,{[`members.${i}`]:L}),b())}catch(w){throw console.error("[firebase-service] setPartyMember fallback failed:",w),g}}}async function de(u,i,d){if(!u)throw new Error("partyId required");if(!i)throw new Error("userId required");if(!d)throw new Error("characterId required");if(!M())return;await F();const{doc:l,runTransaction:f,getDoc:E,updateDoc:y,deleteField:h}=await S(async()=>{const{doc:g,runTransaction:w,getDoc:I,updateDoc:R,deleteField:L}=await import("./x4_yyNok.js");return{doc:g,runTransaction:w,getDoc:I,updateDoc:R,deleteField:L}},__vite__mapDeps([3,1]),import.meta.url),c=l(e,"parties",u);try{await f(e,async g=>{const w=await g.get(c);if(r(),!w||!w.exists())return;const I=w.data()||{},R=I.members&&typeof I.members=="object"?I.members:{},L=Array.isArray(R[i])?R[i].slice():[],O=L.indexOf(d);O!==-1&&(L.splice(O,1),L.length===0?(g.update(c,{[`members.${i}`]:h()}),b()):(g.update(c,{[`members.${i}`]:L}),b()))})}catch(g){console.error("[firebase-service] removePartyMember transaction failed:",g);try{const{deleteField:w}=await S(async()=>{const{deleteField:ce}=await import("./x4_yyNok.js");return{deleteField:ce}},__vite__mapDeps([3,1]),import.meta.url),I=await E(c);if(r(),!I||!I.exists())return;const R=I.data()||{},L=R.members&&typeof R.members=="object"?R.members:{},O=Array.isArray(L[i])?L[i].slice():[],W=O.indexOf(d);W!==-1&&(O.splice(W,1),O.length===0?(await y(c,{[`members.${i}`]:w()}),b()):(await y(c,{[`members.${i}`]:O}),b()))}catch(w){throw console.error("[firebase-service] removePartyMember fallback failed:",w),g}}}async function Pe(u){if(!u||!u.id)throw new Error("party.id required");if(!M())return;await F();const{doc:i,setDoc:d}=await S(async()=>{const{doc:E,setDoc:y}=await import("./x4_yyNok.js");return{doc:E,setDoc:y}},__vite__mapDeps([3,1]),import.meta.url),l=u.asPlain(),f=3;for(let E=1;E<=f;E++)try{await d(i(e,"parties",l.id),l,{merge:!0}),b();return}catch(y){if(console.error(`[firebase-service] saveParty attempt ${E} failed for party ${l.id} owner=${l.ownerId}:`,y),E===f){try{console.error("[firebase-service] saveParty giving up after max attempts for party:",JSON.stringify(l))}catch(h){console.error("[firebase-service] saveParty could not stringify party payload",h)}throw y}await new Promise(h=>setTimeout(h,200*E))}}async function Te(u){if(!u)throw new Error("partyId required");if(!M())return;await F();const{doc:i,deleteDoc:d}=await S(async()=>{const{doc:l,deleteDoc:f}=await import("./x4_yyNok.js");return{doc:l,deleteDoc:f}},__vite__mapDeps([3,1]),import.meta.url);await d(i(e,"parties",u)),b()}function De(u,i){if(!M())return i([]),()=>{};let d=()=>{};return(async()=>{try{await F();const{collection:l,onSnapshot:f}=await S(async()=>{const{collection:y,onSnapshot:h}=await import("./x4_yyNok.js");return{collection:y,onSnapshot:h}},__vite__mapDeps([3,1]),import.meta.url),E=l(e,"parties");d=f(E,y=>{try{r(y?.size??0)}catch{}const h=[];y.forEach(c=>{const g=c.data();if(!g)return;g.id=c.id;const w=g.ownerId===u,I=g.members&&typeof g.members=="object"&&Array.isArray(g.members[u])&&g.members[u].length>0;(w||I)&&h.push(new se(g))}),i(h)},y=>{console.error("[firebase-service] listenToUserParties error:",y),i([])})}catch(l){console.error("[firebase-service] listenToUserParties setup error:",l),i([])}})(),()=>{try{d&&d()}catch{}}}async function Re(u,i){if(!u)throw new Error("userId required");if(!M())return;await F();const{doc:d,writeBatch:l}=await S(async()=>{const{doc:y,writeBatch:h}=await import("./x4_yyNok.js");return{doc:y,writeBatch:h}},__vite__mapDeps([3,1]),import.meta.url),f=i.map(y=>JSON.parse(JSON.stringify(y||{}))),E=3;for(let y=1;y<=E;y++)try{const h=l(e);for(const c of f){const g=d(e,"users",u,"rollLogs",c.id);h.set(g,c,{merge:!0})}await h.commit(),b(f.length);return}catch(h){if(console.error(`[firebase-service] saveRollLogsForUser attempt ${y} failed:`,h),y===E)throw h;await new Promise(c=>setTimeout(c,200*y))}}async function Se(u,i,d){if(!u)throw new Error("partyId required");if(!M())return;await F();const{doc:l,writeBatch:f}=await S(async()=>{const{doc:h,writeBatch:c}=await import("./x4_yyNok.js");return{doc:h,writeBatch:c}},__vite__mapDeps([3,1]),import.meta.url),E=i.map(h=>{const c=JSON.parse(JSON.stringify(h||{}));return d&&(d.id&&(c.authorId=d.id),d.name&&(c.authorName=d.name),d.photoURL&&(c.authorPhotoURL=d.photoURL)),c}),y=3;for(let h=1;h<=y;h++)try{const c=f(e);for(const g of E){const w=l(e,"parties",u,"rollLogs",g.id);c.set(w,g,{merge:!0})}await c.commit(),b(E.length);return}catch(c){if(console.error(`[firebase-service] saveGroupRollLogsForParty attempt ${h} failed:`,c),h===y)throw c;await new Promise(g=>setTimeout(g,200*h))}}function Le(u,i){if(!M())return i([]),()=>{};let d=()=>{};return(async()=>{try{await F();const{collection:l,onSnapshot:f}=await S(async()=>{const{collection:y,onSnapshot:h}=await import("./x4_yyNok.js");return{collection:y,onSnapshot:h}},__vite__mapDeps([3,1]),import.meta.url),E=l(e,"parties",u,"rollLogs");d=f(E,y=>{r(y?.size??0);const h=[];y.forEach(c=>{const g={...c.data()||{},id:c.id};h.push(g)}),i(h)},y=>{console.error("[firebase-service] listenGroupRollLogsForParty snapshot error:",y),i([])})}catch(l){console.error("[firebase-service] listenGroupRollLogsForParty setup error:",l),i([])}})(),()=>{try{d&&d()}catch{}}}async function Me(u,i){if(!u)throw new Error("partyId required");if(!i)throw new Error("logId required");if(!M())return;await F();const{doc:d,deleteDoc:l}=await S(async()=>{const{doc:f,deleteDoc:E}=await import("./x4_yyNok.js");return{doc:f,deleteDoc:E}},__vite__mapDeps([3,1]),import.meta.url);await l(d(e,"parties",u,"rollLogs",i)),b()}async function Fe(u){if(!u)throw new Error("userId required");if(!M())return[];await F();const{collection:i,getDocs:d}=await S(async()=>{const{collection:y,getDocs:h}=await import("./x4_yyNok.js");return{collection:y,getDocs:h}},__vite__mapDeps([3,1]),import.meta.url),l=i(e,"users",u,"rollLogs"),f=await d(l);r(f?.size??0);const E=[];return f.forEach(y=>E.push({...y.data()||{},id:y.id})),E}function Oe(u,i){if(!M())return i([]),()=>{};let d=()=>{};return(async()=>{try{await F();const{collection:l,onSnapshot:f}=await S(async()=>{const{collection:y,onSnapshot:h}=await import("./x4_yyNok.js");return{collection:y,onSnapshot:h}},__vite__mapDeps([3,1]),import.meta.url),E=l(e,"users",u,"rollLogs");d=f(E,y=>{r(y?.size??0);const h=[];y.forEach(c=>{const g={...c.data()||{},id:c.id};h.push(g)}),i(h)},y=>{console.error("[firebase-service] listenRollLogsForUser snapshot error:",y),i([])})}catch(l){console.error("[firebase-service] listenRollLogsForUser setup error:",l),i([])}})(),()=>{try{d&&d()}catch{}}}async function xe(u,i){if(!u)throw new Error("userId required");if(!i)throw new Error("logId required");if(!M())return;await F();const{doc:d,deleteDoc:l}=await S(async()=>{const{doc:f,deleteDoc:E}=await import("./x4_yyNok.js");return{doc:f,deleteDoc:E}},__vite__mapDeps([3,1]),import.meta.url);await l(d(e,"users",u,"rollLogs",i)),b()}const Z={};function pe(u,i){if(!M())return()=>{};const d=`${u.userId}/${u.characterId}`;let l=Z[d];if(l||(l={subscribers:new Set,unsubscribe:null,latest:null},Z[d]=l),l.subscribers.add(i),l.unsubscribe||(async()=>{try{await F();const{doc:f,onSnapshot:E}=await S(async()=>{const{doc:h,onSnapshot:c}=await import("./x4_yyNok.js");return{doc:h,onSnapshot:c}},__vite__mapDeps([3,1]),import.meta.url),y=f(e,"users",u.userId,"characters",u.characterId);l.unsubscribe=E(y,h=>{if(r(),h&&h.exists()){const c=h.data()||{};c.id||(c.id=h.id),l.latest=new X(c)}else l.latest=null;for(const c of Array.from(l.subscribers))try{c(l.latest)}catch(g){console.error("[firebase-service] subscribeCharacter subscriber error:",g)}},h=>{console.error("[firebase-service] subscribeCharacter snapshot error for",d,h)})}catch(f){console.error("[firebase-service] subscribeCharacter setup error for",d,f)}})(),l.latest!==null)try{i(l.latest)}catch(f){console.error("[firebase-service] subscribeCharacter immediate callback error:",f)}return()=>{const f=Z[d];if(f&&(f.subscribers.delete(i),f.subscribers.size===0)){try{f.unsubscribe&&f.unsubscribe()}catch{}delete Z[d]}}}function Ne(u,i){if(!M())return i([]),()=>{};const d={},l=[];for(const f of u){if(!f||!f.userId||!f.characterId)continue;const E=`${f.userId}/${f.characterId}`,y=pe(f,h=>{d[E]=h;const c=[];for(const g of Object.keys(d)){const w=d[g];w&&c.push(w)}try{i(c)}catch(g){console.error("[firebase-service] listenCharactersByIds callback error:",g)}});l.push(y)}return()=>{for(const f of l)try{f()}catch{}}}return{firebaseReady:_,user:v,initFirebase:D,isEnabled:T,signInWithGoogle:U,signOutUser:ae,onAuthState:ne,saveCharactersForUser:ie,loadCharactersForUser:_e,deleteCharacterForUser:Ee,listenCharactersForUser:ve,saveParty:Pe,deleteParty:Te,loadParty:Ie,listenToUserParties:De,setPartyMember:Ae,removePartyMember:de,subscribeCharacter:pe,listenCharactersByIds:Ne,saveRollLogsForUser:Re,loadRollLogsForUser:Fe,deleteRollLogForUser:xe,listenRollLogsForUser:Oe,saveGroupRollLogsForParty:Se,deleteGroupRollLogForParty:Me,listenGroupRollLogsForParty:Le,getReadCount:()=>m,getWriteCount:()=>s,resetOpCounters:()=>{m=0,s=0},getOpCounters:()=>({reads:m,writes:s})}}const Ge=He();function qe(){return Ge}const ge="arcana:rollTarget";function he(){return typeof window<"u"}function oe(t){return typeof t=="string"&&t.trim().length>0}function Je(t){return!t||typeof t!="object"?null:t.type==="party"&&oe(t.partyId)?{type:"party",partyId:t.partyId,partyName:oe(t.partyName)?t.partyName:void 0}:{type:"personal"}}function je(t){if(he())try{localStorage.setItem(ge,JSON.stringify(t))}catch(e){console.warn("[roll-target-service] failed to persist target",e)}}function ze(){if(!he())return null;try{const t=localStorage.getItem(ge);if(!t)return null;const e=JSON.parse(t);return Je(e)}catch(t){return console.warn("[roll-target-service] failed to load target",t),null}}const x={inited:!1,target:z({type:"personal"}),unsub:null};function Ke(){if(!x.inited){x.inited=!0;const n=ze();n&&x.target.set(n),x.unsub=x.target.subscribe(r=>je(r))}const t=()=>{x.target.set({type:"personal"})},e=(n,r)=>{if(!oe(n)){console.warn("[roll-target-service] setPartyTarget called with invalid partyId, falling back to personal"),x.target.set({type:"personal"});return}const b={type:"party",partyId:n.trim()};oe(r)&&(b.partyName=r.trim()),x.target.set(b)},p=n=>{try{const r=C(x.target);r.type==="party"&&(Array.isArray(n)&&n.includes(r.partyId)||x.target.set({type:"personal"}))}catch(r){console.warn("[roll-target-service] reconcileAccessibility error",r)}},a=()=>C(x.target),m=()=>C(x.target).type==="personal",s=()=>C(x.target).type==="party",o=()=>{const n=C(x.target);return n.type==="party"?n.partyId:null};return{target:x.target,setPersonalTarget:t,setPartyTarget:e,reconcileAccessibility:p,getTarget:a,isPersonalTarget:m,isPartyTarget:s,getPartyId:o,cleanup:()=>{if(x.unsub){try{x.unsub()}catch{}x.unsub=null}}}}const We=(t,e)=>{if(!t)return[];const p=[],a=t.replace(/\s+/g,""),m=/([+-]?)(\d*d\d+(?:[eE])?|\d+(\.\d+)?|[A-Za-z_][A-Za-z0-9_]*)/g;let s;for(;(s=m.exec(a))!==null;){const o=s[1]||"+",n=s[2],r=/^(\d*)[dD](\d+)([eE])?$/.exec(n);if(r){const D=r[1],T=r[2],U=!!r[3],ae=D?Number(D):1,ne=Number(T);let F=`${ae}d${ne}`;o==="-"&&(F=`-${F}`);const ie={type:"dice",isExplosive:U,value:F};p.push(ie);continue}if(/^\d+(\.\d+)?$/.exec(n)){let D=Number(n);o==="-"&&(D=-D),p.push({type:"constant",isExplosive:!1,value:D});continue}const _=n,v=e&&Object.prototype.hasOwnProperty.call(e,_)&&Number(e[_])||0,P=o==="-"?-v:v;p.push({type:"variable",value:P,isExplosive:!1,label:_})}return p},Ye=t=>{let e="";return t.forEach((p,a)=>{const m=p.expressionMember;let s="";switch(m.type){case"dice":a>0&&!m.value.toString().startsWith("-")&&(s+="+ "),s+=`${m.value}${m.isExplosive?"e":""} [${p.result.map(o=>`<span class="${o.value===o.sides?"max":""}${o.value===1?"min":""}">`+o.value.toString()+(m.isExplosive&&o.value===o.sides?"ðŸ’¥":"")+"</span>").join(", ")}]`;break;case"constant":s=`${a>0&&m.value>=0?"+ ":""}${m.value}`;break;case"variable":s=`${a>0&&m.value>=0?"+ ":""}${m.label} [${m.value}]`;break}s.startsWith("-")&&(s=s.replace("-","- ")),e+=`${a>0?" ":""}${s}`}),e},we=t=>{let e=0;return t.forEach(p=>{const a=p.expressionMember;switch(a.type){case"dice":e+=p.result.reduce((m,s)=>m+s.value,0)*(a.value.toString().startsWith("-")?-1:1);break;case"constant":e+=a.value;break;case"variable":e+=a.value;break}}),e},ft=t=>{const e=[];if(!t||!String(t).trim())return e;const p=String(t).trim(),a=/^[+-]/.test(p)?p:`+${p}`,m=/([+-])\s*([^+-]+)/g;let s;for(;(s=m.exec(a))!==null;){const n=s[1]==="+"?1:-1,r=(s[2]||"").trim();if(!r)continue;const b=r.match(/^(\d+)\s*d\s*(\d+)/i);if(b){const P=Number(b[1]),D=Number(b[2]),U=r.slice(b[0].length).trim()||null;e.push({kind:"dice",sign:n,n:P,faces:D,damageType:U,raw:r});continue}const _=r.match(/^(\d+)/);if(_){const P=Number(_[1]),T=r.slice(_[0].length).trim()||null;e.push({kind:"flat",sign:n,value:P,damageType:T,raw:r});continue}const v=r.match(/(\d+)\s*d\s*(\d+)/i);if(v){const P=Number(v[1]),D=Number(v[2]),T=r.replace(v[0],"").trim()||null;e.push({kind:"dice",sign:n,n:P,faces:D,damageType:T,raw:r});continue}e.push({kind:"flat",sign:n,value:0,damageType:r||null,raw:r})}return e.reduce((n,r)=>r.kind==="dice"?`${n} ${r.sign===1?"+":"-"} ${r.n}d${r.faces}`:r.kind==="flat"?`${n} ${r.sign===1?"+":"-"} ${r.value}`:n,"")},N=[];for(let t=0;t<256;++t)N.push((t+256).toString(16).slice(1));function Xe(t,e=0){return(N[t[e+0]]+N[t[e+1]]+N[t[e+2]]+N[t[e+3]]+"-"+N[t[e+4]]+N[t[e+5]]+"-"+N[t[e+6]]+N[t[e+7]]+"-"+N[t[e+8]]+N[t[e+9]]+"-"+N[t[e+10]]+N[t[e+11]]+N[t[e+12]]+N[t[e+13]]+N[t[e+14]]+N[t[e+15]]).toLowerCase()}let le;const Ze=new Uint8Array(16);function Qe(){if(!le){if(typeof crypto>"u"||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");le=crypto.getRandomValues.bind(crypto)}return le(Ze)}const et=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),me={randomUUID:et};function tt(t,e,p){t=t||{};const a=t.random??t.rng?.()??Qe();if(a.length<16)throw new Error("Random bytes length must be >= 16");return a[6]=a[6]&15|64,a[8]=a[8]&63|128,Xe(a)}function rt(t,e,p){return me.randomUUID&&!t?me.randomUUID():tt(t)}function ue(){return rt()}const st=()=>{const t=Ue;return{page:{subscribe:t.page.subscribe},navigating:{subscribe:t.navigating.subscribe},updated:t.updated}},ot={subscribe(t){return st().page.subscribe(t)}};async function fe(t,e=256,p=8,a="#000000"){return new Promise((m,s)=>{const o=new Image;o.crossOrigin="Anonymous",o.src=t,o.onload=()=>{try{const n=document.createElement("canvas");n.width=e,n.height=e;const r=n.getContext("2d");if(!r){s(new Error("No ctx"));return}const b=e/2,_=e/2,v=e/2-p/2;r.beginPath(),r.arc(b,_,v,0,Math.PI*2),r.closePath(),r.save(),r.clip();const P=Math.min(o.width,o.height),D=(o.width-P)/2,T=(o.height-P)/2;r.drawImage(o,D,T,P,P,0,0,e,e),r.restore(),p>0&&(r.beginPath(),r.arc(b,_,v,0,Math.PI*2),r.lineWidth=p,r.strokeStyle=a,r.stroke());const U=n.toDataURL("image/webp",.85);m(U)}catch(n){s(n)}},o.onerror=n=>{console.error("Error cargando imagen",n),m(t)}})}const Y=Ce(ot,t=>{const e=t.url.searchParams;return{uuid:e.get("uuid")||e.get("actorId"),startHp:e.get("startHp"),startMax:e.get("startMax"),isFoundry:e.get("mode")==="foundry"}}),at=()=>{const t=s=>{if(typeof window>"u"){console.warn("[Foundry Service] Window is undefined.");return}if(!window.parent||window.parent===window){console.warn("[Foundry Service] No parent window detected (not in iframe).");return}try{console.log("[Foundry Service] Sending message:",s.type,"to parent window"),window.parent.postMessage(s,"*")}catch(o){console.error("[Foundry Service] Error posting message:",o)}};return{broadcastRollResult:(s,o)=>{if(!C(Y).isFoundry)return;const n=[],r=[];s.forEach(v=>{const{type:P,value:D}=v.expressionMember,T=v.result;P==="dice"?(n.push(String(D)),Array.isArray(T)&&T.forEach(U=>{r.push(U.value)})):typeof T=="number"?n.push(String(T)):n.push(String(D))});const b=n.join(" + "),_={type:"PRECALCULATED_ROLL",formula:b,results:r,flavor:o};console.log(`[Foundry] Broadcasting dice roll: ${b} -> [${r}]`),t(_)},isInsideFoundry:()=>window.self!==window.top||C(Y).isFoundry,syncCharacterState:async s=>{const o=C(Y);if(!o.isFoundry)return;if(!o.uuid){console.warn("[Foundry] Error: Modo Foundry detectado pero falta UUID en la URL.");return}let n;try{s.img&&(n=await fe(s.img,256,8,"#000000"))}catch(_){console.error("[Foundry] Error generando token circular:",_),n=s.img}const r={name:s.name,imageUrl:n,imageSource:s.img,hp:{value:s.currentHP,max:s.maxHP},initiative:s.initiative},b={type:"UPDATE_ACTOR",uuid:o.uuid,actorId:o.uuid,payload:r};console.log(`[Foundry] Syncing Character ${o.uuid}:`,r),t(b)},syncCreatureState:async s=>{const o=C(Y);if(!o.isFoundry)return;if(!o.uuid){console.warn("[Foundry] Error: Falta UUID para la criatura.");return}let n;try{s.img&&(n=await fe(s.img,256,8,"#990000"))}catch(_){console.error("[Foundry] Error generando token de criatura:",_),n=s.img}const r={name:s.name,imageUrl:n,imageSource:s.img,hp:{value:s.stats.maxHealth,max:s.stats.maxHealth}},b={type:"UPDATE_ACTOR",uuid:o.uuid,actorId:o.uuid,payload:r};t(b)},foundryParams:Y}},J="arcana:rollLogs:personal",j="arcana:rollLogs:party:",K=100,A={inited:!1,clearTimeoutId:null,roll3DDice:async()=>[],clear3DDices:()=>{},logs:z([]),rollModalOpened:z(!1),rollModalData:z(void 0)},$=qe(),B=Ke();let G=null,k=null,H=!1,te=!1;const{broadcastRollResult:nt,isInsideFoundry:be}=at(),it=()=>{try{const t=(()=>{const m=B.getTarget();return m&&m.type==="party"?`${j}${m.partyId}`:J})(),e=localStorage.getItem(t),p=e?JSON.parse(e):[];return(Array.isArray(p)?p.slice(-K):p).map(m=>q(m))}catch(t){return console.error("Error loading roll logs:",t),[]}finally{A.logs.subscribe(async t=>{try{await ct(t)}catch(e){console.error("[dice-roller-service] saveRollLogs subscription error:",e)}})}},ct=async t=>{if(!H){if(te){try{const p=(Array.isArray(t)?t.slice(-K):[]).map(m=>Q(m)),a=(()=>{const m=B.getTarget();return m&&m.type==="party"?`${j}${m.partyId}`:J})();localStorage.setItem(a,JSON.stringify(p))}catch(e){console.error("[dice-roller-service] Error persisting locally during concurrent save:",e)}return}try{const e=Array.isArray(t)?t.slice(-K):[],p=e.filter(a=>a&&a.pending);for(const a of p)a&&!a.id&&(a.id=ue());if(G&&$.isEnabled()&&p.length>0)try{te=!0;const a=p.map(s=>Q(s));{const s=B.getTarget();if(s&&s.type==="party"){const o=C($.user),n={id:o?.uid,name:o?.displayName??o?.email??"Usuario",photoURL:o?.photoURL??void 0};await $.saveGroupRollLogsForParty(s.partyId,a,n)}else await $.saveRollLogsForUser(G,a)}const m=a.map(s=>s.id).filter(Boolean);if(m.length>0){A.logs.update(r=>Array.isArray(r)?r.map(b=>m.includes(b.id)?{...b,pending:!1}:b):r);const s=C(A.logs)||[],o=(Array.isArray(s)?s.slice(-K):[]).map(r=>Q(r)),n=(()=>{const r=B.getTarget();return r&&r.type==="party"?`${j}${r.partyId}`:J})();localStorage.setItem(n,JSON.stringify(o))}}catch(a){console.error("[dice-roller-service] Cloud sync failed, falling back to localStorage:",a)}finally{te=!1}try{const a=e.map(s=>Q(s)),m=(()=>{const s=B.getTarget();return s&&s.type==="party"?`${j}${s.partyId}`:J})();localStorage.setItem(m,JSON.stringify(a))}catch(a){console.error("Error saving roll logs to localStorage:",a)}}catch(e){console.error("Error preparing roll logs for save:",e)}finally{te=!1}}},ye=async t=>V.STANDARD_DICES.some(p=>t.endsWith(p))&&!be()?A.roll3DDice(t):new Promise(p=>{const[a,m]=t.split("d"),s=[];for(let o=0;o<Number(a);o++)s.push({value:Math.floor(Math.random()*Number(m))+1,sides:Number(m),dieType:"d"+m,groupId:0,rollId:o,theme:"default",themeColor:"#000000"});p(s)}),lt=(t,e,p)=>{const a=we(t),m={id:ue(),timestamp:new Date,title:e||"Tirada rÃ¡pida",total:a,formattedTotal:p?p(a):void 0,pending:!0,detail:Ye(t)},s=B.getTarget();if(s&&s.type==="party"){const o=C($.user);o?.uid&&(m.authorId=o.uid,m.authorName=o.displayName??o.email??void 0)}A.logs.update(o=>[...o,m].slice(-K))},re=(t,e)=>{const p=new Map;for(const s of t)s&&s.id&&p.set(s.id,s);const a=new Map;for(const s of t)s&&s.id&&a.set(s.id,s);for(const s of e){const o=s.id;if(!o){const r=ue();s.id=r,a.set(r,s);continue}if(s.pending){a.set(o,s);continue}const n=p.get(o);if(!n)a.set(o,s);else{const r=new Date(s.timestamp).getTime(),b=new Date(n.timestamp).getTime();!isNaN(r)&&!isNaN(b)?a.set(o,r>=b?s:n):a.set(o,s)}}return Array.from(a.values()).sort((s,o)=>new Date(s.timestamp).getTime()-new Date(o.timestamp).getTime()).slice(-K)},yt=()=>{A.inited||(A.logs.set(it()),A.inited=!0,(async()=>{try{await $.initFirebase(),await $.onAuthState(async o=>{const n=G;if(G=o?o.uid:null,n&&n!==G&&k)try{k(),k=null}catch{}if(G&&$.isEnabled())try{{const r=B.getTarget();r&&r.type==="party"?k=$.listenGroupRollLogsForParty(r.partyId,b=>{H=!0;try{const _=(b||[]).map(D=>q(D)),v=C(A.logs)||[],P=re(_,v);A.logs.set(P)}catch(_){console.error("[dice-roller-service] Error applying remote logs:",_)}finally{H=!1}}):k=$.listenRollLogsForUser(G,b=>{H=!0;try{const _=(b||[]).map(D=>q(D)),v=C(A.logs)||[],P=re(_,v);A.logs.set(P)}catch(_){console.error("[dice-roller-service] Error applying remote logs:",_)}finally{H=!1}})}}catch(r){console.error("[dice-roller-service] Error starting remote listener:",r)}else try{const r=(()=>{const _=B.getTarget();return _&&_.type==="party"?`${j}${_.partyId}`:J})(),b=localStorage.getItem(r);if(b){const v=JSON.parse(b).map(P=>q(P));A.logs.set(v)}}catch(r){console.error("[dice-roller-service] Error loading local logs:",r)}})}catch(o){console.warn("[dice-roller-service] Firebase setup error (continuing with local logs):",o)}})(),B.target.subscribe(o=>{try{const n=o&&o.type==="party"?`${j}${o.partyId}`:J,r=localStorage.getItem(n);if(r){const _=JSON.parse(r).map(v=>q(v));A.logs.set(_)}else A.logs.set([])}catch{A.logs.set([])}if(k){try{k()}catch{}k=null}if(G&&$.isEnabled())try{o&&o.type==="party"?k=$.listenGroupRollLogsForParty(o.partyId,n=>{H=!0;try{const r=(n||[]).map(v=>q(v)),b=C(A.logs)||[],_=re(r,b);A.logs.set(_)}catch(r){console.error("[dice-roller-service] Error applying remote logs:",r)}finally{H=!1}}):k=$.listenRollLogsForUser(G,n=>{H=!0;try{const r=(n||[]).map(v=>q(v)),b=C(A.logs)||[],_=re(r,b);A.logs.set(_)}catch(r){console.error("[dice-roller-service] Error applying remote logs:",r)}finally{H=!1}})}catch(n){console.error("[dice-roller-service] Error starting remote listener:",n)}else try{const n=(()=>{const b=B.getTarget();return b&&b.type==="party"?`${j}${b.partyId}`:J})(),r=localStorage.getItem(n);if(r){const _=JSON.parse(r).map(v=>q(v));A.logs.set(_)}else A.logs.set([])}catch(n){console.error("[dice-roller-service] Error loading local logs:",n)}}));const t=({expression:o,variables:n={},title:r=void 0,resultFormatter:b=()=>{},rollType:_="normal"})=>{A.rollModalData.set({expression:o,variables:n,title:r??"Tirar",rollType:_,extraModsExpression:"",resultFormatter:b}),A.rollModalOpened.set(!0)},e=async()=>{const o=C(A.rollModalData);if(A.rollModalData.set(void 0),A.rollModalOpened.set(!1),!o)return;let n=o.expression,r=o.title;o.rollType!=="normal"&&(n+=o.rollType==="advantage"?"+1d4":"-1d4",r+=o.rollType==="advantage"?" (ventaja)":" (desventaja)"),o?.extraModsExpression&&(n+=`+${o.extraModsExpression.trim()}`,n=n.replaceAll("++","+").replaceAll("+-","-")),a({expression:n,variables:o.variables,title:r})},p=()=>{A.rollModalOpened.set(!1),A.rollModalData.set(void 0)},a=async({expression:o,variables:n={},title:r=void 0,resultFormatter:b=()=>{}})=>{const _=We(o,n);A.clearTimeoutId&&(clearTimeout(A.clearTimeoutId),A.clearTimeoutId=null),A.clear3DDices();const v=[];for(const P of _)P.type==="dice"?v.push({expressionMember:P,promise:ye(P.value),result:void 0,explosionResolved:!1,numExplosions:0}):v.push({expressionMember:P,promise:void 0,result:P.value,explosionResolved:!0,numExplosions:0});for(;v.some(P=>P.result===void 0);){const P=[],D=v.filter(T=>T.expressionMember.type==="dice"&&T.result===void 0);for(const T of D)P.push((async()=>{T.result=await T.promise,T.promise=void 0;for(const U of T.result)T.expressionMember.isExplosive&&U.sides===U.value&&U.sides>1&&T.numExplosions++;if(T.numExplosions>0){const U={...T.expressionMember,value:`${T.numExplosions}d${T.result[0].sides}`};v.push({expressionMember:U,promise:ye(U.value),result:void 0,explosionResolved:!1,numExplosions:0})}return T})());await Promise.all(P)}return A.clearTimeoutId=setTimeout(()=>{A.clear3DDices()},V.CLEAR_3D_DICES_DELAY),lt(v,r,b),be()&&(console.log("Broadcasting roll to Foundry..."),nt(v,r)),we(v)};return{rollExpression:a,register3DDiceRollerFn:o=>{A.roll3DDice=o},registerClear3DDicesFn:o=>{A.clear3DDices=o},rollLogs:A.logs,rollModal:{rollModalOpened:A.rollModalOpened,openRollModal:t,rollModalData:A.rollModalData,submitRollModal:e,abortRollModal:p}}};export{X as C,se as P,yt as a,at as b,Ke as c,ft as d,ot as p,qe as u,rt as v};
