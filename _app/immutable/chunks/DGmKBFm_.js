const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./lCNLHSrR.js","./C4c6zY-H.js","./yBjK6igh.js","./x4_yyNok.js"])))=>i.map(i=>d[i]);
import{_ as D}from"./PPVm8Dsz.js";import{C as U}from"./CyC3GOE6.js";import{w as J,g as $}from"./y52P6WVk.js";const Se=r=>{if(r&&typeof r.toDate=="function")try{return r.toDate()}catch{}if(r instanceof Date)return r;if(typeof r=="string"||typeof r=="number"){const e=new Date(r);if(!isNaN(e.getTime()))return e}if(r&&typeof r=="object"){const e=typeof r.seconds=="number"?r.seconds:typeof r._seconds=="number"?r._seconds:null;if(typeof e=="number")return new Date(e*1e3)}return new Date},z=r=>({...r,timestamp:Se(r.timestamp)}),X=r=>({...r,timestamp:r.timestamp.toISOString()}),Le=(r,e)=>{if(!r)return 0;const y=r.trim();try{const o=new Function("cuerpo","reflejos","mente","instinto","presencia","ppGastados","floor","ceil","round","Math",`return (${y});`);return Number(o(Number(e.cuerpo)||0,Number(e.reflejos)||0,Number(e.mente)||0,Number(e.instinto)||0,Number(e.presencia)||0,Number(e.ppGastados)||0,Math.floor,Math.ceil,Math.round,Math))||0}catch(o){return console.error("Error evaluating modifier expression:",o),0}},Me=(r,e)=>Le(r,{cuerpo:e.attributes.body,reflejos:e.attributes.reflexes,mente:e.attributes.mind,instinto:e.attributes.instinct,presencia:e.attributes.presence,ppGastados:e.spentPP,floor:Math.floor,ceil:Math.ceil,round:Math.round,Math});class W{id;name;attributes;cards;ppHistory;goldHistory;equipment;modifiers;currentHP;tempHP;currentLuck;img;story;notes;languages;quickInfo;attacks;maxActiveCards;version;party;constructor(e){this.id=e.id,this.name=e.name,this.attributes=e.attributes,this.cards=e.cards,this.ppHistory=e.ppHistory,this.goldHistory=e.goldHistory,this.equipment=e.equipment,this.modifiers=e.modifiers,this.currentHP=e.currentHP,this.tempHP=e.tempHP,this.currentLuck=e.currentLuck,this.img=e.img,this.party=e.party??{partyId:null,ownerId:null},this.story=e.story,this.notes=e.notes,this.languages=e.languages,this.quickInfo=e.quickInfo,this.attacks=e.attacks,this.maxActiveCards=e.maxActiveCards,this.version=e.version}calculateAttrModifiers(e,y){let o=y;const m=this.modifiers.filter(a=>a.attribute===e);for(const a of m){const c=Me(a.formula,this);if(a.type==="set")return c;a.type==="add"&&(o+=c)}return o}get maxLuck(){const e=U.MAX_LUCK;return this.calculateAttrModifiers("maxLuck",e)}get maxHP(){const e=U.BASE_HEALTH+this.attributes.body*U.HEALTH_BODY_MULTIPIER;return this.calculateAttrModifiers("maxHP",e)}get speed(){const e=U.BASE_SPEED+this.attributes.reflexes;return this.calculateAttrModifiers("speed",e)}get evasion(){const e=U.BASE_EVASION+this.attributes.reflexes;return this.calculateAttrModifiers("evasion",e)}get physicalMitigation(){return this.calculateAttrModifiers("physicalMitigation",0)}get magicalMitigation(){return this.calculateAttrModifiers("magicalMitigation",0)}get currentGold(){const e=this.goldHistory.filter(o=>o.type==="add").reduce((o,m)=>o+m.value,0),y=this.spentGold;return y>0?e-y:e}get spentGold(){return this.goldHistory.filter(e=>e.type==="subtract").reduce((e,y)=>e+y.value,0)}get currentPP(){const e=this.ppHistory.filter(o=>o.type==="add").reduce((o,m)=>o+m.value,0),y=this.spentPP;return y>0?e-y:e}get spentPP(){return this.ppHistory.filter(e=>e.type==="subtract").reduce((e,y)=>e+y.value,0)}get pjPower(){const e=this.cards.map(m=>m.level).sort((m,a)=>a-m).slice(0,U.TOP_N_CARDS_TO_CALCULATE_PJ_POWER);console.log(e);const y=e.reduce((m,a)=>m+a,0)/e.length,o=this.spentPP/U.PJ_POWER_SPENT_PP_DIVIDER;return Math.round(y+o)}get tier(){for(const e of U.CHARACTER_TIERS)if(this.spentPP>=e.minPP&&this.spentPP<=e.maxPP)return e.tier;return 0}get numActiveCards(){return this.cards.filter(e=>e.isActive).length}get initiative(){return this.attributes.reflexes}copy(){return new W({...this})}getExportableData(){return{...this,party:{partyId:null,ownerId:null}}}}class te{id;name;ownerId;notes;members;characters;unsubscribeCharacterListener;constructor(e){this.id=e?.id??"",this.name=e?.name??"",this.ownerId=e?.ownerId??"",this.notes=Array.isArray(e?.notes)?e.notes:[],this.members=e?.members&&typeof e.members=="object"?e.members:{},this.characters=e?.characters??[],this.unsubscribeCharacterListener=e?.unsubscribeCharacterListener??(()=>{})}getAllCharacterIds(){const e=[];for(const y of Object.keys(this.members)){const o=this.members[y]??[];for(const m of o)e.includes(m)||e.push(m)}return e}getCharactersFullIdentifiers(){const e=[];for(const y of Object.keys(this.members)){const o=this.members[y]??[];for(const m of o)e.push({userId:y,characterId:m})}return e}isAccessible(e){return this.ownerId===e||this.members[e]?.length>0}copy(){const e=JSON.parse(JSON.stringify(this.asPlain())),y=new te(e);return y.characters=this.characters.filter(o=>o.party.partyId===this.id&&y.getAllCharacterIds().includes(o.id)),y.unsubscribeCharacterListener=this.unsubscribeCharacterListener,y}asPlain(){return{id:this.id,name:this.name,ownerId:this.ownerId,notes:this.notes,members:this.members}}}var Z={VITE_FIREBASE_MESSAGING_SENDER_ID:"647852941329",VITE_FIREBASE_STORAGE_BUCKET:"arcana-85eeb.firebasestorage.app",VITE_FIREBASE_AUTH_DOMAIN:"arcana-85eeb.firebaseapp.com",VITE_FIREBASE_PROJECT_ID:"arcana-85eeb",VITE_FIREBASE_APP_ID:"1:647852941329:web:f2aa1e9dd6792f6a9d91b0",VITE_FIREBASE_API_KEY:"AIzaSyAFv5lor5ufY-KPBQ166rPSRnscFrtm88w"};function M(){return typeof window<"u"}function Oe(){if(typeof Z>"u")return null;const r=typeof Z=="string"?JSON.parse(Z):Z;return r.VITE_FIREBASE_API_KEY?{apiKey:r.VITE_FIREBASE_API_KEY,authDomain:r.VITE_FIREBASE_AUTH_DOMAIN,projectId:r.VITE_FIREBASE_PROJECT_ID,storageBucket:r.VITE_FIREBASE_STORAGE_BUCKET,messagingSenderId:r.VITE_FIREBASE_MESSAGING_SENDER_ID,appId:r.VITE_FIREBASE_APP_ID}:null}function Ne(){let r=null,e=null,y=!1,o=null,m=0,a=0,c=null;const w=()=>{if(!c)try{c=setTimeout(()=>{c=null;try{console.debug("[firebase-service] ops:",{reads:m,writes:a})}catch{}},1e3)}catch{}},t=(l=1)=>{m+=l,w()},E=(l=1)=>{a+=l,w()},I=J(!1),A=J(null);async function P(){if(y)return;if(y=!0,!M()){I.set(!1);return}const l=Oe()??null;if(!l)throw I.set(!1),new Error("Firebase configuration missing: VITE_FIREBASE_* variables required.");try{const{initializeApp:s,getApps:u}=await D(async()=>{const{initializeApp:b,getApps:p}=await import("./lCNLHSrR.js");return{initializeApp:b,getApps:p}},__vite__mapDeps([0,1]),import.meta.url),n=await D(()=>import("./yBjK6igh.js"),__vite__mapDeps([2,1]),import.meta.url),d=await D(()=>import("./x4_yyNok.js"),__vite__mapDeps([3,1]),import.meta.url);u&&u().length===0&&s(l),r=n.getAuth(),e=d.getFirestore(),n.onAuthStateChanged(r,b=>{const p=b?{uid:b.uid,displayName:b.displayName,email:b.email,photoURL:b.photoURL}:null;A.set(p)}),I.set(!0)}catch(s){throw I.set(!1),console.error("[firebase-service] Initialization error:",s),s}}async function R(){if(o)return o;o=P();try{await o}finally{o=null}}function S(){let l=!1;return I.subscribe(s=>{l=s})(),l&&!!r&&!!e}async function C(){if(!M())return null;await R();const{GoogleAuthProvider:l,signInWithPopup:s}=await D(async()=>{const{GoogleAuthProvider:p,signInWithPopup:g}=await import("./yBjK6igh.js");return{GoogleAuthProvider:p,signInWithPopup:g}},__vite__mapDeps([2,1]),import.meta.url),u=new l;u.setCustomParameters({prompt:"select_account"});const d=(await s(r,u)).user;if(!d)return null;const b={uid:d.uid,displayName:d.displayName,email:d.email,photoURL:d.photoURL};return A.set(b),b}async function se(){if(!M())return;await R();const{signOut:l}=await D(async()=>{const{signOut:s}=await import("./yBjK6igh.js");return{signOut:s}},__vite__mapDeps([2,1]),import.meta.url);await l(r),A.set(null)}async function oe(l){if(!M())return l(null),()=>{};await R();const{onAuthStateChanged:s}=await D(async()=>{const{onAuthStateChanged:n}=await import("./yBjK6igh.js");return{onAuthStateChanged:n}},__vite__mapDeps([2,1]),import.meta.url);return s(r,n=>{const d=n?{uid:n.uid,displayName:n.displayName,email:n.email,photoURL:n.photoURL}:null;A.set(d),l(d)})}async function O(){if(await R(),!e)throw new Error("Firestore not initialized")}async function ae(l,s){if(!l)throw new Error("userId required");if(!M())return;await O();const{doc:u,writeBatch:n,getDoc:d}=await D(async()=>{const{doc:i,writeBatch:f,getDoc:h}=await import("./x4_yyNok.js");return{doc:i,writeBatch:f,getDoc:h}},__vite__mapDeps([3,1]),import.meta.url);let b=s.map(i=>JSON.parse(JSON.stringify(i||{})));const p=b.filter(i=>!i||typeof i.id!="string"||i.id.trim()==="");if(p.length>0&&console.warn("[firebase-service] saveCharactersForUser: skipping characters without valid id:",p.map(i=>i&&i.id)),b=b.filter(i=>i&&typeof i.id=="string"&&i.id.trim()!==""),b.length===0)return;try{const i=new Set;for(const f of b){const h=(f?.party&&f.party.partyId)??f?.partyId??null;h&&i.add(h)}if(i.size>0){const f=new Map;for(const h of i)try{const _=await d(u(e,"parties",h));t();let T;_&&typeof _.exists=="function"&&_.exists()?T=_.data():T=void 0,f.set(h,T?T.ownerId??null:null)}catch(_){console.warn("[firebase-service] Failed to read party for denormalization",h,_),f.set(h,null)}for(const h of b){const _=(h?.party&&h.party.partyId)??h?.partyId??null;h.party?_?(h.party.partyId=_,h.party.ownerId=f.get(_)??null):h.party={partyId:null,ownerId:null}:h.party={partyId:_??null,ownerId:_?f.get(_)??null:null}}}else for(const f of b)f.party?f.party.ownerId=f.party.ownerId??null:f.party={partyId:null,ownerId:null}}catch(i){console.warn("[firebase-service] Party denormalization step failed:",i);for(const f of b)f.party?f.party.ownerId=f.party.ownerId??null:f.party={partyId:null,ownerId:null}}const g=3;for(let i=1;i<=g;i++)try{for(const h of b)if(!(!h||!h.id||typeof h.id!="string"))try{const _=u(e,"users",l,"characters",h.id),T=await d(_);if(t(),T&&T.exists()){const L=T.data()||{},N=(L?.party&&L.party.partyId)??L?.partyId??null,K=(h?.party&&h.party.partyId)??h?.partyId??null;if(N&&(!K||K!==N))try{await ne(N,l,h.id)}catch(ie){console.warn("[firebase-service] best-effort removePartyMember failed for",{prevPartyId:N,userId:l,cid:h.id,err:ie})}}}catch(_){console.warn("[firebase-service] failed to read existing character doc (continuing):",h?.id,_)}const f=n(e);for(const h of b){if(!h||!h.id||typeof h.id!="string")continue;const _=u(e,"users",l,"characters",h.id);f.set(_,h,{merge:!0})}await f.commit(),E(b.length);return}catch(f){if(console.error(`[firebase-service] saveCharactersForUser attempt ${i} failed:`,f),i===g)throw f;await new Promise(h=>setTimeout(h,200*i))}}async function fe(l,s){if(!l)throw new Error("userId required");if(!s)throw new Error("characterId required");if(!M())return;await O();const{doc:u,deleteDoc:n}=await D(async()=>{const{doc:d,deleteDoc:b}=await import("./x4_yyNok.js");return{doc:d,deleteDoc:b}},__vite__mapDeps([3,1]),import.meta.url);await n(u(e,"users",l,"characters",s)),E()}async function me(l){if(!l)throw new Error("userId required");if(!M())return[];await O();const{collection:s,getDocs:u}=await D(async()=>{const{collection:p,getDocs:g}=await import("./x4_yyNok.js");return{collection:p,getDocs:g}},__vite__mapDeps([3,1]),import.meta.url),n=s(e,"users",l,"characters"),d=await u(n);t(d?.size??0);const b=[];return d.forEach(p=>{const g=p.data();b.push(new W(g))}),b}function ye(l,s){if(!M())return s([]),()=>{};let u=()=>{};return(async()=>{try{await O();const{collection:n,onSnapshot:d}=await D(async()=>{const{collection:p,onSnapshot:g}=await import("./x4_yyNok.js");return{collection:p,onSnapshot:g}},__vite__mapDeps([3,1]),import.meta.url),b=n(e,"users",l,"characters");u=d(b,p=>{t(p?.size??0);const g=[];p.forEach(i=>{g.push(new W(i.data()))}),s(g)},p=>{console.error("[firebase-service] listenCharactersForUser snapshot error:",p),s([])})}catch(n){console.error("[firebase-service] listenCharactersForUser setup error:",n),s([])}})(),()=>{try{u&&u()}catch{}}}async function ge(l){if(!l||!M())return null;await O();const{doc:s,getDoc:u}=await D(async()=>{const{doc:n,getDoc:d}=await import("./x4_yyNok.js");return{doc:n,getDoc:d}},__vite__mapDeps([3,1]),import.meta.url);try{const n=await u(s(e,"parties",l));if(t(),!n.exists())return null;const d=n.data();return new te(d)}catch(n){return console.error("[firebase-service] loadParty failed:",n),null}}async function he(l,s,u){if(!l)throw new Error("partyId required");if(!s)throw new Error("userId required");if(!u)throw new Error("characterId required");if(!M())return;await O();const{doc:n,runTransaction:d,getDoc:b,updateDoc:p,setDoc:g}=await D(async()=>{const{doc:f,runTransaction:h,getDoc:_,updateDoc:T,setDoc:L}=await import("./x4_yyNok.js");return{doc:f,runTransaction:h,getDoc:_,updateDoc:T,setDoc:L}},__vite__mapDeps([3,1]),import.meta.url),i=n(e,"parties",l);try{await d(e,async f=>{const h=await f.get(i);if(t(),!h||!h.exists()){const N={};N[s]=[u],f.set(i,{members:N},{merge:!0}),E();return}const _=h.data()||{},T=_.members&&typeof _.members=="object"?_.members:{},L=Array.isArray(T[s])?T[s].slice():[];if(!L.includes(u)){L.push(u);const N={};N[`members.${s}`]=L,f.update(i,N),E()}})}catch(f){console.error("[firebase-service] setPartyMember transaction failed:",f);try{const h=await b(i);if(t(),!h||!h.exists()){await g(i,{members:{[s]:[u]}},{merge:!0}),E();return}const _=h.data()||{},T=_.members&&typeof _.members=="object"?_.members:{},L=Array.isArray(T[s])?T[s].slice():[];L.includes(u)||(L.push(u),await p(i,{[`members.${s}`]:L}),E())}catch(h){throw console.error("[firebase-service] setPartyMember fallback failed:",h),f}}}async function ne(l,s,u){if(!l)throw new Error("partyId required");if(!s)throw new Error("userId required");if(!u)throw new Error("characterId required");if(!M())return;await O();const{doc:n,runTransaction:d,getDoc:b,updateDoc:p,deleteField:g}=await D(async()=>{const{doc:f,runTransaction:h,getDoc:_,updateDoc:T,deleteField:L}=await import("./x4_yyNok.js");return{doc:f,runTransaction:h,getDoc:_,updateDoc:T,deleteField:L}},__vite__mapDeps([3,1]),import.meta.url),i=n(e,"parties",l);try{await d(e,async f=>{const h=await f.get(i);if(t(),!h||!h.exists())return;const _=h.data()||{},T=_.members&&typeof _.members=="object"?_.members:{},L=Array.isArray(T[s])?T[s].slice():[],N=L.indexOf(u);N!==-1&&(L.splice(N,1),L.length===0?(f.update(i,{[`members.${s}`]:g()}),E()):(f.update(i,{[`members.${s}`]:L}),E()))})}catch(f){console.error("[firebase-service] removePartyMember transaction failed:",f);try{const{deleteField:h}=await D(async()=>{const{deleteField:ie}=await import("./x4_yyNok.js");return{deleteField:ie}},__vite__mapDeps([3,1]),import.meta.url),_=await b(i);if(t(),!_||!_.exists())return;const T=_.data()||{},L=T.members&&typeof T.members=="object"?T.members:{},N=Array.isArray(L[s])?L[s].slice():[],K=N.indexOf(u);K!==-1&&(N.splice(K,1),N.length===0?(await p(i,{[`members.${s}`]:h()}),E()):(await p(i,{[`members.${s}`]:N}),E()))}catch(h){throw console.error("[firebase-service] removePartyMember fallback failed:",h),f}}}async function be(l){if(!l||!l.id)throw new Error("party.id required");if(!M())return;await O();const{doc:s,setDoc:u}=await D(async()=>{const{doc:b,setDoc:p}=await import("./x4_yyNok.js");return{doc:b,setDoc:p}},__vite__mapDeps([3,1]),import.meta.url),n=l.asPlain(),d=3;for(let b=1;b<=d;b++)try{await u(s(e,"parties",n.id),n,{merge:!0}),E();return}catch(p){if(console.error(`[firebase-service] saveParty attempt ${b} failed for party ${n.id} owner=${n.ownerId}:`,p),b===d){try{console.error("[firebase-service] saveParty giving up after max attempts for party:",JSON.stringify(n))}catch(g){console.error("[firebase-service] saveParty could not stringify party payload",g)}throw p}await new Promise(g=>setTimeout(g,200*b))}}async function we(l){if(!l)throw new Error("partyId required");if(!M())return;await O();const{doc:s,deleteDoc:u}=await D(async()=>{const{doc:n,deleteDoc:d}=await import("./x4_yyNok.js");return{doc:n,deleteDoc:d}},__vite__mapDeps([3,1]),import.meta.url);await u(s(e,"parties",l)),E()}function Ee(l,s){if(!M())return s([]),()=>{};let u=()=>{};return(async()=>{try{await O();const{collection:n,onSnapshot:d}=await D(async()=>{const{collection:p,onSnapshot:g}=await import("./x4_yyNok.js");return{collection:p,onSnapshot:g}},__vite__mapDeps([3,1]),import.meta.url),b=n(e,"parties");u=d(b,p=>{try{t(p?.size??0)}catch{}const g=[];p.forEach(i=>{const f=i.data();if(!f)return;f.id=i.id;const h=f.ownerId===l,_=f.members&&typeof f.members=="object"&&Array.isArray(f.members[l])&&f.members[l].length>0;(h||_)&&g.push(new te(f))}),s(g)},p=>{console.error("[firebase-service] listenToUserParties error:",p),s([])})}catch(n){console.error("[firebase-service] listenToUserParties setup error:",n),s([])}})(),()=>{try{u&&u()}catch{}}}async function _e(l,s){if(!l)throw new Error("userId required");if(!M())return;await O();const{doc:u,writeBatch:n}=await D(async()=>{const{doc:p,writeBatch:g}=await import("./x4_yyNok.js");return{doc:p,writeBatch:g}},__vite__mapDeps([3,1]),import.meta.url),d=s.map(p=>JSON.parse(JSON.stringify(p||{}))),b=3;for(let p=1;p<=b;p++)try{const g=n(e);for(const i of d){const f=u(e,"users",l,"rollLogs",i.id);g.set(f,i,{merge:!0})}await g.commit(),E(d.length);return}catch(g){if(console.error(`[firebase-service] saveRollLogsForUser attempt ${p} failed:`,g),p===b)throw g;await new Promise(i=>setTimeout(i,200*p))}}async function ve(l,s,u){if(!l)throw new Error("partyId required");if(!M())return;await O();const{doc:n,writeBatch:d}=await D(async()=>{const{doc:g,writeBatch:i}=await import("./x4_yyNok.js");return{doc:g,writeBatch:i}},__vite__mapDeps([3,1]),import.meta.url),b=s.map(g=>{const i=JSON.parse(JSON.stringify(g||{}));return u&&(u.id&&(i.authorId=u.id),u.name&&(i.authorName=u.name),u.photoURL&&(i.authorPhotoURL=u.photoURL)),i}),p=3;for(let g=1;g<=p;g++)try{const i=d(e);for(const f of b){const h=n(e,"parties",l,"rollLogs",f.id);i.set(h,f,{merge:!0})}await i.commit(),E(b.length);return}catch(i){if(console.error(`[firebase-service] saveGroupRollLogsForParty attempt ${g} failed:`,i),g===p)throw i;await new Promise(f=>setTimeout(f,200*g))}}function Ie(l,s){if(!M())return s([]),()=>{};let u=()=>{};return(async()=>{try{await O();const{collection:n,onSnapshot:d}=await D(async()=>{const{collection:p,onSnapshot:g}=await import("./x4_yyNok.js");return{collection:p,onSnapshot:g}},__vite__mapDeps([3,1]),import.meta.url),b=n(e,"parties",l,"rollLogs");u=d(b,p=>{t(p?.size??0);const g=[];p.forEach(i=>{const f={...i.data()||{},id:i.id};g.push(f)}),s(g)},p=>{console.error("[firebase-service] listenGroupRollLogsForParty snapshot error:",p),s([])})}catch(n){console.error("[firebase-service] listenGroupRollLogsForParty setup error:",n),s([])}})(),()=>{try{u&&u()}catch{}}}async function Ae(l,s){if(!l)throw new Error("partyId required");if(!s)throw new Error("logId required");if(!M())return;await O();const{doc:u,deleteDoc:n}=await D(async()=>{const{doc:d,deleteDoc:b}=await import("./x4_yyNok.js");return{doc:d,deleteDoc:b}},__vite__mapDeps([3,1]),import.meta.url);await n(u(e,"parties",l,"rollLogs",s)),E()}async function Pe(l){if(!l)throw new Error("userId required");if(!M())return[];await O();const{collection:s,getDocs:u}=await D(async()=>{const{collection:p,getDocs:g}=await import("./x4_yyNok.js");return{collection:p,getDocs:g}},__vite__mapDeps([3,1]),import.meta.url),n=s(e,"users",l,"rollLogs"),d=await u(n);t(d?.size??0);const b=[];return d.forEach(p=>b.push({...p.data()||{},id:p.id})),b}function Te(l,s){if(!M())return s([]),()=>{};let u=()=>{};return(async()=>{try{await O();const{collection:n,onSnapshot:d}=await D(async()=>{const{collection:p,onSnapshot:g}=await import("./x4_yyNok.js");return{collection:p,onSnapshot:g}},__vite__mapDeps([3,1]),import.meta.url),b=n(e,"users",l,"rollLogs");u=d(b,p=>{t(p?.size??0);const g=[];p.forEach(i=>{const f={...i.data()||{},id:i.id};g.push(f)}),s(g)},p=>{console.error("[firebase-service] listenRollLogsForUser snapshot error:",p),s([])})}catch(n){console.error("[firebase-service] listenRollLogsForUser setup error:",n),s([])}})(),()=>{try{u&&u()}catch{}}}async function De(l,s){if(!l)throw new Error("userId required");if(!s)throw new Error("logId required");if(!M())return;await O();const{doc:u,deleteDoc:n}=await D(async()=>{const{doc:d,deleteDoc:b}=await import("./x4_yyNok.js");return{doc:d,deleteDoc:b}},__vite__mapDeps([3,1]),import.meta.url);await n(u(e,"users",l,"rollLogs",s)),E()}const Y={};function ce(l,s){if(!M())return()=>{};const u=`${l.userId}/${l.characterId}`;let n=Y[u];if(n||(n={subscribers:new Set,unsubscribe:null,latest:null},Y[u]=n),n.subscribers.add(s),n.unsubscribe||(async()=>{try{await O();const{doc:d,onSnapshot:b}=await D(async()=>{const{doc:g,onSnapshot:i}=await import("./x4_yyNok.js");return{doc:g,onSnapshot:i}},__vite__mapDeps([3,1]),import.meta.url),p=d(e,"users",l.userId,"characters",l.characterId);n.unsubscribe=b(p,g=>{if(t(),g&&g.exists()){const i=g.data()||{};i.id||(i.id=g.id),n.latest=new W(i)}else n.latest=null;for(const i of Array.from(n.subscribers))try{i(n.latest)}catch(f){console.error("[firebase-service] subscribeCharacter subscriber error:",f)}},g=>{console.error("[firebase-service] subscribeCharacter snapshot error for",u,g)})}catch(d){console.error("[firebase-service] subscribeCharacter setup error for",u,d)}})(),n.latest!==null)try{s(n.latest)}catch(d){console.error("[firebase-service] subscribeCharacter immediate callback error:",d)}return()=>{const d=Y[u];if(d&&(d.subscribers.delete(s),d.subscribers.size===0)){try{d.unsubscribe&&d.unsubscribe()}catch{}delete Y[u]}}}function Re(l,s){if(!M())return s([]),()=>{};const u={},n=[];for(const d of l){if(!d||!d.userId||!d.characterId)continue;const b=`${d.userId}/${d.characterId}`,p=ce(d,g=>{u[b]=g;const i=[];for(const f of Object.keys(u)){const h=u[f];h&&i.push(h)}try{s(i)}catch(f){console.error("[firebase-service] listenCharactersByIds callback error:",f)}});n.push(p)}return()=>{for(const d of n)try{d()}catch{}}}return{firebaseReady:I,user:A,initFirebase:R,isEnabled:S,signInWithGoogle:C,signOutUser:se,onAuthState:oe,saveCharactersForUser:ae,loadCharactersForUser:me,deleteCharacterForUser:fe,listenCharactersForUser:ye,saveParty:be,deleteParty:we,loadParty:ge,listenToUserParties:Ee,setPartyMember:he,removePartyMember:ne,subscribeCharacter:ce,listenCharactersByIds:Re,saveRollLogsForUser:_e,loadRollLogsForUser:Pe,deleteRollLogForUser:De,listenRollLogsForUser:Te,saveGroupRollLogsForParty:ve,deleteGroupRollLogForParty:Ae,listenGroupRollLogsForParty:Ie,getReadCount:()=>m,getWriteCount:()=>a,resetOpCounters:()=>{m=0,a=0},getOpCounters:()=>({reads:m,writes:a})}}const Fe=Ne();function xe(){return Fe}const ue="arcana:rollTarget";function de(){return typeof window<"u"}function re(r){return typeof r=="string"&&r.trim().length>0}function $e(r){return!r||typeof r!="object"?null:r.type==="party"&&re(r.partyId)?{type:"party",partyId:r.partyId,partyName:re(r.partyName)?r.partyName:void 0}:{type:"personal"}}function Ce(r){if(de())try{localStorage.setItem(ue,JSON.stringify(r))}catch(e){console.warn("[roll-target-service] failed to persist target",e)}}function ke(){if(!de())return null;try{const r=localStorage.getItem(ue);if(!r)return null;const e=JSON.parse(r);return $e(e)}catch(r){return console.warn("[roll-target-service] failed to load target",r),null}}const F={inited:!1,target:J({type:"personal"}),unsub:null};function Ue(){if(!F.inited){F.inited=!0;const w=ke();w&&F.target.set(w),F.unsub=F.target.subscribe(t=>Ce(t))}const r=()=>{F.target.set({type:"personal"})},e=(w,t)=>{if(!re(w)){console.warn("[roll-target-service] setPartyTarget called with invalid partyId, falling back to personal"),F.target.set({type:"personal"});return}const E={type:"party",partyId:w.trim()};re(t)&&(E.partyName=t.trim()),F.target.set(E)},y=w=>{try{const t=$(F.target);t.type==="party"&&(Array.isArray(w)&&w.includes(t.partyId)||F.target.set({type:"personal"}))}catch(t){console.warn("[roll-target-service] reconcileAccessibility error",t)}},o=()=>$(F.target),m=()=>$(F.target).type==="personal",a=()=>$(F.target).type==="party",c=()=>{const w=$(F.target);return w.type==="party"?w.partyId:null};return{target:F.target,setPersonalTarget:r,setPartyTarget:e,reconcileAccessibility:y,getTarget:o,isPersonalTarget:m,isPartyTarget:a,getPartyId:c,cleanup:()=>{if(F.unsub){try{F.unsub()}catch{}F.unsub=null}}}}const Ve=(r,e)=>{if(!r)return[];const y=[],o=r.replace(/\s+/g,""),m=/([+-]?)(\d*d\d+(?:[eE])?|\d+(\.\d+)?|[A-Za-z_][A-Za-z0-9_]*)/g;let a;for(;(a=m.exec(o))!==null;){const c=a[1]||"+",w=a[2],t=/^(\d*)[dD](\d+)([eE])?$/.exec(w);if(t){const R=t[1],S=t[2],C=!!t[3],se=R?Number(R):1,oe=Number(S);let O=`${se}d${oe}`;c==="-"&&(O=`-${O}`);const ae={type:"dice",isExplosive:C,value:O};y.push(ae);continue}if(/^\d+(\.\d+)?$/.exec(w)){let R=Number(w);c==="-"&&(R=-R),y.push({type:"constant",isExplosive:!1,value:R});continue}const I=w,A=e&&Object.prototype.hasOwnProperty.call(e,I)&&Number(e[I])||0,P=c==="-"?-A:A;y.push({type:"variable",value:P,isExplosive:!1,label:I})}return y},Be=r=>{let e="";return r.forEach((y,o)=>{const m=y.expressionMember;let a="";switch(m.type){case"dice":o>0&&!m.value.toString().startsWith("-")&&(a+="+ "),a+=`${m.value}${m.isExplosive?"e":""} [${y.result.map(c=>`<span class="${c.value===c.sides?"max":""}${c.value===1?"min":""}">`+c.value.toString()+(m.isExplosive&&c.value===c.sides?"ðŸ’¥":"")+"</span>").join(", ")}]`;break;case"constant":a=`${o>0&&m.value>=0?"+ ":""}${m.value}`;break;case"variable":a=`${o>0&&m.value>=0?"+ ":""}${m.label} [${m.value}]`;break}a.startsWith("-")&&(a=a.replace("-","- ")),e+=`${o>0?" ":""}${a}`}),e},pe=r=>{let e=0;return r.forEach(y=>{const o=y.expressionMember;switch(o.type){case"dice":e+=y.result.reduce((m,a)=>m+a.value,0)*(o.value.toString().startsWith("-")?-1:1);break;case"constant":e+=o.value;break;case"variable":e+=o.value;break}}),e},Ke=r=>{const e=[];if(!r||!String(r).trim())return e;const y=String(r).trim(),o=/^[+-]/.test(y)?y:`+${y}`,m=/([+-])\s*([^+-]+)/g;let a;for(;(a=m.exec(o))!==null;){const w=a[1]==="+"?1:-1,t=(a[2]||"").trim();if(!t)continue;const E=t.match(/^(\d+)\s*d\s*(\d+)/i);if(E){const P=Number(E[1]),R=Number(E[2]),C=t.slice(E[0].length).trim()||null;e.push({kind:"dice",sign:w,n:P,faces:R,damageType:C,raw:t});continue}const I=t.match(/^(\d+)/);if(I){const P=Number(I[1]),S=t.slice(I[0].length).trim()||null;e.push({kind:"flat",sign:w,value:P,damageType:S,raw:t});continue}const A=t.match(/(\d+)\s*d\s*(\d+)/i);if(A){const P=Number(A[1]),R=Number(A[2]),S=t.replace(A[0],"").trim()||null;e.push({kind:"dice",sign:w,n:P,faces:R,damageType:S,raw:t});continue}e.push({kind:"flat",sign:w,value:0,damageType:t||null,raw:t})}return e.reduce((w,t)=>t.kind==="dice"?`${w} ${t.sign===1?"+":"-"} ${t.n}d${t.faces}`:t.kind==="flat"?`${w} ${t.sign===1?"+":"-"} ${t.value}`:w,"")},q="arcana:rollLogs:personal",H="arcana:rollLogs:party:",j=100,v={inited:!1,clearTimeoutId:null,roll3DDice:async()=>[],clear3DDices:()=>{},logs:J([]),rollModalOpened:J(!1),rollModalData:J(void 0)},x=xe(),V=Ue();let G=null,k=null,B=!1,Q=!1;const Ge=()=>{try{const r=(()=>{const m=V.getTarget();return m&&m.type==="party"?`${H}${m.partyId}`:q})(),e=localStorage.getItem(r),y=e?JSON.parse(e):[];return(Array.isArray(y)?y.slice(-j):y).map(m=>z(m))}catch(r){return console.error("Error loading roll logs:",r),[]}finally{v.logs.subscribe(async r=>{try{await ze(r)}catch(e){console.error("[dice-roller-service] saveRollLogs subscription error:",e)}})}},ze=async r=>{if(!B){if(Q){try{const y=(Array.isArray(r)?r.slice(-j):[]).map(m=>X(m)),o=(()=>{const m=V.getTarget();return m&&m.type==="party"?`${H}${m.partyId}`:q})();localStorage.setItem(o,JSON.stringify(y))}catch(e){console.error("[dice-roller-service] Error persisting locally during concurrent save:",e)}return}try{const e=Array.isArray(r)?r.slice(-j):[],y=e.filter(o=>o&&o.pending);for(const o of y)if(o&&!o.id)try{o.id=crypto.randomUUID()}catch{o.id=`local-${Date.now()}-${Math.floor(Math.random()*1e5)}`}if(G&&x.isEnabled()&&y.length>0)try{Q=!0;const o=y.map(a=>X(a));{const a=V.getTarget();if(a&&a.type==="party"){const c=$(x.user),w={id:c?.uid,name:c?.displayName??c?.email??"Usuario",photoURL:c?.photoURL??void 0};await x.saveGroupRollLogsForParty(a.partyId,o,w)}else await x.saveRollLogsForUser(G,o)}const m=o.map(a=>a.id).filter(Boolean);if(m.length>0){v.logs.update(t=>Array.isArray(t)?t.map(E=>m.includes(E.id)?{...E,pending:!1}:E):t);const a=$(v.logs)||[],c=(Array.isArray(a)?a.slice(-j):[]).map(t=>X(t)),w=(()=>{const t=V.getTarget();return t&&t.type==="party"?`${H}${t.partyId}`:q})();localStorage.setItem(w,JSON.stringify(c))}}catch(o){console.error("[dice-roller-service] Cloud sync failed, falling back to localStorage:",o)}finally{Q=!1}try{const o=e.map(a=>X(a)),m=(()=>{const a=V.getTarget();return a&&a.type==="party"?`${H}${a.partyId}`:q})();localStorage.setItem(m,JSON.stringify(o))}catch(o){console.error("Error saving roll logs to localStorage:",o)}}catch(e){console.error("Error preparing roll logs for save:",e)}finally{Q=!1}}},le=async r=>U.STANDARD_DICES.some(y=>r.endsWith(y))?v.roll3DDice(r):new Promise(y=>{const[o,m]=r.split("d"),a=[];for(let c=0;c<Number(o);c++)a.push({value:Math.floor(Math.random()*Number(m))+1,sides:Number(m),dieType:"d"+m,groupId:0,rollId:c,theme:"default",themeColor:"#000000"});y(a)}),qe=(r,e,y)=>{const o=pe(r),m={id:crypto.randomUUID(),timestamp:new Date,title:e||"Tirada rÃ¡pida",total:o,formattedTotal:y?y(o):void 0,pending:!0,detail:Be(r)},a=V.getTarget();if(a&&a.type==="party"){const c=$(x.user);c?.uid&&(m.authorId=c.uid,m.authorName=c.displayName??c.email??void 0)}v.logs.update(c=>[...c,m].slice(-j))},ee=(r,e)=>{const y=new Map;for(const a of r)a&&a.id&&y.set(a.id,a);const o=new Map;for(const a of r)a&&a.id&&o.set(a.id,a);for(const a of e){const c=a.id;if(!c){const t=crypto.randomUUID();a.id=t,o.set(t,a);continue}if(a.pending){o.set(c,a);continue}const w=y.get(c);if(!w)o.set(c,a);else{const t=new Date(a.timestamp).getTime(),E=new Date(w.timestamp).getTime();!isNaN(t)&&!isNaN(E)?o.set(c,t>=E?a:w):o.set(c,a)}}return Array.from(o.values()).sort((a,c)=>new Date(a.timestamp).getTime()-new Date(c.timestamp).getTime()).slice(-j)},We=()=>{v.inited||(v.logs.set(Ge()),v.inited=!0,(async()=>{try{await x.initFirebase(),await x.onAuthState(async c=>{const w=G;if(G=c?c.uid:null,w&&w!==G&&k)try{k(),k=null}catch{}if(G&&x.isEnabled())try{{const t=V.getTarget();t&&t.type==="party"?k=x.listenGroupRollLogsForParty(t.partyId,E=>{B=!0;try{const I=(E||[]).map(R=>z(R)),A=$(v.logs)||[],P=ee(I,A);v.logs.set(P)}catch(I){console.error("[dice-roller-service] Error applying remote logs:",I)}finally{B=!1}}):k=x.listenRollLogsForUser(G,E=>{B=!0;try{const I=(E||[]).map(R=>z(R)),A=$(v.logs)||[],P=ee(I,A);v.logs.set(P)}catch(I){console.error("[dice-roller-service] Error applying remote logs:",I)}finally{B=!1}})}}catch(t){console.error("[dice-roller-service] Error starting remote listener:",t)}else try{const t=(()=>{const I=V.getTarget();return I&&I.type==="party"?`${H}${I.partyId}`:q})(),E=localStorage.getItem(t);if(E){const A=JSON.parse(E).map(P=>z(P));v.logs.set(A)}}catch(t){console.error("[dice-roller-service] Error loading local logs:",t)}})}catch(c){console.warn("[dice-roller-service] Firebase setup error (continuing with local logs):",c)}})(),V.target.subscribe(c=>{try{const w=c&&c.type==="party"?`${H}${c.partyId}`:q,t=localStorage.getItem(w);if(t){const I=JSON.parse(t).map(A=>z(A));v.logs.set(I)}else v.logs.set([])}catch{v.logs.set([])}if(k){try{k()}catch{}k=null}if(G&&x.isEnabled())try{c&&c.type==="party"?k=x.listenGroupRollLogsForParty(c.partyId,w=>{B=!0;try{const t=(w||[]).map(A=>z(A)),E=$(v.logs)||[],I=ee(t,E);v.logs.set(I)}catch(t){console.error("[dice-roller-service] Error applying remote logs:",t)}finally{B=!1}}):k=x.listenRollLogsForUser(G,w=>{B=!0;try{const t=(w||[]).map(A=>z(A)),E=$(v.logs)||[],I=ee(t,E);v.logs.set(I)}catch(t){console.error("[dice-roller-service] Error applying remote logs:",t)}finally{B=!1}})}catch(w){console.error("[dice-roller-service] Error starting remote listener:",w)}else try{const w=(()=>{const E=V.getTarget();return E&&E.type==="party"?`${H}${E.partyId}`:q})(),t=localStorage.getItem(w);if(t){const I=JSON.parse(t).map(A=>z(A));v.logs.set(I)}else v.logs.set([])}catch(w){console.error("[dice-roller-service] Error loading local logs:",w)}}));const r=({expression:c,variables:w={},title:t=void 0,resultFormatter:E=()=>{}})=>{v.rollModalData.set({expression:c,variables:w,title:t??"Tirar",rollType:"normal",extraModsExpression:"",resultFormatter:E}),v.rollModalOpened.set(!0)},e=async()=>{const c=$(v.rollModalData);if(v.rollModalData.set(void 0),v.rollModalOpened.set(!1),!c)return;let w=c.expression,t=c.title;c.rollType!=="normal"&&(w+=c.rollType==="advantage"?"+1d4":"-1d4",t+=c.rollType==="advantage"?" (ventaja)":" (desventaja)"),c?.extraModsExpression&&(w+=`+${c.extraModsExpression.trim()}`,w=w.replaceAll("++","+").replaceAll("+-","-")),o({expression:w,variables:c.variables,title:t})},y=()=>{v.rollModalOpened.set(!1),v.rollModalData.set(void 0)},o=async({expression:c,variables:w={},title:t=void 0,resultFormatter:E=()=>{}})=>{const I=Ve(c,w);v.clearTimeoutId&&(clearTimeout(v.clearTimeoutId),v.clearTimeoutId=null),v.clear3DDices();const A=[];for(const P of I)P.type==="dice"?A.push({expressionMember:P,promise:le(P.value),result:void 0,explosionResolved:!1,numExplosions:0}):A.push({expressionMember:P,promise:void 0,result:P.value,explosionResolved:!0,numExplosions:0});for(;A.some(P=>P.result===void 0);){const P=[],R=A.filter(S=>S.expressionMember.type==="dice"&&S.result===void 0);for(const S of R)P.push((async()=>{S.result=await S.promise,S.promise=void 0;for(const C of S.result)S.expressionMember.isExplosive&&C.sides===C.value&&C.sides>1&&S.numExplosions++;if(S.numExplosions>0){const C={...S.expressionMember,value:`${S.numExplosions}d${S.result[0].sides}`};A.push({expressionMember:C,promise:le(C.value),result:void 0,explosionResolved:!1,numExplosions:0})}return S})());await Promise.all(P)}return v.clearTimeoutId=setTimeout(()=>{v.clear3DDices()},U.CLEAR_3D_DICES_DELAY),qe(A,t,E),pe(A)};return{rollExpression:o,register3DDiceRollerFn:c=>{v.roll3DDice=c},registerClear3DDicesFn:c=>{v.clear3DDices=c},rollLogs:v.logs,rollModal:{rollModalOpened:v.rollModalOpened,openRollModal:r,rollModalData:v.rollModalData,submitRollModal:e,abortRollModal:y}}};export{W as C,te as P,We as a,Ue as b,Ke as p,xe as u};
