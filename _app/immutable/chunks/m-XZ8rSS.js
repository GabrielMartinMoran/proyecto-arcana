const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./lCNLHSrR.js","./C4c6zY-H.js","./yBjK6igh.js","./x4_yyNok.js"])))=>i.map(i=>d[i]);
import{_ as I}from"./PPVm8Dsz.js";import{C as T}from"./DBwz8_1j.js";import{w as x,g as J}from"./DnpldMJA.js";const B=t=>({...t,timestamp:new Date(t.timestamp)}),j=t=>({...t,timestamp:t.timestamp.toISOString()}),K=(t,e)=>{if(!t)return 0;const o=t.trim();try{const r=new Function("cuerpo","reflejos","mente","instinto","presencia","Math",`return (${o});`);return Number(r(Number(e.cuerpo)||0,Number(e.reflejos)||0,Number(e.mente)||0,Number(e.instinto)||0,Number(e.presencia)||0,Math))||0}catch(r){return console.error("Error evaluating modifier expression:",r),0}},W=(t,e)=>K(t,{cuerpo:e.attributes.body,reflejos:e.attributes.reflexes,mente:e.attributes.mind,instinto:e.attributes.instinct,presencia:e.attributes.presence,Math});class N{id;name;attributes;cards;ppHistory;goldHistory;equipment;modifiers;currentHP;tempHP;currentLuck;img;story;notes;languages;quickInfo;attacks;maxActiveCards;version;constructor(e){this.id=e.id,this.name=e.name,this.attributes=e.attributes,this.cards=e.cards,this.ppHistory=e.ppHistory,this.goldHistory=e.goldHistory,this.equipment=e.equipment,this.modifiers=e.modifiers,this.currentHP=e.currentHP,this.tempHP=e.tempHP,this.currentLuck=e.currentLuck,this.img=e.img,this.story=e.story,this.notes=e.notes,this.languages=e.languages,this.quickInfo=e.quickInfo,this.attacks=e.attacks,this.maxActiveCards=e.maxActiveCards,this.version=e.version}calculateAttrModifiers(e,o){let r=o;const n=this.modifiers.filter(l=>l.attribute===e);for(const l of n){const s=W(l.formula,this);if(l.type==="set")return s;l.type==="add"&&(r+=s)}return r}get maxLuck(){const e=T.MAX_LUCK;return this.calculateAttrModifiers("maxLuck",e)}get maxHP(){const e=T.BASE_HEALTH+this.attributes.body*T.HEALTH_BODY_MULTIPIER;return this.calculateAttrModifiers("maxHP",e)}get speed(){const e=T.BASE_SPEED+this.attributes.reflexes;return this.calculateAttrModifiers("speed",e)}get evasion(){const e=T.BASE_EVASION+this.attributes.reflexes;return this.calculateAttrModifiers("evasion",e)}get physicalMitigation(){return this.calculateAttrModifiers("physicalMitigation",0)}get magicalMitigation(){return this.calculateAttrModifiers("magicalMitigation",0)}get currentGold(){const e=this.goldHistory.filter(r=>r.type==="add").reduce((r,n)=>r+n.value,0),o=this.spentGold;return o>0?e-o:e}get spentGold(){return this.goldHistory.filter(e=>e.type==="subtract").reduce((e,o)=>e+o.value,0)}get currentPP(){const e=this.ppHistory.filter(r=>r.type==="add").reduce((r,n)=>r+n.value,0),o=this.spentPP;return o>0?e-o:e}get spentPP(){return this.ppHistory.filter(e=>e.type==="subtract").reduce((e,o)=>e+o.value,0)}get pjPower(){const e=this.cards.reduce((r,n)=>Math.max(r,n.level),0),o=this.spentPP/T.PJ_POWER_SPENT_PP_DIVIDER;return Math.round(e+o)}get numActiveCards(){return this.cards.filter(e=>e.isActive).length}get initiative(){return this.attributes.reflexes}copy(){return new N({...this})}}var F={VITE_FIREBASE_MESSAGING_SENDER_ID:"647852941329",VITE_FIREBASE_STORAGE_BUCKET:"arcana-85eeb.firebasestorage.app",VITE_FIREBASE_AUTH_DOMAIN:"arcana-85eeb.firebaseapp.com",VITE_FIREBASE_PROJECT_ID:"arcana-85eeb",VITE_FIREBASE_APP_ID:"1:647852941329:web:f2aa1e9dd6792f6a9d91b0",VITE_FIREBASE_API_KEY:"AIzaSyAFv5lor5ufY-KPBQ166rPSRnscFrtm88w"};function S(){return typeof window<"u"}function Y(){if(typeof F>"u")return null;const t=typeof F=="string"?JSON.parse(F):F;return t.VITE_FIREBASE_API_KEY?{apiKey:t.VITE_FIREBASE_API_KEY,authDomain:t.VITE_FIREBASE_AUTH_DOMAIN,projectId:t.VITE_FIREBASE_PROJECT_ID,storageBucket:t.VITE_FIREBASE_STORAGE_BUCKET,messagingSenderId:t.VITE_FIREBASE_MESSAGING_SENDER_ID,appId:t.VITE_FIREBASE_APP_ID}:null}function X(){let t=null,e=null,o=!1,r=null;const n=x(!1),l=x(null);async function s(){if(o)return;if(o=!0,!S()){n.set(!1);return}const u=Y()??null;if(!u)throw n.set(!1),new Error("Firebase configuration missing: VITE_FIREBASE_* variables required.");try{const{initializeApp:c,getApps:g}=await I(async()=>{const{initializeApp:f,getApps:i}=await import("./lCNLHSrR.js");return{initializeApp:f,getApps:i}},__vite__mapDeps([0,1]),import.meta.url),p=await I(()=>import("./yBjK6igh.js"),__vite__mapDeps([2,1]),import.meta.url),E=await I(()=>import("./x4_yyNok.js"),__vite__mapDeps([3,1]),import.meta.url);g&&g().length===0&&c(u),t=p.getAuth(),e=E.getFirestore(),p.onAuthStateChanged(t,f=>{const i=f?{uid:f.uid,displayName:f.displayName,email:f.email,photoURL:f.photoURL}:null;l.set(i)}),n.set(!0)}catch(c){throw n.set(!1),console.error("[firebase-service] Initialization error:",c),c}}async function m(){if(r)return r;r=s();try{await r}finally{r=null}}function a(){let u=!1;return n.subscribe(c=>{u=c})(),u&&!!t&&!!e}async function y(){if(!S())return null;await m();const{GoogleAuthProvider:u,signInWithPopup:c}=await I(async()=>{const{GoogleAuthProvider:i,signInWithPopup:d}=await import("./yBjK6igh.js");return{GoogleAuthProvider:i,signInWithPopup:d}},__vite__mapDeps([2,1]),import.meta.url),g=new u;g.setCustomParameters({prompt:"select_account"});const E=(await c(t,g)).user;if(!E)return null;const f={uid:E.uid,displayName:E.displayName,email:E.email,photoURL:E.photoURL};return l.set(f),f}async function b(){if(!S())return;await m();const{signOut:u}=await I(async()=>{const{signOut:c}=await import("./yBjK6igh.js");return{signOut:c}},__vite__mapDeps([2,1]),import.meta.url);await u(t),l.set(null)}async function w(u){if(!S())return u(null),()=>{};await m();const{onAuthStateChanged:c}=await I(async()=>{const{onAuthStateChanged:p}=await import("./yBjK6igh.js");return{onAuthStateChanged:p}},__vite__mapDeps([2,1]),import.meta.url);return c(t,p=>{const E=p?{uid:p.uid,displayName:p.displayName,email:p.email,photoURL:p.photoURL}:null;l.set(E),u(E)})}async function h(){if(await m(),!e)throw new Error("Firestore not initialized")}async function A(u,c){if(!u)throw new Error("userId required");if(!S())return;await h();const{doc:g,writeBatch:p}=await I(async()=>{const{doc:i,writeBatch:d}=await import("./x4_yyNok.js");return{doc:i,writeBatch:d}},__vite__mapDeps([3,1]),import.meta.url),E=c.map(i=>JSON.parse(JSON.stringify(i||{}))),f=3;for(let i=1;i<=f;i++)try{const d=p(e);for(const D of E){const $=g(e,"users",u,"characters",D.id);d.set($,D,{merge:!0})}await d.commit();return}catch(d){if(console.error(`[firebase-service] saveCharactersForUser attempt ${i} failed:`,d),i===f)throw d;await new Promise(D=>setTimeout(D,200*i))}}async function v(u,c){if(!u)throw new Error("userId required");if(!c)throw new Error("characterId required");if(!S())return;await h();const{doc:g,deleteDoc:p}=await I(async()=>{const{doc:E,deleteDoc:f}=await import("./x4_yyNok.js");return{doc:E,deleteDoc:f}},__vite__mapDeps([3,1]),import.meta.url);await p(g(e,"users",u,"characters",c))}async function R(u){if(!u)throw new Error("userId required");if(!S())return[];await h();const{collection:c,getDocs:g}=await I(async()=>{const{collection:i,getDocs:d}=await import("./x4_yyNok.js");return{collection:i,getDocs:d}},__vite__mapDeps([3,1]),import.meta.url),p=c(e,"users",u,"characters"),E=await g(p),f=[];return E.forEach(i=>{const d=i.data();f.push(new N(d))}),f}function U(u,c){if(!S())return c([]),()=>{};let g=()=>{};return(async()=>{try{await h();const{collection:p,onSnapshot:E}=await I(async()=>{const{collection:i,onSnapshot:d}=await import("./x4_yyNok.js");return{collection:i,onSnapshot:d}},__vite__mapDeps([3,1]),import.meta.url),f=p(e,"users",u,"characters");g=E(f,i=>{const d=[];i.forEach(D=>{d.push(new N(D.data()))}),c(d)},i=>{console.error("[firebase-service] listenCharactersForUser snapshot error:",i),c([])})}catch(p){console.error("[firebase-service] listenCharactersForUser setup error:",p),c([])}})(),()=>{try{g&&g()}catch{}}}async function V(u,c){if(!u)throw new Error("userId required");if(!S())return;await h();const{doc:g,writeBatch:p}=await I(async()=>{const{doc:i,writeBatch:d}=await import("./x4_yyNok.js");return{doc:i,writeBatch:d}},__vite__mapDeps([3,1]),import.meta.url),E=c.map(i=>JSON.parse(JSON.stringify(i||{}))),f=3;for(let i=1;i<=f;i++)try{const d=p(e);for(const D of E){const $=g(e,"users",u,"rollLogs",D.id);d.set($,D,{merge:!0})}await d.commit();return}catch(d){if(console.error(`[firebase-service] saveRollLogsForUser attempt ${i} failed:`,d),i===f)throw d;await new Promise(D=>setTimeout(D,200*i))}}async function L(u){if(!u)throw new Error("userId required");if(!S())return[];await h();const{collection:c,getDocs:g}=await I(async()=>{const{collection:i,getDocs:d}=await import("./x4_yyNok.js");return{collection:i,getDocs:d}},__vite__mapDeps([3,1]),import.meta.url),p=c(e,"users",u,"rollLogs"),E=await g(p),f=[];return E.forEach(i=>f.push(i.data())),f}function C(u,c){if(!S())return c([]),()=>{};let g=()=>{};return(async()=>{try{await h();const{collection:p,onSnapshot:E}=await I(async()=>{const{collection:i,onSnapshot:d}=await import("./x4_yyNok.js");return{collection:i,onSnapshot:d}},__vite__mapDeps([3,1]),import.meta.url),f=p(e,"users",u,"rollLogs");g=E(f,i=>{const d=[];i.forEach(D=>d.push(D.data())),c(d)},i=>{console.error("[firebase-service] listenRollLogsForUser snapshot error:",i),c([])})}catch(p){console.error("[firebase-service] listenRollLogsForUser setup error:",p),c([])}})(),()=>{try{g&&g()}catch{}}}async function G(u,c){if(!u)throw new Error("userId required");if(!c)throw new Error("logId required");if(!S())return;await h();const{doc:g,deleteDoc:p}=await I(async()=>{const{doc:E,deleteDoc:f}=await import("./x4_yyNok.js");return{doc:E,deleteDoc:f}},__vite__mapDeps([3,1]),import.meta.url);await p(g(e,"users",u,"rollLogs",c))}return{firebaseReady:n,user:l,initFirebase:m,isEnabled:a,signInWithGoogle:y,signOutUser:b,onAuthState:w,saveCharactersForUser:A,loadCharactersForUser:R,deleteCharacterForUser:v,listenCharactersForUser:U,saveRollLogsForUser:V,loadRollLogsForUser:L,deleteRollLogForUser:G,listenRollLogsForUser:C}}const Z=X();function Q(){return Z}const ee=(t,e)=>{if(!t)return[];const o=[],r=t.replace(/\s+/g,""),n=/([+-]?)(\d*d\d+(?:[eE])?|\d+(\.\d+)?|[A-Za-z_][A-Za-z0-9_]*)/g;let l;for(;(l=n.exec(r))!==null;){const s=l[1]||"+",m=l[2],a=/^(\d*)[dD](\d+)([eE])?$/.exec(m);if(a){const A=a[1],v=a[2],R=!!a[3],U=A?Number(A):1,V=Number(v);let L=`${U}d${V}`;s==="-"&&(L=`-${L}`);const C={type:"dice",isExplosive:R,value:L};o.push(C);continue}if(/^\d+(\.\d+)?$/.exec(m)){let A=Number(m);s==="-"&&(A=-A),o.push({type:"constant",isExplosive:!1,value:A});continue}const b=m,w=e&&Object.prototype.hasOwnProperty.call(e,b)&&Number(e[b])||0,h=s==="-"?-w:w;o.push({type:"variable",value:h,isExplosive:!1,label:b})}return o},te=t=>{let e="";return t.forEach((o,r)=>{const n=o.expressionMember;let l="";switch(n.type){case"dice":r>0&&!n.value.toString().startsWith("-")&&(l+="+ "),l+=`${n.value}${n.isExplosive?"e":""} [${o.result.map(s=>`<span class="${s.value===s.sides?"max":""}${s.value===1?"min":""}">`+s.value.toString()+(n.isExplosive&&s.value===s.sides?"💥":"")+"</span>").join(", ")}]`;break;case"constant":l=`${r>0&&n.value>=0?"+ ":""}${n.value}`;break;case"variable":l=`${r>0&&n.value>=0?"+ ":""}${n.label} [${n.value}]`;break}l.startsWith("-")&&(l=l.replace("-","- ")),e+=`${r>0?" ":""}${l}`}),e},z=t=>{let e=0;return t.forEach(o=>{const r=o.expressionMember;switch(r.type){case"dice":e+=o.result.reduce((n,l)=>n+l.value,0)*(r.value.toString().startsWith("-")?-1:1);break;case"constant":e+=r.value;break;case"variable":e+=r.value;break}}),e},le=t=>{const e=[];if(!t||!String(t).trim())return e;const o=String(t).trim(),r=/^[+-]/.test(o)?o:`+${o}`,n=/([+-])\s*([^+-]+)/g;let l;for(;(l=n.exec(r))!==null;){const m=l[1]==="+"?1:-1,a=(l[2]||"").trim();if(!a)continue;const y=a.match(/^(\d+)\s*d\s*(\d+)/i);if(y){const h=Number(y[1]),A=Number(y[2]),R=a.slice(y[0].length).trim()||null;e.push({kind:"dice",sign:m,n:h,faces:A,damageType:R,raw:a});continue}const b=a.match(/^(\d+)/);if(b){const h=Number(b[1]),v=a.slice(b[0].length).trim()||null;e.push({kind:"flat",sign:m,value:h,damageType:v,raw:a});continue}const w=a.match(/(\d+)\s*d\s*(\d+)/i);if(w){const h=Number(w[1]),A=Number(w[2]),v=a.replace(w[0],"").trim()||null;e.push({kind:"dice",sign:m,n:h,faces:A,damageType:v,raw:a});continue}e.push({kind:"flat",sign:m,value:0,damageType:a||null,raw:a})}return e.reduce((m,a)=>a.kind==="dice"?`${m} ${a.sign===1?"+":"-"} ${a.n}d${a.faces}`:a.kind==="flat"?`${m} ${a.sign===1?"+":"-"} ${a.value}`:m,"")},H="arcana:rollLogs",_={inited:!1,clearTimeoutId:null,roll3DDice:async()=>[],clear3DDices:()=>{},logs:x([]),rollModalOpened:x(!1),rollModalData:x(void 0)},P=Q();let M=null,O=null,k=!1;const re=()=>{try{const t=localStorage.getItem(H),e=t?JSON.parse(t):[];return(Array.isArray(e)?e.slice(-100):e).map(r=>B(r))}catch(t){return console.error("Error loading roll logs:",t),[]}finally{_.logs.subscribe(async t=>{try{await se(t)}catch(e){console.error("[dice-roller-service] saveRollLogs subscription error:",e)}})}},se=async t=>{if(!k)try{const o=(Array.isArray(t)?t.slice(-100):t).map(r=>j(r));if(M&&P.isEnabled())try{await P.saveRollLogsForUser(M,o);return}catch(r){console.error("[dice-roller-service] saveRollLogs cloud write failed, falling back to localStorage:",r)}try{localStorage.setItem(H,JSON.stringify(o))}catch(r){console.error("Error saving roll logs to localStorage:",r)}}catch(e){console.error("Error preparing roll logs for save:",e)}},q=async t=>T.STANDARD_DICES.some(o=>t.endsWith(o))?_.roll3DDice(t):new Promise(o=>{const[r,n]=t.split("d"),l=[];for(let s=0;s<Number(r);s++)l.push({value:Math.floor(Math.random()*Number(n))+1,sides:Number(n),dieType:"d"+n,groupId:0,rollId:s,theme:"default",themeColor:"#000000"});o(l)}),oe=(t,e,o)=>{const r=z(t),n={id:crypto.randomUUID(),timestamp:new Date,title:e||"Tirada anónima",total:r,formattedTotal:o?o(r):void 0,detail:te(t)};_.logs.update(l=>[...l,n].slice(-100))},ce=()=>{_.inited||(_.logs.set(re()),_.inited=!0,(async()=>{try{try{await P.initFirebase()}catch(s){console.warn("[dice-roller-service] firebase init error (continuing with local logs):",s)}try{await P.onAuthState(async s=>{const m=M;if(M=s?s.uid:null,m&&m!==M&&O){try{O()}catch{}O=null}if(M&&P.isEnabled())try{O=P.listenRollLogsForUser(M,a=>{k=!0;try{const y=(a||[]).map(b=>B(b));_.logs.set(y)}catch(y){console.error("[dice-roller-service] Error applying remote roll logs:",y)}finally{k=!1}})}catch(a){console.error("[dice-roller-service] Error starting remote roll logs listener:",a)}else try{const a=localStorage.getItem(H);if(a){const y=JSON.parse(a);_.logs.set(y.map(b=>B(b)))}}catch(a){console.error("[dice-roller-service] Error loading local fallback logs:",a)}})}catch(s){console.warn("[dice-roller-service] Error subscribing to auth state (ignored):",s)}}catch(s){console.error("[dice-roller-service] Unexpected error setting up firebase integration:",s)}})());const t=({expression:s,variables:m={},title:a=void 0,resultFormatter:y=()=>{}})=>{_.rollModalData.set({expression:s,variables:m,title:a??"Tirar",rollType:"normal",extraModsExpression:"",resultFormatter:y}),_.rollModalOpened.set(!0)},e=async()=>{const s=J(_.rollModalData);if(_.rollModalData.set(void 0),_.rollModalOpened.set(!1),!s)return;let m=s.expression,a=s.title;s.rollType!=="normal"&&(m+=s.rollType==="advantage"?"+1d4":"-1d4",a+=s.rollType==="advantage"?" (ventaja)":" (desventaja)"),s?.extraModsExpression&&(m+=`+${s.extraModsExpression.trim()}`,m=m.replaceAll("++","+").replaceAll("+-","-")),r({expression:m,variables:s.variables,title:a})},o=()=>{_.rollModalOpened.set(!1),_.rollModalData.set(void 0)},r=async({expression:s,variables:m={},title:a=void 0,resultFormatter:y=()=>{}})=>{const b=ee(s,m);_.clearTimeoutId&&(clearTimeout(_.clearTimeoutId),_.clearTimeoutId=null),_.clear3DDices();const w=[];for(const h of b)h.type==="dice"?w.push({expressionMember:h,promise:q(h.value),result:void 0,explosionResolved:!1,numExplosions:0}):w.push({expressionMember:h,promise:void 0,result:h.value,explosionResolved:!0,numExplosions:0});for(;w.some(h=>h.result===void 0);){const h=[],A=w.filter(v=>v.expressionMember.type==="dice"&&v.result===void 0);for(const v of A)h.push((async()=>{v.result=await v.promise,v.promise=void 0;for(const R of v.result)v.expressionMember.isExplosive&&R.sides===R.value&&R.sides>1&&v.numExplosions++;if(v.numExplosions>0){const R={...v.expressionMember,value:`${v.numExplosions}d${v.result[0].sides}`};w.push({expressionMember:R,promise:q(R.value),result:void 0,explosionResolved:!1,numExplosions:0})}return v})());await Promise.all(h)}return _.clearTimeoutId=setTimeout(()=>{_.clear3DDices()},T.CLEAR_3D_DICES_DELAY),oe(w,a,y),z(w)};return{rollExpression:r,register3DDiceRollerFn:s=>{_.roll3DDice=s},registerClear3DDicesFn:s=>{_.clear3DDices=s},rollLogs:_.logs,rollModal:{rollModalOpened:_.rollModalOpened,openRollModal:t,rollModalData:_.rollModalData,submitRollModal:e,abortRollModal:o}}};export{N as C,ce as a,le as p,Q as u};
