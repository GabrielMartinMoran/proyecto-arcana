import"../chunks/DsnmJJEf.js";import{o as Me,a as Ae}from"../chunks/CzhoJcdv.js";import{aF as ue,p as te,f as M,d as b,a as le,r as h,t as J,g as e,aG as R,e as ee,b as T,s as k,c as se,O as A,a2 as ge,N as Ee,aH as $e}from"../chunks/DLXWS9Me.js";import{i as z}from"../chunks/sk9sCnVa.js";import{e as pe}from"../chunks/DqBPzmir.js";import{s as xe}from"../chunks/YdHDDrJh.js";import{s as re}from"../chunks/DvREelRX.js";import{s as ye,a as de}from"../chunks/9-vBrUj_.js";import{g as H}from"../chunks/ndO8aMg8.js";import{p as l}from"../chunks/jVR0-boS.js";import{g as U}from"../chunks/0JtrQ17s.js";import{C as ae}from"../chunks/QFUiQZjY.js";import{r as Fe}from"../chunks/C9r8QzQg.js";import{p as ve}from"../chunks/B0W8Y-cb.js";import{d as K}from"../chunks/BA7vPwHJ.js";import{u as me}from"../chunks/B1FKtT7k.js";import{C as ce}from"../chunks/B_ycimPA.js";import{C as De,N as Ne,s as Le,T as Re}from"../chunks/Bhl9SfSB.js";import{a as je}from"../chunks/CH8AYPWl.js";import{u as Ue}from"../chunks/BkPtUCkp.js";var Oe=(t,r,a)=>r(e(a).id),Ge=M("<button> </button>"),He=M('<div class="actions svelte-1khrnru"><button class="danger">Eliminar del grupo</button></div>'),qe=M("<!> <!>",1),Be=M('<div class="empty svelte-1khrnru">Selecciona un personaje arriba para ver su ficha aqu√≠.</div>'),Ye=M('<div class="tabs svelte-1khrnru"></div> <!>',1),ze=M('<div class="members-tab svelte-1khrnru"><!></div>');function Ve(t,r){te(r,!0);const a=()=>de(c,"$user",d),[d,I]=ye();let s=ve(r,"party",7);const v=me(),{user:c}=v;let u=R(()=>l.url.searchParams.get("characterId")),w=R(()=>l.url.searchParams.get("sheetTab")??ce.DEFAULT_CHARACTER_SHEET_TAB),p=R(()=>s()?.characters.find(g=>g.id===e(u))),_=R(()=>s()?s().members:{});const m=g=>{for(const C of Object.keys(e(_)))if((e(_)[C]||[]).includes(g))return C;return null},E=g=>{if(!g){l.url.searchParams.delete("characterId"),l.url.searchParams.delete("sheetTab"),H(`?${l.url.searchParams.toString()}`),A(u,null);return}l.url.searchParams.set("characterId",g),l.url.searchParams.set("sheetTab",ce.DEFAULT_CHARACTER_SHEET_TAB),H(`?${l.url.searchParams.toString()}`),A(u,g)},S=g=>{l.url.searchParams.set("sheetTab",g),H(`?${l.url.searchParams.toString()}`)};async function n(g,C){try{await v.saveCharactersForUser(g,[C])}catch(i){console.error("[PartyMembersTab] saveMemberCharacter failed",i)}}async function $(){if(!s()||!e(u)||!e(p)||!await K.confirm(`¬øSeguro que quieres eliminar a '${e(p).name}' del grupo?`,{title:"Confirmar eliminaci√≥n",confirmLabel:"Eliminar",cancelLabel:"Cancelar"}))return;const C=m(e(u)),i=U(c);if(!(!C||!i||i.uid!==s().ownerId)){try{await v.removePartyMember(s().id,C,e(u)),e(p).party.partyId=null,e(p).party.ownerId=null,await n(C,e(p));const y=s().members[C]??[],F=y.indexOf(e(u));F!==-1&&y.splice(F,1),y.length===0?delete s().members[C]:s().members[C]=y,s(s().copy()),r.onChange(s())}catch(y){console.error("[PartyMembersTab] removeSelectedCharacterFromParty failed",y)}A(u,null),l.url.searchParams.delete("characterId"),l.url.searchParams.delete("tab"),H(`?${l.url.searchParams.toString()}`)}}var O=ze(),Q=b(O);ae(Q,{title:"Miembros",children:(g,C)=>{var i=Ye(),y=le(i);pe(y,21,()=>s().characters,f=>f.id,(f,x)=>{var D=Ge();let G;D.__click=[Oe,E,x];var q=b(D,!0);h(D),J(W=>{G=re(D,1,"tab",null,G,W),ee(q,e(x).name)},[()=>({selected:e(u)===e(x).id})]),T(f,D)}),h(y);var F=k(y,2);{var X=f=>{ae(f,{children:(x,D)=>{var G=qe(),q=le(G);{let B=R(()=>r.readonly&&m(e(p).id)!==a()?.uid);De(q,{get character(){return e(p)},get readonly(){return e(B)},onChange:async N=>{const j=U(c),Y=m(N.id);if(!Y){console.error("[PartyMembersTab] No owner found for character",N.id);return}j&&j.uid===s().ownerId?await n(Y,N):j&&j.uid===Y&&await v.saveCharactersForUser(Y,[N])},get currentTab(){return e(w)},onTabChange:S,allowPartyChange:!1})}var W=k(q,2);{var ne=B=>{var N=He(),j=b(N);j.__click=$,h(N),T(B,N)};z(W,B=>{r.readonly||B(ne)})}T(x,G)},$$slots:{default:!0}})},V=f=>{var x=Be();T(f,x)};z(F,f=>{e(p)?f(X):f(V,!1)})}T(g,i)},$$slots:{default:!0}}),h(O),T(t,O),se(),I()}ue(["click"]);var We=M('<div class="notes-tab svelte-1oh06hc"><!></div>');function Je(t,r){te(r,!0);let a=ve(r,"party",7);const d=v=>{a().notes=v,r.onChange(a().copy())};var I=We(),s=b(I);ae(s,{title:"Notas",children:(v,c)=>{Ne(v,{get notes(){return a().notes},get readonly(){return r.readonly},onChange:d})},$$slots:{default:!0}}),h(I),T(t,I),se()}function Ke(t){const r=Pe(t?.title??"").trim(),a=Xe(t?.content??"").trim();if(!r&&!a)return"";let d="";return r&&(d+=`### ${r}

`),a&&(d+=`${a}
`),d}function Qe(t,r){const{headerTitle:a="",blankLineBetweenNotes:d=!0,showEmptyFallback:I=!0,emptyFallbackText:s="__Sin notas.__"}=r??{},v=(Array.isArray(t)?t:[]).map(Ke).filter(Boolean);let c="";if(a&&a.trim().length>0&&(c+=`## ${Pe(a)}

`),v.length===0)return I&&(c+=`${s}
`),c;for(let u=0;u<v.length;u++)c+=v[u],d&&u<v.length-1&&(c+=`
`);return c.endsWith(`
`)||(c+=`
`),c}function Pe(t){return t==null?"":String(t).replace(/\r?\n|\r/g," ").trim()}function Xe(t){return t==null?"":String(t)}const Ze=async(t,r)=>{try{await navigator.clipboard.writeText(e(r)),await K.alert("Grupo en formato Markdown copiado al portapapeles!")}catch(a){console.error("[PartySeeAsMDTab] Failed to copy text:",a),await K.alert("Error al copiar el markdown al portapapeles")}};var er=M('<div class="header svelte-140wxxj"><label>Grupo</label> <button>Copiar Markdown</button></div> <pre class="svelte-140wxxj"> </pre>',1);function rr(t,r){te(r,!0);let a=ge(Ee([]));const{loadAbilityCards:d,abilityCards:I,loadItemCards:s,itemCards:v}=je();function c(w,p){let _="";if(_+=`# ${w.name}

`,_+=`## Miembros
`,Array.isArray(w.characters)&&w.characters.length>0)for(let m=0;m<w.characters.length;m++){const E=w.characters[m];{const n=Le(E,p).split(`
`).map($=>$.length?`> ${$}`:">").join(`
`);_+=`${n}
`}m<w.characters.length-1&&(_+=`
---

`)}else _+=`__Sin miembros.__

`;return _+=Qe(w.notes,{headerTitle:"Notas"}),_}let u=R(()=>c(r.party,e(a)));Me(async()=>{await Promise.all([s(),d()]),A(a,[...U(v),...U(I)],!0)}),ae(t,{children:(w,p)=>{var _=er(),m=le(_),E=k(b(m),2);E.__click=[Ze,u],h(m);var S=k(m,2),n=b(S,!0);h(S),J(()=>ee(n,e(u))),T(w,_)},$$slots:{default:!0}}),se()}ue(["click"]);const ar=async(t,r)=>{await navigator.clipboard.writeText(r().id),await K.alert(`ID de invitaci√≥n copiado al portapapeles!

P√°saselo a tus jugadores para que agreguen sus personajes al grupo desde la pesta√±a de configuraci√≥n de las hojas de personaje.`)};var tr=(t,r)=>r("members"),sr=(t,r)=>r("notes"),nr=(t,r)=>r("see_as_md"),or=M('<div class="party-sheet svelte-saco2k"><div class="row header-row"><!></div> <div class="tabs svelte-saco2k"><button>Miembros</button> <button>Notas</button> <button>Ver como MD</button> <span class="spacer svelte-saco2k"></span> <button>Copiar ID de invitaci√≥n</button></div> <!></div>');function ir(t,r){te(r,!0);let a=ve(r,"party",7);const d=me(),{user:I}=d;let s=R(()=>l.url.searchParams.get("tab")??ce.DEFAULT_PARTY_SHEET_TAB);const v=i=>{l.url.searchParams.set("tab",i),H(`?${l.url.searchParams.toString()}`)};var c=or(),u=b(c),w=b(u);Re(w,{get value(){return a().name},get readonly(){return r.readonly},onChange:i=>{a()&&(a().name=String(i),r.onChange(a().copy()))}}),h(u);var p=k(u,2),_=b(p);_.__click=[tr,v];let m;var E=k(_,2);E.__click=[sr,v];let S;var n=k(E,2);n.__click=[nr,v];let $;var O=k(n,4);O.__click=[ar,a],h(p);var Q=k(p,2);{var g=i=>{Ve(i,{get party(){return a()},get readonly(){return r.readonly},get onChange(){return r.onChange}})},C=i=>{var y=$e(),F=le(y);{var X=f=>{rr(f,{get party(){return a()},get readonly(){return r.readonly},get onChange(){return r.onChange}})},V=f=>{Je(f,{get party(){return a()},get readonly(){return r.readonly},get onChange(){return r.onChange}})};z(F,f=>{e(s)==="see_as_md"?f(X):f(V,!1)},!0)}T(i,y)};z(Q,i=>{e(s)==="members"?i(g):i(C,!1)})}h(c),J((i,y,F)=>{m=re(_,1,"",null,m,i),S=re(E,1,"",null,S,y),$=re(n,1,"",null,$,F)},[()=>({selected:e(s)==="members"}),()=>({selected:e(s)==="notes"}),()=>({selected:e(s)==="see_as_md"})]),T(t,c),se()}ue(["click"]);async function lr(t,r,a){const d=await r("Nuevo Grupo");a(d)}async function cr(t,r,a,d){if(!(!e(r)||!await K.confirm(`¬øEliminar el grupo "${e(r).name}"?`,{title:"Confirmar eliminaci√≥n",confirmLabel:"Eliminar",cancelLabel:"Cancelar"}))){try{await a(e(r).id)}catch(s){console.error("[parties-page] delete failed",s),await K.alert("Error al eliminar el grupo")}A(d,null),A(r,void 0),l.url.searchParams.delete("partyId"),H(`?${l.url.searchParams.toString()}`)}}var ur=M('<div class="empty svelte-1hi552">No tienes grupos. Crea uno con ‚ûï</div>'),dr=(t,r,a)=>r(e(a)),vr=M('<span class="owner svelte-1hi552"> </span>'),mr=M('<button><!> <span class="name svelte-1hi552"> </span></button>'),fr=M("<p>Selecciona un grupo de la lista o crea uno nuevo con ‚ûï</p>"),hr=M('<section class="parties-page svelte-1hi552"><div class="list svelte-1hi552" role="navigation" aria-label="Lista de grupos"><div class="header svelte-1hi552"><button title="Crear">‚ûï</button> <button title="Eliminar">üóëÔ∏è</button></div> <div class="content svelte-1hi552"><!> <!></div></div> <div class="viewport svelte-1hi552"><!> <div class="controls svelte-1hi552"><span class="muted"> </span></div></div></section>');function Lr(t,r){te(r,!0);const a=()=>de(c,"$parties",I),d=()=>de(m,"$user",I),[I,s]=ye(),v=me();let{parties:c,loadParties:u,deleteParty:w,saveParty:p,createParty:_}=Ue();const{user:m,firebaseReady:E}=v;let S=R(()=>l.url.searchParams.get("partyId")),n=R(()=>a().find(o=>o.id===e(S))),$=ge(!1);const O=async()=>{if(U(E)){if(!U(m)){H(Fe("/"));return}await u()}},Q=m.subscribe(async()=>await O()),g=E.subscribe(async o=>{o&&setTimeout(()=>{O()},ce.NO_USER_REDIRECT_DELAY)}),C=c.subscribe(async o=>{e(S)&&A(n,o.find(P=>P.id===e(S)))});Ae(()=>{Q(),g(),C()});let i=null;const y=500;function F(){!e(n)||U(m)?.uid!==e(n).ownerId||(i&&clearTimeout(i),i=setTimeout(async()=>{i=null,await X()},y))}async function X(){if(e(n)){A($,!0);try{const o=U(m);o&&(!e(n).ownerId||e(n).ownerId==="")&&(e(n).ownerId=o.uid),await p(e(n));const P=U(c).find(L=>L.id===e(n).id);A(n,P?P.copy():e(n).copy())}catch(o){console.error("[parties-page] save failed",o)}finally{A($,!1)}}}const V=o=>{A(S,o.id),A(n,o),l.url.searchParams.set("partyId",o.id),l.url.searchParams.delete("characterId"),l.url.searchParams.delete("sheetTab"),l.url.searchParams.delete("tab"),H(`?${l.url.searchParams.toString()}`)};var f=hr(),x=b(f),D=b(x),G=b(D);G.__click=[lr,_,V];var q=k(G,2);q.__click=[cr,n,w,S],h(D);var W=k(D,2),ne=b(W);{var B=o=>{var P=ur();T(o,P)};z(ne,o=>{a().length===0&&o(B)})}var N=k(ne,2);pe(N,1,a,o=>o.id,(o,P)=>{var L=mr();let oe;L.__click=[dr,V,P];var _e=b(L);{var Te=Z=>{var ie=vr(),Ie=b(ie,!0);h(ie),J(()=>{xe(ie,"title",`${e(P).ownerId===d()?.uid?"Due√±o":"Miembro"} del grupo`),ee(Ie,e(P).ownerId===d()?.uid?"üëë":"üë§")}),T(Z,ie)};z(_e,Z=>{e(P).ownerId&&Z(Te)})}var be=k(_e,2),ke=b(be,!0);h(be),h(L),J(Z=>{oe=re(L,1,"party-item svelte-1hi552",null,oe,Z),ee(ke,e(P).name)},[()=>({selected:e(S)===e(P).id})]),T(o,L)}),h(W),h(x);var j=k(x,2),Y=b(j);{var Ce=o=>{{let P=R(()=>d()?.uid!==e(n)?.ownerId);ir(o,{get party(){return e(n)},get readonly(){return e(P)},onChange:L=>{e(n)&&(A(n,L),F())}})}},we=o=>{ae(o,{title:"Selecciona un grupo",children:(P,L)=>{var oe=fr();T(P,oe)},$$slots:{default:!0}})};z(Y,o=>{e(n)?o(Ce):o(we,!1)})}var fe=k(Y,2),he=b(fe),Se=b(he,!0);h(he),h(fe),h(j),h(f),J(()=>{q.disabled=d()?.uid!==e(n)?.ownerId,ee(Se,e($)?"Guardando...":"")}),T(t,f),se(),s()}ue(["click"]);export{Lr as component};
