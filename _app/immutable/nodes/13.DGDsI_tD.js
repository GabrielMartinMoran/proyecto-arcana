import"../chunks/DsnmJJEf.js";import{d as ce,s as X,o as Ie,a as Me}from"../chunks/D_zjkKVN.js";import{p as re,b as M,e as b,f as ie,r as h,t as K,j as e,ab as R,a as S,g as T,d as ae,K as A,aa as _e,J as Ae,c as Ee}from"../chunks/t0Cq7XZL.js";import{i as V,s as be,a as ue}from"../chunks/CuTJ2zLb.js";import{e as ge,s as $e}from"../chunks/BDY9aIh_.js";import{s as Z}from"../chunks/BmU-s7xp.js";import{g as G}from"../chunks/BBHo8jXa.js";import{p as c}from"../chunks/C8bhBYRj.js";import{g as L}from"../chunks/y52P6WVk.js";import{C as ee}from"../chunks/0WDDsGuN.js";import{r as xe}from"../chunks/DvYrvlig.js";import{p as de}from"../chunks/Pn6U6YSw.js";import{C as le}from"../chunks/CyC3GOE6.js";import{C as Fe,N as De,s as Ne,T as je}from"../chunks/CGErStI4.js";import{u as pe}from"../chunks/DGmKBFm_.js";import{a as Re}from"../chunks/BzPjo2az.js";import{u as Ue}from"../chunks/CMz-17u7.js";var Le=(t,r,a)=>r(e(a).id),Oe=M("<button> </button>"),qe=M('<div class="actions svelte-1khrnru"><button class="danger">Eliminar del grupo</button></div>'),Be=M("<!> <!>",1),Ge=M('<div class="empty svelte-1khrnru">Selecciona un personaje arriba para ver su ficha aqu√≠.</div>'),He=M('<div class="tabs svelte-1khrnru"></div> <!>',1),Ye=M('<div class="members-tab svelte-1khrnru"><!></div>');function ze(t,r){re(r,!0);const a=()=>ue(v,"$user",l),[l,g]=be();let o=de(r,"party",7);const d=pe(),{user:v}=d;let u=R(()=>c.url.searchParams.get("characterId")),p=R(()=>c.url.searchParams.get("sheetTab")??le.DEFAULT_CHARACTER_SHEET_TAB),P=R(()=>o()?.characters.find(s=>s.id===e(u))),f=R(()=>o()?o().members:{});const m=s=>{for(const _ of Object.keys(e(f)))if((e(f)[_]||[]).includes(s))return _;return null},E=s=>{if(!s){c.url.searchParams.delete("characterId"),c.url.searchParams.delete("sheetTab"),G(`?${c.url.searchParams.toString()}`),A(u,null);return}c.url.searchParams.set("characterId",s),c.url.searchParams.set("sheetTab",le.DEFAULT_CHARACTER_SHEET_TAB),G(`?${c.url.searchParams.toString()}`),A(u,s)},w=s=>{c.url.searchParams.set("sheetTab",s),G(`?${c.url.searchParams.toString()}`)};async function i(s,_){try{await d.saveCharactersForUser(s,[_])}catch(C){console.error("[PartyMembersTab] saveMemberCharacter failed",C)}}async function x(){if(!o()||!e(u)||!e(P)||!confirm(`¬øSeguro que quieres eliminar a '${e(P).name}' del grupo?`))return;const _=m(e(u)),C=L(v);if(!(!_||!C||C.uid!==o().ownerId)){try{await d.removePartyMember(o().id,_,e(u)),e(P).party.partyId=null,e(P).party.ownerId=null,await i(_,e(P));const k=o().members[_]??[],q=k.indexOf(e(u));q!==-1&&k.splice(q,1),k.length===0?delete o().members[_]:o().members[_]=k,o(o().copy()),r.onChange(o())}catch(k){console.error("[PartyMembersTab] removeSelectedCharacterFromParty failed",k)}A(u,null),c.url.searchParams.delete("characterId"),c.url.searchParams.delete("tab"),G(`?${c.url.searchParams.toString()}`)}}var O=Ye(),W=b(O);ee(W,{title:"Miembros",children:(s,_)=>{var C=He(),k=ie(C);ge(k,21,()=>o().characters,I=>I.id,(I,$)=>{var D=Oe();let B;D.__click=[Le,E,$];var H=b(D,!0);h(D),K(J=>{B=Z(D,1,"tab",null,B,J),X(H,e($).name)},[()=>({selected:e(u)===e($).id})]),S(I,D)}),h(k);var q=T(k,2);{var F=I=>{ee(I,{children:($,D)=>{var B=Be(),H=ie(B);{let Y=R(()=>r.readonly&&m(e(P).id)!==a()?.uid);Fe(H,{get character(){return e(P)},get readonly(){return e(Y)},onChange:async N=>{const U=L(v),z=m(N.id);if(!z){console.error("[PartyMembersTab] No owner found for character",N.id);return}U&&U.uid===o().ownerId?await i(z,N):U&&U.uid===z&&await d.saveCharactersForUser(z,[N])},get currentTab(){return e(p)},onTabChange:w,allowPartyChange:!1})}var J=T(H,2);{var se=Y=>{var N=qe(),U=b(N);U.__click=x,h(N),S(Y,N)};V(J,Y=>{r.readonly||Y(se)})}S($,B)},$$slots:{default:!0}})},te=I=>{var $=Ge();S(I,$)};V(q,I=>{e(P)?I(F):I(te,!1)})}S(s,C)},$$slots:{default:!0}}),h(O),S(t,O),ae(),g()}ce(["click"]);var Ve=M('<div class="notes-tab svelte-1oh06hc"><!></div>');function Je(t,r){re(r,!0);let a=de(r,"party",7);const l=d=>{a().notes=d,r.onChange(a().copy())};var g=Ve(),o=b(g);ee(o,{title:"Notas",children:(d,v)=>{De(d,{get notes(){return a().notes},get readonly(){return r.readonly},onChange:l})},$$slots:{default:!0}}),h(g),S(t,g),ae()}function Ke(t){const r=ye(t?.title??"").trim(),a=Qe(t?.content??"").trim();if(!r&&!a)return"";let l="";return r&&(l+=`### ${r}

`),a&&(l+=`${a}
`),l}function We(t,r){const{headerTitle:a="",blankLineBetweenNotes:l=!0,showEmptyFallback:g=!0,emptyFallbackText:o="__Sin notas.__"}=r??{},d=(Array.isArray(t)?t:[]).map(Ke).filter(Boolean);let v="";if(a&&a.trim().length>0&&(v+=`## ${ye(a)}

`),d.length===0)return g&&(v+=`${o}
`),v;for(let u=0;u<d.length;u++)v+=d[u],l&&u<d.length-1&&(v+=`
`);return v.endsWith(`
`)||(v+=`
`),v}function ye(t){return t==null?"":String(t).replace(/\r?\n|\r/g," ").trim()}function Qe(t){return t==null?"":String(t)}const Xe=async(t,r)=>{try{await navigator.clipboard.writeText(e(r)),alert("Grupo en formato Markdown copiado al portapapeles!")}catch(a){console.error("[PartySeeAsMDTab] Failed to copy text:",a),alert("Error al copiar el markdown al portapapeles")}};var Ze=M('<div class="header svelte-140wxxj"><label>Grupo</label> <button>Copiar Markdown</button></div> <pre class="svelte-140wxxj"> </pre>',1);function er(t,r){re(r,!0);let a=_e(Ae([]));const{loadAbilityCards:l,abilityCards:g,loadItemCards:o,itemCards:d}=Re();function v(p,P){let f="";if(f+=`# ${p.name}

`,f+=`## Miembros
`,Array.isArray(p.characters)&&p.characters.length>0)for(let m=0;m<p.characters.length;m++){const E=p.characters[m];{const i=Ne(E,P).split(`
`).map(x=>x.length?`> ${x}`:">").join(`
`);f+=`${i}
`}m<p.characters.length-1&&(f+=`
---

`)}else f+=`__Sin miembros.__

`;return f+=We(p.notes,{headerTitle:"Notas"}),f}let u=R(()=>v(r.party,e(a)));Ie(async()=>{await Promise.all([o(),l()]),A(a,[...L(d),...L(g)],!0)}),ee(t,{children:(p,P)=>{var f=Ze(),m=ie(f),E=T(b(m),2);E.__click=[Xe,u],h(m);var w=T(m,2),i=b(w,!0);h(w),K(()=>X(i,e(u))),S(p,f)},$$slots:{default:!0}}),ae()}ce(["click"]);const rr=(t,r)=>{navigator.clipboard.writeText(r().id),alert(`ID de invitaci√≥n copiado al portapapeles!

P√°saselo a tus jugadores para que agreguen sus personajes al grupo desde la pesta√±a de configuraci√≥n de las hojas de personaje.`)};var ar=(t,r)=>r("members"),tr=(t,r)=>r("notes"),sr=(t,r)=>r("see_as_md"),nr=M('<div class="party-sheet svelte-saco2k"><div class="row header-row"><!></div> <div class="tabs svelte-saco2k"><button>Miembros</button> <button>Notas</button> <button>Ver como MD</button> <span class="spacer svelte-saco2k"></span> <button>Copiar ID de invitaci√≥n</button></div> <!></div>');function or(t,r){re(r,!0);let a=de(r,"party",7),l=R(()=>c.url.searchParams.get("tab")??le.DEFAULT_PARTY_SHEET_TAB);const g=s=>{c.url.searchParams.set("tab",s),G(`?${c.url.searchParams.toString()}`)};var o=nr(),d=b(o),v=b(d);je(v,{get value(){return a().name},get readonly(){return r.readonly},onChange:s=>{a()&&(a().name=String(s),r.onChange(a().copy()))}}),h(d);var u=T(d,2),p=b(u);p.__click=[ar,g];let P;var f=T(p,2);f.__click=[tr,g];let m;var E=T(f,2);E.__click=[sr,g];let w;var i=T(E,4);i.__click=[rr,a],h(u);var x=T(u,2);{var O=s=>{ze(s,{get party(){return a()},get readonly(){return r.readonly},get onChange(){return r.onChange}})},W=s=>{var _=Ee(),C=ie(_);{var k=F=>{er(F,{get party(){return a()},get readonly(){return r.readonly},get onChange(){return r.onChange}})},q=F=>{Je(F,{get party(){return a()},get readonly(){return r.readonly},get onChange(){return r.onChange}})};V(C,F=>{e(l)==="see_as_md"?F(k):F(q,!1)},!0)}S(s,_)};V(x,s=>{e(l)==="members"?s(O):s(W,!1)})}h(o),K((s,_,C)=>{P=Z(p,1,"",null,P,s),m=Z(f,1,"",null,m,_),w=Z(E,1,"",null,w,C)},[()=>({selected:e(l)==="members"}),()=>({selected:e(l)==="notes"}),()=>({selected:e(l)==="see_as_md"})]),S(t,o),ae()}ce(["click"]);async function ir(t,r,a){const l=await r("Nuevo Grupo");a(l)}async function lr(t,r,a,l){if(!(!e(r)||!confirm(`¬øEliminar el grupo "${e(r).name}"?`))){try{await a(e(r).id)}catch(o){console.error("[parties-page] delete failed",o),alert("Error al eliminar el grupo")}A(l,null),A(r,void 0),c.url.searchParams.delete("partyId"),G(`?${c.url.searchParams.toString()}`)}}var cr=M('<div class="empty svelte-1hi552">No tienes grupos. Crea uno con ‚ûï</div>'),ur=(t,r,a)=>r(e(a)),dr=M('<span class="owner svelte-1hi552"> </span>'),vr=M('<button><!> <span class="name svelte-1hi552"> </span></button>'),mr=M("<p>Selecciona un grupo de la lista o crea uno nuevo con ‚ûï</p>"),hr=M('<section class="parties-page svelte-1hi552"><div class="list svelte-1hi552" role="navigation" aria-label="Lista de grupos"><div class="header svelte-1hi552"><button title="Crear">‚ûï</button> <button title="Eliminar">üóëÔ∏è</button></div> <div class="content svelte-1hi552"><!> <!></div></div> <div class="viewport svelte-1hi552"><!> <div class="controls svelte-1hi552"><span class="muted"> </span></div></div></section>');function xr(t,r){re(r,!0);const a=()=>ue(v,"$parties",g),l=()=>ue(m,"$user",g),[g,o]=be(),d=pe();let{parties:v,loadParties:u,deleteParty:p,saveParty:P,createParty:f}=Ue();const{user:m,firebaseReady:E}=d;let w=R(()=>c.url.searchParams.get("partyId")),i=R(()=>a().find(n=>n.id===e(w))),x=_e(!1);const O=async()=>{if(L(E)){if(!L(m)){G(xe("/"));return}await u()}},W=m.subscribe(async()=>await O()),s=E.subscribe(async n=>{n&&setTimeout(()=>{O()},le.NO_USER_REDIRECT_DELAY)}),_=v.subscribe(async n=>{e(w)&&A(i,n.find(y=>y.id===e(w)))});Me(()=>{W(),s(),_()});let C=null;const k=500;function q(){!e(i)||L(m)?.uid!==e(i).ownerId||(C&&clearTimeout(C),C=setTimeout(async()=>{C=null,await F()},k))}async function F(){if(e(i)){A(x,!0);try{const n=L(m);n&&(!e(i).ownerId||e(i).ownerId==="")&&(e(i).ownerId=n.uid),await P(e(i));const y=L(v).find(j=>j.id===e(i).id);A(i,y?y.copy():e(i).copy())}catch(n){console.error("[parties-page] save failed",n)}finally{A(x,!1)}}}const te=n=>{A(w,n.id),A(i,n),c.url.searchParams.set("partyId",n.id),c.url.searchParams.delete("characterId"),c.url.searchParams.delete("sheetTab"),c.url.searchParams.delete("tab"),G(`?${c.url.searchParams.toString()}`)};var I=hr(),$=b(I),D=b($),B=b(D);B.__click=[ir,f,te];var H=T(B,2);H.__click=[lr,i,p,w],h(D);var J=T(D,2),se=b(J);{var Y=n=>{var y=cr();S(n,y)};V(se,n=>{a().length===0&&n(Y)})}var N=T(se,2);ge(N,1,a,n=>n.id,(n,y)=>{var j=vr();let ne;j.__click=[ur,te,y];var he=b(j);{var Se=Q=>{var oe=dr(),ke=b(oe,!0);h(oe),K(()=>{$e(oe,"title",`${e(y).ownerId===l()?.uid?"Due√±o":"Miembro"} del grupo`),X(ke,e(y).ownerId===l()?.uid?"üëë":"üë§")}),S(Q,oe)};V(he,Q=>{e(y).ownerId&&Q(Se)})}var fe=T(he,2),Te=b(fe,!0);h(fe),h(j),K(Q=>{ne=Z(j,1,"party-item svelte-1hi552",null,ne,Q),X(Te,e(y).name)},[()=>({selected:e(w)===e(y).id})]),S(n,j)}),h(J),h($);var U=T($,2),z=b(U);{var Pe=n=>{{let y=R(()=>l()?.uid!==e(i)?.ownerId);or(n,{get party(){return e(i)},get readonly(){return e(y)},onChange:j=>{e(i)&&(A(i,j),q())}})}},Ce=n=>{ee(n,{title:"Selecciona un grupo",children:(y,j)=>{var ne=mr();S(y,ne)},$$slots:{default:!0}})};V(z,n=>{e(i)?n(Pe):n(Ce,!1)})}var ve=T(z,2),me=b(ve),we=b(me,!0);h(me),h(ve),h(U),h(I),K(()=>{H.disabled=l()?.uid!==e(i)?.ownerId,X(we,e(x)?"Guardando...":"")}),S(t,I),ae(),o()}ce(["click"]);export{xr as component};
