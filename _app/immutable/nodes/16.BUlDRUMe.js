import"../chunks/DsnmJJEf.js";import"../chunks/DYkEFMcb.js";import{o as ar,a as tr,h as sr,s as q}from"../chunks/DDMpRfKd.js";import{p as or,b as y,a as f,d as nr,ac as cr,F as e,ad as I,j as t,e as U,r as B,c as V,f as P,g as A,t as G,k as ir}from"../chunks/Cg1s0EoG.js";import{i as j}from"../chunks/MZe84WCl.js";import{i as lr}from"../chunks/9Ega0Btb.js";import{g as D}from"../chunks/CDyK6DUB.js";import{C as ur}from"../chunks/Bg1TY32O.js";import{R as dr}from"../chunks/B0BlQvao.js";import{c as fr,a as hr,p as vr,u as mr,C as H,b as pr}from"../chunks/tGQMOH97.js";var yr=y('<meta name="viewport" content="width=device-width, initial-scale=1"/>'),gr=y('<div class="status svelte-oz626m">Cargando personaje...</div>'),br=y('<div class="status svelte-oz626m" style="margin-top:8px; white-space:pre-wrap"> </div>'),_r=y('<div class="status svelte-oz626m"> </div> <!>',1),wr=y("<!> <!>",1),Cr=y('<div class="status svelte-oz626m">Personaje no disponible.</div>'),Ir=y('<div class="page svelte-oz626m"><!></div>');function Nr(J,K){or(K,!1);let m,b;const d=mr(),S=fr();hr();const{isInsideFoundry:M,syncCharacterState:O}=pr();let o=I(!0),s=I(null),l=I(null),u=I(void 0),T=null,F=I("general");function p(r){try{if(!r)return String(r);if(typeof r=="string")return r;const a=r;return a?.message?String(a.message):String(a)}catch{return String(r)}}async function R(r){try{if(!r||!r.party||!r.party.partyId){try{S.setPersonalTarget()}catch{}return}const a=r.party.partyId;try{const c=await d.loadParty(a),n=c&&c.name?c.name:void 0;try{S.setPartyTarget(a,n)}catch{}}catch{try{S.setPartyTarget(a)}catch{}}}catch{}}async function Q(r){try{const a=D(d.user);if(!a)return;(a.uid===m||r.party&&r.party.ownerId&&a.uid===r.party.ownerId)&&(await d.saveCharactersForUser(m,[r]),M()&&O(r))}catch(a){console.error("[embed-character] save failed",a),e(l,p(a))}}function W(r){e(F,r||"general");try{const a=new URL(window.location.href);r?a.searchParams.set("tab",r):a.searchParams.delete("tab"),history.replaceState(history.state,"",a.toString())}catch{}}function X(){try{const r=D(d.user);return!r||!t(u)?!1:!!(r.uid===m||t(u).party&&t(u).party.ownerId&&r.uid===t(u).party.ownerId)}catch{return!1}}const L=r=>{e(u,r),M()&&O(t(u))};ar(async()=>{try{const r=D(vr);m=r?.params?.userId,b=r?.params?.characterId}catch{}try{e(F,new URL(window.location.href).searchParams.get("tab")??"general")}catch{e(F,"general")}if(e(o,!0),e(s,null),e(l,null),!m||!b){e(o,!1),e(s,"Parámetros de ruta inválidos.");return}try{await d.initFirebase()}catch(r){console.error("[embed-character] initFirebase failed",r),e(o,!1),e(s,"No se pudo inicializar los servicios."),e(l,p(r));return}if(!d||typeof d.listenCharactersByIds!="function"){console.error("[embed-character] listenCharactersByIds not available",{firebase:d}),e(o,!1),e(s,"No se pudo suscribir al personaje."),e(l,"listenCharactersByIds missing");return}try{const r=d.listenCharactersByIds([{userId:m,characterId:b}],async a=>{try{const c=(a||[]).find(n=>n&&n.id===b);if(c){try{L(new H(c))}catch(n){console.error("[embed-character] Character constructor failed",n,{foundRaw:c}),e(o,!1),e(s,"Ocurrió un error al procesar los datos del personaje."),e(l,p(n));return}e(o,!1),e(s,null),await R(t(u));return}try{const _=(await d.loadCharactersForUser(m)||[]).find(i=>i&&i.id===b);if(_){try{L(new H(_))}catch(i){console.error("[embed-character] Character ctor (fallback) failed",i,{fb:_}),e(o,!1),e(s,"Ocurrió un error al procesar los datos del personaje."),e(l,p(i));return}e(o,!1),e(s,null),await R(t(u));return}else{e(o,!1),e(s,"No se encontró el personaje.");return}}catch(n){console.error("[embed-character] fallback loadCharactersForUser failed",n),e(o,!1),e(s,"No se encontró el personaje. Revisa la consola."),e(l,p(n));return}}catch(c){console.error("[embed-character] listener callback error",c),e(o,!1),e(s,"Ocurrió un error al cargar el personaje."),e(l,p(c))}});T=typeof r=="function"?r:null}catch(r){console.error("[embed-character] subscribe failed",r),e(o,!1),e(s,"No se pudo suscribir al personaje."),e(l,p(r));return}}),tr(()=>{if(T){try{T()}catch{}T=null}try{S.setPersonalTarget()}catch{}}),lr();var k=Ir();sr(r=>{var a=yr();cr.title="Ficha embebida",f(r,a)});var Y=U(k);{var Z=r=>{var a=gr();f(r,a)},$=r=>{var a=V(),c=P(a);{var n=i=>{var w=_r(),C=P(w),z=U(C,!0);B(C);var x=A(C,2);{var h=v=>{var g=br(),E=U(g,!0);B(g),G(()=>q(E,t(l))),f(v,g)};j(x,v=>{t(l)&&v(h)})}G(()=>q(z,t(s))),f(i,w)},_=i=>{var w=V(),C=P(w);{var z=h=>{var v=wr(),g=P(v);{let rr=ir(()=>!X());ur(g,{get character(){return t(u)},get readonly(){return t(rr)},onChange:N=>{e(u,N),R(N),Q(N).catch(er=>{console.error("[embed-character] persistCharacter error",er)})},get currentTab(){return t(F)},onTabChange:W,allowPartyChange:!0})}var E=A(g,2);dr(E,{}),f(h,v)},x=h=>{var v=Cr();f(h,v)};j(C,h=>{t(u)?h(z):h(x,!1)},!0)}f(i,w)};j(c,i=>{t(s)?i(n):i(_,!1)},!0)}f(r,a)};j(Y,r=>{t(o)?r(Z):r($,!1)})}B(k),f(J,k),nr()}export{Nr as component};
